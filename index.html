<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<meta name="color-scheme" content="dark">
<title>FATALBEAST</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- â•â•â•â•â•â•â• FIREBASE CONFIG â€” sostituisci con i tuoi dati â•â•â•â•â•â•â• -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, get, push, onValue, off, update, remove }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  const firebaseConfig = {
  apiKey: "AIzaSyBn0nNetFgHN1FWqV-cV4HQ16FckTctkAA",
  authDomain: "gioco-delle-bestie.firebaseapp.com",
  databaseURL: "https://gioco-delle-bestie-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gioco-delle-bestie",
  storageBucket: "gioco-delle-bestie.firebasestorage.app",
  messagingSenderId: "337213136932",
  appId: "1:337213136932:web:9089ffc7eabb96073638b1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window._fb = { db, ref, set, get, push, onValue, off, update, remove };
  window.dispatchEvent(new Event("firebase-ready"));
</script>

<style>
/* â•â•â• AMOLED VARIABLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  color-scheme: dark;
  /* True AMOLED blacks */
  --bg0:#000000; --bg1:#050507; --bg2:#09090e; --bg3:#0f0f16; --bg4:#14141e;
  /* Blood reds */
  --red:#7a1212; --red2:#c0392b; --red3:#ff3333;
  /* Electric golds */
  --gold:#b8842a; --gold2:#f0b040; --gold3:#ffe580;
  /* UI */
  --text:#f0e8d8; --muted:#4a5070;
  /* Life/death */
  --heal:#12a855; --heal2:#1edd6e;
  --danger:#cc1111; --beast:#0a0000;
  --r:16px; --r2:12px;
  /* Safe area */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
}

/* â”€â”€ Global reset â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;}
button,.btn,.btn-add,.btn-remove,.mode-btn,.settings-btn,
.master-override,.modal-btn,.modal-close,.log-header,.lobby-player,
.game-card,.pu-choice,.pu-manager-row .toggle,.toggle-slider
{touch-action:manipulation;}
html{width:100%;-webkit-text-size-adjust:100%;text-size-adjust:100%;}
body{
  width:100%;min-height:100vh;min-height:100dvh;
  background:#000000;color:var(--text);
  font-family:'Rajdhani',sans-serif;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior-y:none;
  padding-bottom:var(--safe-bottom);
  text-rendering:optimizeSpeed;
}

@media (hover:none) {
  .btn:active{opacity:.8;transform:scale(.97)}
  .mode-btn:active{opacity:.75}
  .btn-add:active{opacity:.7}
  .settings-btn:active{background:rgba(255,255,255,.15)}
  .master-override:active{background:rgba(200,146,42,.18)}
  .card-face:active{transform:perspective(600px) rotateY(3deg) scale(.97)!important}
  .btn-blood:hover{transform:none;box-shadow:0 4px 20px rgba(192,57,43,.4)}
  .btn-remove:hover{color:var(--muted);border-color:rgba(255,255,255,.08)}
  .settings-btn:hover{background:rgba(255,255,255,.07)}
  .btn-add:hover{border-color:rgba(255,255,255,.12);color:var(--muted)}
  /* PERF: remove expensive blur effects on mobile */
  .game-top{backdrop-filter:none;-webkit-backdrop-filter:none}
  .overlay{backdrop-filter:none;-webkit-backdrop-filter:none}
  .reveal-card{backdrop-filter:none;-webkit-backdrop-filter:none}
  .elim-anim-wrap{backdrop-filter:none;-webkit-backdrop-filter:none}
  /* PERF: disable heavy continuous animations on mobile */
  .game-card.critical-card{animation:none;box-shadow:0 8px 40px rgba(0,0,0,.8),0 0 25px rgba(255,40,40,.5)}
  .pu-banner{animation:none}
  .card-covered-shimmer{animation:none}
  /* PERF: simplify hover â†’ only scale, no translateY */
  .game-card:hover:not(.disabled){transform:scale(1.03);box-shadow:0 12px 40px rgba(0,0,0,.9),0 0 0 2px var(--gold2)}
}

/* â•â•â• SCENE BACKGROUND â€” Deep space AMOLED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scene-bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.scene-bg::before{
  content:'';position:absolute;inset:0;
  background:
    radial-gradient(ellipse 70% 40% at 50% -10%, rgba(180,30,30,.5) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 5% 90%, rgba(200,146,42,.09) 0%, transparent 50%),
    radial-gradient(ellipse 50% 60% at 95% 40%, rgba(100,20,20,.08) 0%, transparent 55%),
    radial-gradient(ellipse 30% 30% at 20% 50%, rgba(60,20,80,.05) 0%, transparent 50%);
}
.scene-bg::after{
  content:'';position:absolute;inset:0;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='3' height='3'%3E%3Crect width='3' height='3' fill='%23000'/%3E%3Crect x='0' y='0' width='1' height='1' fill='%23fff' opacity='.008'/%3E%3C/svg%3E");
}
canvas#particle-canvas{position:fixed;inset:0;pointer-events:none;z-index:1}

/* â•â•â• SCREENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{display:none;position:relative;z-index:10;min-height:100vh;flex-direction:column;align-items:center}
.screen.active{display:flex}

/* â•â•â• HOME / SETUP â€” Ultra dark card design â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.home-wrap{width:100%;max-width:420px;padding:20px 16px 40px;display:flex;flex-direction:column;gap:14px}
.logo-hero{text-align:center;padding:28px 0 8px;position:relative}
.logo-hero::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:200px;height:120px;
  background:radial-gradient(ellipse 100% 80% at 50% 30%,rgba(192,57,43,.35) 0%,transparent 70%);
  pointer-events:none;
}
.logo-fatal{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(60px,17vw,92px);letter-spacing:8px;
  color:#ff2020;
  text-shadow:0 0 30px rgba(255,32,32,.9),0 0 60px rgba(255,32,32,.5),0 0 100px rgba(255,32,32,.2);
  display:block;line-height:.88;
}
.logo-beast{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(60px,17vw,92px);letter-spacing:8px;
  color:var(--gold2);
  text-shadow:0 0 30px rgba(240,176,64,.8),0 0 60px rgba(240,176,64,.4);
  display:block;line-height:.88;
}
.logo-tagline{
  font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:5px;
  color:var(--muted);text-transform:uppercase;margin-top:10px;
}

.section-card{
  background:linear-gradient(160deg,rgba(15,15,22,.98),rgba(9,9,14,.98));
  border:1px solid rgba(255,255,255,.06);
  border-top:1px solid rgba(255,255,255,.12);
  border-radius:var(--r);padding:16px;
  box-shadow:0 4px 24px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.06);
}

.section-title{
  font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:4px;
  color:var(--gold);text-transform:uppercase;margin-bottom:12px;font-weight:700;
}

.field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.field label{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:3px;color:var(--muted);text-transform:uppercase}

input[type=text],input[type=number]{
  background:rgba(0,0,0,.7);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--r2);padding:14px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:600;
  width:100%;outline:none;
  transition:border-color .2s,box-shadow .2s;
  -webkit-appearance:none;appearance:none;
}
input:focus{border-color:var(--red2);box-shadow:0 0 0 3px rgba(192,57,43,.18),0 0 20px rgba(192,57,43,.1);}
.player-row{display:flex;gap:6px;margin-bottom:6px}
.player-row input{flex:1}
.btn-remove{
  background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);
  border-radius:8px;color:var(--muted);width:36px;cursor:pointer;font-size:16px;transition:.2s;
}
.btn-remove:hover{color:var(--red3);border-color:var(--red2)}

.mode-row{display:flex;gap:8px}
.mode-btn{
  flex:1;padding:12px;
  background:rgba(0,0,0,.5);
  border:1px solid rgba(255,255,255,.07);
  border-radius:var(--r2);cursor:pointer;
  font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:2px;
  color:var(--muted);text-transform:uppercase;transition:.2s;text-align:center;
  min-height:44px;user-select:none;-webkit-user-select:none;
}
.mode-btn.selected{background:rgba(192,57,43,.18);border-color:var(--red2);color:var(--text);box-shadow:0 0 15px rgba(192,57,43,.15)}
#mode-chaos.selected{background:rgba(120,0,200,.22);border-color:#9b59b6;color:var(--text);box-shadow:0 0 15px rgba(155,89,182,.2)}
#mode-test.selected{background:rgba(0,180,100,.2);border-color:#1db97a;color:#6effc2;box-shadow:0 0 15px rgba(0,180,100,.15)}

.test-mode-pill{
  margin:0 14px 6px;padding:8px 14px;
  background:linear-gradient(135deg,rgba(0,180,100,.12),rgba(0,180,100,.04));
  border:1px solid rgba(0,180,100,.3);border-radius:var(--r2);
  font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;
  color:#6effc2;letter-spacing:3px;text-align:center;text-transform:uppercase;
  display:none;animation:testPill .6s ease;
}
.test-mode-pill.show{display:block}
@keyframes testPill{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}

/* â”€â”€ Cheetah timer overlay â”€â”€ */
.cheetah-ovl{
  position:fixed;top:0;left:0;right:0;z-index:500;pointer-events:none;
  background:linear-gradient(180deg,rgba(160,80,0,.98) 0%,rgba(120,50,0,0) 100%);
  padding:8px 0 24px;display:flex;flex-direction:column;align-items:center;
  animation:chOvlIn .3s ease;
}
@keyframes chOvlIn{from{opacity:0;transform:translateY(-100%)}to{opacity:1;transform:none}}
.cheetah-ovl-lbl{font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:4px;color:rgba(255,220,100,.85);text-transform:uppercase;margin-top:8px}
.cheetah-ovl-num{font-family:'Bebas Neue',sans-serif;font-size:88px;line-height:1;color:#fff;text-shadow:0 0 30px rgba(255,200,0,.9),0 0 60px rgba(255,140,0,.5);letter-spacing:2px}
.cheetah-ovl-num.urgent{color:var(--red3);animation:chUrg .25s ease infinite alternate;text-shadow:0 0 40px rgba(255,60,0,.9),0 0 80px rgba(255,0,0,.5)}
@keyframes chUrg{to{transform:scale(1.12)}}

/* â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{
  padding:16px;border:none;border-radius:var(--r);cursor:pointer;
  font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;letter-spacing:3px;
  text-transform:uppercase;width:100%;
  transition:opacity .15s,transform .15s,box-shadow .2s;
  min-height:54px;user-select:none;-webkit-user-select:none;
  position:relative;overflow:hidden;
}
.btn::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(255,255,255,.08) 0%,transparent 50%);
  pointer-events:none;
}
.btn-blood{
  background:linear-gradient(135deg,#8a1010,#c0392b,#e8402e);
  color:#fff;
  box-shadow:0 4px 24px rgba(192,57,43,.5),0 0 0 1px rgba(255,80,80,.2);
}
.btn-blood:hover{box-shadow:0 6px 32px rgba(192,57,43,.7);transform:translateY(-1px)}
.btn-gold{
  background:linear-gradient(135deg,#9a6a10,#d4911a,#f0b040);
  color:#000;font-weight:800;
  box-shadow:0 4px 24px rgba(240,176,64,.4),0 0 0 1px rgba(255,200,80,.2);
}
.btn-ghost{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:var(--text)}
.btn-sm{padding:10px 14px;font-size:11px;min-height:42px}
.btn-add{
  background:rgba(0,0,0,.3);border:1px dashed rgba(255,255,255,.1);
  color:var(--muted);border-radius:var(--r2);padding:10px;width:100%;
  cursor:pointer;font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:3px;
  transition:.2s;
}
.btn-add:hover{border-color:var(--gold);color:var(--gold)}

/* â•â•â• JOIN SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.join-wrap{width:100%;max-width:380px;padding:40px 16px}
.pin-big{
  font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:10px;text-align:center;
  width:100%;background:rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--r);padding:16px;color:var(--gold2);outline:none;
  transition:.2s;text-transform:uppercase;
}
.pin-big:focus{border-color:var(--red2)}

/* â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lobby-wrap{width:100%;max-width:380px;padding:20px 16px 40px;display:flex;flex-direction:column;gap:14px}
.lobby-code{
  font-family:'Bebas Neue',sans-serif;font-size:56px;letter-spacing:12px;text-align:center;
  color:var(--gold2);text-shadow:0 0 30px rgba(240,176,64,.6),0 0 60px rgba(240,176,64,.3);
}
#qr-container{display:flex;justify-content:center;padding:12px;background:#fff;border-radius:10px;width:fit-content;margin:0 auto}
.lobby-player{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px;
  background:rgba(0,0,0,.4);
  border:1px solid rgba(255,255,255,.06);
  border-radius:var(--r2);
}
.lobby-player.master{border-color:rgba(200,146,42,.3);background:rgba(200,146,42,.04)}
.lobby-dot{width:8px;height:8px;border-radius:50%;background:var(--heal2);box-shadow:0 0 10px var(--heal2)}
.lobby-player.master .lobby-dot{background:var(--gold2);box-shadow:0 0 10px var(--gold2)}

/* â•â•â• GAME SCREEN TOP BAR â€” Glassmorphism â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-game{padding-bottom:max(20px, var(--safe-bottom))}
.game-top{
  display:flex;align-items:center;gap:10px;
  padding:max(10px, calc(var(--safe-top) + 4px)) 14px 10px;
  background:rgba(0,0,0,.9);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid rgba(255,255,255,.06);
  position:sticky;top:0;z-index:50;width:100%;
  box-shadow:0 4px 32px rgba(0,0,0,.6);
}
.game-logo-sm{
  font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;
  color:var(--red2);text-shadow:0 0 14px rgba(192,57,43,.7);
  flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:0;
}
.game-logo-sm .fb-skull{font-size:20px;line-height:1;filter:drop-shadow(0 0 6px rgba(192,57,43,.7))}
.game-logo-sm span{color:var(--gold2)}
.turn-info{flex:1;text-align:center;min-width:0}
.turn-label{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.75);text-transform:uppercase;text-shadow:0 0 8px rgba(255,255,255,.3)}
.turn-name{
  font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:3px;
  color:var(--text);line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;
}
.turn-name.my-turn{
  color:var(--gold2);
  text-shadow:0 0 20px rgba(240,176,64,.6);
  animation:myTurnGlow 1.8s ease infinite alternate;
}
@keyframes myTurnGlow{0%{text-shadow:0 0 12px rgba(240,176,64,.5)}100%{text-shadow:0 0 28px rgba(240,176,64,.85)}}

/* MY TURN banner */
.my-turn-bar{
  display:none;
  background:linear-gradient(135deg,rgba(240,176,64,.25),rgba(240,176,64,.10));
  border-bottom:2px solid rgba(240,176,64,.85);
  padding:7px 14px;text-align:center;
  font-family:'Orbitron',sans-serif;font-size:13px;letter-spacing:5px;
  color:#ffd060;text-shadow:0 0 12px rgba(240,176,64,.9),0 1px 3px rgba(0,0,0,.8);
  animation:myTurnFlash .8s ease infinite alternate;
}
.my-turn-bar.show{display:block}
@keyframes myTurnFlash{0%{background:rgba(240,176,64,.08)}100%{background:rgba(240,176,64,.22)}}

/* Timer */
.timer-wrap{position:relative;width:60px;height:60px;flex-shrink:0;cursor:default}
.timer-wrap svg{position:absolute;inset:0;transform:rotate(-90deg)}
.timer-ring{stroke:var(--red2);stroke-linecap:round;transition:stroke-dashoffset .9s linear;filter:drop-shadow(0 0 4px var(--red2))}
.timer-bg{stroke:rgba(255,255,255,.06)}
#timer-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:28px;color:#fff;text-shadow:0 0 10px rgba(255,255,255,.5)}
.timer-wrap.urgent #timer-num{color:var(--red3);animation:timerPulse .4s ease infinite alternate}
.timer-wrap.urgent .timer-ring{stroke:var(--red3);filter:drop-shadow(0 0 6px var(--red3))}
@keyframes timerPulse{to{transform:scale(1.2)}}

.settings-btn{
  width:36px;height:36px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);
  border-radius:8px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;flex-shrink:0;transition:.2s;
}
.settings-btn:hover{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.18)}

.pu-browse-btn{
  width:36px;height:36px;
  background:rgba(200,146,42,.08);border:2px solid rgba(200,146,42,.3);
  border-radius:50%;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;flex-shrink:0;transition:.2s;
  box-shadow:0 0 12px rgba(200,146,42,.12);
}
.pu-browse-btn:hover,.pu-browse-btn:active{background:rgba(200,146,42,.2);border-color:var(--gold2);box-shadow:0 0 20px rgba(200,146,42,.3)}

.dir-bar{font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:3px;color:var(--muted);text-align:center;padding:4px 14px;border-bottom:1px solid rgba(255,255,255,.04);background:rgba(0,0,0,.3)}

/* â•â•â• HP STRIP â€” Neon health cards â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hp-strip-wrap{padding:10px 14px 6px;overflow-x:auto;-webkit-overflow-scrolling:touch;overscroll-behavior-x:contain}
.hp-strip-wrap::-webkit-scrollbar{height:3px}
.hp-strip-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}
.hp-strip{display:flex;gap:8px;padding-bottom:4px;min-width:-webkit-fit-content;min-width:fit-content}

.hp-card{
  min-width:130px;height:112px;border-radius:14px;
  background:linear-gradient(160deg,rgba(12,12,18,.98),rgba(6,6,10,.99));
  border:1px solid rgba(255,255,255,.07);
  border-top:1px solid rgba(255,255,255,.12);
  padding:10px 12px 8px;position:relative;flex-shrink:0;
  transition:border-color .3s,box-shadow .3s,transform .15s;
  overflow:hidden;will-change:transform;contain:layout style;
}
.hp-card::before{
  content:'';position:absolute;inset:0;border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.04) 0%,transparent 35%);
  pointer-events:none;
}
.hp-card.active{
  border-color:rgba(240,176,64,.6);
  box-shadow:0 0 24px rgba(240,176,64,.2),inset 0 0 24px rgba(240,176,64,.04),0 0 0 1px rgba(240,176,64,.15);
  transform:scale(1.03);
}
.hp-card.active::after{
  content:'';position:absolute;bottom:-1px;left:10%;right:10%;height:3px;
  background:var(--gold2);border-radius:3px;
  box-shadow:0 0 16px var(--gold2),0 0 32px rgba(240,176,64,.5);
  animation:activeGlow 1.5s ease infinite alternate;
}
@keyframes activeGlow{0%{opacity:.5;box-shadow:0 0 8px var(--gold2)}100%{opacity:1;box-shadow:0 0 24px var(--gold2),0 0 40px rgba(240,176,64,.5)}}
.hp-card.dead{opacity:.3;filter:grayscale(.95);transform:scale(.96)}
.hp-card.danger{border-color:rgba(255,30,30,.6);animation:dangerPulse 1.1s ease infinite}
@keyframes dangerPulse{0%,100%{box-shadow:0 0 8px rgba(255,30,30,.3)}50%{box-shadow:0 0 28px rgba(255,30,30,.7),inset 0 0 20px rgba(255,0,0,.08)}}
.hp-card.hit{animation:hpHitV2 .5s ease}
.hp-card.healed{animation:hpHealV2 .5s ease}
@keyframes hpHitV2{0%{transform:scale(1)}20%{background:linear-gradient(160deg,rgba(140,20,20,.7),rgba(90,10,10,.6));transform:scale(1.05)}100%{background:linear-gradient(160deg,rgba(12,12,18,.98),rgba(6,6,10,.99));transform:scale(1)}}
@keyframes hpHealV2{0%{transform:scale(1)}20%{background:linear-gradient(160deg,rgba(15,100,50,.6),rgba(10,70,30,.5));transform:scale(1.05)}100%{background:linear-gradient(160deg,rgba(12,12,18,.98),rgba(6,6,10,.99));transform:scale(1)}}

.hpc-name{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.5px;line-height:1.1}
.hpc-val{font-family:'Bebas Neue',sans-serif;font-size:46px;line-height:1;letter-spacing:1px;margin-top:1px}
.hpc-bar{height:4px;background:rgba(255,255,255,.06);border-radius:3px;margin-top:5px;overflow:hidden}
.hpc-fill{height:100%;border-radius:3px;transition:width .45s ease;box-shadow:0 0 8px currentColor}
.danger-skull{position:absolute;top:6px;right:8px;font-size:16px;animation:skullBob .8s ease infinite alternate}
@keyframes skullBob{to{transform:translateY(-3px)}}
.bug-shield{position:absolute;top:6px;right:8px;font-size:14px;animation:shieldPulse 1s ease infinite}
@keyframes shieldPulse{0%,100%{opacity:1}50%{opacity:.4}}
.dolphin-shield{position:absolute;top:5px;left:8px;font-size:13px;opacity:.7}

/* â•â•â• PU BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pu-banner{
  display:none;align-items:center;gap:10px;
  margin:6px 14px;padding:12px 16px;
  background:linear-gradient(135deg,rgba(200,146,42,.1),rgba(200,146,42,.03));
  border:1px solid rgba(200,146,42,.25);border-radius:var(--r2);
  box-shadow:0 0 20px rgba(200,146,42,.07);
  animation:bannerGlow 2s ease infinite alternate;
}
@keyframes bannerGlow{0%{box-shadow:0 0 12px rgba(200,146,42,.05)}100%{box-shadow:0 0 24px rgba(200,146,42,.15)}}
.pu-banner.show{display:flex}
.pu-banner-icon{font-size:30px;flex-shrink:0;filter:drop-shadow(0 0 10px rgba(200,146,42,.5))}
.pu-banner-text{flex:1;min-width:0}
.pu-banner-title{font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:3px;color:var(--gold2);text-transform:uppercase}
.pu-banner-desc{font-family:'Rajdhani',sans-serif;font-size:13px;color:rgba(255,255,255,.6);margin-top:3px;line-height:1.45}

/* â•â•â• RAT + CARDS SECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cards-section{position:relative;overflow:hidden;padding:0 14px 8px;}
@keyframes ratOverCards{0%{left:-70px;opacity:0}3%{opacity:1}97%{opacity:1}100%{left:calc(100% + 70px);opacity:0}}
.cards-section.rat-active::after{
  content:'ğŸ­';position:absolute;top:calc(50% - 20px);left:-70px;
  font-size:46px;pointer-events:none;z-index:20;
  animation:ratOverCards 2.8s linear infinite;
  filter:drop-shadow(0 0 8px rgba(200,146,42,.7));
}

/* â•â•â• SPECIAL TURN PILL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.special-turn-pill{
  margin:0 14px 6px;padding:8px 14px;
  background:linear-gradient(135deg,rgba(240,176,64,.1),rgba(240,176,64,.03));
  border:1px solid rgba(240,176,64,.25);border-radius:var(--r2);
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;
  color:var(--gold2);letter-spacing:2px;text-align:center;text-transform:uppercase;
}
.bear-cards-left{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--gold2);margin-left:8px;vertical-align:middle}

/* â•â•â• MASTER OVERRIDE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.master-override{
  display:flex;align-items:center;gap:8px;padding:9px 14px;
  margin:0 14px 6px;
  background:rgba(200,146,42,.06);border:1px solid rgba(200,146,42,.18);
  border-radius:var(--r2);cursor:pointer;
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;
  color:var(--gold);letter-spacing:2px;text-transform:uppercase;transition:.2s;
}
.master-override:hover{background:rgba(200,146,42,.12)}

/* â•â•â• CARDS â€” Real playing cards on AMOLED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));grid-gap:10px;gap:10px;justify-items:center}
@media(max-width:380px){.cards-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));grid-gap:8px;gap:8px}}
.cards-grid.compact{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));grid-gap:8px;gap:8px}

.card-corner{position:absolute;font-size:14px;color:rgba(200,146,42,.3);line-height:1}
.card-corner.tl{top:8px;left:10px}
.card-corner.br{bottom:8px;right:10px;transform:rotate(180deg)}

.card-val-main{
  font-family:'Bebas Neue',sans-serif;font-size:84px;line-height:1;
  color:var(--gold2);
  text-shadow:0 0 40px rgba(240,176,64,.6),0 2px 10px rgba(0,0,0,.9);
  z-index:2;position:relative;
}
.card-name-reveal{
  font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;
  color:var(--text);text-align:center;padding:0 10px;margin-top:8px;
  line-height:1.2;min-height:22px;z-index:2;position:relative;
}
.card-name-reveal.hidden{opacity:0}
.card-name-reveal.revealed{animation:nameReveal .4s ease}
@keyframes nameReveal{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.card-name-reveal.eagle-glow{color:var(--gold2);text-shadow:0 0 20px rgba(240,176,64,.9)}

/* Covered card */
.card-covered{background:linear-gradient(160deg,#060810,#030508);border-color:rgba(255,255,255,.05)}
.card-covered-pattern{position:absolute;inset:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,.012) 0,rgba(255,255,255,.012) 1px,transparent 1px,transparent 12px);border-radius:12px}
.card-covered-symbol{font-size:52px;opacity:.1;user-select:none}
.card-covered-shimmer{position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.04) 50%,transparent 60%);animation:cardShimmer 2.5s ease infinite;border-radius:12px}
@keyframes cardShimmer{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}

.critical-flash{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:9px;font-weight:900;letter-spacing:2px;color:var(--red3);background:rgba(255,30,30,.15);border:1px solid rgba(255,30,30,.4);border-radius:4px;padding:2px 8px;text-transform:uppercase;animation:critFlash .6s ease infinite alternate;white-space:nowrap}
@keyframes critFlash{to{background:rgba(255,30,30,.35);box-shadow:0 0 14px rgba(255,50,50,.5)}}

.card-badge{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-family:'Orbitron',sans-serif;font-size:8px;font-weight:900;letter-spacing:1.5px;padding:3px 9px;border-radius:4px;text-transform:uppercase;white-space:nowrap;z-index:3}
.badge-tick{background:rgba(180,80,20,.3);border:1px solid rgba(180,80,20,.6);color:#e87000}
.badge-viper{background:rgba(20,120,20,.25);border:1px solid rgba(20,180,20,.4);color:#3be03b}
.badge-butterfly{background:rgba(130,60,200,.25);border:1px solid rgba(180,80,255,.4);color:#d080ff}
.badge-fly{background:rgba(130,100,0,.35);border:1px solid rgba(200,160,0,.6);color:#ffe066}
.badge-revival{background:rgba(20,160,100,.25);border:1px solid rgba(30,210,130,.4);color:#30e490}
.badge-skunk{background:rgba(30,30,50,.5);border:1px solid rgba(200,200,220,.3);color:#e0e0ff}

.game-card{
  width:148px;height:215px;border-radius:16px;position:relative;
  background:linear-gradient(160deg,#141828,#0a0e18);
  border:1px solid rgba(200,146,42,.2);
  border-top:1px solid rgba(200,146,42,.35);
  box-shadow:0 8px 40px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.07);
  cursor:pointer;
  transition:transform .2s cubic-bezier(.2,.8,.3,1),box-shadow .2s;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  overflow:hidden;transform-style:preserve-3d;
  flex-shrink:0;user-select:none;will-change:transform;contain:layout style;
}
.game-card::before{
  content:'';position:absolute;inset:0;border-radius:14px;
  background:linear-gradient(180deg,rgba(255,255,255,.05) 0%,transparent 45%);
  pointer-events:none;z-index:1;
}
.game-card:hover:not(.disabled){
  transform:translateY(-10px) scale(1.04);
  box-shadow:0 24px 60px rgba(0,0,0,.9),0 0 0 2px var(--gold2),0 0 30px rgba(240,176,64,.3);
}
.game-card.disabled{cursor:default;opacity:.65}
.game-card.critical-card{border-color:rgba(255,40,40,.7);animation:critGlow 1.5s ease infinite alternate}
@keyframes critGlow{from{box-shadow:0 8px 40px rgba(0,0,0,.8),0 0 20px rgba(255,40,40,.3)}to{box-shadow:0 8px 40px rgba(0,0,0,.8),0 0 40px rgba(255,40,40,.7),inset 0 0 30px rgba(255,0,0,.06)}}
.game-card.flip-anim{animation:cardFlip3d .45s ease forwards}
@keyframes cardFlip3d{0%{transform:rotateY(0) scale(1)}35%{transform:rotateY(90deg) scale(1.06)}55%{transform:rotateY(-10deg) scale(1.03)}100%{transform:rotateY(0) scale(.92);opacity:.35}}

.card-ripple{position:absolute;border-radius:50%;background:rgba(240,176,64,.35);pointer-events:none;transform:scale(0);animation:cardRipple .5s ease forwards;z-index:10}
@keyframes cardRipple{0%{transform:scale(0);opacity:1}100%{transform:scale(3);opacity:0}}

/* â•â•â• PU CHOICE â€” Crystalline card design â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pu-section{padding:8px 14px 0;animation:slideUp .35s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.pu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

.pu-choice{
  border-radius:18px;cursor:pointer;position:relative;overflow:hidden;
  transition:transform .25s cubic-bezier(.22,1,.36,1),box-shadow .25s,border-color .2s;
  transform-style:preserve-3d;min-height:210px;display:flex;flex-direction:column;
  will-change:transform;contain:layout style;
  border:1px solid rgba(255,255,255,.06);
  border-top:1px solid rgba(255,255,255,.12);
}
.pu-choice:hover{transform:translateY(-4px) scale(1.02)}
.pu-choice.chosen .puc-shine{opacity:1}
.pu-choice.chosen{animation:puChosen .35s ease;border-color:rgba(240,176,64,.6)!important;box-shadow:0 0 24px rgba(240,176,64,.2)!important}
@keyframes puChosen{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1.04)}}
.puc-art-zone{flex:0 0 85px;display:flex;align-items:center;justify-content:center;position:relative}
.puc-icon{font-size:46px;display:block;position:relative;z-index:2;transition:transform .25s cubic-bezier(.22,1,.36,1)}
.pu-choice:hover .puc-icon,.pu-choice.chosen .puc-icon{transform:scale(1.2) translateY(-3px)}
.puc-band{padding:6px 8px 12px;flex:1;position:relative;z-index:2;display:flex;flex-direction:column}
.puc-name{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;text-align:center;margin-bottom:4px;line-height:1}
.puc-desc{font-size:11px;color:rgba(255,255,255,.65);line-height:1.35;text-align:center;font-family:'Rajdhani',sans-serif;letter-spacing:.3px;overflow-y:auto;max-height:80px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.puc-desc::-webkit-scrollbar{display:none}
.puc-corner{position:absolute;top:7px;left:9px;font-size:14px;opacity:.35;z-index:3;line-height:1}
.puc-shine{position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.14) 0%,transparent 45%,rgba(255,255,255,.05) 100%);border-radius:16px;pointer-events:none;z-index:4;opacity:0;transition:opacity .2s}
.pu-choice:hover .puc-shine{opacity:.7}
.confirm-row{display:none;gap:8px;padding:10px 14px 6px}

/* â•â•â• LOG â€” Dark glass panel â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.log-section{padding:0 14px 8px}
.log-header{display:flex;align-items:center;justify-content:space-between;padding:6px 2px;cursor:pointer}
.log-header-title{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:3px;color:rgba(255,255,255,.85);text-transform:uppercase;text-shadow:0 0 8px rgba(255,255,255,.25)}
.log-header-arrow{font-size:12px;color:var(--muted);transition:.2s}
.log-header.open .log-header-arrow{transform:rotate(180deg)}
.log-entry.damage{border-left-color:#ff3333;background:rgba(255,51,51,.05)}
.log-entry.heal{border-left-color:var(--heal2);background:rgba(30,221,110,.04)}
.log-entry.powerup{border-left-color:var(--gold);background:rgba(240,176,64,.06)}
.log-entry.elim{border-left-color:#c0392b;background:rgba(80,0,0,.25);animation:logElimPulse 1.5s ease 1}
@keyframes logElimPulse{0%,100%{background:rgba(80,0,0,.25)}40%{background:rgba(130,0,0,.4)}}
.log-entry.system{border-left-color:rgba(255,255,255,.12);background:transparent}
.log-entry.turn-divider{border-left:none;background:none;padding:3px 14px;text-align:center;font-family:'Orbitron',sans-serif;font-size:8px;letter-spacing:4px;color:rgba(255,255,255,.18);text-transform:uppercase;border-bottom:1px solid rgba(255,255,255,.04)}
.log-entry.powerup-detail{border-left-color:#c8922a;background:rgba(200,146,42,.04)}
.log-entry.effect-expire{border-left-color:rgba(100,100,100,.5);background:rgba(255,255,255,.02);color:rgba(255,255,255,.5);font-style:italic}

#log-list{height:280px;overflow-y:auto;border-radius:12px;border:1px solid rgba(255,255,255,.05);background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,.4));contain:strict;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;scroll-behavior:smooth}
#log-list::-webkit-scrollbar{width:4px}
#log-list::-webkit-scrollbar-track{background:rgba(255,255,255,.03);border-radius:4px}
#log-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:4px}
#log-list::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.32)}
.log-entry{font-family:'Rajdhani',sans-serif;font-size:15px;line-height:1.55;padding:9px 14px 9px 16px;border-bottom:1px solid rgba(255,255,255,.03);border-left:3px solid transparent;transition:background .12s;letter-spacing:.2px;contain:layout style}
.lp{color:var(--gold2);font-weight:700;font-size:16px}
.ld{color:#ff3333;font-weight:700;font-size:16px}
.lh{color:var(--heal2);font-weight:700;font-size:16px}
.lpu{color:#f0c060;font-weight:700;font-size:14px;padding:1px 4px;background:rgba(240,176,64,.1);border-radius:3px}
.lsys{color:rgba(255,255,255,.45);font-size:13px;font-style:italic}
.larr{color:rgba(255,255,255,.25);font-size:13px;margin:0 3px}

/* â•â•â• MODALS / OVERLAYS â€” Pure glass on black â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.82);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);display:none;align-items:flex-end;justify-content:center;padding:0;animation:fadeOverlay .2s ease;overscroll-behavior:contain}
.overlay.show{display:flex}
.modal{
  background:linear-gradient(160deg,rgba(14,14,22,.99),rgba(8,8,14,.99));
  border:1px solid rgba(255,255,255,.08);
  border-top:1px solid rgba(255,255,255,.14);
  border-radius:22px 22px 0 0;
  padding:24px 20px max(24px,var(--safe-bottom));
  width:100%;max-width:520px;max-height:92dvh;
  overflow-y:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  animation:modalSlideUp .3s cubic-bezier(.34,1.56,.64,1);
  box-shadow:0 -10px 60px rgba(0,0,0,.8);
}
@keyframes fadeOverlay{from{opacity:0}to{opacity:1}}
@keyframes modalSlideUp{from{transform:translateY(120%);opacity:0}to{transform:none;opacity:1}}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;color:var(--gold2);text-align:center;margin-bottom:18px}
.modal-close{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.09);color:var(--muted);border-radius:var(--r2);padding:10px;width:100%;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;margin-top:8px;transition:.2s;text-transform:uppercase}
.modal-close:hover{color:var(--text)}
.modal-btn{display:block;width:100%;padding:13px;margin-bottom:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--r2);cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;letter-spacing:1px;color:var(--text);text-align:left;transition:.2s}
.modal-btn:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.16)}
.modal-btn.danger{color:var(--red3);border-color:rgba(192,57,43,.2)}
.modal-btn.danger:hover{background:rgba(192,57,43,.12)}

.reveal-title{font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:4px;color:var(--text);margin-bottom:8px}
.reveal-desc{font-size:14px;color:var(--muted);line-height:1.5;margin-bottom:16px;font-family:'Rajdhani',sans-serif}
.reveal-dmg{font-family:'Bebas Neue',sans-serif;font-size:68px;letter-spacing:2px;margin:8px 0}
.reveal-dmg.red{color:var(--red3);text-shadow:0 0 30px rgba(255,50,50,.7)}
.reveal-dmg.green{color:var(--heal2);text-shadow:0 0 30px rgba(30,220,110,.7)}
.reveal-dmg.gold{color:var(--gold2);text-shadow:0 0 30px rgba(240,176,64,.7)}
.reveal-card{width:100%;max-width:360px;padding:28px 24px;text-align:center;border-radius:22px 22px 0 0;background:linear-gradient(160deg,rgba(14,14,22,.99),rgba(8,8,14,.99));backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
.reveal-animal{font-size:80px;margin-bottom:8px;animation:revealPopV2 .5s cubic-bezier(.2,.8,.3,1);filter:drop-shadow(0 0 30px rgba(240,176,64,.6))}
@keyframes revealPopV2{0%{transform:scale(0) rotate(-25deg);opacity:0}60%{transform:scale(1.2) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}

/* â”€â”€ PU Browser â”€â”€ */
.pu-browser-entry{display:flex;gap:10px;align-items:flex-start;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.pu-browser-entry:last-child{border-bottom:none}
.pu-browser-icon{font-size:28px;flex-shrink:0;width:36px;text-align:center}
.pu-browser-info{flex:1;min-width:0}
.pu-browser-name{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:var(--gold2);display:flex;align-items:center;gap:6px}
.pu-browser-timing{font-size:10px;letter-spacing:1px;color:var(--muted);background:rgba(255,255,255,.05);padding:2px 6px;border-radius:4px;font-weight:400;font-family:'Orbitron',sans-serif}
.pu-browser-desc{font-family:'Rajdhani',sans-serif;font-size:12px;color:rgba(255,255,255,.55);margin-top:3px;line-height:1.4}
.pu-browser-banned{opacity:.35}
.pu-browser-banned .pu-browser-name{color:var(--muted);text-decoration:line-through}
.pu-banned-tag{font-size:9px;background:rgba(192,57,43,.25);color:var(--red3);padding:2px 6px;border-radius:4px;letter-spacing:1px;font-family:'Orbitron',sans-serif}

/* â”€â”€ Active effects bar â”€â”€ */
.active-effects-bar{margin:0 14px 6px;padding:8px 12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.06);border-radius:10px;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
.effect-chip{font-family:'Orbitron',sans-serif;font-size:9px;letter-spacing:1px;padding:3px 8px;border-radius:6px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.7);display:flex;align-items:center;gap:3px}
.effect-chip.owner{background:rgba(200,146,42,.12);border-color:rgba(200,146,42,.3);color:var(--gold2)}

/* â”€â”€ Pigeon blocked card â”€â”€ */
.pu-choice-covered{position:relative;overflow:hidden;background:linear-gradient(160deg,#150808,#220606)!important;border-color:rgba(239,83,80,.4)!important}
.pu-choice-covered .puc-art-zone{background:radial-gradient(ellipse 120% 100% at 50% 40%,rgba(239,83,80,.25) 0%,transparent 70%)!important}
.pu-choice-covered .puc-name{letter-spacing:4px;color:#bdbdbd!important}
.pu-choice-covered .puc-desc{opacity:0}
.pu-choice-covered .puc-corner{opacity:0}
.pu-choice-covered.chosen{border-color:rgba(239,83,80,.8)!important}

.pigeon-block-x{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:5;pointer-events:none;background:rgba(0,0,0,.4);border-radius:14px}
.pigeon-block-x::before,.pigeon-block-x::after{content:'';position:absolute;width:85%;height:5px;background:rgba(255,50,50,.9);border-radius:3px;box-shadow:0 0 16px rgba(255,50,50,.8)}
.pigeon-block-x::before{transform:rotate(45deg)}
.pigeon-block-x::after{transform:rotate(-45deg)}

/* â”€â”€ PU Manager â”€â”€ */
.pu-manager-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.pu-manager-row:last-child{border-bottom:none}
.pu-mgr-icon{font-size:22px;width:30px;text-align:center;flex-shrink:0}
.pu-mgr-info{flex:1;min-width:0}
.pu-mgr-name{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--text)}
.pu-mgr-desc{font-size:10px;color:var(--muted);line-height:1.3;margin-top:1px;font-family:'Rajdhani',sans-serif}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:rgba(255,255,255,.06);border-radius:24px;cursor:pointer;border:1px solid rgba(255,255,255,.09);transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:2px;top:2px;background:var(--muted);border-radius:50%;transition:.3s}
.toggle input:checked+.toggle-slider{background:rgba(30,180,90,.2);border-color:var(--heal)}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px);background:var(--heal2)}

/* â•â•â• SPECTATOR PILL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spectator-pill{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:rgba(80,30,110,.9);color:#d7bde2;font-size:9px;padding:4px 14px;border-radius:20px;letter-spacing:3px;font-family:'Orbitron',sans-serif;font-weight:700;text-transform:uppercase;z-index:100;pointer-events:none;border:1px solid rgba(140,70,180,.8)}

/* â•â•â• GAME OVER â€” Cinematic finale â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gameover-wrap{width:100%;max-width:420px;padding:30px 16px 50px;display:flex;flex-direction:column;align-items:center;gap:16px}
.go-fire{font-size:84px;animation:fireFloat 1.5s ease-in-out infinite alternate;filter:drop-shadow(0 0 30px rgba(255,120,0,.8))}
@keyframes fireFloat{to{transform:translateY(-14px) scale(1.08)}}
.go-sub{font-family:'Orbitron',sans-serif;font-size:11px;letter-spacing:4px;color:var(--muted);text-transform:uppercase}
.go-winner-name{
  font-family:'Bebas Neue',sans-serif;font-size:clamp(42px,13vw,64px);letter-spacing:4px;
  color:var(--gold2);text-align:center;
  text-shadow:0 0 40px rgba(240,176,64,.7),0 0 80px rgba(240,176,64,.3);
  animation:winnerPulse 2s ease infinite alternate;
}
@keyframes winnerPulse{0%{text-shadow:0 0 30px rgba(240,176,64,.5)}100%{text-shadow:0 0 70px rgba(240,176,64,.9),0 0 120px rgba(240,176,64,.4)}}
.final-list{width:100%;display:flex;flex-direction:column;gap:8px}
.final-row{display:flex;align-items:center;gap:12px;padding:14px 18px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.05);border-radius:var(--r);animation:rowIn .4s ease both}
.final-row:nth-child(1){border-color:rgba(200,146,42,.4);background:rgba(200,146,42,.05);animation-delay:.1s}
.final-row:nth-child(2){animation-delay:.2s}
.final-row:nth-child(3){animation-delay:.3s}
@keyframes rowIn{from{opacity:0;transform:translateX(-14px)}to{opacity:1;transform:none}}
.final-rank{font-size:24px;width:32px;flex-shrink:0}
.final-name{flex:1;font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700}
.final-hp{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--gold)}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:100%}
.stat-box{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.05);border-radius:var(--r);padding:12px 10px;text-align:center}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--red2)}
.stat-val-name{font-family:'Bebas Neue',sans-serif;font-size:20px;color:#fff;letter-spacing:1px;line-height:1.1;min-height:22px}
.stat-val-num{font-family:'Bebas Neue',sans-serif;font-size:26px;color:var(--red2);line-height:1}
.stat-label{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-top:3px;font-family:'Orbitron',sans-serif}
.history-item{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.05);border-radius:var(--r);padding:13px 16px;margin-bottom:8px}
.history-winner{font-family:'Bebas Neue',sans-serif;font-size:19px;color:var(--gold2);letter-spacing:1px}
.history-meta{font-size:11px;color:var(--muted);margin-top:2px;font-family:'Rajdhani',sans-serif}

/* â•â•â• DAMAGE FLOAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dmg-float{position:fixed;pointer-events:none;z-index:900;font-family:'Bebas Neue',sans-serif;font-size:56px;letter-spacing:2px;text-shadow:0 3px 20px rgba(0,0,0,.95),0 0 50px currentColor;animation:floatUpV2 1.4s cubic-bezier(.2,.8,.3,1) forwards;will-change:transform,opacity}
@keyframes floatUpV2{0%{opacity:0;transform:translateY(10px) scale(.5)}12%{opacity:1;transform:translateY(0) scale(1.35)}30%{transform:translateY(-16px) scale(1)}100%{opacity:0;transform:translateY(-100px) scale(.6)}}
.dmg-float.red{color:#ff3333}
.dmg-float.green{color:var(--heal2)}
.dmg-float.gold{color:var(--gold3)}

/* â•â•â• SCREEN FX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.crit-explode{position:fixed;inset:0;pointer-events:none;z-index:890;animation:critExAnim .65s ease forwards;background:radial-gradient(ellipse 65% 45% at 50% 50%,rgba(255,50,50,.2) 0%,transparent 70%)}
@keyframes critExAnim{0%{opacity:0}25%{opacity:1}100%{opacity:0;transform:scale(1.6)}}
.confetti-bit{position:fixed;border-radius:1px;pointer-events:none;z-index:890;animation:confettiFall linear forwards}
@keyframes confettiFall{0%{transform:translateY(-20px) rotateZ(0);opacity:1}100%{transform:translateY(100vh) rotateZ(720deg);opacity:0}}

@keyframes screenShakeV2{0%,100%{transform:translate3d(0,0,0)}12%{transform:translate3d(-6px,3px,0)}25%{transform:translate3d(6px,-4px,0)}37%{transform:translate3d(-4px,5px,0)}50%{transform:translate3d(4px,-3px,0)}62%{transform:translate3d(-3px,2px,0)}75%{transform:translate3d(2px,-1px,0)}}
.screen-shake{animation:screenShakeV2 .4s ease}

/* â•â•â• TOAST â€” Neon notification â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast-v2{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
  background:linear-gradient(135deg,rgba(10,5,5,.97),rgba(100,20,20,.93));
  color:#fff;padding:12px 24px;border-radius:18px;font-size:14px;
  font-family:'Rajdhani',sans-serif;font-weight:700;letter-spacing:1px;
  z-index:1000;white-space:nowrap;max-width:92vw;text-align:center;
  box-shadow:0 8px 40px rgba(0,0,0,.8),0 0 0 1px rgba(255,80,80,.15);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  animation:toastIn .35s cubic-bezier(.22,1,.36,1) forwards;will-change:transform,opacity;
}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px) scale(.9)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
.toast-v2.out{animation:toastOut .3s ease forwards}
@keyframes toastOut{to{opacity:0;transform:translateX(-50%) translateY(-10px) scale(.95)}}

/* â•â•â• FX OVERLAYS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fx-damage-flash{position:fixed;inset:0;pointer-events:none;z-index:780;background:radial-gradient(ellipse 80% 60% at 50% 50%,rgba(255,20,20,.28) 0%,transparent 70%);animation:fxDmgFlash .45s ease forwards;will-change:opacity}
@keyframes fxDmgFlash{0%{opacity:0}20%{opacity:1}100%{opacity:0}}
.fx-heal-flash{position:fixed;inset:0;pointer-events:none;z-index:780;background:radial-gradient(ellipse 80% 60% at 50% 50%,rgba(30,220,100,.22) 0%,transparent 70%);animation:fxHealFlash .5s ease forwards;will-change:opacity}
@keyframes fxHealFlash{0%{opacity:0}25%{opacity:1}100%{opacity:0}}
.fx-pu-flash{position:fixed;inset:0;pointer-events:none;z-index:785;will-change:opacity;animation:fxPuFlash .6s ease forwards}
@keyframes fxPuFlash{0%{opacity:0}15%{opacity:1}100%{opacity:0}}
.fx-turn-flash{position:fixed;inset:0;pointer-events:none;z-index:48;background:linear-gradient(180deg,rgba(240,176,64,.08) 0%,transparent 40%);animation:fxTurnFlash .7s ease forwards;will-change:opacity}
@keyframes fxTurnFlash{0%{opacity:0}20%{opacity:1}100%{opacity:0}}

/* â•â•â• ELIMINATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.elim-anim-wrap{position:fixed;inset:0;z-index:950;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;animation:elimFadeV2 2.5s ease forwards;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
@keyframes elimFadeV2{0%{background:rgba(0,0,0,0)}10%{background:rgba(80,0,0,.88)}60%{background:rgba(30,0,0,.72)}100%{background:rgba(0,0,0,0);opacity:0}}
.elim-skull{font-size:110px;animation:elimSkull 2.5s ease forwards;filter:drop-shadow(0 0 50px rgba(255,50,50,.9))}
@keyframes elimSkull{0%{transform:scale(0) rotate(-40deg);opacity:0}20%{transform:scale(1.5) rotate(10deg);opacity:1}40%{transform:scale(1) rotate(0);opacity:1}80%{opacity:1}100%{transform:scale(1.3) translateY(-30px);opacity:0}}
.elim-name{font-family:'Bebas Neue',sans-serif;font-size:42px;letter-spacing:5px;color:var(--red3);margin-top:12px;text-shadow:0 0 50px rgba(255,50,50,.9);animation:elimName 2.5s ease forwards}
@keyframes elimName{0%,15%{opacity:0;transform:translateY(18px)}30%{opacity:1;transform:none}75%{opacity:1}100%{opacity:0}}
.elim-sub{font-family:'Orbitron',sans-serif;font-size:12px;letter-spacing:4px;color:var(--muted);text-transform:uppercase;animation:elimName 2.5s .1s ease forwards;opacity:0}
.blood-drop{position:fixed;border-radius:50% 50% 50% 0;background:radial-gradient(circle,#900000,#300000);pointer-events:none;z-index:949;animation:bloodDrop ease forwards}
@keyframes bloodDrop{0%{transform:scale(0) rotate(var(--rot));opacity:1}40%{transform:scale(1) rotate(var(--rot));opacity:1}100%{transform:scale(.8) rotate(var(--rot)) translateY(25px);opacity:0}}

/* â•â•â• ANIMAL ALERT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.animal-alert{
  position:fixed;top:50%;left:50%;
  margin-left:-160px;margin-top:-120px;
  z-index:850;pointer-events:none;
  background:linear-gradient(160deg,#06060e,#10101c);
  border-radius:22px;padding:28px 36px;text-align:center;
  width:320px;max-width:90vw;
  animation:alertPop 2.2s cubic-bezier(.22,1,.36,1) forwards;
  backface-visibility:hidden;-webkit-backface-visibility:hidden;
  will-change:transform,opacity;
}
@keyframes alertPop{0%{opacity:0;transform:scale(.5)}22%{opacity:1;transform:scale(1.08)}32%{transform:scale(.97)}40%{transform:scale(1)}80%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(.9)}}
@-webkit-keyframes alertPop{0%{opacity:0;-webkit-transform:scale(.5)}22%{opacity:1;-webkit-transform:scale(1.08)}32%{-webkit-transform:scale(.97)}40%{-webkit-transform:scale(1)}80%{opacity:1;-webkit-transform:scale(1)}100%{opacity:0;-webkit-transform:scale(.9)}}
.animal-alert-icon{font-size:80px;display:block;margin-bottom:12px;animation:alertIcon 2.2s ease forwards}
@keyframes alertIcon{0%,18%{transform:scale(0)}28%{transform:scale(1.3)}38%{transform:scale(1)}80%{opacity:1}100%{opacity:0}}
.animal-alert-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:5px;margin-bottom:8px;animation:nameSlam 2.2s ease forwards}
.animal-alert-desc{font-family:'Rajdhani',sans-serif;font-size:14px;letter-spacing:1px;color:rgba(255,255,255,.55);line-height:1.4;animation:nameSlam 2.2s .05s ease forwards;opacity:0}

/* â•â•â• SCROLLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:2px}

/* â•â•â• LABELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cards-label{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;padding:0 2px}
.pu-section-title{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:10px}

/* â”€â”€ Turn name glow â”€â”€ */
.turn-name-glow{animation:turnNameGlow 2s ease infinite alternate}
@keyframes turnNameGlow{0%{text-shadow:none}100%{text-shadow:0 0 20px rgba(240,176,64,.4)}}

/* â”€â”€ Zecca flash â”€â”€ */
@keyframes zeckaDmg{0%{background:rgba(180,80,0,0)}30%{background:rgba(180,80,0,.4)}100%{background:rgba(180,80,0,0)}}
.zecca-flash{position:fixed;inset:0;pointer-events:none;z-index:799;animation:zeckaDmg .8s ease forwards}

/* â•â•â• POWER-UP ANIMATION SYSTEM â€” 3D Card Slam â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Preserved exactly, but with enhanced effects per powerup
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.pua-backdrop{position:fixed;inset:0;z-index:790;background:rgba(0,0,0,.65);pointer-events:none;animation:puaBkIn .18s ease both;will-change:opacity;-webkit-transform:translateZ(0)}
@keyframes puaBkIn{from{opacity:0}to{opacity:1}}

.pua-card{
  contain:layout style;will-change:transform,opacity;
  position:fixed;width:228px;height:318px;
  /* Centering via margin instead of transform translate â€” much more stable on iOS/Android */
  left:50%;top:50%;
  margin-left:-114px;margin-top:-159px;
  border-radius:24px;
  z-index:800;overflow:hidden;pointer-events:none;
  animation:cardSlam3d 2.4s cubic-bezier(.22,1,.36,1) forwards;
  transform-style:preserve-3d;
  -webkit-transform-style:preserve-3d;
  backface-visibility:hidden;
  -webkit-backface-visibility:hidden;
  will-change:transform,opacity;
  /* Prevent iOS sub-pixel jitter */
  -webkit-transform:translateZ(0);
}
@keyframes cardSlam3d{
  0%  {transform:perspective(900px) rotateY(-90deg) scale(.4) translateZ(-200px);opacity:0}
  28% {transform:perspective(900px) rotateY(14deg)  scale(1.1) translateZ(40px);opacity:1}
  45% {transform:perspective(900px) rotateY(-7deg)  scale(1.04) translateZ(15px)}
  58% {transform:perspective(900px) rotateY(3deg)   scale(1.02) translateZ(5px)}
  68% {transform:perspective(900px) rotateY(0deg)   scale(1)    translateZ(0)}
  80% {transform:perspective(900px) rotateY(0deg)   scale(1)    translateZ(0);opacity:1}
  100%{transform:perspective(900px) rotateY(90deg)  scale(.5)   translateZ(-150px);opacity:0}
}
@-webkit-keyframes cardSlam3d{
  0%  {-webkit-transform:perspective(900px) rotateY(-90deg) scale(.4) translateZ(-200px);opacity:0}
  28% {-webkit-transform:perspective(900px) rotateY(14deg)  scale(1.1) translateZ(40px);opacity:1}
  45% {-webkit-transform:perspective(900px) rotateY(-7deg)  scale(1.04) translateZ(15px)}
  58% {-webkit-transform:perspective(900px) rotateY(3deg)   scale(1.02) translateZ(5px)}
  68% {-webkit-transform:perspective(900px) rotateY(0deg)   scale(1)    translateZ(0)}
  80% {-webkit-transform:perspective(900px) rotateY(0deg)   scale(1)    translateZ(0);opacity:1}
  100%{-webkit-transform:perspective(900px) rotateY(90deg)  scale(.5)   translateZ(-150px);opacity:0}
}

.pua-card-glow{position:absolute;inset:-30px;border-radius:50px;pointer-events:none;animation:glowIn 2.4s ease forwards}
@keyframes glowIn{0%,22%{opacity:0}38%{opacity:1}78%{opacity:1}100%{opacity:0}}
.pua-card-shine{position:absolute;inset:0;border-radius:24px;pointer-events:none;background:linear-gradient(135deg,rgba(255,255,255,.2) 0%,transparent 40%,rgba(255,255,255,.05) 100%);animation:shineIn 2.4s ease forwards}
@keyframes shineIn{0%,25%{opacity:0}35%{opacity:1}82%,100%{opacity:0}}
.pua-card-border{position:absolute;inset:3px;border-radius:20px;border:1.5px solid rgba(255,255,255,.28);pointer-events:none;z-index:10}
.pua-card-grid{position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(255,255,255,.018) 0,rgba(255,255,255,.018) 1px,transparent 1px,transparent 32px),repeating-linear-gradient(90deg,rgba(255,255,255,.018) 0,rgba(255,255,255,.018) 1px,transparent 1px,transparent 32px);border-radius:24px;pointer-events:none}
.pua-card-art{
  position:absolute;top:18%;
  left:0;right:0;
  display:flex;align-items:center;justify-content:center;
  font-size:100px;z-index:3;pointer-events:none;
  animation:artSlam 2.4s cubic-bezier(.22,1,.36,1) forwards;
  will-change:transform,opacity;
}
@keyframes artSlam{
  0%,22%{opacity:0;transform:scale(.2) translateY(30px)}
  38%{opacity:1;transform:scale(1.2) translateY(-8px)}
  48%{transform:scale(.95) translateY(3px)}
  58%{transform:scale(1) translateY(0)}
  82%{opacity:1;transform:scale(1) translateY(0)}
  100%{opacity:0;transform:scale(.7) translateY(-10px)}
}
.pua-card-ring{
  position:absolute;
  top:50%;left:50%;
  margin-left:-80px;margin-top:-80px;
  width:160px;height:160px;
  border-radius:50%;border:2px solid;
  pointer-events:none;z-index:2;
  animation:ringPulse 2.4s ease forwards;
  will-change:transform,opacity;
}
@keyframes ringPulse{
  0%,26%{opacity:0;transform:scale(.4)}
  38%{opacity:1;transform:scale(1)}
  58%{transform:scale(1.06)}
  72%{transform:scale(1)}
  80%{opacity:.4}
  100%{opacity:0}
}
.pua-card-band{position:absolute;bottom:0;left:0;right:0;padding:14px 14px 18px;background:linear-gradient(180deg,transparent 0%,rgba(0,0,0,.92) 40%,rgba(0,0,0,.99) 100%);border-radius:0 0 24px 24px;z-index:4;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}
.pua-card-name{font-family:'Bebas Neue',sans-serif;font-size:30px;letter-spacing:6px;color:#fff;text-align:center;line-height:1;animation:nameSlam 2.4s ease forwards}
@keyframes nameSlam{0%,35%{opacity:0;transform:translateY(10px)}50%{opacity:1;transform:none}80%{opacity:1}100%{opacity:0}}
.pua-card-subtitle{font-family:'Orbitron',sans-serif;font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.6);text-transform:uppercase;text-align:center;animation:nameSlam 2.4s .04s ease forwards;opacity:0;padding:0 12px;line-height:1.3}
.pua-card-corner{position:absolute;font-size:18px;opacity:.35;line-height:1;z-index:5}
.pua-card-corner.tl{top:10px;left:12px}
.pua-card-corner.br{bottom:88px;right:12px;transform:rotate(180deg)}

/* â”€â”€ Hedgehog spines â”€â”€ */
@keyframes spineShoot3d{0%{transform:translate(-50%,-50%) translate(0,0) scale(0);opacity:1}60%{opacity:1}100%{transform:translate(-50%,-50%) translate(var(--dx),var(--dy)) scale(.4);opacity:0}}
.spine3d{position:fixed;left:50%;top:50%;font-size:24px;pointer-events:none;z-index:810;animation:spineShoot3d .9s .35s ease forwards;opacity:0}

/* â”€â”€ Rat running â”€â”€ */
.cards-section.rat-active::after{content:'ğŸ­';position:absolute;top:calc(50% - 22px);left:-70px;font-size:50px;pointer-events:none;z-index:20;animation:ratOverCards 2.6s linear infinite;filter:drop-shadow(0 0 12px rgba(155,89,182,.9))}

/* â”€â”€ Spider web â”€â”€ */
.spider-web-canvas{position:fixed;inset:0;pointer-events:none;z-index:802;opacity:.75;transition:opacity 1.5s}

/* â”€â”€ Mobile responsive â”€â”€ */
@media(max-width:380px){
  .pu-grid{gap:6px}
  .puc-desc{font-size:10.5px;max-height:68px}
  .puc-art-zone{height:72px}
  .puc-icon{font-size:38px}
}
@media(max-width:320px){
  .pu-grid{grid-template-columns:repeat(3,1fr);gap:4px}
  .puc-desc{font-size:10px}
}
@media(prefers-reduced-motion:reduce){
  *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}
  .hp-card,.game-card,.pu-choice{will-change:auto}
}

/* â”€â”€ Performance contains â”€â”€ */
.hp-strip-wrap{contain:content;will-change:scroll-position}
.cards-grid{contain:layout style}
#log-list{contain:strict}
</style>
</head>
<body>
<div class="scene-bg"></div>
<canvas id="particle-canvas"></canvas>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• HOME / SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-home">
  <div class="home-wrap">
    <div class="logo-hero">
      <span class="logo-fatal">FATAL</span>
      <span class="logo-beast">BEAST</span>
      <div class="logo-tagline">âš” Il gioco della sopravvivenza âš”</div>
    </div>

    <div class="section-card">
      <div class="section-title">Maestro di gioco</div>
      <div class="field">
        <label>Il tuo nome</label>
        <input type="text" id="master-name" placeholder="Nome del Master" maxlength="16">
      </div>
    </div>

    <div class="section-card">
      <div class="section-title">Giocatori</div>
      <div id="players-list"></div>
      <button class="btn-add" onclick="addPlayerField()">ï¼‹ Aggiungi giocatore</button>
    </div>

    <div class="section-card">
      <div class="section-title">Punti vita iniziali</div>
      <input type="number" id="setup-hp" value="300" min="10" max="99999">
    </div>

    <div class="section-card">
      <div class="section-title">ModalitÃ  di gioco</div>
      <div class="mode-row">
        <div class="mode-btn selected" id="mode-classic" onclick="selectMode('classic')">ğŸ´ Classic</div>
        <div class="mode-btn" id="mode-hardcore" onclick="selectMode('hardcore')">ğŸ’€ Hard</div>
        <div class="mode-btn" id="mode-chaos" onclick="selectMode('chaos')">ğŸŒ€ Caos</div>
        <div class="mode-btn" id="mode-test" onclick="selectMode('test')">ğŸ§ª Test</div>
      </div>
      <div id="mode-desc" style="margin-top:10px;font-family:'Rajdhani',sans-serif;font-size:11px;color:var(--muted);line-height:1.5">ğŸ´ Classica: vedi i valori delle carte, scegli il powerup dopo ogni turno.</div>
    </div>

    <button class="btn btn-blood" id="btn-create-game" onclick="createGame()">âš”ï¸ CREA PARTITA</button>
    <button class="btn btn-ghost" onclick="showScreen('screen-join')" style="margin-top:4px">Entra in una stanza</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-join">
  <div class="join-wrap" style="display:flex;flex-direction:column;gap:14px">
    <div class="logo-hero" style="padding:20px 0 6px">
      <span class="logo-fatal" style="font-size:clamp(38px,10vw,60px)">FATAL</span>
      <span class="logo-beast" style="font-size:clamp(38px,10vw,60px)">BEAST</span>
    </div>
    <div class="section-card">
      <div class="field">
        <label>Codice stanza</label>
        <div style="display:flex;gap:8px">
          <input class="pin-big" type="text" id="join-code" placeholder="XXXX" maxlength="4" style="flex:1" oninput="onCodeInput(this.value)">
          <button class="btn btn-ghost btn-sm" onclick="loadRoomNames()" style="flex-shrink:0;padding:14px 16px;font-size:13px">Cerca</button>
        </div>
      </div>
      <div class="field" id="join-name-field" style="display:none">
        <label>Seleziona il tuo nome</label>
        <div id="join-name-list" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </div>
    <button class="btn btn-blood" id="join-btn" onclick="joinGame()" style="display:none">ğŸ® ENTRA</button>
    <button class="btn btn-ghost btn-sm" onclick="showScreen('screen-home')">â† Indietro</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-lobby">
  <div class="lobby-wrap">
    <div style="text-align:center">
      <div style="font-family:'Rajdhani',sans-serif;font-size:11px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:4px">Codice stanza</div>
      <div class="lobby-code" id="room-code-display">----</div>
    </div>
    <div id="qr-container"></div>
    <div class="section-card">
      <div class="section-title">Giocatori connessi</div>
      <div id="waiting-players" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="copyRoomLink()">ğŸ”— Copia link stanza</button>
    <button class="btn btn-blood" id="start-btn" onclick="startGame()" style="display:none">âš”ï¸ AVVIA PARTITA</button>
    <div id="lobby-waiting-msg" style="display:none;font-family:'Rajdhani',sans-serif;font-size:13px;color:var(--muted);text-align:center;padding:8px 0;letter-spacing:1px">â³ In attesa che il Master avvii la partita...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-game">
  <div id="game-wrap" style="width:100%;max-width:520px">

    <!-- Top bar -->
    <div class="game-top">
      <div class="game-logo-sm">
        <div class="fb-skull">â˜ ï¸</div>
        <div id="game-elapsed" style="font-size:9px;color:rgba(255,255,255,.45);font-family:'Rajdhani',sans-serif;letter-spacing:.5px;margin-top:1px">00:00</div>
      </div>
      <div class="turn-info">
        <div class="turn-label" id="turn-label-text">Turno di</div>
        <div class="turn-name" id="turn-name">â€”</div>
      </div>
      <div class="timer-wrap" id="timer-wrap">
        <svg viewBox="0 0 54 54">
          <circle class="timer-bg" cx="27" cy="27" r="22" fill="none" stroke-width="3.5"/>
          <circle class="timer-ring" id="timer-ring" cx="27" cy="27" r="22" fill="none" stroke-width="3.5"
            stroke-dasharray="138.2" stroke-dashoffset="0"/>
        </svg>
        <div id="timer-num">â€”</div>
      </div>
      <div class="pu-browse-btn" onclick="openPuBrowser()" title="Consulta tutti i poteri">ğŸ“–</div>
      <div class="settings-btn" onclick="showSettingsModal()">âš™</div>
    </div>
    <!-- MY TURN bar - visible only when it's the local player's turn -->
    <div class="my-turn-bar" id="my-turn-bar">âš”ï¸ Ãˆ IL TUO TURNO â€” SCEGLI UNA CARTA âš”ï¸</div>
    <div class="dir-bar" id="dir-bar">â†’ SENSO ORARIO</div>

    <!-- HP Strip -->
    <div class="hp-strip-wrap">
      <div class="hp-strip" id="hp-strip"></div>
    </div>

    <!-- Spectator pill -->
    <div class="spectator-pill" id="spectator-pill" style="display:none">ğŸ‘ SPETTATORE</div>
    <!-- Test mode pill -->
    <div class="test-mode-pill" id="test-mode-pill">ğŸ§ª MODALITÃ€ TEST â€” Giochi per tutti i giocatori</div>

    <!-- Active PU banner -->
    <div class="pu-banner" id="pu-banner">
      <div class="pu-banner-icon" id="pu-banner-icon">ğŸ”¥</div>
      <div class="pu-banner-text">
        <div class="pu-banner-title" id="pu-banner-title"></div>
        <div class="pu-banner-desc" id="pu-banner-desc"></div>
      </div>
    </div>

    <!-- Special turn pill (bear/fox/etc) -->
    <div class="special-turn-pill" id="special-turn-pill" style="display:none"></div>

    <!-- Master override -->
    <div class="master-override" id="master-override" style="display:none" onclick="masterPlayForCurrent()">
      <span>âš¡</span><span id="master-override-text">Gioca per...</span>
    </div>

    <!-- Cards section -->
    <div class="cards-section">
      <div class="cards-label" id="cards-label">â³ Attendi il tuo turno</div>
      <div class="cards-grid" id="cards-grid"></div>
    </div>

    <!-- PU choice (slides up after turn) -->
    <div class="pu-section" id="pu-section" style="display:none">
      <div class="pu-section-title">âœ¨ Scegli un potere</div>
      <div class="pu-grid" id="pu-grid"></div>
    </div>
    <div class="confirm-row" id="confirm-row" style="display:none">
      <button class="btn btn-gold" style="flex:1" onclick="confirmPowerup()">âœ“ Conferma</button>
      
    </div>

    <!-- Log -->
    <div class="log-section" style="margin-top:10px">
      <div class="log-header open" id="log-header" onclick="toggleLog()">
        <div class="log-header-title">ğŸ“œ Storico eventi</div>
        <div class="log-header-arrow">â–²</div>
      </div>
      <div id="log-list"></div>
    </div>

  </div><!-- /game-wrap -->
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• GAME OVER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-gameover">
  <div class="gameover-wrap">
    <div class="go-fire">ğŸ”¥</div>
    <div class="go-sub">Vincitore</div>
    <div class="go-winner-name" id="winner-name">â€”</div>
    <div class="stats-grid" id="stats-grid"></div>
    <div class="final-list" id="final-list"></div>
    <div class="section-card" style="width:100%;margin-top:8px">
      <div class="section-title">ğŸ“œ Storico completo della partita</div>
      <div id="final-log" style="max-height:400px;overflow-y:auto;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:rgba(0,0,0,.35)"></div>
    </div>
    <button class="btn btn-blood" onclick="restartGame()" style="margin-top:8px" id="go-restart-btn">ğŸ”„ Rivincita</button>
    <div id="go-waiting-msg" style="display:none;font-family:'Rajdhani',sans-serif;font-size:13px;color:var(--muted);text-align:center;padding:8px 0;letter-spacing:1px">â³ In attesa che il Master riavvii la partita...</div>
    <button class="btn btn-ghost btn-sm" onclick="goHome()">â† Home</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• OVERLAYS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- QR Code overlay (in-game) -->
<div class="overlay" id="overlay-qr">
  <div class="modal" style="text-align:center;max-width:320px">
    <div class="modal-title">ğŸ“· CODICE STANZA</div>
    <div class="lobby-code" id="qr-overlay-code" style="margin-bottom:12px">----</div>
    <div id="qr-overlay-container" style="display:flex;justify-content:center;padding:12px;background:#fff;border-radius:10px;width:fit-content;margin:0 auto 16px"></div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:12px;color:var(--muted);letter-spacing:1px;margin-bottom:12px">Inquadra per accedere alla partita</div>
    <button class="btn btn-ghost btn-sm" onclick="copyRoomLink();toast('ğŸ”— Link copiato!')">ğŸ”— Copia Link</button>
    <button class="modal-close" onclick="closeOverlay('overlay-qr')">Chiudi</button>
  </div>
</div>

<!-- Reveal -->
<div class="overlay" id="overlay-reveal">
  <div class="modal reveal-card">
    <div class="reveal-animal" id="reveal-icon">âš”ï¸</div>
    <div class="reveal-title" id="reveal-title"></div>
    <div class="reveal-desc" id="reveal-desc"></div>
    <div class="reveal-dmg" id="reveal-dmg"></div>
    <button class="btn btn-blood" style="margin-top:16px" onclick="closeReveal()">OK !</button>
  </div>
</div>

<!-- Settings -->
<div class="overlay" id="overlay-settings">
  <div class="modal">
    <div class="modal-title">âš™ IMPOSTAZIONI</div>
    <div id="settings-content"></div>
    <button class="modal-close" onclick="closeOverlay('overlay-settings')">Chiudi</button>
  </div>
</div>

<!-- PU manager -->
<div class="overlay" id="overlay-pu-manager">
  <div class="modal">
    <div class="modal-title">ğŸ¾ GESTIONE POTERI</div>
    <div id="pu-manager-list"></div>
    <button class="modal-close" onclick="closeOverlay('overlay-pu-manager')">Chiudi</button>
  </div>
</div>

<!-- PU Browser (new!) -->
<div class="overlay" id="overlay-pu-browser">
  <div class="modal" style="max-width:480px;max-height:88vh;overflow-y:auto">
    <div class="modal-title" id="pu-browser-title">ğŸ“– TUTTI I POTERI</div>
    <div style="font-family:'Rajdhani',sans-serif;font-size:11px;letter-spacing:1px;color:var(--muted);margin-bottom:10px;text-align:center" id="pu-browser-mode-note"></div>
    <div id="pu-browser-list"></div>
    <button class="modal-close" onclick="closeOverlay('overlay-pu-browser')">Chiudi</button>
  </div>
</div>

<!-- Restart -->
<div class="overlay" id="overlay-restart">
  <div class="modal">
    <div class="modal-title">ğŸ”„ NUOVA PARTITA</div>
    <div class="field"><label>HP iniziali</label><input id="restart-hp" type="number" value="1000" min="10" max="99999"></div>
    <button class="btn btn-blood btn-sm" onclick="doRestart()" style="width:100%;margin-bottom:8px">Riavvia</button>
    <button class="modal-close" onclick="closeOverlay('overlay-restart')">Annulla</button>
  </div>
</div>

<!-- History removed per v7 -->


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FATALBEAST v7 â€” Full Engine with 40 Powerups
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const G = {
  roomId:null,playerId:null,playerName:null,
  isMaster:false,isSpectator:false,gameMode:'classic',isTestMode:false,
  pendingConfirm:false,puEnabled:{},
  _cardPickedOnTurn:-1,
  unsubscribes:[],
  sessionStats:{dmgDealt:0,dmgReceived:0,highCard:0,turnsPlayed:0,puUsed:0},
  masterOverrideActive:false,masterOverridePid:null,
  bearMode:false,bearCardsChosen:0,bearFirstTarget:null,bearFirstCardId:null,

  dogMode:false,dogPuCount:0,
  timerTO:null,timerActive:false,timerSec:0,
  selectedPU:null,
  _shownAnims:{},
  _gameoverShown:false,
  _logOpen:true,
  _logForcedHide:false,
};

// â”€â”€ MODE BANS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MODE_BANS = {
  classic: [],
  hardcore: ['rat','donkey','cheetah','fox'],
  chaos: ['rat','owl','wolf','weasel','donkey','cheetah','ladybug','fox','blacksheep'],
};

// â”€â”€ Power-up definitions (63 total) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const POWERUPS = [
  // === ORIGINAL 24 ===
  {id:'eagle',    icon:'ğŸ¦…', name:'Aquila',     timing:'before',
   desc:'Nel tuo prossimo turno puoi vedere il nome di 1 giocatore su una carta. L\'effetto termina alla fine del tuo prossimo turno o se vieni eliminato prima.'},
  {id:'bull',     icon:'ğŸ‚', name:'Toro',       timing:'after',
   desc:'Raddoppia il danno della prossima carta scelta dal giocatore successivo.'},
  {id:'hedgehog', icon:'ğŸ¦”', name:'Riccio',     timing:'after',
   desc:'La prossima carta scelta dal giocatore successivo infligge danni a tutti.'},
  {id:'rat',      icon:'ğŸ­', name:'Topo',       timing:'before',
   desc:'Carte coperte per tutti gli altri fino al tuo prossimo turno.'},
  {id:'kangaroo', icon:'ğŸ¦˜', name:'Canguro',    timing:'before',
   desc:'Il giocatore successivo salta il turno. Se il turno viene saltato, gli effetti "prossimo giocatore" slittano al successivo vivo.'},
  {id:'turtle',   icon:'ğŸ¢', name:'Tartaruga',  timing:'after',
   desc:'Il danno della prossima carta scelta dal prossimo giocatore viene dimezzato (arrotondato per eccesso).'},
  {id:'koala',    icon:'ğŸ¨', name:'Koala',      timing:'after',
   desc:'La prossima carta scelta dal prossimo giocatore cura invece di infliggere danni.'},
  {id:'cheetah',  icon:'ğŸ†', name:'Ghepardo',   timing:'before',
   desc:'12 secondi per scegliere carta e potere. Scaduto â†’ turno saltato.'},
  {id:'bear',     icon:'ğŸ»', name:'Orso',       timing:'before',
   desc:'Il giocatore successivo DEVE scegliere 2 carte diverse.'},
  {id:'owl',      icon:'ğŸ¦‰', name:'Gufo',       timing:'before',
   desc:'Il prossimo giocatore non puÃ² attivare power-up.'},
  {id:'chameleon',icon:'ğŸ¦', name:'Camaleonte', timing:'before',
   desc:'I tuoi punti vita diventano uguali a quelli del giocatore con piÃ¹ HP. Effetto immediato.'},
  {id:'armadillo',icon:'ğŸ¦¡', name:'Tasso',  timing:'after',
   desc:'La prossima carta scelta dal prossimo giocatore infliggerÃ  danni anche a se stesso.'},
  {id:'crocodile',icon:'ğŸŠ', name:'Coccodrillo',timing:'before',
   desc:'Il prossimo giocatore non puÃ² colpirti.'},
  {id:'bug',      icon:'ğŸ', name:'Ape',     timing:'before',
   desc:'Annulla e riflette il prossimo danno ricevuto.'},

  {id:'shark',    icon:'ğŸ¦ˆ', name:'Squalo',     timing:'before',
   desc:'Elimina tutti i giocatori con HP < 15% degli HP iniziali.'},
  {id:'deer',     icon:'ğŸ¦Œ', name:'Cervo',      timing:'after',
   desc:'Dopo la scelta della carta del prossimo giocatore ne verrÃ  scelta un\'altra a caso tra le rimanenti che infliggerÃ  danni a tutti.'},
  {id:'tick',     icon:'ğŸœ', name:'Formica',      timing:'before',
   desc:'Carta extra con valore variabile. Infligge danno automatico ogni turno finchÃ© non viene scelta.'},
  {id:'rhino',    icon:'ğŸ¦', name:'Rinoceronte',timing:'before',
   desc:'Somma gli HP di tutti i giocatori vivi e dividi per il numero di giocatori vivi (arrotondato per eccesso). Infliggi quel danno a un giocatore casuale. Effetto istantaneo.'},
  {id:'fly',       icon:'ğŸª°', name:'Mosca',              timing:'before',
   desc:'Sceglie un bersaglio casuale: aggiunge ogni turno una carta ğŸª° nel pool. Il bersaglio subisce quei danni ogni turno. Chiunque scelga la carta ğŸª° interrompe l\'effetto.'},
  {id:'butterfly',icon:'ğŸ¦‹', name:'Farfalla',   timing:'after',
   desc:'Aggiungi una carta extra a tutti gli altri giocatori e ogni volta che viene scelta guadagni punti vita pari a quel valore.'},
  {id:'viper',    icon:'ğŸ', name:'Vipera',     timing:'after',
   desc:'Carta trappola: se scelta, eliminazione immediata.'},
  {id:'spider',   icon:'ğŸ•·ï¸', name:'Ragno',      timing:'before',
   desc:'Tutti i giocatori subiscono un danno pari alla metÃ  degli HP del giocatore con meno vita (arrotondato per eccesso). Effetto istantaneo.'},
  {id:'ram',      icon:'ğŸ', name:'Ariete',     timing:'after',
   desc:'Il danno della prossima carta scelta dal giocatore successivo si propagherÃ  anche sui giocatori adiacenti.'},
  {id:'donkey',   icon:'ğŸ«', name:'Asino',      timing:'after',
   desc:'Dopo la scelta della carta del prossimo giocatore inverti i valori tra quella piÃ¹ alta e quella piÃ¹ bassa.'},
  // === NEW 16 ===
  {id:'mosquito', icon:'ğŸ¦Ÿ', name:'Zanzara',    timing:'before',
   desc:'Infliggi un danno casuale (1-100) a un giocatore casuale e recuperi gli stessi HP. Effetto immediato.'},

  {id:'scorpion', icon:'ğŸ¦‚', name:'Scorpione',  timing:'before',
   desc:'Aggiungi una carta extra a tutti gli altri giocatori. Quando viene scelta infligge 100 danni al giocatore che la ha scelta.'},
  {id:'peacock',  icon:'ğŸ¦š', name:'Pavone',     timing:'before',
   desc:'I punti vita di tutti i giocatori vivi vengono randomizzati tra 1 e gli HP iniziali.'},
  {id:'zebra',    icon:'ğŸ¦“', name:'Zebra',      timing:'after',
   desc:'Duplica la carta del giocatore successivo.'},
  {id:'scarab',   icon:'ğŸª²', name:'Scarabeo',   timing:'after',
   desc:'Carta extra al prossimo giocatore: se scelta, perde metÃ  HP.'},
  {id:'swordfish',icon:'ğŸ¡', name:'Pesce Palla',timing:'after',
   desc:'Il danno colpisce anche i 2 giocatori successivi al bersaglio.'},
  {id:'wolf',     icon:'ğŸº', name:'Lupo',       timing:'before',
   desc:'Nessuno puÃ² attivare powerup per un giro completo.'},
  {id:'ostrich',  icon:'ğŸ¦¤', name:'Dodo',    timing:'before',
   desc:'L\'ultima carta a destra Ã¨ bloccata per tutti fino al tuo prossimo turno.'},

  {id:'lion',     icon:'ğŸ¦', name:'Leone',      timing:'before',
   desc:'Infligge a un giocatore casuale un danno tra 1 e gli HP attuali del giocatore con vita piÃ¹ alta. Effetto istantaneo.'},

  {id:'dog',      icon:'ğŸ•', name:'Cane',       timing:'before',
   desc:'Attiva immediatamente gli altri 2 powerup della lista (tutti e 3 si attivano).'},
  {id:'weasel',   icon:'ğŸ¦¦', name:'Donnola',    timing:'before',
   desc:'Gli altri giocatori scelgono tra 2 powerup (invece di 3) fino al tuo prossimo turno.'},
  {id:'frog',     icon:'ğŸ¸', name:'Rana',       timing:'after',
   desc:'Il prossimo giocatore scambia i suoi HP con quelli del bersaglio (nessun danno).'},

  // === 17 NUOVI POWERUP ===
  {id:'pigeon',    icon:'ğŸ•Šï¸', name:'Piccione',       timing:'before',
   desc:'Una carta casuale per ogni avversario Ã¨ bloccata fino al tuo prossimo turno.'},
  {id:'elephant',  icon:'ğŸ˜', name:'Elefante',        timing:'after',
   desc:'Infliggi ad un giocatore casuale un danno pari alla somma delle carte che non hai scelto.'},
  {id:'jaguar',    icon:'ğŸˆâ€â¬›',name:'Gatto',         timing:'before',
   desc:'Il prossimo danno che ricevi viene riflesso su un giocatore casuale. Effetto nascosto.'},
  {id:'crab',      icon:'ğŸ¦€', name:'Granchio',        timing:'before',
   desc:'3 giocatori casuali subiscono 3 danni casuali (1-100). Effetto immediato.'},
  {id:'bat',       icon:'ğŸ¦‡', name:'Pipistrello',     timing:'before',
   desc:'Guadagni HP pari al giocatore con meno vita (incluso te stesso). Effetto immediato.'},
  {id:'horse',     icon:'ğŸ´', name:'Cavallo',         timing:'before',
   desc:'Le carte con valore pari infliggono il doppio dei danni per 1 turno completo.'},
  {id:'squirrel',  icon:'ğŸ¿ï¸', name:'Scoiattolo',      timing:'before',
   desc:'Riassegna gli HP di tutti i giocatori vivi in modo casuale. Immediato.'},
  {id:'walrus',    icon:'ğŸ¦­', name:'Foca',        timing:'before',
   desc:'Tutti gli avversari ricevono una carta extra: se scelta, subiscono la somma di tutte le loro carte normali.'},
  {id:'hyena',     icon:'ğŸ“', name:'Gallo',            timing:'before',
   desc:'Tutti i giocatori vivi subiscono un danno casuale (1-100) separato in ordine fisso di turno. Istantaneo. Bypassa Anatra. Soggetto a Coccodrillo, Ape, Gatto, Tasso. Non interagisce con il Pappagallo.'},
  {id:'giraffe',   icon:'ğŸ¦’', name:'Giraffa',         timing:'before',
   desc:'Il giocatore con piÃ¹ HP perde metÃ  HP; quella quota viene distribuita a tutti gli altri. Immediato.'},



  {id:'duck',      icon:'ğŸ¦†', name:'Anatra',          timing:'before',
   desc:'La prossima carta del giocatore successivo applica danni a lui stesso. Effetto nascosto.'},
  {id:'tiger',     icon:'ğŸ¯', name:'Tigre',           timing:'before',
   desc:'Un giocatore casuale subisce la differenza in valore assoluto tra i tuoi HP e i suoi. Immediato.'},
  {id:'mantis',    icon:'ğŸ¦—', name:'Mantide',         timing:'before',
   desc:'Un giocatore casuale vivo perde metÃ  dei suoi HP. Immediato.'},
  {id:'monkey',    icon:'ğŸ’', name:'Scimmia',         timing:'after',
   desc:'Guadagni HP pari alla somma delle carte che NON hai scelto.'},

  // === 9 NUOVISSIMI POWERUP ===
  {id:'orca',       icon:'ğŸ‹', name:'Balena',            timing:'before',
   desc:'Infliggi danni casuali (1-100) al primo giocatore vivo prima e dopo di te. Effetto immediato.'},
  {id:'gorilla',    icon:'ğŸ¦', name:'Gorilla',          timing:'before',
   desc:'Infliggi esattamente 100 HP di danno a un giocatore casuale. Effetto immediato.'},
  {id:'parrot',     icon:'ğŸ¦œ', name:'Pappagallo',       timing:'before',
   desc:'Fino al tuo prossimo turno, i danni delle carte diventano cure (solo carte, non effetti istantanei). Segreto/nascosto fino alla prima carta scelta. Non possono coesistere 2 Pappagalli. Si disattiva al tuo prossimo turno o se vieni eliminato.'},
  {id:'ladybug',    icon:'ğŸ', name:'Coccinella',       timing:'before',
   desc:'Fino al tuo prossimo turno, tutti i powerup sono mostrati coperti durante la scelta. Non usabile in Caos.'},
  {id:'snail',      icon:'ğŸŒ', name:'Lumaca',           timing:'before',
   desc:'Un giocatore casuale subisce danni pari all\'ora attuale + i minuti (es: 7:03 â†’ 7+3 = 10 danni). Effetto immediato.'},
  {id:'pig',        icon:'ğŸ·', name:'Maiale',           timing:'after',
   desc:'La prossima carta scelta dal giocatore successivo vale 0. Effetto nascosto, si disattiva dopo.'},
  {id:'camel',      icon:'ğŸª', name:'Cammello',         timing:'after',
   desc:'La prossima carta scelta dal giocatore successivo cura tutti gli altri vivi. Effetto nascosto.'},
  {id:'fox',        icon:'ğŸ¦Š', name:'Volpe',            timing:'after',
   desc:'La prossima carta scelta dal giocatore successivo ha valore casuale (0-100). Nascosta. Non in Hardcore/Caos.'},
  {id:'blacksheep', icon:'ğŸ‘', name:'Pecora',      timing:'before',
   desc:'Il prossimo giocatore non sceglie il powerup: il gioco ne sceglie uno casuale. Non in Caos.'},
  {id:'panda',      icon:'ğŸ¼', name:'Panda',             timing:'before',
   desc:'Annulla il prossimo danno ricevuto e ti cura di quel valore. Effetto segreto, si rivela al fuoco.'},

  // === NUOVISSIMI ===
  {id:'rabbit',     icon:'ğŸ‡', name:'Coniglio',          timing:'before',
   desc:'Imposta i punti vita di tutti i giocatori vivi uguali ai tuoi. Effetto immediato.'},
  {id:'medusa',     icon:'ğŸ™', name:'Piovra',             timing:'before',
   desc:'Fino al tuo prossimo turno le carte pari infliggono il doppio dei danni, quelle dispari la metÃ  (arrotondato per eccesso). Non possono coesistere 2 Meduse. Si disattiva al tuo prossimo turno o se vieni eliminato.'},
  {id:'skunk',      icon:'ğŸ¦¨', name:'Puzzola',            timing:'before',
   desc:'Aggiunge una carta Puzzola a tutti i giocatori. Se scelta con HP > metÃ  degli HP iniziali: danno doppio. Se HP â‰¤ metÃ : cura. Segreto fino alla rivelazione. Non possono coesistere 2 Puzzole. Scade al tuo prossimo turno.'},
];
POWERUPS.forEach(p => G.puEnabled[p.id] = true);

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _ac=null;
function getAC(){if(!_ac)_ac=new(window.AudioContext||window.webkitAudioContext)();return _ac;}
function resumeAC(){try{const a=getAC();if(a.state==='suspended')a.resume();}catch(e){}}
function playSound(type){
  try{
    resumeAC();const ac=getAC(),t=ac.currentTime;
    const M={
      hit:  [[200,.3,.22,'sawtooth'],[100,.2,.17,'sawtooth']],
      crit: [[440,.5,.3,'sawtooth'],[220,.35,.5,'square'],[55,.2,.6,'sawtooth']],
      heal: [[523,.2,.3,'sine'],[659,.15,.35,'sine'],[784,.1,.4,'sine']],
      elim: [[180,.45,.5,'sawtooth'],[110,.3,.7,'square'],[70,.2,.9,'square']],
      flip: [[440,.12,.09,'triangle'],[330,.08,.07,'triangle']],
      pu:   [[523,.18,.2,'triangle'],[659,.14,.26,'triangle'],[784,.1,.32,'triangle'],[1047,.07,.38,'triangle']],
      win:  [[523,.3,.5,'sine'],[659,.25,.6,'sine'],[784,.2,.7,'sine'],[880,.15,.85,'sine'],[1047,.1,1.1,'sine']],
      tick: [[880,.15,.12,'square'],[440,.1,.18,'square']],
      zecca:[[180,.3,.4,'sawtooth'],[90,.2,.6,'sawtooth']],
      lion: [[150,.35,.3,'sawtooth'],[200,.3,.5,'sawtooth'],[80,.25,.7,'square']],
    };
    (M[type]||M.flip).forEach(([f,g,d,tp],i)=>{
      const o=ac.createOscillator(),gn=ac.createGain();
      o.type=tp;o.frequency.setValueAtTime(f,t+i*.04);
      gn.gain.setValueAtTime(g,t+i*.04);gn.gain.exponentialRampToValueAtTime(.001,t+i*.04+d);
      o.connect(gn);gn.connect(ac.destination);o.start(t+i*.04);o.stop(t+i*.04+d+.01);
    });
  }catch(e){}
}
function vibrate(p){try{navigator.vibrate(p)}catch(e){}}

(function(){
  const cv=document.getElementById('particle-canvas');if(!cv)return;
  const ctx=cv.getContext('2d',{alpha:true});let W,H,pts=[];
  const isMobile='ontouchstart' in window||innerWidth<768;
  const MAX_PTS=isMobile?8:15;
  let _animActive=true;
  window._stopParticles=()=>{_animActive=false;};
  window._startParticles=()=>{if(!_animActive){_animActive=true;draw(0);}};
  function resize(){const dpr=Math.min(window.devicePixelRatio||1,2);W=innerWidth;H=innerHeight;cv.width=W*dpr;cv.height=H*dpr;ctx.setTransform(dpr,0,0,dpr,0,0);}
  resize();let _resizeTimer;window.addEventListener('resize',()=>{clearTimeout(_resizeTimer);_resizeTimer=setTimeout(resize,200);});
  function mk(){return{x:Math.random()*W,y:H+10,r:Math.random()*2+.5,vx:(Math.random()-.5)*.3,vy:-(Math.random()*.7+.2),life:1,decay:Math.random()*.003+.001,col:`hsl(${Math.random()<.5?'4,100%':'38,100%'},${30+Math.random()*30}%)`};}
  for(let i=0;i<Math.min(MAX_PTS,8);i++)pts.push({...mk(),y:Math.random()*H});
  let lastTime=0;
  function draw(now){
    if(!_animActive){ctx.clearRect(0,0,W,H);return;}
    // Throttle to ~24fps on mobile for battery
    if(isMobile&&now-lastTime<42){requestAnimationFrame(draw);return;}
    lastTime=now;
    ctx.clearRect(0,0,W,H);if(pts.length<MAX_PTS)pts.push(mk());
    pts=pts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;if(p.life<=0)return false;
      ctx.save();ctx.globalAlpha=p.life*.4;ctx.fillStyle=p.col;ctx.shadowBlur=8;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();return true;});
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();

// â•â• ANIMATION SYSTEM v2 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PU_THEMES = {
  eagle:    {bg:'linear-gradient(160deg,#060e22,#0e2a5a,#1a4a9e)',glow:'#4fa3f7',accent:'#a8d4ff'},
  bull:     {bg:'linear-gradient(160deg,#1a0505,#600e0e,#b02020)',glow:'#ff4444',accent:'#ff9999'},
  hedgehog: {bg:'linear-gradient(160deg,#2d1200,#7a3300,#c05800)',glow:'#ff8c00',accent:'#ffb347'},
  rat:      {bg:'linear-gradient(160deg,#16122a,#2a2050,#4a3890)',glow:'#9b59b6',accent:'#c39bd3'},
  kangaroo: {bg:'linear-gradient(160deg,#261500,#5a3500,#9a6000)',glow:'#f0b040',accent:'#ffd580'},
  turtle:   {bg:'linear-gradient(160deg,#08200f,#155a2a,#1e8449)',glow:'#27ae60',accent:'#82e0aa'},
  koala:    {bg:'linear-gradient(160deg,#101a10,#224422,#2d6b2d)',glow:'#58d68d',accent:'#d5f5d5'},
  cheetah:  {bg:'linear-gradient(160deg,#221100,#5a3000,#c47000)',glow:'#f4d03f',accent:'#ffe082'},
  bear:     {bg:'linear-gradient(160deg,#1a0500,#4a1200,#8a2a00)',glow:'#e05020',accent:'#f0a080'},
  owl:      {bg:'linear-gradient(160deg,#08080f,#14143a,#201860)',glow:'#7c3aed',accent:'#c4b5fd'},
  chameleon:{bg:'linear-gradient(160deg,#00200e,#005a28,#009940)',glow:'#00e676',accent:'#69f0ae'},
  armadillo:{bg:'linear-gradient(160deg,#181000,#403000,#806000)',glow:'#d4af37',accent:'#fce38a'},
  crocodile:{bg:'linear-gradient(160deg,#041200,#0e3a00,#1a6600)',glow:'#4caf50',accent:'#a5d6a7'},
  bug:      {bg:'linear-gradient(160deg,#1e1400,#4a3200,#806000)',glow:'#cda800',accent:'#f5e642'},
  shark:    {bg:'linear-gradient(160deg,#001426,#002a52,#004080)',glow:'#0984e3',accent:'#74b9ff'},
  deer:     {bg:'linear-gradient(160deg,#180a00,#3e2000,#7a4400)',glow:'#c89030',accent:'#f0c060'},
  tick:     {bg:'linear-gradient(160deg,#0a1200,#203000,#3a5800)',glow:'#8bc34a',accent:'#c5e1a5'},
  rhino:    {bg:'linear-gradient(160deg,#0c0c0c,#1e1e1e,#2e2e2e)',glow:'#9e9e9e',accent:'#e0e0e0'},
  butterfly:{bg:'linear-gradient(160deg,#1a0028,#3d0068,#7800c0)',glow:'#d500f9',accent:'#ea80fc'},
  fly:      {bg:'linear-gradient(160deg,#1a1200,#3d2e00,#7a5a00)',glow:'#c8a200',accent:'#ffe066'},
  viper:    {bg:'linear-gradient(160deg,#001800,#003800,#007200)',glow:'#00e000',accent:'#a0ff80'},
  spider:   {bg:'linear-gradient(160deg,#080808,#100018,#1e0030)',glow:'#9c27b0',accent:'#e040fb'},
  ram:      {bg:'linear-gradient(160deg,#1e0000,#500000,#960000)',glow:'#f44336',accent:'#ef9a9a'},
  donkey:   {bg:'linear-gradient(160deg,#1a1200,#3e2c00,#706000)',glow:'#c8a000',accent:'#f5d500'},
  // NEW 16
  mosquito: {bg:'linear-gradient(160deg,#0a0018,#200040,#400080)',glow:'#bb86fc',accent:'#e1bee7'},
  scorpion: {bg:'linear-gradient(160deg,#1a0a00,#4a2000,#803800)',glow:'#ff6f00',accent:'#ffab40'},
  peacock:  {bg:'linear-gradient(160deg,#001830,#003060,#0060a0)',glow:'#00bcd4',accent:'#84ffff'},
  zebra:    {bg:'linear-gradient(160deg,#0a0a0a,#222222,#444444)',glow:'#e0e0e0',accent:'#ffffff'},
  scarab:   {bg:'linear-gradient(160deg,#0a1400,#1e3800,#306000)',glow:'#76ff03',accent:'#ccff90'},
  swordfish:{bg:'linear-gradient(160deg,#001028,#002858,#004888)',glow:'#2196f3',accent:'#90caf9'},
  pigeon:{bg:'linear-gradient(160deg,#1a1a2e,#2d2d44)',glow:'#aaa',accent:'#ddd'},
  elephant:{bg:'linear-gradient(160deg,#1a0a2e,#2d1a44)',glow:'#9c27b0',accent:'#e1bee7'},
  jaguar:{bg:'linear-gradient(160deg,#1a1000,#3d2800)',glow:'#ff9800',accent:'#ffe082'},
  crab:{bg:'linear-gradient(160deg,#200000,#500000)',glow:'#f44336',accent:'#ffcdd2'},
  bat:{bg:'linear-gradient(160deg,#0d0d1a,#1a1a33)',glow:'#7c4dff',accent:'#b39ddb'},
  horse:{bg:'linear-gradient(160deg,#1a0800,#3d1c00)',glow:'#ff6d00',accent:'#ffe0b2'},
  squirrel:{bg:'linear-gradient(160deg,#0d1a0d,#1a3300)',glow:'#43a047',accent:'#a5d6a7'},
  walrus:{bg:'linear-gradient(160deg,#001a2e,#003d5c)',glow:'#00acc1',accent:'#b2ebf2'},
  hyena:{bg:'linear-gradient(160deg,#1a0a00,#4a2400,#804000)',glow:'#ff8c00',accent:'#ffd580'},
  giraffe:{bg:'linear-gradient(160deg,#1a0f00,#3d2400)',glow:'#ffa000',accent:'#ffecb3'},
  duck:{bg:'linear-gradient(160deg,#1a1500,#3d3200)',glow:'#f9a825',accent:'#fff9c4'},
  tiger:{bg:'linear-gradient(160deg,#1a0700,#3d1700)',glow:'#e64a19',accent:'#ffccbc'},
  mantis:{bg:'linear-gradient(160deg,#0d1a00,#1a3300)',glow:'#33691e',accent:'#dcedc8'},
  monkey:{bg:'linear-gradient(160deg,#1a0f00,#3d2400)',glow:'#795548',accent:'#d7ccc8'},
  wolf:     {bg:'linear-gradient(160deg,#100808,#301818,#502828)',glow:'#b71c1c',accent:'#ef5350'},
  ostrich:  {bg:'linear-gradient(160deg,#181208,#3a2e18,#5c4a28)',glow:'#d4a040',accent:'#ffe0a0'},
  lion:     {bg:'linear-gradient(160deg,#1a1000,#4a3000,#805000)',glow:'#ff9800',accent:'#ffe0b2'},
  dog:      {bg:'linear-gradient(160deg,#1a0c00,#3e2800,#6a4400)',glow:'#ff8f00',accent:'#ffc46b'},
  weasel:   {bg:'linear-gradient(160deg,#0c1000,#1e2c00,#344c00)',glow:'#aeea00',accent:'#f4ff81'},
  frog:     {bg:'linear-gradient(160deg,#001a0a,#003a18,#005a28)',glow:'#00c853',accent:'#69f0ae'},
  // NEW 9
  orca:     {bg:'linear-gradient(160deg,#001428,#002a50,#004880)',glow:'#29b6f6',accent:'#80d8ff'},
  gorilla:  {bg:'linear-gradient(160deg,#080810,#181828,#282840)',glow:'#7986cb',accent:'#c5cae9'},
  parrot:   {bg:'linear-gradient(160deg,#1a0028,#3d0058,#6a0090)',glow:'#e040fb',accent:'#ea80fc'},
  rabbit:   {bg:'linear-gradient(160deg,#0a1f00,#1a4a00,#2e7a00)',glow:'#69f0ae',accent:'#b9f6ca'},
  medusa:   {bg:'linear-gradient(160deg,#000828,#001855,#002a8e)',glow:'#40c4ff',accent:'#b3e5fc'},
  skunk:    {bg:'linear-gradient(160deg,#0e0e0e,#1a1a2e,#16213e)',glow:'#e0e0e0',accent:'#ffffff'},
  ladybug:  {bg:'linear-gradient(160deg,#280000,#580000,#920000)',glow:'#ef5350',accent:'#ffcdd2'},
  snail:    {bg:'linear-gradient(160deg,#1a1200,#3a2800,#5c3e00)',glow:'#8d6e63',accent:'#d7ccc8'},
  pig:      {bg:'linear-gradient(160deg,#280010,#500028,#800040)',glow:'#f48fb1',accent:'#fce4ec'},
  camel:    {bg:'linear-gradient(160deg,#1a1000,#3d2800,#664200)',glow:'#ffb74d',accent:'#fff3e0'},
  fox:      {bg:'linear-gradient(160deg,#280800,#581a00,#902a00)',glow:'#ff8f00',accent:'#ffecb3'},
  blacksheep:{bg:'linear-gradient(160deg,#0a0a0a,#1a1a1a,#2a2a2a)',glow:'#bdbdbd',accent:'#fafafa'},
  panda:    {bg:'linear-gradient(160deg,#0a0a0a,#1e1e1e,#2a2a2a)',glow:'#e0e0e0',accent:'#ffffff'},
};

function triggerAnim(id, opts={}) {
  const theme = PU_THEMES[id];
  const def = POWERUPS.find(p=>p.id===id);
  if(!theme || !def) return;
  const bd = document.createElement('div');
  bd.className = 'pua-backdrop';
  document.body.appendChild(bd);
  const card = document.createElement('div');
  card.className = 'pua-card';
  card.style.cssText = `background:${theme.bg};box-shadow:0 0 100px ${theme.glow}80,0 30px 80px rgba(0,0,0,.9),inset 0 1px 0 rgba(255,255,255,.18);border:2px solid ${theme.glow}70;`;
  const subtitle = opts.subtitle || '';
  card.innerHTML = `
    <div class="pua-card-glow" style="background:radial-gradient(ellipse 140% 120% at 50% 35%,${theme.glow}55 0%,transparent 65%)"></div>
    <div class="pua-card-grid"></div>
    <div class="pua-card-ring" style="border-color:${theme.glow}50;box-shadow:0 0 20px ${theme.glow}40"></div>
    <div class="pua-card-art" style="filter:drop-shadow(0 0 28px ${theme.glow}) drop-shadow(0 0 60px ${theme.glow}60)">${def.icon}</div>
    <div class="pua-card-band">
      <div class="pua-card-name" style="color:${theme.accent};text-shadow:0 0 24px ${theme.glow},0 0 48px ${theme.glow}80">${def.name.toUpperCase()}</div>
      ${subtitle?`<div class="pua-card-subtitle">${subtitle}</div>`:''}
    </div>
    <div class="pua-card-corner tl" style="color:${theme.accent}">${def.icon}</div>
    <div class="pua-card-corner br" style="color:${theme.accent}">${def.icon}</div>
    <div class="pua-card-border" style="border-color:${theme.glow}40"></div>
    <div class="pua-card-shine"></div>`;
  document.body.appendChild(card);
  if(window._stopParticles) window._stopParticles();
  spawnPuBurst(theme.glow, theme.accent, id);
  flashPu(theme.glow);
  if(id==='hedgehog') spawnHedgehogSpines();
  if(id==='spider') setTimeout(()=>drawSpiderWebCanvas(), 350);
  setTimeout(()=>{
    bd.style.transition='opacity .5s';bd.style.opacity='0';
    setTimeout(()=>{try{bd.remove();card.remove();}catch(e){}if(window._startParticles)window._startParticles();},550);
  },1900);
}

// â•â• UNIQUE PER-POWERUP CANVAS EFFECTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnPuBurst(color1, color2, id) {
  const cv = document.createElement('canvas');
  cv.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:801';
  // Use visualViewport for accurate dims on iOS (handles notch/safe-area)
  const vvw = window.visualViewport ? window.visualViewport.width  : window.innerWidth;
  const vvh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  const dpr=Math.min(window.devicePixelRatio||1,2);
  cv.width = vvw*dpr; cv.height = vvh*dpr;
  document.body.appendChild(cv);
  const ctx = cv.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.imageSmoothingEnabled=false;
  const cx = vvw/2, cy = vvh/2;
  const mob='ontouchstart' in window;
  // PERF: cap shadowBlur on mobile (most expensive canvas op)
  if(mob){const _oSB=Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype,'shadowBlur');if(_oSB){Object.defineProperty(ctx,'shadowBlur',{get(){return _oSB.get.call(this)},set(v){_oSB.set.call(this,v>0?Math.min(v*0.3,8):0)}});}}
  const R=160; // card exclusion radius - particles start OUTSIDE this
  const cvSafe=setTimeout(()=>{try{cv.remove();}catch(e){}},4000);
  const done=()=>{clearTimeout(cvSafe);try{cv.remove();}catch(e){}};
  // Helper: point on card perimeter
  const rim=(a,dr=0)=>({x:cx+Math.cos(a)*(R+dr),y:cy+Math.sin(a)*(R+dr)});
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const c1=color1,c2=color2;

  const fx = {

// 1. EAGLE â€” Feathers stream from top rim, arc down like falling feathers
eagle:()=>{
  const pts=[];const n=mob?40:80;
  for(let i=0;i<n;i++){const a=-Math.PI*.5+(rnd(-.8,.8));const p=rim(a,rnd(0,30));pts.push({x:p.x,y:p.y,vx:rnd(-4,4),vy:-(rnd(4,14)),r:rnd(1.5,4),life:1,decay:rnd(.012,.022),col:i%3===0?c1:i%3===1?c2:'#fff',rot:rnd(0,Math.PI*2),rs:rnd(-.1,.1)});}
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // sweeping glow behind each feather
    pts.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.vx+=Math.sin(f*.05+p.x*.008)*.3;p.rot+=p.rs;p.life-=p.decay;
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.shadowBlur=18;ctx.shadowColor=p.col;
      ctx.beginPath();ctx.ellipse(0,0,p.r*3,p.r,0,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 2. BULL â€” CARICA DEVASTANTE: silhouette di toro che carica, terreno che trema + fuoco + impatto cosmico
bull:()=>{
  // Phase 1 (0-10): tremore del suolo, vapore che sale, aura di furia rossa
  // Phase 2 (10-38): il toro CARICA da sinistra lasciando scia di fuoco e calpestii
  // Phase 3 (38-44): IMPATTO â€” flash bianco + schegge di terreno + shockwave multipli
  // Phase 4 (44-120): esplosione di brace + corni che squarciano lo schermo + magma

  const maxF=mob?115:145;
  const chargeStartF=10;
  const impactF=38;

  // â”€â”€ Toro silhouette: corpo + testa + corni + zampe â”€â”€
  // Parte da sinistra fuori schermo, arriva al centro
  const bullStartX=cx-(mob?vvw*.85:vvw*.9);
  const bullEndX=cx-(mob?28:40);
  const bullY=cy+(mob?10:15);
  const bullW=mob?90:140;// larghezza del corpo
  const bullH=mob?52:80;// altezza del corpo

  // â”€â”€ Fuoco/scia di calore (trail) â”€â”€
  const fireTrail=[];const nFT=mob?30:55;
  for(let i=0;i<nFT;i++){fireTrail.push({x:-999,y:-999,vx:rnd(-3,1),vy:rnd(-5,-1),r:rnd(mob?5:8,mob?18:30),life:0,decay:rnd(.025,.05),hue:rnd(0,40),delay:chargeStartF+i});}

  // â”€â”€ Calpestii (zoccoli che battono) â”€â”€
  const hoofPrints=[];const nHP=mob?5:9;
  for(let i=0;i<nHP;i++)hoofPrints.push({x:-999,y:-999,life:0,spawnF:-1,col:c1});

  // â”€â”€ Schegge di terreno all'impatto â”€â”€
  const debris=[];const nDeb=mob?20:40;
  for(let i=0;i<nDeb;i++){const a=rnd(-Math.PI*.9,-.1);const spd=rnd(mob?8:12,mob?25:42);debris.push({x:bullEndX,y:bullY,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-rnd(2,8),w:rnd(mob?4:6,mob?14:22),h:rnd(mob?3:4,mob?8:14),rot:rnd(0,Math.PI*2),rs:rnd(-.2,.2),life:0,decay:rnd(.018,.032),col:i%3===0?c1:i%3===1?'#4a3010':'#7a5020'});}

  // â”€â”€ Corni che squarciano (post impatto) â”€â”€
  // Due linee taglienti che partono dall'impatto e sfondano lo schermo
  const hornSlashes=[];
  for(let i=0;i<(mob?2:4);i++){const a=-(Math.PI*.12)+(i%2===0?-1:1)*(Math.PI*.18+i*.05);const len=mob?300:480;hornSlashes.push({sx:bullEndX,sy:bullY-bullH*.6,ex:bullEndX+Math.cos(a)*len,ey:bullY-bullH*.6+Math.sin(a)*len,prog:0,spd:.1+i*.02,life:1,decay:.022,col:i%2===0?c1:c2,w:mob?4:7});}

  // â”€â”€ Shockwave concentricamente â”€â”€
  const impactWaves=[];for(let i=0;i<(mob?5:8);i++)impactWaves.push({r:mob?14:20,spd:mob?11+i*4:15+i*6,life:0,decay:.022+i*.003,col:i%3===0?c1:i%3===1?c2:'#fff',delay:i*3});

  // â”€â”€ Brace / embers esplosione â”€â”€
  const embers2=[];const nEm=mob?40:75;
  for(let i=0;i<nEm;i++){const a=rnd(0,Math.PI*2);const spd=rnd(mob?6:10,mob?28:48);embers2.push({x:bullEndX,y:bullY,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-rnd(2,6),r:rnd(mob?1.5:2,mob?5:8),life:0,decay:rnd(.018,.032),hue:rnd(0,50)});}

  // â”€â”€ Vapore pre-carica â”€â”€
  const steam=[];const nSt=mob?10:20;
  for(let i=0;i<nSt;i++){steam.push({x:cx-(mob?100:160)+rnd(-40,40),y:bullY-rnd(20,60),vx:rnd(-1.5,.5),vy:-rnd(1,4),r:rnd(mob?8:12,mob?22:38),life:1,decay:.016,delay:i*2});}

  // â”€â”€ Aura di furia rossa intorno alla carta â”€â”€
  let auraP=0;

  let bullX=bullStartX;
  let impacted=false;
  let f=0;

  // Funzione che disegna la silhouette del toro come path
  function drawBull(x2,y2,w,h,alpha,col1,col2){
    ctx.save();ctx.translate(x2,y2);ctx.globalAlpha=alpha;
    // Corpo principale (ellisse orizzontale)
    ctx.fillStyle=col1;ctx.shadowBlur=45;ctx.shadowColor=c1;
    ctx.beginPath();ctx.ellipse(0,0,w*.5,h*.5,0,0,Math.PI*2);ctx.fill();
    // Testa (cerchio piÃ¹ piccolo in avanti, destra)
    const hx=w*.42;const hy=-h*.18;const hr=h*.38;
    ctx.beginPath();ctx.arc(hx,hy,hr,0,Math.PI*2);ctx.fill();
    // Muso (rettangolo smussato)
    ctx.fillStyle=col2;ctx.shadowBlur=0;
    ctx.beginPath();ctx.roundRect(hx+hr*.3,hy-hr*.3,hr*.7,hr*.6,hr*.15);ctx.fill();
    // Occhio (cerchio rosso luminoso)
    ctx.fillStyle='#ff0000';ctx.shadowBlur=15;ctx.shadowColor='#ff0000';
    ctx.beginPath();ctx.arc(hx+hr*.25,hy-hr*.1,mob?4:6,0,Math.PI*2);ctx.fill();
    // Corno sinistro (curvo in su e avanti)
    ctx.strokeStyle='#f5d500';ctx.lineWidth=mob?3:5;ctx.shadowBlur=20;ctx.shadowColor='#f5d500';ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(hx,hy-hr*.85);ctx.bezierCurveTo(hx+hr*.3,hy-hr*1.5,hx+hr*.9,hy-hr*1.6,hx+hr*.8,hy-hr*.9);ctx.stroke();
    // Corno destro
    ctx.beginPath();ctx.moveTo(hx+hr*.2,hy-hr*.85);ctx.bezierCurveTo(hx+hr*.7,hy-hr*1.4,hx+hr*1.1,hy-hr*.8,hx+hr*.85,hy-hr*.2);ctx.stroke();
    // Zampe (4 linee sotto il corpo â€” animazione)
    const legOff=Math.sin(f*.35)*(mob?6:9);ctx.strokeStyle=col1;ctx.lineWidth=mob?7:11;ctx.shadowBlur=0;ctx.lineCap='round';
    const legs=[[-w*.32,h*.35],[-w*.08,h*.4],[w*.12,h*.35],[w*.35,h*.38]];
    legs.forEach(([lx,ly],li)=>{const legBob=li%2===0?legOff:-legOff;ctx.beginPath();ctx.moveTo(lx,ly*.5+legBob);ctx.lineTo(lx+rnd(-3,3),ly+legBob);ctx.stroke();});
    // Coda (curva a destra)
    ctx.strokeStyle=col1;ctx.lineWidth=mob?4:6;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-w*.48,-h*.1);ctx.bezierCurveTo(-w*.65,-h*.3,-w*.7,h*.1,-w*.55,h*.3);ctx.stroke();
    ctx.restore();
  }

  (function draw(){if(f>maxF){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);

    // â”€â”€ Vapore pre-carica â”€â”€
    if(f<impactF+10){steam.forEach(s=>{if(f<s.delay)return;s.x+=s.vx;s.y+=s.vy;s.r+=.5;s.life-=s.decay;if(s.life<=0)return;
      ctx.save();ctx.globalAlpha=s.life*.22;ctx.fillStyle='#ff4400';ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});}

    // â”€â”€ Aura di furia intorno alla carta (frames 0-impactF) â”€â”€
    if(f<impactF){auraP+=.12;const auraA=.3+Math.sin(auraP)*.15;const auraR=R*(1.18+Math.sin(auraP*.7)*.06);ctx.save();ctx.globalAlpha=auraA*(f/impactF);ctx.strokeStyle=c1;ctx.lineWidth=mob?6:10;ctx.shadowBlur=35;ctx.shadowColor=c1;ctx.setLineDash([mob?12:20,mob?6:10]);ctx.lineDashOffset=-f*2.5;ctx.beginPath();ctx.arc(cx,cy,auraR,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.restore();}

    // â”€â”€ Carica del toro â”€â”€
    if(f>=chargeStartF&&f<impactF){
      const prog=Math.min(1,(f-chargeStartF)/(impactF-chargeStartF));
      const ease=1-(1-prog)*(1-prog)*(1-prog);// cubic ease in
      bullX=bullStartX+(bullEndX-bullStartX)*ease;
      // Tremore schermo crescente
      const shakeAmt=(f-chargeStartF)*0.18;
      ctx.save();ctx.translate(rnd(-shakeAmt,shakeAmt),rnd(-shakeAmt*.5,shakeAmt*.5));
      // Scia di fuoco della carica
      const trailX=bullX-bullW*.3;
      fireTrail.forEach(ft=>{if(f<ft.delay)return;if(ft.x===-999){ft.x=trailX+rnd(-20,20);ft.y=bullY+rnd(-bullH*.3,bullH*.5);ft.life=1;}
        ft.x+=ft.vx;ft.y+=ft.vy;ft.vy-=.08;ft.r*=.97;ft.life-=ft.decay;if(ft.life<=0)return;
        const fc=`hsl(${ft.hue},100%,${55+ft.hue}%)`;
        ctx.save();ctx.globalAlpha=ft.life*.75;ctx.fillStyle=fc;ctx.shadowBlur=18;ctx.shadowColor=fc;ctx.beginPath();ctx.arc(ft.x,ft.y,ft.r,0,Math.PI*2);ctx.fill();ctx.restore();});
      // Calpestii
      if(f%5===0){const hp=hoofPrints[Math.floor((f-chargeStartF)/5)%nHP];if(hp){hp.x=bullX+rnd(-bullW*.2,bullW*.1);hp.y=bullY+bullH*.5+rnd(-5,5);hp.life=1;hp.spawnF=f;}}
      hoofPrints.forEach(hp=>{if(hp.life<=0)return;hp.life-=.04;if(hp.spawnF>0&&f>hp.spawnF){ctx.save();ctx.globalAlpha=hp.life*.5;ctx.fillStyle=c1;ctx.shadowBlur=10;ctx.shadowColor=c1;ctx.beginPath();ctx.ellipse(hp.x,hp.y,mob?6:10,mob?3:5,0,0,Math.PI*2);ctx.fill();ctx.restore();}});
      // Disegna toro
      drawBull(bullX,bullY,bullW,bullH,Math.min(1,(f-chargeStartF)/8),'#1a0800','#3a1800');
      ctx.restore();
    }

    // â”€â”€ IMPATTO â”€â”€
    if(f===impactF&&!impacted){impacted=true;
      debris.forEach(d=>{d.life=1;});embers2.forEach(e=>{e.life=1;});
      impactWaves.forEach(w=>{w.life=1;});
    }

    // â”€â”€ Flash impatto â”€â”€
    if(f>=impactF&&f<=impactF+6){ctx.save();ctx.globalAlpha=(impactF+7-f)*.5;ctx.fillStyle='#fff';ctx.fillRect(0,0,vvw,vvh);ctx.restore();}

    // â”€â”€ Shockwave â”€â”€
    impactWaves.forEach(w=>{if(w.life<=0)return;if(f<impactF+w.delay)return;w.r+=w.spd;w.life-=w.decay;if(w.life<=0)return;
      ctx.save();ctx.globalAlpha=w.life*.65;ctx.strokeStyle=w.col;ctx.lineWidth=mob?3:6;ctx.shadowBlur=28;ctx.shadowColor=w.col;ctx.beginPath();ctx.arc(cx,cy,w.r,0,Math.PI*2);ctx.stroke();ctx.restore();});

    // â”€â”€ Corni che squarciano â”€â”€
    if(f>=impactF){hornSlashes.forEach(hs=>{if(hs.prog<1)hs.prog=Math.min(1,hs.prog+hs.spd);else hs.life-=hs.decay;if(hs.life<=0)return;
      const fade=f>90?Math.max(0,1-(f-90)/40):1;const px=hs.sx+(hs.ex-hs.sx)*hs.prog;const py=hs.sy+(hs.ey-hs.sy)*hs.prog;
      ctx.save();ctx.globalAlpha=hs.life*.9*fade;ctx.strokeStyle=hs.col;ctx.lineWidth=hs.w*(1-hs.prog*.7+.3);ctx.shadowBlur=30;ctx.shadowColor=hs.col;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(hs.sx,hs.sy);ctx.lineTo(px,py);ctx.stroke();
      // Glow coda del taglio
      ctx.globalAlpha=hs.life*.4*fade;ctx.lineWidth=hs.w*3;ctx.shadowBlur=50;ctx.beginPath();ctx.moveTo(hs.sx,hs.sy);ctx.lineTo(px,py);ctx.stroke();
      // Punta luminosa
      if(hs.prog<1){ctx.globalAlpha=hs.life*fade;ctx.fillStyle='#fff';ctx.shadowBlur=40;ctx.shadowColor=hs.col;ctx.beginPath();ctx.arc(px,py,hs.w*.8,0,Math.PI*2);ctx.fill();}
      ctx.restore();});}

    // â”€â”€ Schegge terreno â”€â”€
    debris.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.45;d.vx*=.97;d.rot+=d.rs;d.life-=d.decay;if(d.life<=0)return;
      const fade3=f>95?Math.max(0,1-(f-95)/40):1;
      ctx.save();ctx.translate(d.x,d.y);ctx.rotate(d.rot);ctx.globalAlpha=d.life*.9*fade3;ctx.fillStyle=d.col;ctx.shadowBlur=12;ctx.shadowColor=c1;ctx.fillRect(-d.w*.5,-d.h*.5,d.w,d.h);ctx.restore();});

    // â”€â”€ Brace / embers â”€â”€
    embers2.forEach(e=>{if(e.life<=0)return;e.x+=e.vx;e.y+=e.vy;e.vy+=.3;e.vx*=.97;e.life-=e.decay;
      if(mob&&(e.x<-5||e.x>vvw+5||e.y>vvh+5)){e.life=0;return;}
      if(e.life<=0)return;const fade4=f>100?Math.max(0,1-(f-100)/40):1;
      const fc2=`hsl(${e.hue},100%,62%)`;ctx.save();ctx.globalAlpha=e.life*.9*fade4;ctx.fillStyle=fc2;ctx.shadowBlur=14;ctx.shadowColor=fc2;ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();ctx.restore();});

    // â”€â”€ Toro fermo (post impatto, breve) â”€â”€
    if(f>impactF&&f<impactF+20){const fadeB=Math.max(0,1-(f-impactF)/20);drawBull(bullEndX,bullY,bullW,bullH,fadeB*.85,'#1a0800','#3a1800');}

    // â”€â”€ Testo "FURIA!!" â”€â”€
    if(f>=impactF&&f<=impactF+40){
      const ta=Math.min(1,(f-impactF)/5)*Math.max(0,1-(f-impactF-22)/18);
      const ts=mob?56:86;const sc=f<impactF+5?1+(impactF+4-f)*.1:1;
      ctx.save();ctx.globalAlpha=ta*.95;ctx.font=`900 ${ts*sc}px 'Bebas Neue',sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowBlur=50;ctx.shadowColor=c1;ctx.fillStyle=c2;ctx.fillText('FURIA!!',cx,cy-(mob?100:145));
      ctx.shadowBlur=20;ctx.fillStyle='#fff';ctx.globalAlpha=ta*.4;ctx.fillText('FURIA!!',cx,cy-(mob?100:145));ctx.restore();
    }

  requestAnimationFrame(draw);})();},

// 3. HEDGEHOG â€” Spines shoot radially from all rim points, oscillate
hedgehog:()=>{
  const spk=mob?20:40;const pts=[];
  for(let i=0;i<spk;i++){const a=Math.PI*2*i/spk;const p=rim(a,5);const spd=rnd(12,28);pts.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,px:p.x,py:p.y,life:1,decay:.022,col:i%2===0?c1:c2,w:rnd(2,4)});}
  // ring burst from rim
  let rr=R;let f=0;const max=mob?55:80;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    rr+=8;ctx.save();ctx.globalAlpha=Math.max(0,.7-rr/500);ctx.strokeStyle=c1;ctx.lineWidth=5;ctx.shadowBlur=35;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,rr,0,Math.PI*2);ctx.stroke();ctx.restore();
    pts.forEach(p=>{if(p.life<=0)return;const ox=p.x,oy=p.y;p.x+=p.vx;p.y+=p.vy;p.vx*=.93;p.vy*=.93;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life;ctx.strokeStyle=p.col;ctx.lineWidth=p.w;ctx.shadowBlur=16;ctx.shadowColor=p.col;ctx.beginPath();ctx.moveTo(ox,oy);ctx.lineTo(p.x,p.y);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 4. RAT â€” Dark tendrils spiral outward from rim like poison vines
rat:()=>{
  const n=mob?5:10;const tendrils=[];
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a);tendrils.push({x:p.x,y:p.y,a,phase:rnd(0,Math.PI*2),spd:rnd(3,6),pts:[{x:p.x,y:p.y}],life:1,decay:.012,col:i%2===0?c1:c2});}
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    tendrils.forEach(t=>{if(t.life<=0)return;t.phase+=.09;t.a+=Math.sin(t.phase)*.08;t.x+=Math.cos(t.a)*t.spd;t.y+=Math.sin(t.a)*t.spd;t.pts.push({x:t.x,y:t.y});if(t.pts.length>30)t.pts.shift();t.life-=t.decay;
      ctx.save();ctx.globalAlpha=t.life*.8;ctx.strokeStyle=t.col;ctx.lineWidth=4;ctx.shadowBlur=18;ctx.shadowColor=t.col;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();t.pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 5. KANGAROO â€” Bouncing energy spheres arc outward from bottom rim
kangaroo:()=>{
  const balls=[];const n=mob?14:28;
  for(let i=0;i<n;i++){const a=Math.PI*.15+Math.PI*.7*i/n;const p=rim(Math.PI*.5,rnd(0,20));balls.push({x:p.x,y:p.y,vx:Math.cos(a)*(rnd(8,18)),vy:-(rnd(10,22)),r:rnd(4,10),life:1,decay:.014,col:i%3===0?c1:i%3===1?c2:'#fff',bounces:0,trail:[]});}
  let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    balls.forEach(b=>{if(b.life<=0)return;b.trail.push({x:b.x,y:b.y});if(b.trail.length>8)b.trail.shift();b.x+=b.vx;b.y+=b.vy;b.vy+=.55;b.vx*=.99;
      if(b.y>cy+innerHeight*.35&&b.bounces<2){b.vy*=-.65;b.vx*=.85;b.bounces++;}b.life-=b.decay;
      b.trail.forEach((t,ti)=>{ctx.save();ctx.globalAlpha=(ti/b.trail.length)*b.life*.5;ctx.fillStyle=b.col;ctx.shadowBlur=10;ctx.shadowColor=b.col;ctx.beginPath();ctx.arc(t.x,t.y,b.r*.6,0,Math.PI*2);ctx.fill();ctx.restore();});
      ctx.save();ctx.globalAlpha=b.life;ctx.fillStyle=b.col;ctx.shadowBlur=22;ctx.shadowColor=b.col;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 6. TURTLE â€” Golden Fibonacci shell spiral unfurls outward + slow armored rings rotate
turtle:()=>{
  const spiralPts=[];let sr=R,sa=0;for(let i=0;i<(mob?160:300);i++){sa+=0.18;sr+=1.6;spiralPts.push({x:cx+Math.cos(sa)*sr,y:cy+Math.sin(sa)*sr});}
  const rings=[];for(let i=0;i<5;i++)rings.push({r:R+i*25,rot:i*Math.PI/5,rs:rnd(.008,.018)*(i%2?1:-1),life:1,decay:.011,col:i%2===0?c1:c2,sides:6});
  let f=0;const max=mob?110:150;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const prog=Math.min(1,f/50);const endPt=Math.floor(prog*spiralPts.length);
    if(endPt>1){ctx.save();ctx.globalAlpha=Math.max(0,1-f/max)*0.9+0.1;ctx.strokeStyle=c1;ctx.lineWidth=3.5;ctx.shadowBlur=22;ctx.shadowColor=c1;ctx.lineCap='round';ctx.beginPath();spiralPts.slice(0,endPt).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();}
    rings.forEach((rg,ri)=>{if(f<ri*12)return;rg.rot+=rg.rs;rg.life-=rg.decay;if(rg.life<=0)return;ctx.save();ctx.translate(cx,cy);ctx.rotate(rg.rot);ctx.globalAlpha=rg.life*.65;ctx.strokeStyle=rg.col;ctx.lineWidth=2.5;ctx.shadowBlur=16;ctx.shadowColor=rg.col;ctx.beginPath();for(let s=0;s<=rg.sides;s++){const a=Math.PI*2*s/rg.sides;s===0?ctx.moveTo(Math.cos(a)*rg.r,Math.sin(a)*rg.r):ctx.lineTo(Math.cos(a)*rg.r,Math.sin(a)*rg.r);}ctx.closePath();ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 7. KOALA â€” Dreamy eucalyptus mist clouds drift up + crystalline dew drops fall softly
koala:()=>{
  const mist=[];const n=mob?20:40;for(let i=0;i<n;i++){const a=rnd(-Math.PI*.9,-Math.PI*.1);const p=rim(a,rnd(0,40));mist.push({x:p.x,y:p.y,vx:rnd(-1.5,1.5),vy:-(rnd(.4,1.8)),r:rnd(18,45),life:1,decay:rnd(.007,.013),seed:rnd(0,100),hue:rnd(100,160)});}
  const drops=[];for(let i=0;i<(mob?25:50);i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,50));drops.push({x:p.x,y:p.y,vx:rnd(-1.5,1.5),vy:rnd(-3,-.5),r:rnd(1,3.5),life:1,decay:rnd(.012,.02),hue:rnd(120,200)});}
  let f=0;const max=mob?120:160;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    mist.forEach(p=>{if(p.life<=0)return;p.x+=p.vx+Math.sin(f*.03+p.seed)*.5;p.y+=p.vy;p.r+=.25;p.life-=p.decay;const col=`hsl(${p.hue},60%,70%)`;ctx.save();ctx.globalAlpha=p.life*.18;ctx.fillStyle=col;ctx.shadowBlur=0;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
    drops.forEach(p=>{if(p.life<=0)return;p.x+=p.vx+Math.sin(f*.05+p.r)*.4;p.y+=p.vy;p.vy+=.06;p.life-=p.decay;const col=`hsl(${p.hue},80%,75%)`;ctx.save();ctx.globalAlpha=p.life*.85;ctx.fillStyle=col;ctx.shadowBlur=14;ctx.shadowColor=col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();// sparkle cross
      if(p.r>2){ctx.strokeStyle='#fff';ctx.lineWidth=.8;ctx.globalAlpha=p.life*.4;ctx.beginPath();ctx.moveTo(p.x-p.r*1.4,p.y);ctx.lineTo(p.x+p.r*1.4,p.y);ctx.moveTo(p.x,p.y-p.r*1.4);ctx.lineTo(p.x,p.y+p.r*1.4);ctx.stroke();}ctx.restore();});
  requestAnimationFrame(draw);})();},

// 8. CHEETAH â€” Ultra-fast horizontal speed-lines burst from left rim, comet trails
cheetah:()=>{
  const streaks=[];const n=mob?12:24;
  for(let i=0;i<n;i++){const p=rim(-Math.PI,rnd(0,10));streaks.push({x:p.x,y:p.y+(rnd(-1,1)*80),vx:rnd(40,90),vy:rnd(-4,4),len:rnd(100,300),life:1,decay:rnd(.03,.05),col:i%2===0?c1:c2,w:rnd(1.5,4)});}
  let f=0;const max=mob?40:55;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // motion blur glow
    if(f<5){ctx.save();ctx.globalAlpha=(1-f/5)*.2;ctx.fillStyle=c1;ctx.fillRect(0,0,vvw,vvh);ctx.restore();}
    streaks.forEach(s=>{if(s.life<=0)return;const ox=s.x;s.x+=s.vx;s.y+=s.vy;s.vx*=.96;s.life-=s.decay;ctx.save();ctx.globalAlpha=s.life;ctx.strokeStyle=s.col;ctx.lineWidth=s.w;ctx.shadowBlur=24;ctx.shadowColor=s.col;ctx.beginPath();ctx.moveTo(ox-s.len,s.y);ctx.lineTo(s.x,s.y);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 9. BEAR â€” Triple shockwave ROAR + massive sweep claw arcs that slash full screen
bear:()=>{
  // 3 shockwave rings at staggered times
  const waves=[{t:0,r:R,done:false},{t:12,r:R,done:false},{t:24,r:R,done:false}];
  // Massive claw slashes: 3 pairs of giant curved arcs
  const claws=[];
  const clawData=[
    {a:-Math.PI*.15,dir:1,delay:5},{a:Math.PI*.15,dir:-1,delay:5},
    {a:-Math.PI*.35,dir:1,delay:15},{a:Math.PI*.35,dir:-1,delay:15},
    {a:-Math.PI*.55,dir:1,delay:25},{a:Math.PI*.55,dir:-1,delay:25}
  ];
  clawData.forEach(({a,dir,delay},ci)=>{
    const len=rnd(260,380);const p=rim(a-Math.PI*.5*(dir>0?1:-1),10);
    const pts=[];for(let t=0;t<=1;t+=.04){const curve=a+dir*t*Math.PI*.55;pts.push({x:cx+Math.cos(curve)*(R+t*len),y:cy+Math.sin(curve)*(R+t*len)});}
    claws.push({pts,progress:0,spd:.07+ci*.005,life:1,decay:.022,col:ci%2===0?c1:c2,w:rnd(6,12),delay});
  });
  // Ember sparks on impact
  const embers=[];for(let i=0;i<(mob?30:60);i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));embers.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(4,14),vy:Math.sin(a)*rnd(4,14)-2,r:rnd(2,5),life:0,delay:8,decay:rnd(.018,.03),col:i%2===0?c1:c2});}
  let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Shockwave rings
    waves.forEach(w=>{if(f<w.t)return;w.r+=14;const al=Math.max(0,.9-w.r/700);if(al<=0)return;
      [c1,c2].forEach((col,ci)=>{ctx.save();ctx.globalAlpha=al*(ci===0?.7:.4);ctx.strokeStyle=col;ctx.lineWidth=ci===0?12:5;ctx.shadowBlur=50;ctx.shadowColor=col;ctx.beginPath();ctx.arc(cx,cy,w.r*(ci===0?1:.7),0,Math.PI*2);ctx.stroke();ctx.restore();});});
    // Claw arcs
    claws.forEach(cl=>{if(f<cl.delay)return;if(cl.progress<1)cl.progress=Math.min(1,cl.progress+cl.spd);else cl.life-=cl.decay;if(cl.life<=0)return;
      const nPts=Math.max(2,Math.floor(cl.progress*cl.pts.length));ctx.save();ctx.globalAlpha=(cl.progress<1?cl.progress+.2:cl.life)*.95;ctx.strokeStyle=cl.col;ctx.lineWidth=cl.w*cl.life;ctx.shadowBlur=35;ctx.shadowColor=cl.col;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();cl.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();
      // bright tip
      if(nPts>0){const tip=cl.pts[nPts-1];ctx.save();ctx.globalAlpha=cl.life*.9;ctx.fillStyle='#fff';ctx.shadowBlur=25;ctx.shadowColor=cl.col;ctx.beginPath();ctx.arc(tip.x,tip.y,cl.w*.6,0,Math.PI*2);ctx.fill();ctx.restore();}});
    // Embers
    embers.forEach(e=>{if(f<e.delay){e.life=0;return;}if(e.life===0)e.life=.01;e.x+=e.vx;e.y+=e.vy;e.vy+=.15;e.vx*=.97;e.life=Math.min(1,e.life+.12);e.life-=e.decay;if(e.life<=0)return;ctx.save();ctx.globalAlpha=e.life;ctx.fillStyle=e.col;ctx.shadowBlur=14;ctx.shadowColor=e.col;ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 10. OWL â€” Mystical all-seeing eye opens: iris rings expand + rune sparks orbit
owl:()=>{
  let eyeScale=0;let f=0;const max=mob?110:150;
  const sparks=[];const n=mob?18:36;for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(5,25));sparks.push({x:p.x,y:p.y,orbit:R+rnd(20,60)+i*8,oa:a,os:rnd(-.05,.05)||.04,r:rnd(2,5),rot:rnd(0,Math.PI),life:1,decay:.012,col:i%2===0?c1:c2});}
  const irisRings=[];for(let i=0;i<8;i++)irisRings.push({r:R*.25*(i+1),col:`hsl(${260+i*8},80%,${50+i*4}%)`,life:1,decay:.01,rot:0,rs:rnd(-.03,.03)*(i%2?1:-1),thick:rnd(2,5)});
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Eye opening scale
    eyeScale=Math.min(1,f/25);const fade=f>90?1-(f-90)/(max-90):1;
    // Iris rings
    irisRings.forEach((ir,ii)=>{ir.rot+=ir.rs;if(ii/irisRings.length>eyeScale)return;ctx.save();ctx.translate(cx,cy);ctx.rotate(ir.rot);ctx.globalAlpha=ir.life*fade*.7;ctx.strokeStyle=ir.col;ctx.lineWidth=ir.thick;ctx.shadowBlur=18;ctx.shadowColor=ir.col;ctx.beginPath();ctx.arc(0,0,ir.r*eyeScale,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Pupil
    if(eyeScale>.3){ctx.save();ctx.translate(cx,cy);ctx.globalAlpha=fade*.9;ctx.fillStyle='#000';ctx.shadowBlur=25;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(0,0,R*.12*eyeScale,0,Math.PI*2);ctx.fill();ctx.fillStyle=c2;ctx.globalAlpha=fade*.4;ctx.beginPath();ctx.arc(0,0,R*.06*eyeScale,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Orbiting rune sparks
    sparks.forEach(g=>{g.oa+=g.os;g.x=cx+Math.cos(g.oa)*g.orbit;g.y=cy+Math.sin(g.oa)*g.orbit;g.orbit+=.4;g.rot+=.08;g.life-=g.decay;if(g.life<=0)return;ctx.save();ctx.translate(g.x,g.y);ctx.rotate(g.rot);ctx.globalAlpha=g.life*fade*.75;ctx.fillStyle=g.col;ctx.shadowBlur=16;ctx.shadowColor=g.col;ctx.beginPath();ctx.arc(0,0,g.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 11. CHAMELEON â€” Rainbow pixel storm from all rim points, hue-shifting
chameleon:()=>{
  const pts=[];const n=mob?60:120;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,10));const spd=rnd(3,12);pts.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,hue:i/n*360,r:rnd(3,8),life:1,decay:rnd(.012,.02)});}
  let f=0;const max=mob?80:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    pts.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.hue=(p.hue+4)%360;p.life-=p.decay;const col=`hsl(${p.hue},100%,65%)`;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=col;ctx.shadowBlur=18;ctx.shadowColor=col;ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life+1,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 12. ARMADILLO â€” Defensive curl: plate segments spin inward then explode outward in a ring
armadillo:()=>{
  const plates=[];const n=mob?16:32;const phaseIn=30;
  for(let i=0;i<n;i++){const finalA=Math.PI*2*i/n;plates.push({i,finalA,curA:finalA+rnd(-2,2),curR:R+rnd(60,140),targetR:R,spd:.25,life:1,decay:.013,col:i%2===0?c1:c2,size:rnd(10,20),rot:rnd(0,Math.PI*2),rs:rnd(-.15,.15)});}
  let exploded=false;let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const t=Math.min(1,f/phaseIn);
    if(!exploded&&t>=1){// explode outward
      exploded=true;plates.forEach(p=>{p.vx=Math.cos(p.finalA)*rnd(8,18);p.vy=Math.sin(p.finalA)*rnd(8,18);});
    }
    plates.forEach(p=>{
      if(!exploded){// spiral inward
        p.curR+=(p.targetR-p.curR)*.18;p.curA+=(p.finalA-p.curA)*.15;p.rot+=p.rs;
        const px=cx+Math.cos(p.curA)*p.curR;const py=cy+Math.sin(p.curA)*p.curR;
        ctx.save();ctx.translate(px,py);ctx.rotate(p.rot);ctx.globalAlpha=.85;ctx.fillStyle=p.col;ctx.shadowBlur=14;ctx.shadowColor=p.col;
        ctx.beginPath();for(let s=0;s<6;s++){const a=Math.PI/3*s;s===0?ctx.moveTo(Math.cos(a)*p.size,Math.sin(a)*p.size):ctx.lineTo(Math.cos(a)*p.size,Math.sin(a)*p.size);}ctx.closePath();ctx.fill();ctx.restore();
      }else{
        if(!p.px){p.px=cx+Math.cos(p.finalA)*p.targetR;p.py=cy+Math.sin(p.finalA)*p.targetR;}
        p.px+=p.vx;p.py+=p.vy;p.vx*=.96;p.vy*=.96;p.vy+=.15;p.life-=p.decay;p.rot+=p.rs*2;
        if(p.life<=0)return;ctx.save();ctx.translate(p.px,p.py);ctx.rotate(p.rot);ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.shadowBlur=16;ctx.shadowColor=p.col;
        ctx.beginPath();for(let s=0;s<6;s++){const a=Math.PI/3*s;s===0?ctx.moveTo(Math.cos(a)*p.size,Math.sin(a)*p.size):ctx.lineTo(Math.cos(a)*p.size,Math.sin(a)*p.size);}ctx.closePath();ctx.fill();ctx.restore();
      }});
  requestAnimationFrame(draw);})();},

// 13. CROCODILE â€” Jaw snap: two rows of teeth close shut + water spray ripple
crocodile:()=>{
  // Teeth: top jaw and bottom jaw
  const teeth=[];const n=mob?8:14;
  for(let i=0;i<n;i++){const side=i<n/2?-1:1;const pct=i<n/2?(i/(n/2-1||1)):(i-n/2)/((n-n/2-1)||1);const startX=cx-R*.9+pct*R*1.8;const topY=cy-(R*.5+rnd(20,50));const botY=cy+(R*.5+rnd(20,50));[-1,1].forEach(jSide=>{const ty=jSide<0?topY:botY;const targetY=cy+jSide*(R*.3+rnd(5,20));teeth.push({x:startX,y:ty,tx:startX,ty:targetY,prog:0,spd:rnd(.04,.09),col:i%2===0?c1:c2,w:rnd(8,18),h:rnd(18,36),life:1,decay:.015});});
  }
  const splashes=[];for(let i=0;i<(mob?20:40);i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));const s=rnd(3,10);splashes.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2,r:rnd(2,5),life:1,decay:rnd(.016,.028),col:i%2===0?c1:c2});}
  let f=0;const max=mob?75:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Jaw close
    teeth.forEach(t=>{if(t.prog<1)t.prog=Math.min(1,t.prog+t.spd);t.life-=t.decay;if(t.life<=0)return;const curY=t.y+(t.ty-t.y)*t.prog;ctx.save();ctx.globalAlpha=(t.prog<.8?t.prog+.2:t.life)*.9;ctx.fillStyle=t.col;ctx.shadowBlur=16;ctx.shadowColor=t.col;ctx.beginPath();ctx.moveTo(t.x-t.w/2,curY);ctx.lineTo(t.x,curY+(t.ty>cy?-t.h:t.h));ctx.lineTo(t.x+t.w/2,curY);ctx.closePath();ctx.fill();ctx.restore();});
    // Water splashes
    splashes.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.22;p.vx*=.97;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life*.75;ctx.fillStyle=p.col;ctx.shadowBlur=10;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 14. BUG â€” Bee swarm: formation of hexagons converge to center then sting outward
bug:()=>{
  const bees=[];const n=mob?20:40;const ring1=mob?6:10,ring2=mob?14:30;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const startR=R+rnd(80,200);const spd=rnd(.06,.1);bees.push({angle:a,curR:startR,targetR:R+rnd(5,30),spd,life:1,decay:.013,col:i%2===0?c1:c2,size:rnd(4,8),phase:rnd(0,Math.PI*2),done:false,vx:0,vy:0});}
  let stung=false;let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    let allIn=true;
    bees.forEach(b=>{
      if(!stung){
        b.curR+=(b.targetR-b.curR)*b.spd;if(Math.abs(b.curR-b.targetR)>.5)allIn=false;
        const px=cx+Math.cos(b.angle)*b.curR;const py=cy+Math.sin(b.angle)*b.curR;
        b.phase+=.15;ctx.save();ctx.translate(px,py);ctx.globalAlpha=.9;ctx.fillStyle=b.col;ctx.shadowBlur=12;ctx.shadowColor=b.col;
        ctx.beginPath();for(let s=0;s<6;s++){const a=Math.PI/3*s;s===0?ctx.moveTo(Math.cos(a)*b.size,Math.sin(a)*b.size):ctx.lineTo(Math.cos(a)*b.size,Math.sin(a)*b.size);}ctx.closePath();ctx.fill();
        // wings
        ctx.globalAlpha=.35;ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(-b.size*.5,-b.size,b.size*.8,b.size*.4,-.4,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.ellipse(b.size*.5,-b.size,b.size*.8,b.size*.4,.4,0,Math.PI*2);ctx.fill();ctx.restore();
      }else{
        b.curR+=rnd(8,18);b.life-=b.decay;if(b.life<=0)return;
        const px=cx+Math.cos(b.angle)*b.curR;const py=cy+Math.sin(b.angle)*b.curR;
        ctx.save();ctx.translate(px,py);ctx.globalAlpha=b.life;ctx.fillStyle=b.col;ctx.shadowBlur=18;ctx.shadowColor=b.col;
        ctx.beginPath();for(let s=0;s<6;s++){const a=Math.PI/3*s;s===0?ctx.moveTo(Math.cos(a)*b.size,Math.sin(a)*b.size):ctx.lineTo(Math.cos(a)*b.size,Math.sin(a)*b.size);}ctx.closePath();ctx.fill();ctx.restore();
      }});
    if(allIn&&!stung)stung=true;
  requestAnimationFrame(draw);})();},

// 15. SHARK â€” APEX PREDATOR: dorsal fin slices from bottom + deep sonar rings + blood streak
shark:()=>{
  // Dorsal fin: materializes from bottom center slicing up through card
  const fin={y:vvh+80,vy:-(rnd(22,32)),life:1,decay:.025,w:24};
  const finTrail=[];
  // Sonar echo rings (deep blue waves from all sides)
  const sonarRings=[];for(let i=0;i<5;i++){const sides=[Math.PI*.5,Math.PI,0,-Math.PI*.5,Math.PI*1.5];const a=sides[i];const p=rim(a,20);sonarRings.push({cx2:p.x,cy2:p.y,r:0,spd:rnd(12,18)+i*4,delay:i*7,life:1,decay:.018,col:i%2===0?c1:c2});}
  // Blood streak slashing through water
  const streaks=[];const nSt=mob?4:8;
  for(let i=0;i<nSt;i++){const y=cy+rnd(-100,100);streaks.push({x:cx+(i%2===0?-R-200:R+200),y,vx:(i%2===0?rnd(22,40):-(rnd(22,40))),vy:rnd(-1,1),trail:[],life:1,decay:.03,col:i===0?'#cc0000':i%2===0?c1:c2,w:rnd(2,6),delay:i*5});}
  let f=0;const max=mob?75:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Sonar rings
    sonarRings.forEach(sr=>{if(f<sr.delay)return;sr.r+=sr.spd;sr.life-=sr.decay;if(sr.life<=0)return;ctx.save();ctx.globalAlpha=sr.life*.5;ctx.strokeStyle=sr.col;ctx.lineWidth=3;ctx.shadowBlur=22;ctx.shadowColor=sr.col;ctx.beginPath();ctx.arc(sr.cx2,sr.cy2,sr.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Dorsal fin sweeping up
    finTrail.push({y:fin.y,life:fin.life});if(finTrail.length>20)finTrail.shift();
    fin.y+=fin.vy;fin.vy*=.97;
    finTrail.forEach((pt,ti)=>{ctx.save();ctx.globalAlpha=(ti/finTrail.length)*fin.life*.5;ctx.fillStyle=c1;ctx.shadowBlur=20;ctx.shadowColor=c1;ctx.beginPath();ctx.moveTo(cx-fin.w*(ti/finTrail.length),pt.y+fin.w*2);ctx.lineTo(cx,pt.y-fin.w*2);ctx.lineTo(cx+fin.w*(ti/finTrail.length),pt.y+fin.w*2);ctx.closePath();ctx.fill();ctx.restore();});
    // Fin head
    if(fin.y>-50){ctx.save();ctx.globalAlpha=.95;ctx.fillStyle='#fff';ctx.shadowBlur=35;ctx.shadowColor=c1;ctx.strokeStyle=c1;ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(cx-fin.w,fin.y+fin.w*2);ctx.lineTo(cx,fin.y-fin.w*2);ctx.lineTo(cx+fin.w,fin.y+fin.w*2);ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();}
    // Streaks
    streaks.forEach(s=>{if(f<s.delay||s.life<=0)return;s.trail.push({x:s.x,y:s.y});if(s.trail.length>18)s.trail.shift();s.x+=s.vx;s.y+=s.vy;s.life-=s.decay;if(s.trail.length<2)return;const grad=ctx.createLinearGradient(s.trail[0].x,s.trail[0].y,s.x,s.y);grad.addColorStop(0,'transparent');grad.addColorStop(1,s.col);ctx.save();ctx.globalAlpha=s.life;ctx.strokeStyle=grad;ctx.lineWidth=s.w;ctx.shadowBlur=25;ctx.shadowColor=s.col;ctx.beginPath();ctx.moveTo(s.trail[0].x,s.trail[0].y);s.trail.forEach(pt=>ctx.lineTo(pt.x,pt.y));ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 16. DEER â€” Fractal branching antlers grow from top rim points
deer:()=>{
  const lines=[];
  const branch=(x,y,angle,len,depth)=>{if(depth<=0||len<6)return;const ex=x+Math.cos(angle)*len;const ey=y+Math.sin(angle)*len;lines.push({x1:x,y1:y,x2:ex,y2:ey,life:1,decay:.014,col:depth%2===0?c1:c2,w:depth+1});branch(ex,ey,angle-.45,len*.68,depth-1);branch(ex,ey,angle+.45,len*.68,depth-1);if(depth>2)branch(ex,ey,angle,len*.5,depth-2);};
  const p1=rim(-Math.PI*.6),p2=rim(-Math.PI*.4);branch(p1.x,p1.y,-Math.PI*.55,55,5);branch(p2.x,p2.y,-Math.PI*.45,55,5);
  let f=0;const max=mob?80:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const rev=Math.min(1,f/35);lines.forEach((l,li)=>{if(li/lines.length>rev)return;l.life-=l.decay;if(l.life<=0)return;ctx.save();ctx.globalAlpha=l.life;ctx.strokeStyle=l.col;ctx.lineWidth=l.w;ctx.shadowBlur=18;ctx.shadowColor=l.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(l.x1,l.y1);ctx.lineTo(l.x2,l.y2);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 17. TICK â€” Marching ant columns spiral outward from card in organized lines
tick:()=>{
  // 4 marching columns at 90Â° angles
  const cols=[];const perCol=mob?20:35;
  [0,Math.PI*.5,Math.PI,Math.PI*1.5].forEach((baseA,ci)=>{
    const colPts=[];for(let i=0;i<perCol;i++){const a=baseA+rnd(-.2,.2);const startR=R+i*12;colPts.push({x:cx+Math.cos(a)*startR,y:cy+Math.sin(a)*startR,vx:Math.cos(a)*rnd(1.5,3),vy:Math.sin(a)*rnd(1.5,3),r:rnd(1.5,3),life:1,delay:i*3,col:ci%2===0?c1:c2,phase:i*.4});}
    cols.push(colPts);
  });
  let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    cols.forEach(col=>{col.forEach(a=>{if(f<a.delay||a.life<=0)return;a.x+=a.vx+Math.sin(f*.1+a.phase)*.5;a.y+=a.vy+Math.cos(f*.1+a.phase)*.5;a.life-=.013;ctx.save();ctx.globalAlpha=a.life*.9;ctx.fillStyle=a.col;ctx.shadowBlur=8;ctx.shadowColor=a.col;ctx.beginPath();ctx.arc(a.x,a.y,a.r,0,Math.PI*2);ctx.fill();// ant body segments
      if(a.r>1.5){ctx.fillStyle='#fff';ctx.globalAlpha=a.life*.3;ctx.beginPath();ctx.arc(a.x+a.vx*.8,a.y+a.vy*.8,a.r*.55,0,Math.PI*2);ctx.fill();}ctx.restore();});});
  requestAnimationFrame(draw);})();},

// 18. RHINO â€” Charging impact: single massive momentum dash + seismic fault cracks
rhino:()=>{
  // Single charge comet from left
  const comet={x:cx-R-250,y:cy,vx:rnd(28,40),vy:0,trail:[],r:20,life:1,decay:.02};
  const cracks=[];let cracked=false;const n=mob?5:9;
  const dust=[];for(let i=0;i<(mob?20:40);i++){dust.push({x:cx,y:cy,vx:rnd(-8,8),vy:rnd(-8,4),r:rnd(6,20),life:0,decay:rnd(.013,.022),col:c1});}
  let f=0;const max=mob?85:120;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    comet.trail.push({x:comet.x,y:comet.y});if(comet.trail.length>30)comet.trail.shift();
    comet.x+=comet.vx;comet.vx*=.99;
    if(!cracked&&comet.x>cx-R*.3){cracked=true;
      for(let i=0;i<n;i++){const a=Math.PI*.6+Math.PI*.8*i/n+rnd(-.2,.2);const p=rim(a,5);cracks.push({x:p.x,y:p.y,a:a+rnd(-.15,.15),pts:[{x:p.x,y:p.y}],spd:rnd(12,24),life:1,decay:.016,col:i%2===0?c1:c2,w:rnd(3,7)});}
      dust.forEach(d=>{d.life=1;});
    }
    // Comet trail
    if(comet.trail.length>2){const grad=ctx.createLinearGradient(comet.trail[0].x,comet.trail[0].y,comet.x,comet.y);grad.addColorStop(0,'transparent');grad.addColorStop(1,c1);ctx.save();ctx.strokeStyle=grad;ctx.lineWidth=comet.r*2;ctx.shadowBlur=40;ctx.shadowColor=c1;ctx.globalAlpha=.6;ctx.beginPath();ctx.moveTo(comet.trail[0].x,comet.trail[0].y);comet.trail.forEach(pt=>ctx.lineTo(pt.x,pt.y));ctx.stroke();ctx.restore();}
    // Comet head
    if(comet.x<cx+innerWidth*.4){ctx.save();ctx.globalAlpha=comet.life;ctx.fillStyle='#fff';ctx.shadowBlur=35;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(comet.x,comet.y,comet.r,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Cracks
    cracks.forEach(cr=>{if(cr.life<=0)return;const last=cr.pts[cr.pts.length-1];cr.a+=rnd(-.1,.1);cr.pts.push({x:last.x+Math.cos(cr.a)*cr.spd,y:last.y+Math.sin(cr.a)*cr.spd});cr.life-=cr.decay;ctx.save();ctx.globalAlpha=cr.life;ctx.strokeStyle=cr.col;ctx.lineWidth=cr.w;ctx.shadowBlur=22;ctx.shadowColor=cr.col;ctx.beginPath();cr.pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
    dust.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.r+=.5;d.vy+=.08;d.life-=d.decay;ctx.save();ctx.globalAlpha=d.life*.2;ctx.fillStyle=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 19. FLY â€” TOXIC SWARM: buzzing figure-8 swarm clusters + nauseating spiral vortex
fly:()=>{
  // Figure-8 swarm dots orbit two focal points
  const swarm=[];const n=mob?60:120;
  for(let i=0;i<n;i++){const side=i<n/2?1:-1;const offsetX=side*60;const a=rnd(0,Math.PI*2);const r=rnd(20,80);swarm.push({cx2:cx+offsetX,cy2:cy+rnd(-20,20),angle:a,radius:r,angSpd:rnd(.1,.22)*(Math.random()<.5?1:-1),wobble:rnd(0,Math.PI*2),ws:rnd(.05,.12),life:1,decay:rnd(.008,.013),r2:rnd(2,5),hue:rnd(70,130),side});}
  // Outer rotating toxic ring
  let ringAngle=0;
  // Central vortex spiral
  const vPts=[];for(let i=0;i<(mob?40:80);i++){const a=rnd(0,Math.PI*2);const r=rnd(R,R+120);vPts.push({angle:a,radius:r,angSpd:rnd(.08,.15)*(Math.random()<.5?1:-1),vr:-(rnd(2,5)),r2:rnd(1.5,3.5),life:1,decay:rnd(.01,.018),hue:rnd(80,140)});}
  let f=0;const max=mob?110:150;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    ringAngle+=.04;
    // Outer toxic ring
    [0,1].forEach(ri=>{ctx.save();ctx.globalAlpha=.35;ctx.strokeStyle=ri===0?c1:c2;ctx.lineWidth=ri===0?4:2;ctx.shadowBlur=25;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,R+ri*40+Math.sin(f*.07+ri)*15,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Figure-8 swarm
    swarm.forEach(s=>{if(s.life<=0)return;s.angle+=s.angSpd;s.wobble+=s.ws;const wobR=s.radius+Math.sin(s.wobble)*12;const sx=s.cx2+Math.cos(s.angle)*wobR;const sy=s.cy2+Math.sin(s.angle)*wobR*(1+Math.sin(s.wobble)*.3);s.life-=s.decay;const col=`hsl(${s.hue},90%,55%)`;ctx.save();ctx.globalAlpha=s.life*.9;ctx.fillStyle=col;ctx.shadowBlur=8;ctx.shadowColor=col;ctx.beginPath();ctx.arc(sx,sy,s.r2,0,Math.PI*2);ctx.fill();// tiny wing line
      ctx.globalAlpha=s.life*.25;ctx.strokeStyle='#fff';ctx.lineWidth=.8;ctx.beginPath();ctx.moveTo(sx-s.r2*1.5,sy-s.r2*.5);ctx.lineTo(sx+s.r2*1.5,sy-s.r2*.5);ctx.stroke();ctx.restore();});
    // Vortex spiral
    vPts.forEach(p=>{if(p.life<=0)return;p.angle+=p.angSpd;p.radius+=p.vr;if(p.radius<20){p.radius=20;p.vr=rnd(3,8);}p.life-=p.decay;const px=cx+Math.cos(p.angle)*p.radius;const py=cy+Math.sin(p.angle)*p.radius;const col=`hsl(${p.hue},100%,50%)`;ctx.save();ctx.globalAlpha=p.life*.7;ctx.fillStyle=col;ctx.shadowBlur=10;ctx.shadowColor=col;ctx.beginPath();ctx.arc(px,py,p.r2,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 20. BUTTERFLY â€” Colorful wing-pair silhouettes flutter outward
butterfly:()=>{
  const wings=[];const n=mob?10:20;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,20));const spd=rnd(3,8);wings.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-2,phase:rnd(0,Math.PI*2),ps:rnd(.12,.22),size:rnd(20,45),life:1,decay:rnd(.013,.02),hue:i/n*360});}
  let f=0;const max=mob?85:120;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    wings.forEach(w=>{if(w.life<=0)return;w.x+=w.vx;w.y+=w.vy;w.vx*=.98;w.vy+=.1;w.phase+=w.ps;w.life-=w.decay;const flap=Math.sin(w.phase)*w.size;const col=`hsl(${w.hue},100%,65%)`;ctx.save();ctx.translate(w.x,w.y);ctx.globalAlpha=w.life*.8;ctx.fillStyle=col;ctx.shadowBlur=20;ctx.shadowColor=col;
      // left wing
      ctx.beginPath();ctx.ellipse(-flap*.5,-w.size*.3,Math.abs(flap)*.8+4,w.size*.6,-.3,0,Math.PI*2);ctx.fill();
      // right wing
      ctx.beginPath();ctx.ellipse(flap*.5,-w.size*.3,Math.abs(flap)*.8+4,w.size*.6,.3,0,Math.PI*2);ctx.fill();
      ctx.restore();});
  requestAnimationFrame(draw);})();},

// 21. VIPER â€” DNA double-helix snake trails twist from sides
viper:()=>{
  const snakes=[];const n=mob?4:8;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a);snakes.push({x:p.x,y:p.y,a,phase:rnd(0,Math.PI*2),spd:rnd(5,9),trail:[],life:1,decay:.012,col:i%2===0?c1:c2,pair:i%2===0?1:-1});}
  let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    snakes.forEach(s=>{if(s.life<=0)return;s.phase+=.1;s.a+=Math.sin(s.phase)*.1;s.x+=Math.cos(s.a)*s.spd;s.y+=Math.sin(s.a)*s.spd;s.trail.push({x:s.x,y:s.y});if(s.trail.length>25)s.trail.shift();s.life-=s.decay;
      // main trail
      ctx.save();ctx.globalAlpha=s.life*.85;ctx.strokeStyle=s.col;ctx.lineWidth=4;ctx.shadowBlur=16;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();s.trail.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();
      // paired strand
      const off=12;s.trail.forEach((p,pi)=>{if(pi%4!==0)return;ctx.save();ctx.globalAlpha=s.life*.4;ctx.strokeStyle=pi%2===0?c1:c2;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(p.x+Math.sin(pi*.4)*off*s.pair,p.y+Math.cos(pi*.4)*off*s.pair);ctx.lineTo(p.x-Math.sin(pi*.4)*off*s.pair,p.y-Math.cos(pi*.4)*off*s.pair);ctx.stroke();ctx.restore();});});
  requestAnimationFrame(draw);})();},

// 22. SPIDER â€” Silk threads shoot from rim to screen corners, web forms
spider:()=>{
  const threads=[];const corners=[[0,0],[vvw,0],[0,vvh],[vvw,vvh],[cx,0],[cx,vvh],[0,cy],[vvw,cy]];
  corners.forEach((corner,ci)=>{const a=Math.atan2(corner[1]-cy,corner[0]-cx);const p=rim(a,5);threads.push({x:p.x,y:p.y,tx:corner[0],ty:corner[1],prog:0,spd:rnd(.025,.045),life:1,decay:.01,col:ci%2===0?c1:c2,w:rnd(1,2)});});
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    threads.forEach(t=>{if(t.prog>=1){t.life-=t.decay;if(t.life<=0)return;}else t.prog=Math.min(1,t.prog+t.spd);const ex=t.x+(t.tx-t.x)*t.prog;const ey=t.y+(t.ty-t.y)*t.prog;ctx.save();ctx.globalAlpha=(t.prog<1?t.prog:t.life)*.7;ctx.strokeStyle=t.col;ctx.lineWidth=t.w;ctx.shadowBlur=12;ctx.shadowColor=t.col;ctx.beginPath();ctx.moveTo(t.x,t.y);ctx.lineTo(ex,ey);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 23. RAM â€” Shattering glass impact â€” shards burst from horizontal rim
ram:()=>{
  const shards=[];const n=mob?15:30;
  for(let i=0;i<n;i++){const a=Math.PI*(rnd(0,1));const p=rim(a,5);const spd=rnd(8,22);shards.push({x:p.x,y:p.y,vx:Math.cos(a)*spd*(Math.random()<.5?1:-1),vy:Math.sin(a)*spd,pts:[],size:rnd(10,30),rot:rnd(0,Math.PI*2),rs:rnd(-.15,.15),life:1,decay:rnd(.018,.03),col:i%2===0?c1:c2});}
  let rr=R;let f=0;const max=mob?65:90;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    rr+=14;[[rr,.7,8],[rr*.5,.35,3]].forEach(([r,al,lw])=>{ctx.save();ctx.globalAlpha=Math.max(0,al-r/350);ctx.strokeStyle=c1;ctx.lineWidth=lw;ctx.shadowBlur=40;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    shards.forEach(s=>{if(s.life<=0)return;s.x+=s.vx;s.y+=s.vy;s.vy+=.2;s.rot+=s.rs;s.life-=s.decay;ctx.save();ctx.translate(s.x,s.y);ctx.rotate(s.rot);ctx.globalAlpha=s.life*.85;ctx.strokeStyle=s.col;ctx.fillStyle=s.col+'33';ctx.lineWidth=1.5;ctx.shadowBlur=16;ctx.shadowColor=s.col;const pts=[[0,-s.size],[s.size*.6,s.size*.4],[-s.size*.5,s.size*.6]];ctx.beginPath();pts.forEach((p,pi)=>pi===0?ctx.moveTo(p[0],p[1]):ctx.lineTo(p[0],p[1]));ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 24. DONKEY â€” CAOS DEI VALORI: i numeri si staccano dalle carte, volteggiano caoticamente e si scambiano
donkey:()=>{
  // CALCI DEVASTANTI â€” due zoccoli giganti arrivano dai lati, si schiantano al centro,
  // crepe radiali sul terreno, esplosione di scintille e stelle, testo d'impatto epico
  // Phase 1 (0-22): buildup tremor + due zoccoli scivolano dai bordi verso il centro
  // Phase 2 (22-26): IMPACT â€” flash bianco + shockwave esplosivo
  // Phase 3 (26-90): crepe radiali si aprono + scintille + stelle volanti + polvere
  // Phase 4 (90-120): fade out

  const maxF=mob?100:130;

  // Zoccoli: due sagome che arrivano da sinistra e destra
  // Ogni zoccolo = ellisse scura con bordo giallo + piccoli dettagli
  const hoofL={x:cx-(vvw*.6),y:cy+rnd(-20,20),tx:cx-(mob?38:55),ty:cy,prog:0};
  const hoofR={x:cx+(vvw*.6),y:cy+rnd(-20,20),tx:cx+(mob?38:55),ty:cy,prog:0};

  // Crepe radiali (generate all'impatto)
  const cracks=[];const nCracks=mob?8:14;
  for(let i=0;i<nCracks;i++){
    const a=Math.PI*2*i/nCracks+rnd(-.18,.18);
    const len=rnd(mob?70:100,mob?160:260);
    const nSeg=Math.floor(rnd(4,8));const pts2=[{x:cx+Math.cos(a)*R*.6,y:cy+Math.sin(a)*R*.6}];
    let cx2=pts2[0].x,cy2=pts2[0].y;
    for(let s=0;s<nSeg;s++){const t=(s+1)/nSeg;const jitter=rnd(-22,22);cx2+=Math.cos(a+jitter*.05)*len/nSeg;cy2+=Math.sin(a+jitter*.05)*len/nSeg;pts2.push({x:cx2,y:cy2});}
    cracks.push({pts:pts2,prog:0,spd:rnd(.06,.13),life:1,decay:.012+i*.002,col:i%3===0?c1:i%3===1?c2:'#fff',w:rnd(mob?1.5:2,mob?3.5:5.5)});
  }

  // Scintille esplosione (born at impact point)
  const sparks=[];const nSp=mob?30:60;
  for(let i=0;i<nSp;i++){
    const a=rnd(0,Math.PI*2);const spd=rnd(mob?6:10,mob?22:38);
    sparks.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(mob?1.5:2,mob?4:6.5),life:0,decay:rnd(.02,.04),col:i%4===0?c1:i%4===1?c2:i%4===2?'#ffe566':'#fff',trail:[]});
  }

  // Stelle (â˜…) volanti
  const stars=[];const nSt=mob?6:12;
  for(let i=0;i<nSt;i++){
    const a=rnd(0,Math.PI*2);const spd=rnd(mob?4:7,mob?12:20);
    stars.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-rnd(2,5),rot:rnd(0,Math.PI*2),rs:rnd(-.15,.15),life:0,decay:.018,sz:rnd(mob?10:14,mob?22:32),col:i%2===0?c1:c2});
  }

  // Polvere/detriti (particelle grigie che cadono)
  const dust2=[];const nD=mob?18:36;
  for(let i=0;i<nD;i++){
    const a=rnd(-Math.PI*.8,-.2);const spd=rnd(mob?3:5,mob?12:20);
    dust2.push({x:cx+rnd(-80,80),y:cy+rnd(-40,40),vx:Math.cos(a)*spd+rnd(-2,2),vy:Math.sin(a)*spd-rnd(1,4),r:rnd(mob?3:4,mob?10:16),life:0,decay:.014,col:'#aaaaaa'});
  }

  // Shockwave rings at impact
  const swaves=[];for(let i=0;i<(mob?4:6);i++)swaves.push({r:mob?12:18,spd:mob?10+i*4:14+i*6,life:0,decay:.025+i*.004,col:i%2===0?c1:c2,delay:i*3});

  // Tremor pre-impatto: scuoti leggermente le posizioni hoof negli ultimi frame
  let impacted=false;
  let f=0;
  const impactF=22;// frame dell'impatto

  // Funzione stella a 5 punte
  function drawStar(ctx2,x2,y2,sz,rot2,col,alpha){
    ctx2.save();ctx2.translate(x2,y2);ctx2.rotate(rot2);ctx2.globalAlpha=alpha;
    ctx2.fillStyle=col;ctx2.shadowBlur=20;ctx2.shadowColor=col;
    ctx2.beginPath();
    for(let si=0;si<10;si++){const sr=si%2===0?sz:sz*.4;const sa=Math.PI*si/5-Math.PI/2;ctx2.lineTo(Math.cos(sa)*sr,Math.sin(sa)*sr);}
    ctx2.closePath();ctx2.fill();ctx2.restore();
  }

  (function draw(){if(f>maxF){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);

    // â”€â”€ Fase 1: avanzamento zoccoli â”€â”€
    if(f<impactF){
      const p=Math.min(1,f/impactF);// easing in
      const ease=1-(1-p)*(1-p);
      // Tremor: jitter leggero negli ultimi frame
      const jit=p>.7?rnd(-3,3):0;
      hoofL.cx=hoofL.x+(hoofL.tx-hoofL.x)*ease+jit;
      hoofL.cy=hoofL.y+(hoofL.ty-hoofL.y)*ease+jit;
      hoofR.cx=hoofR.x+(hoofR.tx-hoofR.x)*ease+jit;
      hoofR.cy=hoofR.y+(hoofR.ty-hoofR.y)*ease+jit;
    } else {
      hoofL.cx=hoofL.tx;hoofL.cy=hoofL.ty;
      hoofR.cx=hoofR.tx;hoofR.cy=hoofR.ty;
    }

    // â”€â”€ IMPATTO â”€â”€
    if(f===impactF&&!impacted){impacted=true;
      // Attiva tutto
      sparks.forEach(s=>{s.life=1;});
      stars.forEach(s=>{s.life=1;});
      dust2.forEach(d=>{d.life=1;});
      swaves.forEach(w=>{w.life=1;});
    }

    // â”€â”€ Flash impatto â”€â”€
    if(f>=impactF&&f<=impactF+4){ctx.save();ctx.globalAlpha=(impactF+5-f)*.35;ctx.fillStyle='#fff';ctx.fillRect(0,0,vvw,vvh);ctx.restore();}

    // â”€â”€ Shockwave rings â”€â”€
    swaves.forEach(w=>{if(w.life<=0)return;if(f<impactF+w.delay)return;w.r+=w.spd;w.life-=w.decay;if(w.life<=0)return;
      ctx.save();ctx.globalAlpha=w.life*.55;ctx.strokeStyle=w.col;ctx.lineWidth=mob?3:5;ctx.shadowBlur=22;ctx.shadowColor=w.col;ctx.beginPath();ctx.arc(cx,cy,w.r,0,Math.PI*2);ctx.stroke();ctx.restore();});

    // â”€â”€ Crepe radiali â”€â”€
    if(f>=impactF){cracks.forEach(cr=>{
      if(cr.prog<1)cr.prog=Math.min(1,cr.prog+cr.spd);else cr.life-=cr.decay;if(cr.life<=0)return;
      const nPts=Math.max(2,Math.floor(cr.prog*cr.pts.length));
      const fade2=f>90?Math.max(0,1-(f-90)/30):1;
      ctx.save();ctx.globalAlpha=cr.life*.85*fade2;ctx.strokeStyle=cr.col;ctx.lineWidth=cr.w;ctx.shadowBlur=18;ctx.shadowColor=cr.col;ctx.lineCap='round';ctx.lineJoin='round';
      ctx.beginPath();cr.pts.slice(0,nPts).forEach((pt,pi)=>pi===0?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y));ctx.stroke();
      // Glow crack fill
      ctx.globalAlpha=cr.life*.25*fade2;ctx.lineWidth=cr.w*3;ctx.shadowBlur=30;ctx.stroke();
      ctx.restore();});}

    // â”€â”€ Scintille â”€â”€
    sparks.forEach(s=>{if(s.life<=0)return;s.x+=s.vx;s.y+=s.vy;s.vy+=.35;s.vx*=.97;s.life-=s.decay;if(s.life<=0)return;
      const fade3=f>80?Math.max(0,1-(f-80)/40):1;
      ctx.save();ctx.globalAlpha=s.life*.9*fade3;ctx.fillStyle=s.col;ctx.shadowBlur=15;ctx.shadowColor=s.col;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
      // Trailing streak
      ctx.strokeStyle=s.col;ctx.lineWidth=s.r*.7;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x-s.vx*1.8,s.y-s.vy*1.8);ctx.stroke();ctx.restore();});

    // â”€â”€ Stelle â”€â”€
    stars.forEach(s=>{if(s.life<=0)return;s.x+=s.vx;s.y+=s.vy;s.vy+=.18;s.vx*=.96;s.rot+=s.rs;s.life-=s.decay;if(s.life<=0)return;
      const fade4=f>80?Math.max(0,1-(f-80)/40):1;drawStar(ctx,s.x,s.y,s.sz,s.rot,s.col,s.life*fade4);});

    // â”€â”€ Polvere â”€â”€
    dust2.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.12;d.r+=.4;d.vx*=.96;d.life-=d.decay;if(d.life<=0)return;
      const fade5=f>85?Math.max(0,1-(f-85)/35):1;ctx.save();ctx.globalAlpha=d.life*.3*fade5;ctx.fillStyle=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});

    // â”€â”€ Disegna zoccoli â”€â”€
    const fadeH=f>impactF+8?Math.max(0,1-(f-(impactF+8))/25):1;
    if(fadeH>0){
      const hw=mob?52:80;const hh=mob?30:46;
      // Zoccolo sinistro
      ctx.save();ctx.translate(hoofL.cx,hoofL.cy);ctx.globalAlpha=fadeH;
      ctx.shadowBlur=40;ctx.shadowColor=c1;
      ctx.fillStyle='#1a1000';ctx.strokeStyle=c1;ctx.lineWidth=mob?3:5;
      ctx.beginPath();ctx.ellipse(0,0,hw,hh,0,0,Math.PI*2);ctx.fill();ctx.stroke();
      // Dettagli zoccolo (linee orizzontali)
      ctx.strokeStyle=c1+'99';ctx.lineWidth=2;
      for(let li=0;li<3;li++){const ly=(li-1)*hh*.28;ctx.beginPath();ctx.moveTo(-hw*.7,ly);ctx.lineTo(hw*.7,ly);ctx.stroke();}
      ctx.restore();
      // Zoccolo destro
      ctx.save();ctx.translate(hoofR.cx,hoofR.cy);ctx.globalAlpha=fadeH;
      ctx.shadowBlur=40;ctx.shadowColor=c1;
      ctx.fillStyle='#1a1000';ctx.strokeStyle=c1;ctx.lineWidth=mob?3:5;
      ctx.beginPath();ctx.ellipse(0,0,hw,hh,0,0,Math.PI*2);ctx.fill();ctx.stroke();
      ctx.strokeStyle=c1+'99';ctx.lineWidth=2;
      for(let li=0;li<3;li++){const ly=(li-1)*hh*.28;ctx.beginPath();ctx.moveTo(-hw*.7,ly);ctx.lineTo(hw*.7,ly);ctx.stroke();}
      ctx.restore();
    }

    // â”€â”€ Testo impatto "CALCI!!" â”€â”€
    if(f>=impactF&&f<=impactF+35){
      const ta=Math.min(1,(f-impactF)/6)*Math.max(0,1-(f-(impactF+20))/15);
      const ts=mob?52:80;const bumpScale=f<impactF+5?1+(impactF+4-f)*.08:1;
      ctx.save();ctx.globalAlpha=ta*.95;ctx.font=`900 ${ts*bumpScale}px 'Bebas Neue',sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowBlur=40;ctx.shadowColor=c1;ctx.fillStyle=c2;ctx.fillText('CALCI!!',cx,cy-mob?90:130);
      ctx.shadowBlur=20;ctx.fillStyle='#fff';ctx.fillText('CALCI!!',cx,cy-(mob?90:130));ctx.restore();
    }

  requestAnimationFrame(draw);})();},

// 25. MOSQUITO â€” Blood drain: proboscis lances in, pulsing blood orb, crimson burst
mosquito:()=>{
  // Phase 1: multiple thin needles converge inward to card center (like a mosquito landing)
  // Phase 2: blood orb pulses at center
  // Phase 3: blood splatter erupts outward from center
  const nNeedles=mob?10:18;
  const needles=[];
  for(let i=0;i<nNeedles;i++){
    const a=Math.PI*2*i/nNeedles;
    const dist=R+rnd(30,mob?70:110);
    // Start far out, converge to cx,cy
    needles.push({sx:cx+Math.cos(a)*dist,sy:cy+Math.sin(a)*dist,tx:cx+Math.cos(a)*(R*.2),ty:cy+Math.sin(a)*(R*.2),prog:0,spd:rnd(.08,.14),life:1,col:i%3===0?'#cc0000':i%3===1?'#880000':'#ff2244',w:rnd(mob?1:1.5,mob?2.5:3.5)});
  }
  // Blood splatter particles (erupt after convergence)
  const bloods=[];for(let i=0;i<(mob?22:45);i++){const a=Math.PI*2*i/(mob?22:45)+rnd(-.2,.2);const spd=rnd(mob?5:8,mob?18:28);bloods.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(mob?2:3,mob?6:9),life:0,decay:rnd(.018,.032),col:i%4===0?'#ff2244':i%4===1?'#cc0000':i%4===2?'#880000':'#ff6688'});}
  // Drip drops
  const drips=[];for(let i=0;i<(mob?6:12);i++){const a=rnd(Math.PI*.3,Math.PI*.9);const p=rim(a,rnd(0,15));drips.push({x:p.x,y:p.y,vx:rnd(-1.5,1.5),vy:rnd(2,6),r:rnd(2,5),life:0,decay:rnd(.012,.022)});}
  let orbR=0;let orbPulse=0;let phase=0;// 0=converge, 1=pulse, 2=burst
  let f=0;const max=mob?85:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Flash on impact
    if(f===20||f===21){ctx.save();ctx.globalAlpha=(22-f)*.35;ctx.fillStyle='#cc0000';ctx.fillRect(0,0,vvw,vvh);ctx.restore();}
    // Phase control
    const allIn=needles.every(n=>n.prog>=1);
    if(f<20)phase=0;
    else if(f<45)phase=1;
    else phase=2;
    if(phase===2&&bloods[0].life===0){bloods.forEach(b=>{b.life=.01;});drips.forEach(d=>{d.life=.01;});}
    // Needles converge
    needles.forEach(n=>{
      if(phase===0||n.prog<1)n.prog=Math.min(1,n.prog+n.spd);
      const x=n.sx+(n.tx-n.sx)*n.prog;const y=n.sy+(n.ty-n.sy)*n.prog;
      const alpha=phase>=2?Math.max(0,1-(f-45)/15):n.prog*.9+.1;
      ctx.save();ctx.globalAlpha=alpha;ctx.strokeStyle=n.col;ctx.lineWidth=n.w;ctx.shadowBlur=12;ctx.shadowColor='#cc0000';ctx.lineCap='round';ctx.beginPath();ctx.moveTo(n.sx,n.sy);ctx.lineTo(x,y);ctx.stroke();ctx.restore();});
    // Blood orb pulse at center
    if(phase>=1){orbPulse+=.18;orbR=phase===1?Math.min(R*.55,orbR+3.5):Math.max(0,orbR-4);const pr=orbR+Math.sin(orbPulse)*8;if(pr>1){ctx.save();ctx.globalAlpha=phase===1?.85:Math.max(0,1-(f-45)/20)*.7;const g=ctx.createRadialGradient(cx,cy,0,cx,cy,pr);g.addColorStop(0,'#ff4466');g.addColorStop(.5,'#cc0000');g.addColorStop(1,'rgba(100,0,0,0)');ctx.fillStyle=g;ctx.shadowBlur=35;ctx.shadowColor='#cc0000';ctx.beginPath();ctx.arc(cx,cy,pr,0,Math.PI*2);ctx.fill();ctx.restore();}}
    // Blood splatter
    bloods.forEach(b=>{if(b.life<=0)return;b.x+=b.vx;b.y+=b.vy;b.vy+=.22;b.vx*=.97;b.life=Math.min(1,b.life+.12);b.life-=b.decay;
      if(mob&&(b.x<0||b.x>vvw||b.y<0||b.y>vvh)){b.life=0;return;}
      ctx.save();ctx.globalAlpha=b.life*.9;ctx.fillStyle=b.col;ctx.shadowBlur=12;ctx.shadowColor='#cc0000';ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.fill();ctx.restore();});
    // Drips
    drips.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.15;d.life=Math.min(1,d.life+.08);d.life-=d.decay;ctx.save();ctx.globalAlpha=d.life*.85;ctx.fillStyle='#cc0022';ctx.shadowBlur=8;ctx.shadowColor='#cc0000';ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#880000';ctx.lineWidth=d.r*.5;ctx.beginPath();ctx.moveTo(d.x,d.y);ctx.lineTo(d.x,d.y-d.r*2.5);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 26. SCORPION â€” MORTE LENTA: gigantesco pungiglione cala dall'alto + esplosione di veleno tossico + teschi fluttuanti
scorpion:()=>{
  // Phase 1 (0-35): il pungiglione gigante cala dall'alto con la coda che si snoda
  // Phase 2 (35-42): STRIKE â€” flash verde + shockwave letale
  // Phase 3 (42-130): esplosione veleno esplosiva, gocce tossiche, teschi, anelli pulsanti

  const maxF=mob?120:150;
  const strikeF=36;// frame del colpo

  // â”€â”€ Coda del pungiglione: serpente di segmenti che cala dall'alto â”€â”€
  // Il pungiglione arriva da cy - (vvh*.7) verso il centro della carta
  const nSegs=mob?14:22;
  const tailPts2=[];
  // Calcola i punti della coda: una curva a forma di S che parte dall'alto
  // I punti vengono calcolati frame per frame in base al progresso
  const stingerTip={x:cx,y:cy}; // target: centro carta

  // Gocce veleno esplosione (born at impact)
  const venomDrops=[];const nVD=mob?35:70;
  for(let i=0;i<nVD;i++){
    const a=rnd(0,Math.PI*2);const spd=rnd(mob?5:8,mob?25:45);
    venomDrops.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-rnd(mob?3:5,mob?8:12),
      r:rnd(mob?2:3,mob?7:12),life:0,decay:rnd(.015,.03),
      col:i%3===0?c1:i%3===1?c2:'#44ff22',trail:[]});
  }

  // Anelli veleno pulsanti
  const vRings=[];for(let i=0;i<(mob?5:8);i++){vRings.push({r:mob?15:20,spd:mob?9+i*3:12+i*5,life:0,decay:.02+i*.003,col:i%2===0?c1:c2,delay:i*4});}

  // Teschi fluttuanti
  const skulls=[];const nSk=mob?4:8;
  for(let i=0;i<nSk;i++){
    const a=rnd(0,Math.PI*2);const spd=rnd(mob?2:3,mob?6:10);
    skulls.push({x:cx+rnd(-60,60),y:cy+rnd(-40,40),vx:Math.cos(a)*spd*.5,vy:-rnd(mob?1.5:2,mob?4:7),life:0,decay:.012,sz:mob?18:28,rot:rnd(-.4,.4)});
  }

  // Particelle veleno che stillano dalla coda (phase 1)
  const drips2=[];const nDr=mob?20:40;
  for(let i=0;i<nDr;i++){drips2.push({x:cx+rnd(-80,80),y:rnd(-50,cy),vx:rnd(-1.5,1.5),vy:rnd(1,4),r:rnd(mob?1.5:2,mob?4:7),life:1,decay:.02,col:i%2===0?c1:c2,delay:rnd(0,30)});}

  // Vortice tossico (phase 3)
  const vort2=[];const nVo=mob?16:32;
  for(let i=0;i<nVo;i++){const a=Math.PI*2*i/nVo;vort2.push({a,r:rnd(R*.2,R*.6),ar:rnd(.05,.14)*(i%2===0?1:-1),vr:rnd(mob?1:2,mob?4:7),life:0,decay:.016,col:i%3===0?c1:i%3===1?c2:'#00ff44',sz:rnd(mob?2:3,mob?5:8)});}

  let struck=false;
  let f=0;

  (function draw(){if(f>maxF){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);

    // â”€â”€ STRIKE â”€â”€
    if(f===strikeF&&!struck){struck=true;
      venomDrops.forEach(d=>{d.life=1;});
      vRings.forEach(r2=>{r2.life=1;});
      skulls.forEach(s=>{s.life=1;});
      vort2.forEach(v=>{v.life=1;});
    }

    // â”€â”€ Flash al colpo â”€â”€
    if(f>=strikeF&&f<=strikeF+5){ctx.save();ctx.globalAlpha=(strikeF+6-f)*.4;ctx.fillStyle=c1;ctx.fillRect(0,0,vvw,vvh);ctx.restore();}

    // â”€â”€ Drip pre-impatto (gocce che cadono dalla coda) â”€â”€
    if(f<strikeF+20){drips2.forEach(d=>{if(f<d.delay)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.1;d.life-=d.decay;if(d.life<=0)return;
      ctx.save();ctx.globalAlpha=d.life*.7;ctx.fillStyle=d.col;ctx.shadowBlur=14;ctx.shadowColor=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});}

    // â”€â”€ Anelli veleno â”€â”€
    vRings.forEach(rg=>{if(rg.life<=0)return;if(f<strikeF+rg.delay)return;rg.r+=rg.spd;rg.life-=rg.decay;if(rg.life<=0)return;
      ctx.save();ctx.globalAlpha=rg.life*.6;ctx.strokeStyle=rg.col;ctx.lineWidth=mob?3:5;ctx.shadowBlur=25;ctx.shadowColor=rg.col;ctx.beginPath();ctx.arc(cx,cy,rg.r,0,Math.PI*2);ctx.stroke();ctx.restore();});

    // â”€â”€ Gocce veleno â”€â”€
    venomDrops.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.28;d.vx*=.97;d.life-=d.decay;if(d.life<=0)return;
      if(mob&&(d.x<-10||d.x>vvw+10||d.y<-10||d.y>vvh+10)){d.life=0;return;}
      const fade6=f>100?Math.max(0,1-(f-100)/40):1;
      ctx.save();ctx.globalAlpha=d.life*.9*fade6;ctx.fillStyle=d.col;ctx.shadowBlur=18;ctx.shadowColor=d.col;
      // Goccia (ellisse verticale)
      ctx.beginPath();ctx.ellipse(d.x,d.y,d.r*.7,d.r,0,0,Math.PI*2);ctx.fill();
      // Trailing streak di veleno
      ctx.strokeStyle=d.col;ctx.lineWidth=d.r*.6;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(d.x,d.y);ctx.lineTo(d.x-d.vx*1.5,d.y-d.vy*1.5);ctx.stroke();ctx.restore();});

    // â”€â”€ Vortice tossico â”€â”€
    if(f>strikeF&&f<strikeF+60){vort2.forEach(v=>{if(v.life<=0)return;v.a+=v.ar;v.r=Math.min(v.r+v.vr,R*.9);v.life-=v.decay;const vxP=cx+Math.cos(v.a)*v.r;const vyP=cy+Math.sin(v.a)*v.r;
      ctx.save();ctx.globalAlpha=v.life*.6;ctx.fillStyle=v.col;ctx.shadowBlur=12;ctx.shadowColor=v.col;ctx.beginPath();ctx.arc(vxP,vyP,v.sz,0,Math.PI*2);ctx.fill();ctx.restore();});}

    // â”€â”€ Teschi â”€â”€
    skulls.forEach(s=>{if(s.life<=0)return;s.x+=s.vx;s.y+=s.vy;s.vy-=.04;// fluttuano su
      s.life-=s.decay;if(s.life<=0)return;
      const fade7=f>100?Math.max(0,1-(f-100)/40):1;
      ctx.save();ctx.translate(s.x,s.y);ctx.rotate(s.rot);ctx.globalAlpha=s.life*.85*fade7;
      ctx.font=`${s.sz}px serif`;ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowBlur=25;ctx.shadowColor=c1;ctx.fillText('ğŸ’€',0,0);ctx.restore();});

    // â”€â”€ PUNGIGLIONE â€” disegna la coda che cala â”€â”€
    const tailProgress=Math.min(1,f/strikeF);
    // La punta del pungiglione scende da (cx, cy-vvh*.65) verso (cx, cy-R*.3)
    const tipStartY=cy-(mob?vvh*.65:vvh*.7);
    const tipEndY=cy-R*.3;
    const tipCurrentY=tipStartY+(tipEndY-tipStartY)*tailProgress;
    const tipCurrentX=cx+Math.sin(f*.18)*rnd(8,18)*(1-tailProgress*.8);// leggero ondeggiamento

    // Costruisci punti della coda a S
    const nS=mob?10:16;
    const segPts=[];
    for(let si=0;si<nS;si++){const t=si/(nS-1);
      const wave=Math.sin(t*Math.PI*2.2+f*.08)*(mob?20:32)*(1-tailProgress*.3);
      segPts.push({x:tipCurrentX+wave*(si/nS),y:tipCurrentY+(si/nS)*(cy-vvh*.1-tipCurrentY)});
    }
    // Aggiungi la coda che esce in alto
    for(let si2=0;si2<5;si2++){const t=si2/4;segPts.push({x:tipCurrentX+rnd(-10,10),y:cy-vvh*.1-t*(vvh*.15)});}

    // Disegna segmenti coda
    const strikeFade=f>strikeF+10?Math.max(0,1-(f-strikeF-10)/25):1;
    if(strikeFade>0&&segPts.length>1){
      for(let si=1;si<segPts.length;si++){
        const p0=segPts[si-1];const p1=segPts[si];
        const segW=mob?(16-si*.5):(26-si*.8);const hw=Math.max(3,segW*.5);
        const da=Math.atan2(p1.y-p0.y,p1.x-p0.x);
        ctx.save();ctx.translate((p0.x+p1.x)*.5,(p0.y+p1.y)*.5);ctx.rotate(da);ctx.globalAlpha=strikeFade*.95;
        ctx.fillStyle=si%2===0?c1:c2;ctx.strokeStyle='#001a00';ctx.lineWidth=1.5;
        ctx.shadowBlur=22;ctx.shadowColor=c1;
        const sLen=Math.hypot(p1.x-p0.x,p1.y-p0.y)+2;
        ctx.beginPath();ctx.ellipse(0,0,sLen*.6,hw,0,0,Math.PI*2);ctx.fill();ctx.stroke();
        // Linea centrale lucente
        ctx.strokeStyle=c2;ctx.lineWidth=mob?1.5:2.5;ctx.shadowBlur=0;ctx.beginPath();ctx.moveTo(-sLen*.3,0);ctx.lineTo(sLen*.3,0);ctx.stroke();
        ctx.restore();
      }
      // Punta del pungiglione â€” triangolo affilato luminoso
      const tipGlow=1-(f>strikeF+5?Math.max(0,1-(f-strikeF-5)/20):0)*.7;
      ctx.save();ctx.translate(tipCurrentX,tipCurrentY);ctx.globalAlpha=strikeFade*tipGlow;
      ctx.fillStyle='#ffffff';ctx.shadowBlur=45;ctx.shadowColor=c1;
      ctx.beginPath();ctx.moveTo(0,-mob?12:18);ctx.lineTo(mob?7:11,mob?10:16);ctx.lineTo(-mob?7:11,mob?10:16);ctx.closePath();ctx.fill();
      ctx.fillStyle=c1;ctx.shadowBlur=20;ctx.beginPath();ctx.moveTo(0,-mob?8:12);ctx.lineTo(mob?4:6,mob?7:11);ctx.lineTo(-mob?4:6,mob?7:11);ctx.closePath();ctx.fill();
      // Alone luminoso alla punta
      const g2=ctx.createRadialGradient(0,0,0,0,0,mob?28:40);g2.addColorStop(0,c1+'cc');g2.addColorStop(.5,c1+'44');g2.addColorStop(1,'transparent');ctx.fillStyle=g2;ctx.beginPath();ctx.arc(0,0,mob?28:40,0,Math.PI*2);ctx.fill();
      ctx.restore();
    }

  requestAnimationFrame(draw);})();},

// 27. PEACOCK

// 27. PEACOCK â€” Rainbow feather fan radiates from top of card outward
peacock:()=>{
  let f=0;const max=mob?80:115;const rayCount=mob?18:36;
  const pts=[];for(let i=0;i<(mob?40:80);i++){const spread=.6+i/(mob?40:80)*.7;const a=-Math.PI*.5+(i/(mob?40:80)-.5)*Math.PI*spread;const p=rim(a,rnd(0,20));const spd=rnd(4,14);const hue=i/(mob?40:80)*300;pts.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(2,6),life:1,decay:rnd(.012,.02),col:`hsl(${hue},100%,65%)`});}
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const spread=Math.min(1,f/30);const fade=f>85?1-(f-85)/30:1;
    for(let i=0;i<rayCount;i++){const a=-Math.PI*.5+(i/(rayCount-1)-.5)*Math.PI*1.4*spread;const hue=i/rayCount*320;const len=Math.min(1,f/35)*innerHeight*.55;ctx.save();ctx.globalAlpha=(0.4-Math.abs(i/rayCount-.5)*.7)*fade;ctx.strokeStyle=`hsl(${hue},100%,65%)`;ctx.lineWidth=4;ctx.shadowBlur=25;ctx.shadowColor=`hsl(${hue},100%,65%)`;ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*R,cy+Math.sin(a)*R);ctx.lineTo(cx+Math.cos(a)*(R+len),cy+Math.sin(a)*(R+len));ctx.stroke();ctx.restore();}
    pts.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life*fade;ctx.fillStyle=p.col;ctx.shadowBlur=12;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 28. ZEBRA â€” THUNDER HERD: waves of striped animals stampede right + ground tremor rings + dust
zebra:()=>{
  // Herd: striped ovals charging leftâ†’right in 3 staggered waves
  const herd=[];const waveN=mob?12:22;
  for(let i=0;i<waveN;i++){
    const wave=Math.floor(i*3/waveN);
    const vy=rnd(-1.5,1.5);
    herd.push({x:cx-R-rnd(60,400),y:cy+rnd(-120,120),vx:rnd(22,40),vy,
      w:rnd(28,50),h:rnd(16,30),stripes:Math.floor(rnd(3,6)),
      life:1,decay:rnd(.013,.02),delay:wave*12+rnd(0,8),
      tilt:rnd(-.18,.18)});
  }
  // Ground tremor shockwave rings from bottom
  const rings=[];for(let i=0;i<4;i++)rings.push({r:R*.3,spd:rnd(8,14)+i*3,delay:i*8,life:1,decay:.022});
  // Dust clouds from hooves
  const dust=[];for(let i=0;i<(mob?20:45);i++){const p=rim(Math.PI*.4+rnd(0,Math.PI*.4),rnd(0,50));dust.push({x:p.x,y:p.y+rnd(20,60),vx:rnd(-4,8),vy:rnd(-3,-8),r:rnd(8,22),life:1,decay:.018,delay:rnd(0,15)});}
  let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Tremor rings
    rings.forEach(rg=>{if(f<rg.delay)return;rg.r+=rg.spd;rg.life-=rg.decay;if(rg.life<=0)return;ctx.save();ctx.globalAlpha=rg.life*.55;ctx.strokeStyle=c1;ctx.lineWidth=3.5;ctx.shadowBlur=22;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,rg.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Herd
    herd.forEach(h=>{if(f<h.delay)return;h.x+=h.vx;h.y+=h.vy;h.life-=h.decay;if(h.life<=0)return;
      ctx.save();ctx.translate(h.x,h.y);ctx.rotate(h.tilt);ctx.globalAlpha=h.life*.92;
      // Body (white)
      ctx.fillStyle=c2;ctx.shadowBlur=14;ctx.shadowColor=c1;
      ctx.beginPath();ctx.ellipse(0,0,h.w*.5,h.h*.5,0,0,Math.PI*2);ctx.fill();
      // Black stripes
      ctx.fillStyle='#111';ctx.shadowBlur=0;
      for(let s=0;s<h.stripes;s++){const sx=(s/(h.stripes)-.5)*h.w*.8;ctx.fillRect(sx,-(h.h*.5),h.w*.09,h.h);}
      // Outline
      ctx.strokeStyle='#333';ctx.lineWidth=1.5;ctx.beginPath();ctx.ellipse(0,0,h.w*.5,h.h*.5,0,0,Math.PI*2);ctx.stroke();
      // Speed blur trail
      ctx.globalAlpha=h.life*.25;ctx.fillStyle=c1;ctx.beginPath();ctx.ellipse(-h.w*.7,0,h.w*.4,h.h*.3,0,0,Math.PI*2);ctx.fill();
      ctx.restore();});
    // Dust
    dust.forEach(d=>{if(f<d.delay)return;d.x+=d.vx;d.y+=d.vy;d.vy*=.94;d.r+=.7;d.life-=d.decay;if(d.life<=0)return;ctx.save();ctx.globalAlpha=d.life*.28;ctx.fillStyle=c2;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 29. SCARAB â€” Two wing-case arcs sweep open from the top rim + iridescent dust burst
scarab:()=>{
  // Due grandi archi (elitre) che si aprono verso l'alto-esterno + particelle iridescenti
  const nWings=mob?5:9;
  const wingsL=[],wingsR=[];
  for(let i=0;i<nWings;i++){
    const t=i/(nWings-1);
    const pL=rim(-Math.PI*.5-t*.1,2);const pR=rim(-Math.PI*.5+t*.1,2);
    const endAL=-Math.PI*.25-t*Math.PI*.7;const endAR=-Math.PI*.75+t*Math.PI*.7;
    const len=R+rnd(60,160)+t*80;
    const wL={sx:pL.x,sy:pL.y,cx1:cx-R*.3-t*60,cy1:cy-R*.8-t*40,ex:cx+Math.cos(endAL)*len,ey:cy+Math.sin(endAL)*len,prog:0,spd:.045+i*.006,life:1,decay:.014,col:i%2===0?c1:c2,w:rnd(3,8)};
    const wR={sx:pR.x,sy:pR.y,cx1:cx+R*.3+t*60,cy1:cy-R*.8-t*40,ex:cx+Math.cos(endAR)*len,ey:cy+Math.sin(endAR)*len,prog:0,spd:.045+i*.006,life:1,decay:.014,col:i%2===0?c2:c1,w:rnd(3,8)};
    wingsL.push(wL);wingsR.push(wR);
  }
  // Burst di particelle iridescenti dal bordo della carta
  const pts=[];const n=mob?40:80;
  for(let i=0;i<n;i++){const a=rnd(-Math.PI,0);const p=rim(a,rnd(0,15));const spd=rnd(4,13);const hue=80+i/n*120;pts.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(1.5,4),life:1,decay:rnd(.015,.025),col:`hsl(${hue},100%,65%)`});}
  let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const fade=f>max-20?1-(f-(max-20))/20:1;
    // Elitre sinistra e destra â€” archi di Bezier che si tracciano
    [wingsL,wingsR].forEach(wings=>{wings.forEach(w=>{
      if(w.prog<1)w.prog=Math.min(1,w.prog+w.spd);else w.life-=w.decay;if(w.life<=0)return;
      // Campiona la curva di Bezier fino a prog
      const nSamples=Math.max(2,Math.floor(w.prog*20));
      ctx.save();ctx.globalAlpha=(w.prog<.5?w.prog*2:w.life)*fade*.9;ctx.strokeStyle=w.col;ctx.lineWidth=w.w;ctx.shadowBlur=22;ctx.shadowColor=w.col;ctx.lineCap='round';
      ctx.beginPath();ctx.moveTo(w.sx,w.sy);
      for(let s=1;s<=nSamples;s++){const t=s/20;const x=(1-t)*(1-t)*w.sx+2*(1-t)*t*w.cx1+t*t*w.ex;const y=(1-t)*(1-t)*w.sy+2*(1-t)*t*w.cy1+t*t*w.ey;ctx.lineTo(x,y);}
      ctx.stroke();ctx.restore();});});
    // Particelle iridescenti
    pts.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vx*=.95;p.vy*=.95;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life*fade;ctx.fillStyle=p.col;ctx.shadowBlur=10;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 30. SWORDFISH/PESCE PALLA â€” INFLATE & SPIKE BURST: explosive radial spikes in all directions
swordfish:()=>{
  // Phase 1: rapid inflate rings
  const inflateRings=[];for(let i=0;i<5;i++)inflateRings.push({r:R*.3*(i+1),life:1,decay:.02,phase:i*6,done:false});
  // Phase 2: spikes shoot radially outward
  const spikes=[];const nSpikes=mob?24:48;
  for(let i=0;i<nSpikes;i++){const a=Math.PI*2*i/nSpikes;const p=rim(a,5);const len=rnd(180,320);const pts=[];for(let t=0;t<=1;t+=.05){pts.push({x:cx+Math.cos(a)*(R+t*len),y:cy+Math.sin(a)*(R+t*len)});}spikes.push({pts,progress:0,spd:rnd(.1,.18),life:1,decay:.02,col:i%3===0?c1:i%3===1?c2:'#fff',w:rnd(2,6),delay:10});}
  // Burst flash
  let burstR=0;let f=0;const max=mob?70:100;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Inflate rings pulse
    inflateRings.forEach(ir=>{if(f<ir.phase)return;ir.r+=8;ir.life-=ir.decay;if(ir.life<=0)return;ctx.save();ctx.globalAlpha=ir.life*.6;ctx.strokeStyle=c1;ctx.lineWidth=4;ctx.shadowBlur=30;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,ir.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Central burst at frame 10
    if(f>=10){burstR+=22;const al=Math.max(0,.8-burstR/600);if(al>0){ctx.save();ctx.globalAlpha=al;ctx.strokeStyle='#fff';ctx.lineWidth=8;ctx.shadowBlur=60;ctx.shadowColor=c2;ctx.beginPath();ctx.arc(cx,cy,burstR,0,Math.PI*2);ctx.stroke();ctx.restore();}}
    // Spikes
    spikes.forEach(sp=>{if(f<sp.delay)return;if(sp.progress<1)sp.progress=Math.min(1,sp.progress+sp.spd);else sp.life-=sp.decay;if(sp.life<=0)return;const nPts=Math.max(2,Math.floor(sp.progress*sp.pts.length));ctx.save();ctx.globalAlpha=(sp.progress<1?sp.progress+.3:sp.life)*.9;ctx.strokeStyle=sp.col;ctx.lineWidth=sp.w*(sp.progress<.3?sp.progress*3+.1:sp.life);ctx.shadowBlur=22;ctx.shadowColor=sp.col;ctx.lineCap='round';ctx.beginPath();sp.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
      if(nPts>0){const tip=sp.pts[nPts-1];ctx.globalAlpha=sp.life*.85;ctx.fillStyle=sp.col;ctx.beginPath();ctx.arc(tip.x,tip.y,sp.w*.5,0,Math.PI*2);ctx.fill();}ctx.restore();});
  requestAnimationFrame(draw);})();},

// 31. WOLF â€” BLOOD HOWL: crimson jaw fangs snap from sides + howl shockwave + claw gashes tear through
wolf:()=>{
  // Claw gashes: 4 diagonal parallel slashes rip across the screen
  const claws=[];const nClaws=mob?4:6;
  for(let i=0;i<nClaws;i++){const offsetY=cy+(i-(nClaws-1)/2)*50;const a=-Math.PI*.28+rnd(-.08,.08);const len=vvw*.85;const pts=[];for(let t=0;t<=1;t+=.05){pts.push({x:cx-len*.5+t*len,y:offsetY+Math.sin(t*Math.PI)*rnd(-15,15)});}
    claws.push({pts,progress:0,spd:.1+i*.015,life:1,decay:.02,col:i%2===0?c1:c2,w:rnd(3,9),delay:i*6});}
  // Fang pairs: upper+lower jaw shapes snapping from top and bottom
  const fangs=[];const nFangs=mob?6:10;
  for(let i=0;i<nFangs;i++){const sx=cx+(i-nFangs/2)*((R+20)*2/nFangs);const topY=-40;const botY=vvh+40;const tipY=cy+rnd(-30,30);const topLen=rnd(60,120);const botLen=rnd(60,120);
    fangs.push({topSy:topY,topTy:tipY-topLen,topPy:tipY,botSy:botY,botTy:tipY+botLen,botPy:tipY,x:sx,progress:0,spd:rnd(.07,.12),life:1,decay:.025,col:i%2===0?c1:c2,w:rnd(4,11),delay:i*5});}
  // Howl shockwaves: 3 massive expanding rings
  const howlRings=[];for(let i=0;i<3;i++)howlRings.push({r:R*.3,spd:rnd(10,18)+i*5,life:1,decay:.022,delay:i*12,col:i%2===0?c1:c2,w:rnd(4,9)});
  // Blood sparks
  const sparks=[];const nS=mob?25:50;
  for(let i=0;i<nS;i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,25));sparks.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(3,12),vy:Math.sin(a)*rnd(3,12)-rnd(0,3),r:rnd(2,6),life:1,decay:rnd(.018,.03),col:i%3===0?c1:i%3===1?c2:'#ff0000',delay:rnd(8,30)});}
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Claw slashes
    claws.forEach(cl=>{if(f<cl.delay)return;if(cl.progress<1)cl.progress=Math.min(1,cl.progress+cl.spd);else cl.life-=cl.decay;if(cl.life<=0)return;const nPts=Math.max(2,Math.floor(cl.progress*cl.pts.length));ctx.save();ctx.globalAlpha=(cl.progress<1?cl.progress*.7+.3:cl.life)*.88;ctx.strokeStyle=cl.col;ctx.lineWidth=cl.w*(cl.progress<.5?.5+cl.progress:cl.life);ctx.shadowBlur=28;ctx.shadowColor=cl.col;ctx.lineCap='round';ctx.beginPath();cl.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
    // Fang snap
    fangs.forEach(fg=>{if(f<fg.delay)return;if(fg.progress<1)fg.progress=Math.min(1,fg.progress+fg.spd);else fg.life-=fg.decay;if(fg.life<=0)return;const p=fg.progress;
      ctx.save();ctx.globalAlpha=(p<1?p*.6+.3:fg.life)*.9;ctx.strokeStyle=fg.col;ctx.lineWidth=fg.w*(fg.progress<.5?.4+fg.progress:fg.life);ctx.shadowBlur=30;ctx.shadowColor=fg.col;ctx.lineCap='round';
      // Top fang: from topSy to tip
      const ty=fg.topSy+(fg.topPy-fg.topSy)*p;ctx.beginPath();ctx.moveTo(fg.x,fg.topSy);ctx.quadraticCurveTo(fg.x+rnd(-15,15),fg.topTy,fg.x,ty);ctx.stroke();
      // Bottom fang
      const by=fg.botSy+(fg.botPy-fg.botSy)*p;ctx.beginPath();ctx.moveTo(fg.x,fg.botSy);ctx.quadraticCurveTo(fg.x+rnd(-15,15),fg.botTy,fg.x,by);ctx.stroke();ctx.restore();});
    // Howl rings
    howlRings.forEach(hr=>{if(f<hr.delay)return;hr.r+=hr.spd;hr.life-=hr.decay;if(hr.life<=0)return;ctx.save();ctx.globalAlpha=hr.life*.6;ctx.strokeStyle=hr.col;ctx.lineWidth=hr.w;ctx.shadowBlur=35;ctx.shadowColor=hr.col;ctx.beginPath();ctx.arc(cx,cy,hr.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Blood sparks
    sparks.forEach(s=>{if(f<s.delay)return;s.x+=s.vx;s.y+=s.vy;s.vy+=.35;s.vx*=.92;s.life-=s.decay;if(s.life<=0)return;ctx.save();ctx.globalAlpha=s.life*.9;ctx.fillStyle=s.col;ctx.shadowBlur=16;ctx.shadowColor=s.col;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 32. OSTRICH â€” Feather plume burst: giant plumes erupt from top of card sweeping sideways, then drift & shimmer
ostrich:()=>{
  // Giant feather plumes fan from top center
  const plumes=[];const nPlumes=mob?10:18;
  for(let i=0;i<nPlumes;i++){
    const spread=.9;
    const a=-Math.PI*.5+(i/(nPlumes-1)-.5)*Math.PI*spread;
    const p=rim(a,rnd(0,10));
    const pts2=[];
    const len=rnd(120,280);
    // curved feather path with drift
    const drift=rnd(-30,30);
    for(let t=0;t<=1;t+=.05){
      const wave=Math.sin(t*Math.PI*2)*drift;
      pts2.push({x:p.x+Math.cos(a)*len*t+wave*Math.cos(a+Math.PI*.5),
                 y:p.y+Math.sin(a)*len*t+wave*Math.sin(a+Math.PI*.5)});
    }
    plumes.push({pts:pts2,progress:0,spd:rnd(.05,.09),life:1,decay:.012,
                 col:i%2===0?c1:c2,w:rnd(4,9),tip:p});
  }
  // Sand dust floats downward from bottom
  const sand=[];for(let i=0;i<(mob?25:50);i++){const p=rim(Math.PI*.5+rnd(-.8,.8),rnd(0,40));sand.push({x:p.x,y:p.y,vx:rnd(-3,3),vy:rnd(2,7),r:rnd(3,9),life:1,decay:.016,col:i%2===0?c1:c2});}
  let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    plumes.forEach(pl=>{
      if(pl.progress<1)pl.progress=Math.min(1,pl.progress+pl.spd);else pl.life-=pl.decay;
      if(pl.life<=0)return;
      const nPts=Math.max(2,Math.floor(pl.progress*pl.pts.length));
      const shim=1+Math.sin(f*.12+pl.tip.x*.02)*.08;
      ctx.save();ctx.globalAlpha=(pl.progress<1?pl.progress+.1:pl.life)*.8;ctx.strokeStyle=pl.col;ctx.lineWidth=pl.w*pl.life*shim;ctx.shadowBlur=22;ctx.shadowColor=pl.col;ctx.lineCap='round';
      ctx.beginPath();pl.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
      // Feather tip glow
      if(nPts>1){const tip=pl.pts[nPts-1];ctx.globalAlpha=pl.life*.9;ctx.fillStyle=pl.col;ctx.beginPath();ctx.arc(tip.x,tip.y,pl.w*.6,0,Math.PI*2);ctx.fill();}
      ctx.restore();
    });
    sand.forEach(s=>{if(s.life<=0)return;s.x+=s.vx+Math.sin(f*.06+s.r)*.5;s.y+=s.vy;s.r+=.1;s.life-=s.decay;ctx.save();ctx.globalAlpha=s.life*.35;ctx.fillStyle=s.col;ctx.beginPath();ctx.ellipse(s.x,s.y,s.r*1.5,s.r,0,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 33. LION â€” Solar crown nova: crown spikes alternate with plasma arcs radiating outward
lion:()=>{
  const spikes=[];const n=mob?16:28;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,5);const spikeLen=rnd(80,200);const isCrown=i%3===0;spikes.push({sx:p.x,sy:p.y,progress:0,spd:rnd(.05,.09),a,len:spikeLen,w:isCrown?rnd(6,12):rnd(2,5),col:isCrown?c1:c2,life:1,decay:.015,isCrown,_prev:null});}
  // Central glow burst
  let rr=R;let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    rr+=14;[[rr,.9,14,c1],[rr*.65,.55,6,c2],[rr*.35,.25,3,c1]].forEach(([r,al,lw,col])=>{ctx.save();ctx.globalAlpha=Math.max(0,al-r/600);ctx.strokeStyle=col;ctx.lineWidth=lw;ctx.shadowBlur=55;ctx.shadowColor=col;ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    spikes.forEach(s=>{if(s.progress<1)s.progress=Math.min(1,s.progress+s.spd);else s.life-=s.decay;if(s.life<=0)return;
      const ex=s.sx+Math.cos(s.a)*s.len*s.progress;const ey=s.sy+Math.sin(s.a)*s.len*s.progress;
      ctx.save();ctx.globalAlpha=(s.progress<1?s.progress+.2:s.life)*.95;ctx.strokeStyle=s.col;ctx.lineWidth=s.w*(s.progress<.5?s.progress*2+.2:1)*s.life;ctx.shadowBlur=s.isCrown?32:16;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(s.sx,s.sy);// Crown spikes have a V-notch
      if(s.isCrown&&s.progress>.5){const midX=(s.sx+ex)/2+Math.cos(s.a+Math.PI*.5)*s.w*2;const midY=(s.sy+ey)/2+Math.sin(s.a+Math.PI*.5)*s.w*2;ctx.lineTo(midX,midY);}ctx.lineTo(ex,ey);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 34. DOG â€” Paw prints stamp outward in 3 waves + excited spark bursts
dog:()=>{
  const paws=[];const waves=[[0,1],[Math.PI*.66,18],[Math.PI*1.33,36]];
  waves.forEach(([baseA,delay])=>{const p=rim(baseA,5);for(let i=0;i<(mob?5:8);i++){const a=baseA+rnd(-.6,.6);const dist=rnd(40,180);const tx=cx+Math.cos(a)*dist;const ty=cy+Math.sin(a)*dist;paws.push({tx,ty,sx:p.x,sy:p.y,prog:0,spd:.07,size:rnd(12,22),life:1,decay:.018,col:i%2===0?c1:c2,delay,rot:a});}});
  const sparks=[];for(let i=0;i<(mob?20:40);i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));const s=rnd(6,14);sparks.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:rnd(2,4),life:1,delay:rnd(0,20),decay:rnd(.02,.035),col:i%2===0?c1:c2});}
  let f=0;const max=mob?95:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    paws.forEach(pw=>{if(f<pw.delay)return;if(pw.prog<1)pw.prog=Math.min(1,pw.prog+pw.spd);pw.life-=pw.decay;if(pw.life<=0)return;const x=pw.sx+(pw.tx-pw.sx)*pw.prog;const y=pw.sy+(pw.ty-pw.sy)*pw.prog;ctx.save();ctx.translate(x,y);ctx.rotate(pw.rot+Math.PI*.5);ctx.globalAlpha=(pw.prog<.5?pw.prog*2:pw.life)*.9;ctx.fillStyle=pw.col;ctx.shadowBlur=14;ctx.shadowColor=pw.col;// paw: 1 big pad + 4 small toes
      ctx.beginPath();ctx.arc(0,pw.size*.2,pw.size*.45,0,Math.PI*2);ctx.fill();const toePos=[[-pw.size*.5,-pw.size*.35],[-.18*pw.size,-pw.size*.65],[.18*pw.size,-pw.size*.65],[pw.size*.5,-pw.size*.35]];toePos.forEach(([tx,ty])=>{ctx.beginPath();ctx.arc(tx,ty,pw.size*.22,0,Math.PI*2);ctx.fill();});ctx.restore();});
    sparks.forEach(s=>{if(f<s.delay||s.life<=0)return;s.x+=s.vx;s.y+=s.vy;s.vy+=.18;s.vx*=.97;s.life-=s.decay;ctx.save();ctx.globalAlpha=s.life;ctx.fillStyle=s.col;ctx.shadowBlur=12;ctx.shadowColor=s.col;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 35. WEASEL â€” Shadow Z-darts: ultra-fast zigzag ghosts leave afterimage trails
weasel:()=>{
  const darts=[];const n=mob?10:20;
  for(let i=0;i<n;i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));darts.push({x:p.x,y:p.y,trail:[],a,spd:rnd(20,38),life:1,decay:.025,col:i%2===0?c1:c2,w:rnd(2,4),zigTimer:0,zigInterval:rnd(3,6),zigAmt:rnd(.5,1.2)*(Math.random()<.5?1:-1)});}
  let f=0;const max=mob?50:70;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    darts.forEach(d=>{if(d.life<=0)return;d.trail.push({x:d.x,y:d.y,a:d.life});if(d.trail.length>12)d.trail.shift();d.zigTimer++;if(d.zigTimer>=d.zigInterval){d.a+=d.zigAmt;d.zigAmt*=-1;d.zigTimer=0;}d.x+=Math.cos(d.a)*d.spd;d.y+=Math.sin(d.a)*d.spd;d.spd*=.93;d.life-=d.decay;
      // Trail
      if(d.trail.length>2){ctx.save();ctx.strokeStyle=d.col;ctx.lineWidth=d.w;ctx.shadowBlur=18;ctx.shadowColor=d.col;ctx.lineCap='round';for(let ti=1;ti<d.trail.length;ti++){ctx.globalAlpha=(ti/d.trail.length)*d.life*.8;ctx.beginPath();ctx.moveTo(d.trail[ti-1].x,d.trail[ti-1].y);ctx.lineTo(d.trail[ti].x,d.trail[ti].y);ctx.stroke();}ctx.restore();}
      // Head flash
      ctx.save();ctx.globalAlpha=d.life*.9;ctx.fillStyle='#fff';ctx.shadowBlur=14;ctx.shadowColor=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.w*1.2,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 36. FROG â€” Splash arcs + droplets from bottom of card
frog:()=>{
  const drops=[];const n=mob?25:50;
  for(let i=0;i<n;i++){const a=Math.PI*.1+Math.PI*.8*i/n;const p=rim(Math.PI*.5,rnd(0,15));const s=rnd(8,20);drops.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-rnd(3,8),r:rnd(2,6),life:1,decay:rnd(.016,.025),col:i%2===0?c1:c2,splashed:false});}
  const rings=[];let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    drops.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vy+=.4;d.vx*=.98;d.life-=d.decay;ctx.save();ctx.globalAlpha=d.life;ctx.fillStyle=d.col;ctx.shadowBlur=14;ctx.shadowColor=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();
      if(d.y>cy+innerHeight*.3&&!d.splashed){d.splashed=true;rings.push({x:d.x,r:8,spd:rnd(3,6),life:.8,decay:.025,col:d.col});}});
    rings.forEach(rg=>{rg.r+=rg.spd;rg.life-=rg.decay;if(rg.life<=0)return;ctx.save();ctx.globalAlpha=rg.life*.5;ctx.strokeStyle=rg.col;ctx.lineWidth=2;ctx.shadowBlur=12;ctx.shadowColor=rg.col;ctx.beginPath();ctx.ellipse(rg.x,cy+innerHeight*.3,rg.r,rg.r*.4,0,0,Math.PI*2);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 37. PIGEON â€” Gray feather shower drifts sideways from top rim
pigeon:()=>{
  const feathers=[];const n=mob?25:50;
  for(let i=0;i<n;i++){const a=rnd(-Math.PI*.9,-Math.PI*.1);const p=rim(a,rnd(0,40));feathers.push({x:p.x,y:p.y,vx:rnd(-3,3),vy:rnd(.5,3),r:rnd(3,8),rot:rnd(0,Math.PI*2),rs:rnd(-.06,.06),life:1,decay:rnd(.009,.016),col:i%2===0?c1:c2,seed:rnd(0,100)});}
  let f=0;const max=mob?120:160;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    feathers.forEach(p=>{if(p.life<=0)return;p.x+=p.vx+Math.sin(f*.03+p.seed)*.8;p.y+=p.vy;p.rot+=p.rs+Math.sin(f*.05+p.seed)*.02;p.life-=p.decay;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.life*.7;ctx.fillStyle=p.col;ctx.shadowBlur=8;ctx.shadowColor=p.col;ctx.beginPath();ctx.ellipse(0,0,p.r*.4,p.r,0,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 38. ELEPHANT â€” Trumpet blast: expanding fan of concentric arcs like a megaphone
elephant:()=>{
  const arcs=[];const nFan=mob?5:8;const fanSpread=Math.PI*.8;const fanDir=-Math.PI*.5;// upward
  for(let i=0;i<nFan;i++){const delay=i*10;const a1=fanDir-fanSpread/2+fanSpread*(i/nFan);const a2=fanDir-fanSpread/2+fanSpread*((i+1)/nFan);arcs.push({r:R,spd:rnd(5,10)+i*2,a1,a2,delay,life:1,decay:.018,col:i%2===0?c1:c2,w:rnd(4,9)});}
  // Debris
  const debris=[];for(let i=0;i<(mob?20:40);i++){const a=fanDir+rnd(-fanSpread*.6,fanSpread*.6);const p=rim(a,rnd(0,30));debris.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(5,14),vy:Math.sin(a)*rnd(5,14),r:rnd(4,12),life:1,delay:rnd(0,15),decay:.02,col:i%2===0?c1:c2,rot:rnd(0,Math.PI*2),rs:rnd(-.1,.1)});}
  let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    arcs.forEach(a=>{if(f<a.delay)return;a.r+=a.spd;a.life-=a.decay;if(a.life<=0||a.r>innerWidth)return;ctx.save();ctx.globalAlpha=a.life*.75;ctx.strokeStyle=a.col;ctx.lineWidth=a.w;ctx.shadowBlur=28;ctx.shadowColor=a.col;ctx.beginPath();ctx.arc(cx,cy,a.r,a.a1,a.a2);ctx.stroke();ctx.restore();});
    debris.forEach(p=>{if(f<p.delay||p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.25;p.rot+=p.rs;p.life-=p.decay;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.life*.8;ctx.fillStyle=p.col;ctx.shadowBlur=16;ctx.shadowColor=p.col;ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);ctx.restore();});
  requestAnimationFrame(draw);})();},

// 39. JAGUAR â€” Amber claw slash arcs slice from sides
jaguar:()=>{
  const slashes=[];const n=mob?5:10;
  for(let i=0;i<n;i++){const a=-Math.PI*.4+i*Math.PI*.08;const p=rim(a,5);slashes.push({progress:0,spd:rnd(.06,.1),x1:p.x,y1:p.y,cpx:cx+Math.cos(a+Math.PI*.5)*rnd(60,120),cpy:cy+Math.sin(a+Math.PI*.5)*rnd(60,120),x2:p.x+Math.cos(a)*rnd(200,400),y2:p.y+Math.sin(a)*rnd(150,300),life:1,decay:.02,col:i%2===0?c1:c2,w:rnd(4,8),_prev:null});}
  let f=0;const max=mob?60:85;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    slashes.forEach(s=>{if(s.progress>=1){s.life-=s.decay;if(s.life<=0)return;}else s.progress=Math.min(1,s.progress+s.spd);const t=s.progress;const qx=(1-t)*(1-t)*s.x1+2*(1-t)*t*s.cpx+t*t*s.x2;const qy=(1-t)*(1-t)*s.y1+2*(1-t)*t*s.cpy+t*t*s.y2;if(s._prev){ctx.save();ctx.globalAlpha=(s.progress<1?s.progress+.2:s.life)*.9;ctx.strokeStyle=s.col;ctx.lineWidth=s.w*(s.progress<1?s.progress+.4:s.life);ctx.shadowBlur=28;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(s._prev.x,s._prev.y);ctx.lineTo(qx,qy);ctx.stroke();ctx.restore();}s._prev={x:qx,y:qy};});
  requestAnimationFrame(draw);})();},

// 40. CRAB â€” Bubble clusters rise and pop from both sides
crab:()=>{
  const bubbles=[];const n=mob?30:60;
  for(let i=0;i<n;i++){const side=i%2===0?-1:1;const p=rim(side<0?Math.PI*.7:Math.PI*.3,rnd(0,40));bubbles.push({x:p.x,y:p.y,vx:rnd(-2,2),vy:-(rnd(1.5,5)),r:rnd(4,16),life:1,decay:rnd(.01,.018),col:i%2===0?c1:c2,phase:rnd(0,Math.PI*2)});}
  let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    bubbles.forEach(b=>{if(b.life<=0)return;b.x+=b.vx+Math.sin(f*.05+b.phase)*.8;b.y+=b.vy;b.life-=b.decay;ctx.save();ctx.globalAlpha=b.life*.5;ctx.strokeStyle=b.col;ctx.lineWidth=2;ctx.shadowBlur=14;ctx.shadowColor=b.col;ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);ctx.stroke();// highlight
      ctx.globalAlpha=b.life*.25;ctx.fillStyle=b.col;ctx.beginPath();ctx.arc(b.x-b.r*.25,b.y-b.r*.25,b.r*.3,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 41. BAT â€” Dark wing silhouettes orbit outward from top rim
bat:()=>{
  const bats=[];const n=mob?6:12;
  for(let i=0;i<n;i++){const a=-Math.PI*.5+(rnd(-1,1)*Math.PI*.5);const p=rim(a,rnd(0,20));const spd=rnd(4,10);bats.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd-2,phase:rnd(0,Math.PI*2),ps:rnd(.18,.28),size:rnd(18,36),life:1,decay:rnd(.012,.02),col:i%2===0?c1:c2});}
  let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    bats.forEach(b=>{if(b.life<=0)return;b.x+=b.vx;b.y+=b.vy;b.vx+=Math.sin(f*.04+b.phase)*.3;b.vx*=.98;b.vy+=.05;b.phase+=b.ps;b.life-=b.decay;const flap=Math.sin(b.phase)*b.size;ctx.save();ctx.translate(b.x,b.y);ctx.globalAlpha=b.life*.85;ctx.fillStyle=b.col;ctx.shadowBlur=15;ctx.shadowColor=b.col;
      // bat wing shape
      ctx.beginPath();ctx.ellipse(-Math.abs(flap)*.6,-b.size*.2,Math.abs(flap)*.8+3,b.size*.45,-.5,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.ellipse(Math.abs(flap)*.6,-b.size*.2,Math.abs(flap)*.8+3,b.size*.45,.5,0,Math.PI*2);ctx.fill();
      ctx.beginPath();ctx.arc(0,0,b.size*.15,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 42. HORSE â€” Galloping rhythm: hoof stamp rings in 4-beat pattern + speed arc trails
horse:()=>{
  const beats=[0,15,25,38].map((delay,i)=>{const a=Math.PI*.5+i*.4;const p=rim(a+(i%2===0?-.3:.3),rnd(0,15));return{px:p.x,py:p.y,delay,rings:[],r:0,stamped:false};});
  const streaks=[];const n=mob?16:30;
  for(let i=0;i<n;i++){const p=rim(Math.PI*.5,rnd(0,20));const a=Math.PI*.5+rnd(-.8,.8);const s=rnd(10,22);streaks.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,trail:[],life:1,delay:rnd(0,20),decay:rnd(.02,.035),col:i%2===0?c1:c2,w:rnd(2,4)});}
  let f=0;const max=mob?85:120;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    beats.forEach(b=>{if(f===b.delay)b.stamped=true;if(!b.stamped)return;b.r+=6;const life=Math.max(0,1-b.r/250);if(life<=0)return;[b.r,b.r*.6,b.r*.3].forEach((r,ri)=>{ctx.save();ctx.globalAlpha=life*(1-ri*.25)*.7;ctx.strokeStyle=ri===0?c1:c2;ctx.lineWidth=4-ri;ctx.shadowBlur=20;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(b.px,b.py,r,0,Math.PI*2);ctx.stroke();ctx.restore();});});
    streaks.forEach(s=>{if(f<s.delay||s.life<=0)return;s.trail.push({x:s.x,y:s.y});if(s.trail.length>10)s.trail.shift();s.x+=s.vx;s.y+=s.vy;s.vy+=.25;s.vx*=.96;s.life-=s.decay;if(s.trail.length>2){ctx.save();ctx.strokeStyle=s.col;ctx.lineWidth=s.w;ctx.shadowBlur=18;ctx.shadowColor=s.col;for(let ti=1;ti<s.trail.length;ti++){ctx.globalAlpha=(ti/s.trail.length)*s.life*.7;ctx.beginPath();ctx.moveTo(s.trail[ti-1].x,s.trail[ti-1].y);ctx.lineTo(s.trail[ti].x,s.trail[ti].y);ctx.stroke();}ctx.restore();}});
  requestAnimationFrame(draw);})();},

// 43. SQUIRREL â€” Autumn leaf spiral: leaves spin down from height + acorn drops bounce
squirrel:()=>{
  const leaves=[];const n=mob?30:55;
  for(let i=0;i<n;i++){const a=rnd(-Math.PI*.8,-Math.PI*.2);const p=rim(a,rnd(0,60));leaves.push({x:p.x,y:p.y+(rnd(-1,1)*30),vx:rnd(-3,3),vy:rnd(.5,3),rot:rnd(0,Math.PI*2),rs:rnd(-.12,.12),r:rnd(6,14),life:1,decay:rnd(.009,.016),seed:rnd(0,100),hue:rnd(15,50)});}
  const acorns=[];for(let i=0;i<(mob?6:12);i++){const a=rnd(-Math.PI*.7,-Math.PI*.3);const p=rim(a,rnd(0,40));acorns.push({x:p.x,y:p.y,vy:rnd(-5,-2),vx:rnd(-2,2),r:rnd(5,10),life:1,decay:.016,col:i%2===0?c1:c2,bounces:0});}
  let f=0;const max=mob?110:150;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    leaves.forEach(l=>{if(l.life<=0)return;l.x+=l.vx+Math.sin(f*.04+l.seed)*.8;l.y+=l.vy;l.rot+=l.rs;l.life-=l.decay;const col=`hsl(${l.hue},80%,58%)`;ctx.save();ctx.translate(l.x,l.y);ctx.rotate(l.rot);ctx.globalAlpha=l.life*.85;ctx.fillStyle=col;ctx.shadowBlur=10;ctx.shadowColor=col;// leaf shape
      ctx.beginPath();ctx.ellipse(0,0,l.r*.45,l.r,0,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(0,0,0,.2)';ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(0,-l.r);ctx.lineTo(0,l.r);ctx.stroke();ctx.restore();});
    acorns.forEach(a=>{if(a.life<=0)return;a.x+=a.vx;a.y+=a.vy;a.vy+=.5;if(a.y>cy+R*.5&&a.bounces<2){a.vy*=-.55;a.vx*=.8;a.bounces++;}a.life-=a.decay;ctx.save();ctx.globalAlpha=a.life;ctx.fillStyle=a.col;ctx.shadowBlur=14;ctx.shadowColor=a.col;ctx.beginPath();ctx.arc(a.x,a.y,a.r,0,Math.PI*2);ctx.fill();// cap
      ctx.fillStyle='#5a3a00';ctx.beginPath();ctx.ellipse(a.x,a.y-a.r*.5,a.r*.65,a.r*.35,0,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 44. WALRUS â€” Ice crystal formations grow from all rim points
walrus:()=>{
  const crystals=[];const n=mob?8:16;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,5);crystals.push({x:p.x,y:p.y,a,arms:[],maxLen:rnd(80,200),growSpd:rnd(4,10),life:1,decay:.012,col:i%2===0?c1:c2});}
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    crystals.forEach(cr=>{if(cr.life<=0)return;cr.life-=cr.decay;const len=Math.min(cr.maxLen,f*cr.growSpd);
      // main arm
      const ex=cr.x+Math.cos(cr.a)*len;const ey=cr.y+Math.sin(cr.a)*len;ctx.save();ctx.globalAlpha=cr.life*.8;ctx.strokeStyle=cr.col;ctx.lineWidth=3;ctx.shadowBlur=20;ctx.shadowColor=cr.col;ctx.beginPath();ctx.moveTo(cr.x,cr.y);ctx.lineTo(ex,ey);ctx.stroke();// branch arms
      for(let b=1;b<=3;b++){const blen=len*(1-b*.25);const bx=cr.x+Math.cos(cr.a)*blen;const by=cr.y+Math.sin(cr.a)*blen;[-1,1].forEach(side=>{const ba=cr.a+side*Math.PI*.4;const bl=blen*.5;ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(bx+Math.cos(ba)*bl,by+Math.sin(ba)*bl);ctx.stroke();});}
      ctx.restore();});
  requestAnimationFrame(draw);})();},

// 45. HYENA â€” Pack circling attack: predators orbit in tightening spirals then burst inward
hyena:()=>{
  const nPack=mob?5:9;
  const hunters=[];
  for(let i=0;i<nPack;i++){
    const phase=Math.PI*2*i/nPack;
    const eccen=rnd(.45,.85);
    hunters.push({phase,rx:R*2.4,ry:R*1.5*eccen,spd:rnd(.09,.16)*(i%2===0?1:-1.15),trail:[],r:rnd(6,11),life:1,decay:.016,col:i%2===0?c1:c2,spots:[{dx:rnd(-3,3),dy:rnd(-3,3),dr:rnd(1.5,3.5)},{dx:rnd(-3,3),dy:rnd(-3,3),dr:rnd(1,2.5)}]});
  }
  const sparks=[];for(let i=0;i<(mob?30:60);i++){const a=rnd(0,Math.PI*2);sparks.push({x:cx,y:cy,vx:Math.cos(a)*rnd(8,22),vy:Math.sin(a)*rnd(8,22),r:rnd(2,5),life:0,delay:52,decay:rnd(.02,.035),col:i%3===0?c1:i%3===1?c2:'#ffcc44'});}
  let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;
    ctx.clearRect(0,0,vvw,vvh);
    const shrink=Math.max(.04,1-f/max*.88);
    hunters.forEach(h=>{
      if(h.life<=0)return;
      h.phase+=h.spd;
      const x=cx+Math.cos(h.phase)*h.rx*shrink;
      const y=cy+Math.sin(h.phase)*h.ry*shrink;
      h.trail.push({x,y});if(h.trail.length>14)h.trail.shift();
      if(shrink<.08){h.life-=h.decay*5;}else{h.life-=h.decay*.08;}
      if(h.trail.length>2){ctx.save();ctx.strokeStyle=h.col;ctx.lineWidth=2;ctx.shadowBlur=14;ctx.shadowColor=h.col;
        for(let ti=1;ti<h.trail.length;ti++){ctx.globalAlpha=(ti/h.trail.length)*Math.min(1,h.life)*.65;ctx.beginPath();ctx.moveTo(h.trail[ti-1].x,h.trail[ti-1].y);ctx.lineTo(h.trail[ti].x,h.trail[ti].y);ctx.stroke();}ctx.restore();}
      ctx.save();ctx.translate(x,y);ctx.globalAlpha=Math.min(1,h.life)*.9;ctx.fillStyle=h.col;ctx.shadowBlur=18;ctx.shadowColor=h.col;
      ctx.beginPath();ctx.arc(0,0,h.r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='rgba(0,0,0,.55)';h.spots.forEach(s=>{ctx.beginPath();ctx.arc(s.dx,s.dy,s.dr,0,Math.PI*2);ctx.fill();});
      ctx.restore();
    });
    sparks.forEach(s=>{if(f<s.delay)return;if(s.life===0)s.life=.01;s.x+=s.vx;s.y+=s.vy;s.vy+=.2;s.vx*=.96;s.life=Math.min(1,s.life+.08);s.life-=s.decay;if(s.life<=0)return;ctx.save();ctx.globalAlpha=s.life;ctx.fillStyle=s.col;ctx.shadowBlur=12;ctx.shadowColor=s.col;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 46. GIRAFFE â€” Tall upward beams stretch high from top of card
giraffe:()=>{
  const beams=[];const n=mob?8:16;
  for(let i=0;i<n;i++){const a=-Math.PI*.5+rnd(-.5,.5);const p=rim(a,rnd(0,20));beams.push({x:p.x,y:p.y,progress:0,spd:rnd(.02,.04),targetY:rnd(-innerHeight*.2,-innerHeight*.8),targetX:p.x+(rnd(-1,1)*80),life:1,decay:.015,col:i%2===0?c1:c2,w:rnd(2,6)});}
  let f=0;const max=mob?90:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    beams.forEach(b=>{if(b.progress>=1){b.life-=b.decay;if(b.life<=0)return;}else b.progress=Math.min(1,b.progress+b.spd);const curY=b.y+(b.targetY-b.y)*b.progress;const curX=b.x+(b.targetX-b.x)*b.progress;ctx.save();ctx.globalAlpha=(b.progress<1?b.progress:b.life)*.8;const g=ctx.createLinearGradient(b.x,b.y,curX,curY);g.addColorStop(0,b.col+'44');g.addColorStop(1,b.col);ctx.strokeStyle=g;ctx.lineWidth=b.w*(b.progress<1?b.progress+.2:b.life);ctx.shadowBlur=25;ctx.shadowColor=b.col;ctx.beginPath();ctx.moveTo(b.x,b.y);ctx.lineTo(curX,curY);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 47. DUCK â€” Yellow ripple rings + bubble pop from bottom
duck:()=>{
  // === ANATRA â€” TRAPPOLA NASCOSTA: goccia d'acqua silenziosa â†’ impatto esplosivo â†’ piume dorate che volano ===
  // Fase 1 (f 0-20): cerchio d'acqua "calmo" che si espande lentamente + increspature sottili
  // Fase 2 (f 20-40): grande SPLASH â€” cerchi concentrici ellittici + esplosione verticale
  // Fase 3 (f 40+): piume dorate che galleggiano verso l'alto
  // Increspature tranquille pre-impatto
  const quietRipples=[];for(let i=0;i<4;i++)quietRipples.push({rx:R*.6+i*18,ry:R*.25+i*7,life:1,decay:.022,delay:i*6,col:c1});
  // Splash ellittico
  const splashRings=[];for(let i=0;i<6;i++)splashRings.push({rx:0,ry:0,maxRx:R+i*55,maxRy:(R*.4+i*22),spd:rnd(8,13)+i*3,life:1,decay:.015,delay:20+i*5,col:i%2===0?c1:c2,w:rnd(3,7)});
  // Colonna d'acqua verticale verso l'alto
  const watercol=[];const nWC=mob?20:40;
  for(let i=0;i<nWC;i++){const spread=(i/nWC-.5)*60;watercol.push({x:cx+spread+rnd(-15,15),y:cy,vy:-(rnd(8,22))-i*.3,vx:rnd(-1.5,1.5),r:rnd(3,9),life:0,delay:22+i*2,decay:rnd(.014,.025),col:i%3===0?c1:i%3===1?c2:'#fffaaa'});}
  // Piume dorate che galleggiano su
  const feathers=[];const nF=mob?15:28;
  for(let i=0;i<nF;i++){const a=rnd(-Math.PI*.9,-Math.PI*.1);const p=rim(a,rnd(0,R*.5));feathers.push({x:p.x+rnd(-80,80),y:p.y+rnd(-20,20),vx:rnd(-2.5,2.5),vy:-(rnd(.8,3.5)),rot:rnd(0,Math.PI*2),rs:rnd(-.08,.08),len:rnd(12,28),w:rnd(2,4.5),life:0,delay:35+i*4,decay:rnd(.011,.018),col:i%2===0?c1:c2});}
  // Droplets che ricadono
  const drops=[];for(let i=0;i<(mob?20:40);i++){const a=rnd(-Math.PI*.95,-Math.PI*.05);const spd=rnd(10,20);drops.push({x:cx+rnd(-40,40),y:cy,vx:Math.cos(a)*spd*.6+rnd(-2,2),vy:-rnd(5,14),r:rnd(1.5,4),life:0,delay:28+rnd(0,18),decay:rnd(.02,.032)});}
  let f=0;const max=mob?105:145;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Increspature tranquille
    quietRipples.forEach(rp=>{if(f<rp.delay||f>22)return;rp.rx+=1.5;rp.ry+=.6;rp.life-=rp.decay;if(rp.life<=0)return;ctx.save();ctx.globalAlpha=rp.life*.35;ctx.strokeStyle=rp.col;ctx.lineWidth=2;ctx.shadowBlur=10;ctx.shadowColor=rp.col;ctx.beginPath();ctx.ellipse(cx,cy,rp.rx,rp.ry,0,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Flash impatto (f 20-23)
    if(f>=20&&f<24){ctx.save();ctx.globalAlpha=(24-f)/4*.7;ctx.fillStyle='#fff';ctx.shadowBlur=70;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,R*.5,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Splash ellittico
    splashRings.forEach(sr=>{if(f<sr.delay)return;sr.rx=Math.min(sr.maxRx,sr.rx+sr.spd*1.2);sr.ry=Math.min(sr.maxRy,sr.ry+sr.spd*.45);sr.life-=sr.decay;if(sr.life<=0)return;ctx.save();ctx.globalAlpha=sr.life*.6;ctx.strokeStyle=sr.col;ctx.lineWidth=sr.w;ctx.shadowBlur=22;ctx.shadowColor=sr.col;ctx.beginPath();ctx.ellipse(cx,cy,Math.max(1,sr.rx),Math.max(1,sr.ry),0,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Colonna d'acqua
    watercol.forEach(w=>{if(f<w.delay){w.life=0;return;}w.life=Math.min(1,w.life+.15);w.x+=w.vx;w.y+=w.vy;w.vy+=.45;w.life-=w.decay;if(w.life<=0)return;ctx.save();ctx.globalAlpha=w.life*.8;ctx.fillStyle=w.col;ctx.shadowBlur=14;ctx.shadowColor=w.col;ctx.beginPath();ctx.arc(w.x,w.y,w.r*w.life+.5,0,Math.PI*2);ctx.fill();ctx.restore();});
    // Droplets
    drops.forEach(d=>{if(f<d.delay){d.life=0;return;}d.life=Math.min(1,d.life+.2);d.x+=d.vx;d.y+=d.vy;d.vy+=.5;d.life-=d.decay;if(d.life<=0)return;ctx.save();ctx.globalAlpha=d.life*.65;ctx.fillStyle=c2;ctx.shadowBlur=8;ctx.shadowColor=c1;ctx.beginPath();ctx.ellipse(d.x,d.y,d.r,d.r*1.6,d.vy>0?Math.PI/2:0,0,Math.PI*2);ctx.fill();ctx.restore();});
    // Piume dorate
    feathers.forEach(fe=>{if(f<fe.delay){fe.life=0;return;}fe.life=Math.min(1,fe.life+.09);fe.x+=fe.vx+Math.sin(f*.04+fe.rot)*0.7;fe.y+=fe.vy;fe.rot+=fe.rs;fe.life-=fe.decay;if(fe.life<=0)return;ctx.save();ctx.translate(fe.x,fe.y);ctx.rotate(fe.rot);ctx.globalAlpha=fe.life*.85;ctx.strokeStyle=fe.col;ctx.lineWidth=fe.w;ctx.shadowBlur=16;ctx.shadowColor=fe.col;ctx.lineCap='round';// forma piuma: linea curva con ramificazioni
    ctx.beginPath();ctx.moveTo(0,-fe.len*.5);ctx.quadraticCurveTo(fe.len*.3,0,0,fe.len*.5);ctx.stroke();ctx.lineWidth=fe.w*.5;ctx.globalAlpha=fe.life*.4;ctx.beginPath();ctx.moveTo(0,-fe.len*.2);ctx.lineTo(fe.len*.4,-fe.len*.05);ctx.moveTo(0,0);ctx.lineTo(fe.len*.4,fe.len*.15);ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 48. TIGER â€” BLAZING ORBIT: swirling fire stripes orbit card then detonate outward
tiger:()=>{
  // Phase 1: stripes orbit as arcs, speeding up
  const orbStripes=[];const nO=mob?8:16;
  for(let i=0;i<nO;i++){const startA=Math.PI*2*i/nO;const arc=[];for(let t=0;t<=1;t+=.05){const a=startA+t*Math.PI*.8;arc.push({x:cx+Math.cos(a)*(R+rnd(15,45)),y:cy+Math.sin(a)*(R+rnd(15,45))});}orbStripes.push({arc,angle:startA,angSpd:.06+i*.003,life:1,decay:.015,col:i%2===0?c1:c2,w:rnd(5,12),phase:'orbit',explodeA:startA,delay:i*2});}
  // Phase 2: stripes explode as radial lines
  const explodeLines=[];const nE=mob?16:32;
  for(let i=0;i<nE;i++){const a=Math.PI*2*i/nE;const p=rim(a,5);explodeLines.push({sx:p.x,sy:p.y,a,len:0,maxLen:rnd(200,380),spd:rnd(15,28),life:1,decay:.02,col:i%3===0?c1:i%3===1?c2:'#fff',w:rnd(2,7),delay:30+i*1});}
  let f=0;const max=mob?75:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Orbit phase
    orbStripes.forEach(s=>{if(f<s.delay)return;s.angle+=s.angSpd*(1+f*.02);s.angSpd=Math.min(.18,s.angSpd*1.015);
      if(f<30){s.life-=.003;if(s.life<=0)return;// Draw rotated arc
        const pts=s.arc.map(p=>{const dx=p.x-cx,dy=p.y-cy;const a=Math.atan2(dy,dx)+s.angle-s.angSpd*s.delay;const r=Math.hypot(dx,dy);return{x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r};});ctx.save();ctx.globalAlpha=s.life*.85;ctx.strokeStyle=s.col;ctx.lineWidth=s.w;ctx.shadowBlur=30;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();}});
    // Explode phase
    if(f>=25){// Central burst
      if(f===25||f===26){ctx.save();ctx.globalAlpha=.7;ctx.fillStyle='#fff';ctx.shadowBlur=80;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,R*.5,0,Math.PI*2);ctx.fill();ctx.restore();}
      explodeLines.forEach(el=>{if(f<el.delay||el.life<=0)return;el.len=Math.min(el.maxLen,el.len+el.spd);el.life-=el.decay;const ex=el.sx+Math.cos(el.a)*el.len;const ey=el.sy+Math.sin(el.a)*el.len;ctx.save();ctx.globalAlpha=el.life*.9;ctx.strokeStyle=el.col;ctx.lineWidth=el.w*el.life;ctx.shadowBlur=25;ctx.shadowColor=el.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(el.sx,el.sy);ctx.lineTo(ex,ey);ctx.stroke();ctx.restore();});}
  requestAnimationFrame(draw);})();},

// 49. MANTIS â€” COLPO MORTALE: la mantide attacca in un lampo â€” doppio slash diagonale + implosione verde + schegge velenose
mantis:()=>{
  // === Flash bianco iniziale (caricamento) ===
  // Fase 1 (f 0-18): due lame di energia verde si materializzano dagli angoli opposti avanzando verso il centro
  const blade1Pts=[];const blade2Pts=[];
  const bLen=vvw*.55;
  for(let t=0;t<=1;t+=.04){
    // lama 1: da top-left verso bottom-right passando per il centro
    blade1Pts.push({x:(cx-bLen*.5)+t*bLen,y:(cy-R*.8)+t*(R*1.6)});
    // lama 2: da top-right verso bottom-left
    blade2Pts.push({x:(cx+bLen*.5)-t*bLen,y:(cy-R*.8)+t*(R*1.6)});
  }
  const blade1={pts:blade1Pts,progress:0,spd:.08,life:1,decay:.025};
  const blade2={pts:blade2Pts,progress:0,spd:.08,life:1,decay:.025,delay:4};
  // Fase 2 (f 18-28): impatto al centro â€” shockwave verde circolare + flash
  const shockRings=[];for(let i=0;i<4;i++)shockRings.push({r:0,spd:14+i*5,life:1,decay:.03,delay:16+i*4,col:i%2===0?c1:c2,w:rnd(3,8)});
  // Schegge velenose che esplodono radialmente dall'impatto
  const venom=[];const nV=mob?30:60;
  for(let i=0;i<nV;i++){const a=rnd(0,Math.PI*2);const spd=rnd(7,22);venom.push({x:cx,y:cy,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(2,6),life:0,delay:18+rnd(0,12),decay:rnd(.022,.038),col:i%3===0?c1:i%3===1?c2:'#aaff44',trail:[]});}
  // Linee di "taglio" orizzontali che lampeggiano (cicatrici dell'attacco)
  const cuts=[];const nC=mob?3:5;
  for(let i=0;i<nC;i++){const y=cy+(i-(nC-1)/2)*50;cuts.push({y,width:0,maxW:vvw*.7,spd:rnd(50,80),life:1,decay:.028,col:i%2===0?c1:c2,w:rnd(2,5),delay:20+i*4});}
  let f=0;const max=mob?75:110;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Flash carica (f 0-3)
    if(f<4){ctx.save();ctx.globalAlpha=(1-f/4)*.55;ctx.fillStyle=c1;ctx.shadowBlur=80;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,R*.6,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Lama 1
    {const bl=blade1;if(bl.progress<1)bl.progress=Math.min(1,bl.progress+bl.spd);else bl.life-=bl.decay;const nP=Math.max(2,Math.floor(bl.progress*bl.pts.length));if(bl.life>0){ctx.save();ctx.globalAlpha=(bl.progress<.5?bl.progress*2:bl.life)*.95;ctx.strokeStyle=c1;ctx.lineWidth=12*(bl.progress<.3?bl.progress*3+.1:bl.life);ctx.shadowBlur=55;ctx.shadowColor=c1;ctx.lineCap='round';ctx.beginPath();bl.pts.slice(0,nP).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.lineWidth=3;ctx.strokeStyle='#fff';ctx.globalAlpha*=.5;ctx.beginPath();bl.pts.slice(0,nP).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();}}
    // Lama 2
    if(f>blade2.delay){const bl=blade2;if(bl.progress<1)bl.progress=Math.min(1,bl.progress+bl.spd);else bl.life-=bl.decay;const nP=Math.max(2,Math.floor(bl.progress*bl.pts.length));if(bl.life>0){ctx.save();ctx.globalAlpha=(bl.progress<.5?bl.progress*2:bl.life)*.9;ctx.strokeStyle=c2;ctx.lineWidth=9*(bl.progress<.3?bl.progress*3+.1:bl.life);ctx.shadowBlur=40;ctx.shadowColor=c2;ctx.lineCap='round';ctx.beginPath();bl.pts.slice(0,nP).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();}}
    // Impatto al centro (f 16-20)
    if(f>=16&&f<22){const al=(22-f)/6;ctx.save();ctx.globalAlpha=al*.85;ctx.fillStyle='#fff';ctx.shadowBlur=90;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,R*.7,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Shockwave rings
    shockRings.forEach(r=>{if(f<r.delay)return;r.r+=r.spd;r.spd*=.88;r.life-=r.decay;if(r.life<=0||r.r>vvw)return;ctx.save();ctx.globalAlpha=r.life*.7;ctx.strokeStyle=r.col;ctx.lineWidth=r.w;ctx.shadowBlur=30;ctx.shadowColor=r.col;ctx.beginPath();ctx.arc(cx,cy,r.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Cicatrici di taglio
    cuts.forEach(c=>{if(f<c.delay)return;c.width=Math.min(c.maxW,c.width+c.spd);c.life-=c.decay;if(c.life<=0)return;const x0=cx-c.width/2,x1=cx+c.width/2;ctx.save();ctx.globalAlpha=c.life*.8;ctx.strokeStyle=c.col;ctx.lineWidth=c.w;ctx.shadowBlur=22;ctx.shadowColor=c.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(x0,c.y);ctx.lineTo(x1,c.y);ctx.stroke();ctx.restore();});
    // Schegge velenose
    venom.forEach(v=>{if(f<v.delay){v.life=0;return;}v.life=Math.min(1,v.life+.12);v.trail.push({x:v.x,y:v.y});if(v.trail.length>6)v.trail.shift();v.x+=v.vx;v.y+=v.vy;v.vx*=.92;v.vy*=.92;v.vy+=.2;v.life-=v.decay;if(v.life<=0)return;v.trail.forEach((t,ti)=>{ctx.save();ctx.globalAlpha=(ti/v.trail.length)*v.life*.4;ctx.fillStyle=v.col;ctx.beginPath();ctx.arc(t.x,t.y,v.r*.6,0,Math.PI*2);ctx.fill();ctx.restore();});ctx.save();ctx.globalAlpha=v.life*.9;ctx.fillStyle=v.col;ctx.shadowBlur=18;ctx.shadowColor=v.col;ctx.beginPath();ctx.arc(v.x,v.y,v.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 50. MONKEY â€” Swinging arc particles from sides like vines
monkey:()=>{
  const arcs=[];const n=mob?10:20;
  for(let i=0;i<n;i++){const startA=(i/n)*Math.PI*2;const p=rim(startA,rnd(0,20));arcs.push({cx2:cx,cy2:cy,r:R+rnd(40,180),startA,curA:startA,spd:rnd(.08,.15)*(i%2===0?1:-1),trail:[],life:1,decay:.014,col:i%2===0?c1:c2,w:rnd(2,5)});}
  let f=0;const max=mob?85:120;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    arcs.forEach(a=>{if(a.life<=0)return;a.curA+=a.spd;const x=a.cx2+Math.cos(a.curA)*a.r;const y=a.cy2+Math.sin(a.curA)*a.r;a.trail.push({x,y});if(a.trail.length>20)a.trail.shift();a.r+=2;a.life-=a.decay;if(a.trail.length<2)return;ctx.save();ctx.globalAlpha=a.life*.8;ctx.strokeStyle=a.col;ctx.lineWidth=a.w;ctx.shadowBlur=16;ctx.shadowColor=a.col;ctx.lineCap='round';ctx.beginPath();a.trail.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 51. ORCA â€” Deep ocean implosion â€” rings implode inward then explode out
orca:()=>{
  let f=0;const max=mob?90:130;
  const rings=[];for(let i=0;i<6;i++){const big=innerWidth*.6+i*50;rings.push({r:big,spd:-(10+i*4),delay:i*8,life:1,decay:.016,col:i%2===0?c1:c2,phase:'in'});}
  const pts=[];for(let i=0;i<(mob?30:60);i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));const s=rnd(5,15);pts.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:rnd(2,6),life:.01,delay:35,decay:rnd(.014,.022),col:i%2===0?c1:c2});}
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    rings.forEach(rg=>{if(f<rg.delay)return;rg.r+=rg.spd;if(rg.r<R){rg.spd*=-1;rg.r=R;}rg.life-=rg.decay;if(rg.life<=0||rg.r<5)return;ctx.save();ctx.globalAlpha=rg.life*.6;ctx.strokeStyle=rg.col;ctx.lineWidth=4;ctx.shadowBlur=25;ctx.shadowColor=rg.col;ctx.beginPath();ctx.arc(cx,cy,rg.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    pts.forEach(p=>{if(f<p.delay){p.life=0;return;}p.life=Math.min(1,p.life+.15);p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.life-=p.decay;if(p.life<=0)return;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.shadowBlur=16;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 52. GORILLA â€” Chest beat: concentric shockwave rings pulse outward in 3 mighty beats + rising energy fists
gorilla:()=>{
  // 3 chest beats fire at different times
  const beats=[{t:0,done:false},{t:20,done:false},{t:38,done:false}];
  const rings=[];
  const addBeat=()=>{for(let i=0;i<4;i++){rings.push({r:R,spd:10+i*3,life:1,decay:.016+i*.004,col:i%2===0?c1:c2,w:6-i*1.2});}};
  // Rising energy fists - two vertical streaks that accelerate upward
  const fists=[];
  [[-60,0],[60,0]].forEach(([ox,oy],fi)=>{
    const p=rim(-Math.PI*.5,5);
    fists.push({x:cx+ox,y:cy+oy,vy:-rnd(5,9),vx:rnd(-.5,.5),trail:[],life:1,decay:.022,col:fi===0?c1:c2,delay:8});
  });
  // Impact debris arc outward horizontally
  const debris=[];for(let i=0;i<(mob?18:35);i++){const a=rnd(-.6,.6)+Math.PI*(i<(mob?9:17)?0:1);const p=rim(a,rnd(0,20));debris.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(8,18),vy:Math.sin(a)*rnd(4,12)-4,r:rnd(5,14),life:1,delay:4,decay:rnd(.016,.026),col:i%2===0?c1:c2,rot:rnd(0,Math.PI*2),rs:rnd(-.12,.12)});}
  let f=0;const max=mob?85:120;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    beats.forEach(b=>{if(!b.done&&f>=b.t){addBeat();b.done=true;}});
    rings.forEach(rg=>{if(rg.life<=0)return;rg.r+=rg.spd;rg.spd*=.96;rg.life-=rg.decay;ctx.save();ctx.globalAlpha=rg.life*.7;ctx.strokeStyle=rg.col;ctx.lineWidth=rg.w;ctx.shadowBlur=35;ctx.shadowColor=rg.col;ctx.beginPath();ctx.arc(cx,cy,rg.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    fists.forEach(fst=>{if(f<fst.delay)return;fst.trail.push({x:fst.x,y:fst.y});if(fst.trail.length>10)fst.trail.shift();fst.x+=fst.vx;fst.y+=fst.vy;fst.vy-=.2;fst.life-=fst.decay;if(fst.trail.length>2){ctx.save();ctx.strokeStyle=fst.col;ctx.lineWidth=8;ctx.shadowBlur=28;ctx.shadowColor=fst.col;for(let ti=1;ti<fst.trail.length;ti++){ctx.globalAlpha=(ti/fst.trail.length)*fst.life*.8;ctx.beginPath();ctx.moveTo(fst.trail[ti-1].x,fst.trail[ti-1].y);ctx.lineTo(fst.trail[ti].x,fst.trail[ti].y);ctx.stroke();}ctx.restore();}ctx.save();ctx.globalAlpha=fst.life*.9;ctx.fillStyle=fst.col;ctx.shadowBlur=22;ctx.shadowColor=fst.col;ctx.beginPath();ctx.arc(fst.x,fst.y,8,0,Math.PI*2);ctx.fill();ctx.restore();});
    debris.forEach(p=>{if(f<p.delay||p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.3;p.rot+=p.rs;p.life-=p.decay;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.life*.8;ctx.fillStyle=p.col;ctx.shadowBlur=16;ctx.shadowColor=p.col;ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);ctx.restore();});
  requestAnimationFrame(draw);})();},

// 53. PARROT â€” Tropical wing fan: curved rainbow feather arcs sweep outward rotating like a tropical bird display
parrot:()=>{
  const nFeathers=mob?12:20;
  const feathers=[];
  for(let i=0;i<nFeathers;i++){
    const hue=i/nFeathers*320+20;
    const baseAngle=Math.PI*2*i/nFeathers;
    const pts=[];
    const len=rnd(180,320);
    const curve=rnd(.6,1.4)*(i%2===0?1:-1);
    for(let t=0;t<=1;t+=.04){
      const a=baseAngle+curve*t*Math.PI*.5;
      const r=R+t*len;
      pts.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r});
    }
    feathers.push({pts,hue,progress:0,spd:rnd(.04,.07),life:1,decay:.014,w:rnd(3,7)});
  }
  // Spinning halo rings
  const halos=[];for(let i=0;i<4;i++)halos.push({r:R+i*35,angle:i*Math.PI*.5,spd:.08*(i%2===0?1:-1),life:.9-i*.12,decay:.01,hue:i*90,w:3+i});
  let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    halos.forEach(h=>{h.angle+=h.spd;h.life-=h.decay;if(h.life<=0)return;ctx.save();ctx.globalAlpha=h.life*.5;const col=`hsl(${h.hue+f*2},100%,65%)`;ctx.strokeStyle=col;ctx.lineWidth=h.w;ctx.shadowBlur=22;ctx.shadowColor=col;ctx.beginPath();ctx.arc(cx,cy,h.r,h.angle,h.angle+Math.PI*1.5);ctx.stroke();ctx.restore();});
    feathers.forEach(fe=>{
      if(fe.progress<1)fe.progress=Math.min(1,fe.progress+fe.spd);else fe.life-=fe.decay;
      if(fe.life<=0)return;
      const nPts=Math.floor(fe.progress*fe.pts.length);
      if(nPts<2)return;
      const col=`hsl(${fe.hue},100%,65%)`;
      ctx.save();ctx.globalAlpha=(fe.progress<1?fe.progress:fe.life)*.85;ctx.strokeStyle=col;ctx.lineWidth=fe.w;ctx.shadowBlur=26;ctx.shadowColor=col;ctx.lineCap='round';
      ctx.beginPath();fe.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();
      // tip dot
      const tip=fe.pts[nPts-1];ctx.globalAlpha=fe.life*.95;ctx.fillStyle=col;ctx.beginPath();ctx.arc(tip.x,tip.y,fe.w*.8,0,Math.PI*2);ctx.fill();
      ctx.restore();
    });
  requestAnimationFrame(draw);})();},

// 54. RABBIT â€” Lucky clover teleport: quad-burst sparkle portals open at 4 compass points + lucky star confetti
rabbit:()=>{
  // 4 portal rings that expand quickly at NESW
  const portals=[];
  [[0,-1],[1,0],[0,1],[-1,0]].forEach(([dx,dy],i)=>{
    const dist=R+80;
    portals.push({x:cx+dx*dist,y:cy+dy*dist,r:8,spd:rnd(5,9)+i*2,life:1,decay:.018,col:i%2===0?c1:c2,delay:i*8,phase:i*Math.PI*.5});
  });
  // Lucky star confetti scatters from each portal
  const stars=[];
  for(let i=0;i<(mob?40:80);i++){
    const qi=Math.floor(i/(mob?10:20));
    const dx=[[0,-1],[1,0],[0,1],[-1,0]][qi][0];
    const dy=[[0,-1],[1,0],[0,1],[-1,0]][qi][1];
    const dist=R+80;
    const a=rnd(0,Math.PI*2);const s=rnd(5,14);
    stars.push({x:cx+dx*dist,y:cy+dy*dist,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:rnd(3,8),rot:rnd(0,Math.PI*2),rs:rnd(-.15,.15),life:0,delay:qi*8+8,decay:rnd(.016,.028),col:i%2===0?c1:c2,pts:5});
  }
  let f=0;const max=mob?80:115;
  const drawStar=(x,y,r,pts,rot)=>{ctx.beginPath();for(let i=0;i<pts*2;i++){const a=rot+Math.PI*i/pts;const rr=i%2===0?r:r*.45;ctx.lineTo(x+Math.cos(a)*rr,y+Math.sin(a)*rr);}ctx.closePath();};
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    portals.forEach(p=>{if(f<p.delay)return;p.r+=p.spd;p.spd*=.9;p.life-=p.decay;if(p.life<=0)return;
      ctx.save();ctx.globalAlpha=p.life*.7;ctx.strokeStyle=p.col;ctx.lineWidth=4;ctx.shadowBlur=28;ctx.shadowColor=p.col;
      ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.stroke();
      ctx.globalAlpha=p.life*.25;ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r*.6,0,Math.PI*2);ctx.fill();
      ctx.restore();});
    stars.forEach(s=>{if(f<s.delay)return;if(s.life===0)s.life=.01;s.x+=s.vx;s.y+=s.vy;s.vy+=.2;s.vx*=.97;s.rot+=s.rs;s.life=Math.min(1,s.life+.1);s.life-=s.decay;if(s.life<=0)return;
      ctx.save();ctx.translate(s.x,s.y);ctx.globalAlpha=s.life;ctx.fillStyle=s.col;ctx.shadowBlur=14;ctx.shadowColor=s.col;drawStar(0,0,s.r,s.pts,s.rot);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 55. MEDUSA â€” Purple jellyfish tentacles drift from lower rim
medusa:()=>{
  const tentacles=[];const n=mob?7:14;
  for(let i=0;i<n;i++){const a=Math.PI*.2+Math.PI*.6*i/n;const p=rim(a,rnd(0,20));tentacles.push({x:p.x,y:p.y,a:a+Math.PI*.5,pts:[{x:p.x,y:p.y}],phase:rnd(0,Math.PI*2),spd:rnd(2,5),ps:rnd(.07,.12),life:1,decay:.012,col:i%2===0?c1:c2,w:rnd(2,5)});}
  // pulsing bell
  let rr=R,bellLife=1;let f=0;const max=mob?100:140;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    bellLife-=.012;rr=R+Math.sin(f*.08)*20;if(bellLife>0){ctx.save();ctx.globalAlpha=bellLife*.35;ctx.strokeStyle=c1;ctx.lineWidth=3;ctx.shadowBlur=25;ctx.shadowColor=c1;ctx.beginPath();ctx.ellipse(cx,cy,rr,rr*.6,0,Math.PI,Math.PI*2);ctx.stroke();ctx.restore();}
    tentacles.forEach(t=>{if(t.life<=0)return;t.phase+=t.ps;const last=t.pts[t.pts.length-1];const wave=Math.sin(t.phase+t.pts.length*.25)*30;t.a+=wave*.015;t.pts.push({x:last.x+Math.cos(t.a)*t.spd,y:last.y+Math.sin(t.a)*t.spd+.5});if(t.pts.length>40)t.pts.shift();t.life-=t.decay;ctx.save();ctx.globalAlpha=t.life*.8;ctx.strokeStyle=t.col;ctx.lineWidth=t.w;ctx.shadowBlur=18;ctx.shadowColor=t.col;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();t.pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 56. SKUNK â€” Toxic stink bomb: neon stench waves ripple outward with wavy toxic vapor trails
skunk:()=>{
  // Stink waves expand in oblate ellipses (wider than tall, like a gas cloud)
  const waves=[];for(let i=0;i<8;i++){waves.push({rx:R,ry:R*.5,spd:rnd(6,12)+i*2,delay:i*7,life:1,decay:.016,col:i%2===0?c1:c2,w:4-i*.3});}
  // Toxic vapor particles drift sideways + upward
  const vapors=[];for(let i=0;i<(mob?35:70);i++){
    const a=rnd(Math.PI*.7,Math.PI*2.3);const p=rim(a,rnd(0,25));
    vapors.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(.5,2.5),vy:Math.sin(a)*rnd(.5,2.5)-rnd(.5,2),r:rnd(10,28),
                 life:1,decay:rnd(.009,.015),seed:rnd(0,100),rs:rnd(-.02,.02),rot:rnd(0,Math.PI*2),
                 col:i%3===0?c1:i%3===1?c2:'rgba(180,255,130,.5)'});
  }
  // Wavy stink squiggles shoot outward
  const squiggles=[];for(let i=0;i<(mob?6:12);i++){
    const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,15));const pts3=[];
    for(let t=0;t<=1;t+=.06){const wa=a+Math.sin(t*Math.PI*4)*.4;const r2=R+t*rnd(150,250);pts3.push({x:cx+Math.cos(wa)*r2,y:cy+Math.sin(wa)*r2});}
    squiggles.push({pts:pts3,progress:0,spd:rnd(.05,.09),life:1,decay:.014,col:i%2===0?c1:c2,w:rnd(2,4)});
  }
  let f=0;const max=mob?110:150;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    waves.forEach(w=>{if(f<w.delay)return;w.rx+=w.spd*1.4;w.ry+=w.spd*.55;w.life-=w.decay;if(w.life<=0)return;ctx.save();ctx.globalAlpha=w.life*.55;ctx.strokeStyle=w.col;ctx.lineWidth=w.w;ctx.shadowBlur=22;ctx.shadowColor=w.col;ctx.beginPath();ctx.ellipse(cx,cy,w.rx,w.ry,0,0,Math.PI*2);ctx.stroke();ctx.restore();});
    squiggles.forEach(s=>{if(s.progress<1)s.progress=Math.min(1,s.progress+s.spd);else s.life-=s.decay;if(s.life<=0)return;const nPts=Math.max(2,Math.floor(s.progress*s.pts.length));ctx.save();ctx.globalAlpha=(s.progress<1?s.progress:s.life)*.75;ctx.strokeStyle=s.col;ctx.lineWidth=s.w;ctx.shadowBlur=16;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();s.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
    vapors.forEach(p=>{if(p.life<=0)return;p.x+=p.vx+Math.sin(f*.04+p.seed)*.6;p.y+=p.vy;p.r+=.4;p.rot+=p.rs;p.life-=p.decay;ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.globalAlpha=p.life*.18;ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(0,0,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 57. LADYBUG â€” Red polka-dot explosion from all rim points
ladybug:()=>{
  const dots=[];const n=mob?50:100;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,10));const s=rnd(4,12);dots.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,r:rnd(4,14),life:1,decay:rnd(.014,.024),col:i%4===0?'#000':i%4===1?c2:i%4===2?c1:'#fff',hasSpot:i%3===0});}
  let rr=R;let f=0;const max=mob?75:105;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    rr+=10;ctx.save();ctx.globalAlpha=Math.max(0,.5-rr/400);ctx.strokeStyle=c1;ctx.lineWidth=6;ctx.shadowBlur=35;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,rr,0,Math.PI*2);ctx.stroke();ctx.restore();
    dots.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.18;p.vx*=.97;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.shadowBlur=12;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();if(p.hasSpot&&p.r>6){ctx.fillStyle='#000';ctx.beginPath();ctx.arc(p.x+p.r*.25,p.y-p.r*.25,p.r*.3,0,Math.PI*2);ctx.fill();}ctx.restore();});
  requestAnimationFrame(draw);})();},

// 58. SNAIL â€” Slow golden spiral unfurls from card center-right rim
snail:()=>{
  const spirals=[];const n=mob?3:5;
  for(let i=0;i<n;i++){const startA=Math.PI*.3*i;const p=rim(startA,5);spirals.push({cx2:p.x,cy2:p.y,angle:startA,radius:0,maxR:rnd(200,350),spd:.08,radSpd:rnd(3,6),pts:[],life:1,decay:.009,col:i%2===0?c1:c2,w:rnd(2,4)});}
  let f=0;const max=mob?140:180;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    spirals.forEach(s=>{if(s.life<=0)return;if(s.radius<s.maxR){s.angle+=s.spd;s.radius+=s.radSpd;s.pts.push({x:s.cx2+Math.cos(s.angle)*s.radius,y:s.cy2+Math.sin(s.angle)*s.radius});}else{s.life-=s.decay*3;}if(s.pts.length<2)return;ctx.save();ctx.globalAlpha=s.life*.75;ctx.strokeStyle=s.col;ctx.lineWidth=s.w;ctx.shadowBlur=16;ctx.shadowColor=s.col;ctx.lineCap='round';ctx.beginPath();s.pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 59. PIG â€” Pink heart & bubble burst from all rim points
pig:()=>{
  // === MAIALE â€” NULLIFICA! Grande zero rosa lampeggiante + nuvola di fumo + coriandoli ===
  // Il "zero" che annulla il danno: scritto con il canvas, poi esplode
  let zeroScale=0;const zeroMaxR=R*.8;let zeroRot=0;
  // Onde di "annullamento" â€” cerchi che si espandono con effetto cancellazione
  const nullRings=[];for(let i=0;i<5;i++)nullRings.push({r:0,spd:rnd(9,15)+i*4,life:1,decay:.016,delay:i*10,col:i%2===0?c1:c2,w:rnd(4,9),dashed:i%2===1});
  // Nuvola di fumo rosa
  const smoke=[];const nSm=mob?16:30;
  for(let i=0;i<nSm;i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,R*.4));smoke.push({x:p.x,y:p.y,vx:rnd(-2,2),vy:-(rnd(.5,2.5)),r:rnd(20,55),life:0,delay:rnd(15,35),decay:rnd(.008,.015),col:i%2===0?c1:c2});}
  // Coriandoli / bolle che esplodono
  const confetti=[];const nCo=mob?40:80;
  for(let i=0;i<nCo;i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,20));const s=rnd(4,11);confetti.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-rnd(1,4),size:rnd(4,12),rot:rnd(0,Math.PI*2),rs:rnd(-.12,.12),life:0,delay:rnd(5,25),decay:rnd(.016,.028),col:i%3===0?c1:i%3===1?c2:'#ffb7d1',square:i%4<2});}
  // Piccole stelle (simbolo nulla / annullato)
  const xMarks=[];for(let i=0;i<(mob?6:12);i++){const a=rnd(0,Math.PI*2);const r=R+rnd(20,100);xMarks.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r,size:rnd(8,18),life:0,delay:30+i*6,decay:rnd(.022,.034),rot:rnd(0,Math.PI*.5),col:i%2===0?c1:c2});}
  let f=0;const max=mob?95:135;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Zero centrale (cresce poi rimpicciolisce)
    {const al=f<20?f/20:f<70?1:1-(f-70)/(max-70);if(al>0){zeroScale=f<20?(f/20)*zeroMaxR:f<60?zeroMaxR:zeroMaxR*(1-(f-60)/50);zeroRot+=.03;ctx.save();ctx.translate(cx,cy);ctx.rotate(zeroRot);ctx.globalAlpha=al*.85;ctx.strokeStyle=c1;ctx.lineWidth=10;ctx.shadowBlur=60;ctx.shadowColor=c1;ctx.beginPath();ctx.ellipse(0,0,zeroScale*.7,zeroScale,0,0,Math.PI*2);ctx.stroke();ctx.lineWidth=4;ctx.strokeStyle=c2;ctx.shadowBlur=20;ctx.beginPath();ctx.ellipse(0,0,zeroScale*.7,zeroScale,0,0,Math.PI*2);ctx.stroke();// Barra diagonale del "proibito"
      ctx.strokeStyle='#fff';ctx.lineWidth=7;ctx.globalAlpha=al*.5;ctx.beginPath();ctx.moveTo(-zeroScale*.5,-zeroScale*.5);ctx.lineTo(zeroScale*.5,zeroScale*.5);ctx.stroke();ctx.restore();}}
    // Onde di annullamento
    nullRings.forEach(nr=>{if(f<nr.delay)return;nr.r+=nr.spd;nr.spd*=.95;nr.life-=nr.decay;if(nr.life<=0)return;ctx.save();ctx.globalAlpha=nr.life*.55;ctx.strokeStyle=nr.col;ctx.lineWidth=nr.w;ctx.shadowBlur=25;ctx.shadowColor=nr.col;if(nr.dashed)ctx.setLineDash([12,8]);ctx.beginPath();ctx.arc(cx,cy,nr.r,0,Math.PI*2);ctx.stroke();ctx.setLineDash([]);ctx.restore();});
    // Fumo
    smoke.forEach(s=>{if(f<s.delay){s.life=0;return;}s.life=Math.min(1,s.life+.06);s.x+=s.vx;s.y+=s.vy;s.r+=.6;s.life-=s.decay;if(s.life<=0)return;ctx.save();ctx.globalAlpha=s.life*.22;ctx.fillStyle=s.col;ctx.shadowBlur=0;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});
    // X mark (annullato)
    xMarks.forEach(x=>{if(f<x.delay){x.life=0;return;}x.life=Math.min(1,x.life+.12);x.life-=x.decay;if(x.life<=0)return;ctx.save();ctx.translate(x.x,x.y);ctx.rotate(x.rot);ctx.globalAlpha=x.life*.85;ctx.strokeStyle=x.col;ctx.lineWidth=x.size*.28;ctx.shadowBlur=18;ctx.shadowColor=x.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(-x.size*.5,-x.size*.5);ctx.lineTo(x.size*.5,x.size*.5);ctx.moveTo(x.size*.5,-x.size*.5);ctx.lineTo(-x.size*.5,x.size*.5);ctx.stroke();ctx.restore();});
    // Coriandoli
    confetti.forEach(co=>{if(f<co.delay){co.life=0;return;}co.life=Math.min(1,co.life+.14);co.x+=co.vx;co.y+=co.vy;co.vy+=.2;co.vx+=Math.sin(f*.07+co.rot)*.15;co.rot+=co.rs;co.life-=co.decay;if(co.life<=0)return;ctx.save();ctx.translate(co.x,co.y);ctx.rotate(co.rot);ctx.globalAlpha=co.life*.88;ctx.fillStyle=co.col;ctx.shadowBlur=12;ctx.shadowColor=co.col;if(co.square){ctx.fillRect(-co.size/2,-co.size/2,co.size,co.size*.6);}else{ctx.beginPath();ctx.arc(0,0,co.size*.5,0,Math.PI*2);ctx.fill();}ctx.restore();});
  requestAnimationFrame(draw);})();},

// 60. CAMEL â€” DESERT MIRAGE: shimmering heat ripple wave + sand vortex tornado
camel:()=>{
  // Shimmering heat wave distortion bands sweeping leftâ†’right
  const heatBands=[];const nH=mob?5:9;
  for(let i=0;i<nH;i++){heatBands.push({x:-(vvw*.2)+i*(vvw*.15+50),y:cy+rnd(-80,80),amplitude:rnd(25,55),freq:rnd(.018,.035),spd:rnd(10,18),w:rnd(12,28),life:1,decay:.018,col:i%2===0?c1:c2,phase:rnd(0,Math.PI*2)});}
  // Sand tornado: particles spiraling in tight rising column
  const tornado=[];const nT=mob?60:120;
  for(let i=0;i<nT;i++){const a=rnd(0,Math.PI*2);const r=rnd(8,60+i*.3);const startY=cy+rnd(0,100);tornado.push({angle:a,radius:r,y:startY,angSpd:rnd(.08,.18)*(i%2===0?1:-1),vy:-(rnd(1.5,4)),yr:rnd(-15,15),r2:rnd(2,6),life:1,decay:rnd(.009,.016),col:i%3===0?c1:i%3===1?c2:'rgba(200,160,60,.6)',phase:rnd(0,Math.PI*2)});}
  // Gold dust sparkles
  const dust=[];for(let i=0;i<(mob?20:40);i++){const p=rim(rnd(0,Math.PI*2),rnd(0,40));dust.push({x:p.x,y:p.y,vx:rnd(-3,3),vy:-(rnd(1,4)),r:rnd(1.5,4),life:1,decay:rnd(.015,.025),col:i%2===0?c1:c2});}
  let f=0;const max=mob?95:130;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Heat shimmer bands
    heatBands.forEach(b=>{if(b.life<=0)return;b.x+=b.spd;b.phase+=.05;b.life-=b.decay;ctx.save();ctx.globalAlpha=b.life*.25;ctx.fillStyle=b.col;for(let x=b.x;x<b.x+200;x+=4){const y=b.y+Math.sin((x*b.freq)+b.phase)*b.amplitude;ctx.beginPath();ctx.ellipse(x,y,2,b.w*.5,Math.PI*.5,0,Math.PI*2);ctx.fill();}ctx.restore();});
    // Sand tornado
    tornado.forEach(t=>{if(t.life<=0)return;t.angle+=t.angSpd*(1+t.y/vvh*.5);t.y+=t.vy+Math.sin(f*.06+t.phase)*.5;t.radius=Math.max(5,t.radius*(1-t.vy*.003)+t.yr*.01);t.life-=t.decay;const tx=cx+Math.cos(t.angle)*t.radius;const ty=t.y;ctx.save();ctx.globalAlpha=t.life*.75;ctx.fillStyle=t.col;ctx.shadowBlur=8;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(tx,ty,t.r2,0,Math.PI*2);ctx.fill();ctx.restore();});
    // Gold sparkles
    dust.forEach(d=>{if(d.life<=0)return;d.x+=d.vx+Math.sin(f*.08)*.4;d.y+=d.vy;d.vy+=.04;d.life-=d.decay;ctx.save();ctx.globalAlpha=d.life;ctx.fillStyle=d.col;ctx.shadowBlur=14;ctx.shadowColor=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 61. FOX â€” Orange fire spiral rings + embers
fox:()=>{
  const embers=[];const n=mob?60:120;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,15));const s=rnd(3,10);embers.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-rnd(1,3),r:rnd(1,4),life:1,decay:rnd(.012,.022),hue:rnd(15,45)});}
  const spirals=[];for(let j=0;j<3;j++){const pts=[];const dir=j%2===0?1:-1;for(let i=0;i<60;i++){const a=(i/60)*Math.PI*4*dir+(j*Math.PI*.667);const r=R+(i/60)*280;pts.push({x:cx+Math.cos(a)*r,y:cy+Math.sin(a)*r});}spirals.push({pts,prog:0,spd:.02+j*.01,life:1,decay:.012,col:j%2===0?c1:c2});}
  let f=0;const max=mob?90:125;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    spirals.forEach(s=>{s.prog=Math.min(1,s.prog+s.spd);s.life-=s.decay;const pts=s.pts.slice(0,Math.floor(s.prog*s.pts.length));if(pts.length<2)return;ctx.save();ctx.globalAlpha=s.life*.7;ctx.strokeStyle=s.col;ctx.lineWidth=3;ctx.shadowBlur=20;ctx.shadowColor=s.col;ctx.beginPath();pts.forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
    embers.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vx+=Math.sin(f*.08)*.2;p.vy-=.05;p.vx*=.97;p.life-=p.decay;const col=`hsl(${p.hue},100%,65%)`;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=col;ctx.shadowBlur=14;ctx.shadowColor=col;ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life+.5,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// 62. BLACKSHEEP â€” Chaos confetti: rings of random hues expand + multicolor dots scatter from rim
blacksheep:()=>{
  // Anelli colorati a caso che si espandono â€” ogni uno di un colore diverso
  const rings=[];const nR=mob?5:8;
  for(let i=0;i<nR;i++){const hue=i/nR*360;rings.push({r:R,spd:rnd(8,15)+i*3,delay:i*8,life:1,decay:.018,col:`hsl(${hue},100%,65%)`,w:rnd(3,7)});}
  // Punti colorati (confetti) sparati in tutte le direzioni dal rim
  const dots=[];const nD=mob?50:100;
  for(let i=0;i<nD;i++){const a=rnd(0,Math.PI*2);const p=rim(a,rnd(0,10));const spd=rnd(4,15);const hue=rnd(0,360);dots.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:rnd(2,5),life:1,decay:rnd(.013,.022),col:`hsl(${hue},100%,65%)`});}
  // Punto interrogativo al centro: flash che appare e svanisce
  let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    const fade=f>max-20?1-(f-(max-20))/20:1;
    // Anelli
    rings.forEach(rg=>{if(f<rg.delay)return;rg.r+=rg.spd;rg.spd*=.96;rg.life-=rg.decay;if(rg.life<=0)return;ctx.save();ctx.globalAlpha=rg.life*.55*fade;ctx.strokeStyle=rg.col;ctx.lineWidth=rg.w;ctx.shadowBlur=22;ctx.shadowColor=rg.col;ctx.beginPath();ctx.arc(cx,cy,rg.r,0,Math.PI*2);ctx.stroke();ctx.restore();});
    // Confetti
    dots.forEach(d=>{if(d.life<=0)return;d.x+=d.vx;d.y+=d.vy;d.vx*=.95;d.vy*=.95;d.vy+=.1;d.life-=d.decay;ctx.save();ctx.globalAlpha=d.life*fade*.9;ctx.fillStyle=d.col;ctx.shadowBlur=10;ctx.shadowColor=d.col;ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();ctx.restore();});
    // "?" al centro â€” lampeggia
    if(f>5&&f<max-15){const qs=Math.min(1,(f-5)/15);ctx.save();ctx.globalAlpha=qs*(0.6+.25*Math.sin(f*.2))*fade;ctx.fillStyle=c2;ctx.shadowBlur=35;ctx.shadowColor=c2;ctx.font=`bold ${Math.round(R*.9)}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('?',cx,cy);ctx.restore();}
  requestAnimationFrame(draw);})();},

// 63. PANDA â€” Yin-yang orbit rings + black/white dot spiral
panda:()=>{
  let angle=0;let f=0;const max=mob?90:125;
  const dots=[];const n=mob?30:60;
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,10));dots.push({x:p.x,y:p.y,vx:Math.cos(a)*rnd(3,8)*(i%2===0?1:-1),vy:Math.sin(a)*rnd(3,8)*(i%2===0?1:-1),r:rnd(4,10),life:1,decay:rnd(.013,.02),col:i%2===0?'#fff':'#111',shadow:i%2===0?'#fff':'#8888ff'});}
  const rings=[];for(let i=0;i<3;i++)rings.push({r:R+i*60,spd:rnd(3,6)*(i%2===0?1:-1)*0,growing:true,life:1,decay:.012,col:i%2===0?'#fff':'#222'});
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    angle+=.06;const scale=Math.min(1,f/20);const fade=f>100?1-(f-100)/(max-100):1;const r=90*scale;
    ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);ctx.globalAlpha=fade*.7;
    ctx.fillStyle='#fff';ctx.shadowBlur=30;ctx.shadowColor='#fff';ctx.beginPath();ctx.arc(0,0,r,Math.PI*.5,Math.PI*1.5);ctx.arc(0,-r/2,r/2,Math.PI*.5,Math.PI*1.5,true);ctx.arc(0,r/2,r/2,Math.PI*.5,Math.PI*1.5);ctx.fill();
    ctx.fillStyle='#000';ctx.shadowBlur=0;ctx.beginPath();ctx.arc(0,-r/2,r/6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,r/2,r/6,0,Math.PI*2);ctx.fill();ctx.restore();
    dots.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vx*=.97;p.vy*=.97;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life*fade;ctx.fillStyle=p.col;ctx.shadowBlur=18;ctx.shadowColor=p.shadow;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

// JAGUAR (GATTO) â€” SHADOW POUNCE: dark shadow tendrils coil inward + silver redirect flash
jaguar:()=>{
  // Inward-spiraling shadow tendrils from screen edges
  const tendrils=[];const nT=mob?10:18;
  for(let i=0;i<nT;i++){const a=Math.PI*2*i/nT;const startR=rnd(vvw*.4,vvw*.65);const pts=[];for(let t=0;t<=1;t+=.04){const spiral=a+t*Math.PI*1.2;const r=startR*(1-t*.7);pts.push({x:cx+Math.cos(spiral)*r,y:cy+Math.sin(spiral)*r});}tendrils.push({pts,progress:0,spd:rnd(.06,.1),life:1,decay:.018,col:i%2===0?c1:c2,w:rnd(3,8),delay:i*3});}
  // Shadow pool expands then retracts
  let poolR=0;let poolPhase='expand';
  // Silver flash redirect: X-shaped burst
  const xLines=[];[0,Math.PI*.5,Math.PI*.25,Math.PI*.75].forEach((a,ai)=>{const p=rim(a,R*.3);xLines.push({x:p.x,y:p.y,a,len:0,maxLen:rnd(160,280),spd:rnd(20,35),life:1,decay:.025,col:ai<2?c2:c1,w:rnd(4,10),delay:25+ai*3});});
  // Dark sparks scatter
  const sparks=[];for(let i=0;i<(mob?25:50);i++){const a=rnd(0,Math.PI*2);sparks.push({x:cx,y:cy,vx:Math.cos(a)*rnd(6,16),vy:Math.sin(a)*rnd(6,16),r:rnd(2,6),life:0,delay:28,decay:rnd(.02,.035),col:i%2===0?c1:c2});}
  let f=0;const max=mob?80:115;
  (function draw(){if(f>max){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);
    // Shadow pool at card center
    if(f<25){poolR=R*.6*(f/25);ctx.save();ctx.globalAlpha=.35;ctx.fillStyle=c1;ctx.shadowBlur=40;ctx.shadowColor=c1;ctx.beginPath();ctx.arc(cx,cy,poolR,0,Math.PI*2);ctx.fill();ctx.restore();}
    // Tendrils
    tendrils.forEach(t=>{if(f<t.delay)return;if(t.progress<1)t.progress=Math.min(1,t.progress+t.spd);else t.life-=t.decay;if(t.life<=0)return;const nPts=Math.max(2,Math.floor(t.progress*t.pts.length));ctx.save();ctx.globalAlpha=(t.progress<1?t.progress+.2:t.life)*.85;ctx.strokeStyle=t.col;ctx.lineWidth=t.w*t.life;ctx.shadowBlur=28;ctx.shadowColor=t.col;ctx.lineCap='round';ctx.lineJoin='round';ctx.beginPath();t.pts.slice(0,nPts).forEach((p,pi)=>pi===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));ctx.stroke();ctx.restore();});
    // Silver X-flash
    if(f>=25&&f<27){ctx.save();ctx.globalAlpha=.8;ctx.fillStyle='#fff';ctx.shadowBlur=70;ctx.shadowColor=c2;ctx.beginPath();ctx.arc(cx,cy,R*.45,0,Math.PI*2);ctx.fill();ctx.restore();}
    xLines.forEach(xl=>{if(f<xl.delay||xl.life<=0)return;xl.len=Math.min(xl.maxLen,xl.len+xl.spd);xl.life-=xl.decay;const ex=xl.x+Math.cos(xl.a)*xl.len;const ey=xl.y+Math.sin(xl.a)*xl.len;ctx.save();ctx.globalAlpha=xl.life*.9;ctx.strokeStyle=xl.col;ctx.lineWidth=xl.w*xl.life;ctx.shadowBlur=30;ctx.shadowColor=xl.col;ctx.lineCap='round';ctx.beginPath();ctx.moveTo(xl.x,xl.y);ctx.lineTo(ex,ey);ctx.stroke();ctx.restore();});
    // Dark sparks
    sparks.forEach(s=>{if(f<s.delay){s.life=0;return;}if(s.life===0)s.life=.01;s.x+=s.vx;s.y+=s.vy;s.vy+=.15;s.vx*=.97;s.life=Math.min(1,s.life+.1);s.life-=s.decay;if(s.life<=0)return;ctx.save();ctx.globalAlpha=s.life;ctx.fillStyle=s.col;ctx.shadowBlur=14;ctx.shadowColor=s.col;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();ctx.restore();});
  requestAnimationFrame(draw);})();},

  }; // end effects object

  const fn = fx[id];
  if(fn) fn();
  else{// fallback: generic ring burst from rim
    const pts=[];const n=mob?40:75;for(let i=0;i<n;i++){const a=Math.PI*2*i/n;const p=rim(a,rnd(0,10));const s=rnd(4,12);pts.push({x:p.x,y:p.y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,r:rnd(2,5),life:1,decay:rnd(.016,.024),col:i%2===0?c1:c2});}
    let f=0;(function draw(){if(f>100){done();return;}f++;ctx.clearRect(0,0,vvw,vvh);pts.forEach(p=>{if(p.life<=0)return;p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.vx*=.97;p.life-=p.decay;ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.col;ctx.shadowBlur=14;ctx.shadowColor=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();ctx.restore();});requestAnimationFrame(draw);})();}
}

function spawnHedgehogSpines(){for(let i=0;i<12;i++){const el=document.createElement('div');el.className='spine3d';const a=(Math.PI*2*i/12);const d=170+Math.random()*60;el.style.setProperty('--dx',`${Math.cos(a)*d}px`);el.style.setProperty('--dy',`${Math.sin(a)*d}px`);el.textContent=['ğŸ’¥','âš¡','ğŸ”¥','âœ¨'][i%4];document.body.appendChild(el);setTimeout(()=>el.remove(),1400);}}
function drawSpiderWebCanvas(){const cv=document.createElement('canvas');cv.className='spider-web-canvas';cv.width=innerWidth;cv.height=innerHeight;document.body.appendChild(cv);const ctx=cv.getContext('2d');const drawWeb=(cx,cy,spk,rings,sz)=>{ctx.strokeStyle='rgba(180,100,220,.55)';ctx.lineWidth=1;ctx.shadowBlur=6;ctx.shadowColor='#9c27b0';for(let s=0;s<spk;s++){const a=s*(Math.PI*2/spk);ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(a)*sz,cy+Math.sin(a)*sz);ctx.stroke();}for(let r=1;r<=rings;r++){ctx.beginPath();for(let s=0;s<=spk;s++){const a=s*(Math.PI*2/spk);const d=r*sz/rings;if(s===0)ctx.moveTo(cx+Math.cos(a)*d,cy+Math.sin(a)*d);else ctx.lineTo(cx+Math.cos(a)*d,cy+Math.sin(a)*d);}ctx.closePath();ctx.stroke();}};drawWeb(0,0,8,5,220);drawWeb(innerWidth,0,8,5,220);drawWeb(0,innerHeight,8,5,220);drawWeb(innerWidth,innerHeight,8,5,220);drawWeb(innerWidth/2,innerHeight/2,14,7,280);setTimeout(()=>{cv.style.opacity='0';setTimeout(()=>cv.remove(),1600);},3000);}

function showAnimalAlert(icon,title,desc,color) {
  const bd=document.createElement('div');bd.className='pua-backdrop';document.body.appendChild(bd);
  const al=document.createElement('div');al.className='animal-alert';
  al.style.cssText=`border:2px solid ${color}60;box-shadow:0 0 60px ${color}40,0 20px 50px rgba(0,0,0,.8)`;
  al.innerHTML=`<span class="animal-alert-icon" style="filter:drop-shadow(0 0 20px ${color})">${icon}</span>
    <div class="animal-alert-title" style="color:${color};text-shadow:0 0 20px ${color}80">${title}</div>
    <div class="animal-alert-desc">${desc}</div>`;
  document.body.appendChild(al);
  playSound('pu');vibrate([80,40,120]);
  setTimeout(()=>{bd.style.transition='opacity .4s';bd.style.opacity='0';al.style.transition='opacity .4s';al.style.opacity='0';setTimeout(()=>{try{bd.remove();al.remove();}catch(e){}},450);},2100);
}

// â•â• Visual effects â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function spawnFloat(text,type='red',x,y){
  const el=document.createElement('div');el.className=`dmg-float ${type}`;el.textContent=text;
  const vvw=window.visualViewport?window.visualViewport.width:window.innerWidth;
  const vvh=window.visualViewport?window.visualViewport.height:window.innerHeight;
  el.style.left=(x||vvw/2-28)+'px';el.style.top=(y||vvh*.38)+'px';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1500);
  // Also trigger screen flash
  if(type==='red')flashDamage();else if(type==='green')flashHeal();
}
function flashDamage(){const el=document.createElement('div');el.className='fx-damage-flash';document.body.appendChild(el);setTimeout(()=>el.remove(),500);}
function flashHeal(){const el=document.createElement('div');el.className='fx-heal-flash';document.body.appendChild(el);setTimeout(()=>el.remove(),550);}
function flashPu(color){const el=document.createElement('div');el.className='fx-pu-flash';el.style.background=`radial-gradient(ellipse 80% 60% at 50% 50%,${color}30 0%,transparent 70%)`;document.body.appendChild(el);setTimeout(()=>el.remove(),650);}
function flashTurn(){const el=document.createElement('div');el.className='fx-turn-flash';document.body.appendChild(el);setTimeout(()=>el.remove(),750);}
function shakeScreen(){const w=document.getElementById('game-wrap');if(!w)return;w.classList.remove('screen-shake');void w.offsetWidth;w.classList.add('screen-shake');setTimeout(()=>w.classList.remove('screen-shake'),450);}
function critExplode(){const el=document.createElement('div');el.className='crit-explode';document.body.appendChild(el);setTimeout(()=>el.remove(),700);}
function confetti(){const cols=['#c0392b','#f0b040','#27d676','#3498db','#9b59b6','#e74c3c','#fff'];for(let i=0;i<80;i++){const el=document.createElement('div');el.className='confetti-bit';el.style.cssText=`left:${rnd(5,95)}vw;top:-20px;background:${cols[rnd(0,cols.length-1)]};animation-duration:${rnd(12,22)/10}s;animation-delay:${rnd(0,14)/10}s;transform:rotateZ(${rnd(0,360)}deg);width:${rnd(6,12)}px;height:${rnd(10,18)}px;`;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}}
function triggerEliminationAnim(name){
  playSound('elim');vibrate([120,60,120,60,250]);
  for(let i=0;i<14;i++){const b=document.createElement('div');b.className='blood-drop';const sz=rnd(14,36);b.style.cssText=`width:${sz}px;height:${sz*1.4}px;left:${rnd(15,85)}vw;top:${rnd(20,70)}vh;--rot:${rnd(-60,60)}deg;animation-duration:${rnd(8,14)/10}s;animation-delay:${rnd(0,4)/10}s;`;document.body.appendChild(b);setTimeout(()=>b.remove(),1700);}
  const w=document.createElement('div');w.className='elim-anim-wrap';
  w.innerHTML=`<div class="elim-skull">ğŸ’€</div><div class="elim-name">${name}</div><div class="elim-sub">Ã¨ stato eliminato!</div>`;
  document.body.appendChild(w);setTimeout(()=>w.remove(),2600);
}
function toast(msg,dur=2500){const el=document.createElement('div');el.className='toast-v2';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>{el.classList.add('out');},dur-300);setTimeout(()=>el.remove(),dur);}

// â•â• Firebase helpers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genRoomId(){return Math.random().toString(36).substr(2,4).toUpperCase();}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');
  // Particles only needed on home screen â€” stop during gameplay to save resources
  if(id==='screen-home'||id==='screen-join'||id==='screen-lobby'){if(window._startParticles)window._startParticles();}
  else{if(window._stopParticles)window._stopParticles();}
}
function showOverlay(id){document.getElementById(id).classList.add('show');}
function closeOverlay(id){document.getElementById(id).classList.remove('show');}
async function dbSet(p,d){const{db,ref,set}=window._fb;await set(ref(db,p),d);}
async function dbUpdate(p,d){const{db,ref,update}=window._fb;await update(ref(db,p),d);}
async function dbGet(p){const{db,ref,get}=window._fb;const s=await get(ref(db,p));return s.exists()?s.val():null;}
function dbListen(p,cb){const{db,ref,onValue}=window._fb;const unsub=onValue(ref(db,p),s=>cb(s.exists()?s.val():null));G.unsubscribes.push(unsub);}
function dbUnsubAll(){G.unsubscribes.forEach(fn=>{try{fn();}catch(e){}});G.unsubscribes=[];}
// Log system with micro-batching (max 15ms delay, max 10 entries per batch)
const _logQueue=[];let _logFlushTO=null;
function addLog(html,type='system'){
  if(!window._fb||!G.roomId)return;
  _logQueue.push({html,ts:Date.now(),type});
  if(!_logFlushTO) _logFlushTO=setTimeout(_flushLogs,15);
}
function _flushLogs(){
  _logFlushTO=null;
  if(!_logQueue.length)return Promise.resolve();
  const batch=_logQueue.splice(0,10);
  const{db,ref,update}=window._fb;
  const upd={};
  batch.forEach(entry=>{const k='log_'+entry.ts+'_'+Math.random().toString(36).substr(2,4);upd[k]=entry;});
  return update(ref(db,`rooms/${G.roomId}/log`),upd).catch(()=>{});
}
async function flushAllLogs(){
  // Flush tutti i log in coda prima di terminare la partita
  clearTimeout(_logFlushTO);_logFlushTO=null;
  const promises=[];
  while(_logQueue.length){
    const batch=_logQueue.splice(0,10);
    const{db,ref,update}=window._fb;
    const upd={};
    batch.forEach(entry=>{const k='log_'+entry.ts+'_'+Math.random().toString(36).substr(2,4);upd[k]=entry;});
    promises.push(update(ref(db,`rooms/${G.roomId}/log`),upd).catch(()=>{}));
  }
  if(promises.length) await Promise.all(promises);
}

// â•â• Setup â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  // BUG FIX: empty player fields at start
  for(let i=0;i<4;i++) addPlayerField('');
  document.getElementById('setup-hp').value=300;
})();
function addPlayerField(defaultName){
  const list=document.getElementById('players-list');
  if(list.children.length>=17){toast('Max 17 giocatori');return;}
  const n=list.children.length+1;
  const row=document.createElement('div');row.className='player-row';
  const val=defaultName||'';
  row.innerHTML=`<input type="text" value="${val}" placeholder="Giocatore ${n}" maxlength="16"><button class="btn-remove" onclick="this.parentElement.remove()">Ã—</button>`;
  list.appendChild(row);
}
function selectMode(m){
  G.gameMode=m==='test'?'classic':m; // test mode uses classic rules
  G.isTestMode=(m==='test');
  ['classic','hardcore','chaos','test'].forEach(id=>{const el=document.getElementById('mode-'+id);if(el)el.classList.toggle('selected',m===id);});
  const descs={
    classic:'ğŸ´ Classica: vedi i valori delle carte, scegli il powerup dopo ogni turno.',
    hardcore:'ğŸ’€ Hardcore: carte coperte! Scegli alla cieca. Poi scegli il powerup.',
    chaos:'ğŸŒ€ Caos: carte coperte + powerup casuale assegnato automaticamente ogni turno!',
    test:'ğŸ§ª Test: il Master gioca per tutti i giocatori. Nessuna lobby, parte subito. Perfetto per testare i powerup!'
  };
  const el=document.getElementById('mode-desc');if(el)el.textContent=descs[m]||'';
  // Update button label
  const btn=document.getElementById('btn-create-game');
  if(btn)btn.textContent=m==='test'?'ğŸ§ª AVVIA TEST':'âš”ï¸ CREA PARTITA';
}
function toggleLog(){const h=document.getElementById('log-header');const l=document.getElementById('log-list');if(l.style.display==='none'&&G._logForcedHide)return;G._logOpen=!G._logOpen;h.classList.toggle('open',G._logOpen);l.style.display=G._logOpen?'block':'none';}

// â•â• Create game â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createGame(){
  if(G.isTestMode){await createGameTest();return;}
  if(!window._fb){toast('âš ï¸ Firebase non configurato!');return;}
  const masterName=document.getElementById('master-name').value.trim()||'Master';
  const hp=parseInt(document.getElementById('setup-hp').value)||300;
  const inputs=document.querySelectorAll('#players-list .player-row input');
  const extras=Array.from(inputs).map(i=>i.value.trim()).filter(Boolean);
  if(extras.length<1){toast('Aggiungi almeno 1 giocatore');return;}
  const roomId=genRoomId();
  G.roomId=roomId;G.playerName=masterName;G.isMaster=true;G.isSpectator=false;
  const allNames=[masterName,...extras];
  const players={};
  allNames.forEach((name,i)=>{
    players['p'+i]={id:'p'+i,name,hp,maxHp:hp,alive:true,ismaster:i===0,joined:true,
      skipNext:false,activeBug:false};
  });
  // Apply mode bans
  const puEnabled={};
  const bans=MODE_BANS[G.gameMode]||[];
  POWERUPS.forEach(p=>puEnabled[p.id]=!bans.includes(p.id));
  const state={
    status:'lobby',mode:G.gameMode,initialHp:hp,direction:1,
    currentTurnIndex:0,turnCount:0,gameStartTime:Date.now(),
    players,playerOrder:allNames.map((_,i)=>'p'+i),
    cards:[],activePowerups:{},puEnabled,log:{},stats:{},
    tickCard:null,moscaCard:null,butterflyActive:false,butterflyOwner:null,butterflyCards:{},
    chameleonUsed:false,
  };
  await dbSet(`rooms/${roomId}`,state);
  G.playerId='p0';
  showLobby(roomId,players);
}

// â•â• Test Mode â€” skip lobby, master plays for all â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createGameTest(){
  if(!window._fb){toast('âš ï¸ Firebase non configurato!');return;}
  const masterName=document.getElementById('master-name').value.trim()||'Master';
  const hp=parseInt(document.getElementById('setup-hp').value)||300;
  const inputs=document.querySelectorAll('#players-list .player-row input');
  const extras=Array.from(inputs).map(i=>i.value.trim()).filter(Boolean);
  if(extras.length<1){toast('Aggiungi almeno 1 altro giocatore per il test');return;}
  const roomId=genRoomId();
  G.roomId=roomId;G.playerName=masterName;G.isMaster=true;G.isSpectator=false;G.isTestMode=true;
  G.playerId='p0';
  const allNames=[masterName,...extras];
  const players={};
  allNames.forEach((name,i)=>{
    players['p'+i]={id:'p'+i,name,hp,maxHp:hp,alive:true,ismaster:i===0,joined:true,
      skipNext:false,activeBug:false};
  });
  const puEnabled={};
  POWERUPS.forEach(p=>puEnabled[p.id]=true); // all PU enabled in test mode
  const playerOrder=allNames.map((_,i)=>'p'+i);
  const cards=generateCards(players,'classic');
  // Start directly as 'playing' â€” no lobby needed
  const state={
    status:'playing',mode:'classic',initialHp:hp,direction:1,
    currentTurnIndex:Math.floor(Math.random()*Object.values(players).filter(p=>p.alive).length),turnCount:1,gameStartTime:Date.now(),
    players,playerOrder,
    cards,activePowerups:{},puEnabled,log:{},
    tickCard:null,moscaCard:null,butterflyActive:false,butterflyOwner:null,butterflyCards:{},
    chameleonUsed:false,stats:{},
  };
  await dbSet(`rooms/${roomId}`,state);
  toast(`ğŸ§ª Test avviato! Stanza: ${roomId}`);
  startPlayingScreen();
}

// â•â• Lobby â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLobby(roomId,players){
  showScreen('screen-lobby');
  document.getElementById('room-code-display').textContent=roomId;
  // Show/hide start button based on master role
  const startBtn=document.getElementById('start-btn');
  const waitMsg=document.getElementById('lobby-waiting-msg');
  if(startBtn) startBtn.style.display=G.isMaster?'block':'none';
  if(waitMsg) waitMsg.style.display=G.isMaster?'none':'block';
  const qrEl=document.getElementById('qr-container');qrEl.innerHTML='';
  const url=`${location.origin}${location.pathname}?room=${roomId}`;
  new QRCode(qrEl,{text:url,width:160,height:160,colorDark:'#000',colorLight:'#fff'});
  dbListen(`rooms/${roomId}/players`,data=>{
    if(!data)return;
    const wrap=document.getElementById('waiting-players');wrap.innerHTML='';
    Object.values(data).forEach(p=>{
      const d=document.createElement('div');d.className=`lobby-player${p.ismaster?' master':''}`;
      d.innerHTML=`<div class="lobby-dot"></div><span style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700">${p.name}</span>${p.ismaster?'<span style="margin-left:auto;font-size:11px;color:var(--gold);letter-spacing:1px">MASTER</span>':''}`;
      wrap.appendChild(d);
    });
  });
  dbListen(`rooms/${roomId}/status`,status=>{if(status==='playing')startPlayingScreen();});
}
function copyRoomLink(){navigator.clipboard.writeText(`${location.origin}${location.pathname}?room=${G.roomId}`).then(()=>toast('ğŸ”— Link copiato!'));}

async function startGame(){
  const room=await dbGet(`rooms/${G.roomId}`);if(!room)return;
  if(Object.values(room.players).filter(p=>p.alive).length<2){toast('Servono almeno 2 giocatori');return;}
  const cards=generateCards(room.players,room.mode);
  const playerCount=Object.values(room.players).filter(p=>p.alive).length;
  const randStart=Math.floor(Math.random()*playerCount);
  await dbUpdate(`rooms/${G.roomId}`,{status:'playing',cards,currentTurnIndex:randStart,turnCount:1,gameStartTime:Date.now()});
}
function generateCards(players,mode){
  const alive=Object.entries(players).filter(([_,p])=>p.alive);
  return [...alive].sort(()=>Math.random()-.5).map(([pid,p],i)=>({id:'c'+i,value:rnd(0,100),assignedTo:pid,assignedName:p.name}));
}

let _selectedJoinName=null;
function onCodeInput(v){if(v.length!==4)return;loadRoomNames();}
async function loadRoomNames(){
  if(!window._fb){toast('âš ï¸ Firebase non configurato!');return;}
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  if(code.length!==4){toast('Inserisci il codice stanza a 4 lettere');return;}
  const room=await dbGet(`rooms/${code}`);
  if(!room){toast('Stanza non trovata');return;}
  const listEl=document.getElementById('join-name-list');
  const fieldEl=document.getElementById('join-name-field');
  const btnEl=document.getElementById('join-btn');
  _selectedJoinName=null;btnEl.style.display='none';
  listEl.innerHTML='';
  const players=room.players||{};
  const names=Object.values(players).filter(p=>!p.ismaster).map(p=>p.name);
  if(!names.length){toast('Nessun giocatore in questa stanza');return;}
  names.forEach(name=>{
    const btn=document.createElement('button');btn.className='btn btn-ghost btn-sm';btn.textContent=name;
    btn.style.cssText='text-align:left;padding:12px 16px;font-size:15px;font-weight:700;font-family:"Rajdhani",sans-serif;letter-spacing:.5px;transition:.2s';
    btn.onclick=()=>{document.querySelectorAll('#join-name-list .btn').forEach(b=>b.style.background='');btn.style.background='rgba(200,146,42,.15)';btn.style.borderColor='rgba(200,146,42,.4)';_selectedJoinName=name;btnEl.style.display='block';};
    listEl.appendChild(btn);
  });
  fieldEl.style.display='block';
}
async function joinGame(){
  if(!window._fb){toast('âš ï¸ Firebase non configurato!');return;}
  const name=_selectedJoinName||'';
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  if(!name){toast('Seleziona il tuo nome dalla lista');return;}
  if(code.length!==4){toast('Codice non valido');return;}
  const room=await dbGet(`rooms/${code}`);
  if(!room){toast('Stanza non trovata');return;}
  if(room.status==='gameover'){toast('Partita terminata');return;}
  G.roomId=code;G.playerName=name;G.isMaster=false;G.isSpectator=false;
  const match=Object.entries(room.players||{}).find(([_,p])=>p.name.toLowerCase()===name.toLowerCase());
  if(match){G.playerId=match[0];await dbUpdate(`rooms/${code}/players/${G.playerId}`,{joined:true});if(room.status==='playing'){startPlayingScreen();return;}showLobby(code,room.players);}
  else{toast('Nome non trovato. Contatta il Master.');}
}
async function joinAsSpectator(){
  if(!window._fb){toast('âš ï¸ Firebase non configurato!');return;}
  const code=document.getElementById('join-code').value.trim().toUpperCase();
  if(code.length!==4){toast('Inserisci codice');return;}
  const room=await dbGet(`rooms/${code}`);if(!room){toast('Stanza non trovata');return;}
  G.roomId=code;G.isSpectator=true;G.isMaster=false;G.playerId=null;
  startPlayingScreen();
}

// â•â• Playing screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastTurnPid=null;
function startPlayingScreen(){
  dbUnsubAll();showScreen('screen-game');
  document.getElementById('spectator-pill').style.display=G.isSpectator?'block':'none';
  const testPill=document.getElementById('test-mode-pill');
  if(testPill)testPill.classList.toggle('show',!!G.isTestMode);
  clearTimer();
  G.sessionStats={dmgDealt:0,dmgReceived:0,highCard:0,turnsPlayed:0,puUsed:0};
  G.bearMode=false;G.dogMode=false;G.dogPuCount=0;  G.masterOverrideActive=false;G._shownAnims={};
  G._cardPickedOnTurn=-1;G._lastRenderedTurn=-1;
  _logCount=0;_logRenderedKeys.clear();_lastLogKey='';
  // â”€â”€ Game elapsed timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  G._gameStartedAt=G._gameStartedAt||Date.now();
  if(G._elapsedTimer)clearInterval(G._elapsedTimer);
  const elapsedEl=document.getElementById('game-elapsed');
  G._elapsedTimer=setInterval(()=>{
    if(!elapsedEl)return;
    const sec=Math.floor((Date.now()-G._gameStartedAt)/1000);
    const m=String(Math.floor(sec/60)).padStart(2,'0');
    const s=String(sec%60).padStart(2,'0');
    elapsedEl.textContent=m+':'+s;
  },1000);
  let _lastStateKey='';let _renderPending=false;let _latestState=null;
  // Listener separato per il log â€” cosÃ¬ le scritture di log non triggerano il re-render dello stato di gioco
  dbListen(`rooms/${G.roomId}/log`,log=>{
    renderLog(log);
  });
  // Listener principale â€” il log ha listener dedicato
  dbListen(`rooms/${G.roomId}`,state=>{
    if(!state)return;
    if(state.status==='gameover'){showGameOver(state);return;}
    // PERF: stateKey leggero senza JSON.stringify
    const puKeys=Object.keys(state.activePowerups||{}).sort().join('|');
    const hpKeys=(state.playerOrder||Object.keys(state.players||{}))
      .map(pid=>{const p=state.players?.[pid];return p?`${p.hp}${p.alive?1:0}${p.activeBug?1:0}${p.jaguarShield?1:0}`:'';}).join(',');
    const stateKey=`${state.turnCount}_${state.currentTurnIndex}_${puKeys}_${hpKeys}_${state.butterflyActive?1:0}`;
    // Aggiorna cache sempre (serve per card click anche durante log-only updates)
    G._lastState=state;
    // Sync G.puEnabled con Firebase (fix race condition dopo reload/rejoin)
    if(state.puEnabled){Object.entries(state.puEnabled).forEach(([id,val])=>{if(G.puEnabled[id]===undefined||G.puEnabled[id]===true&&val===false)G.puEnabled[id]=val;});}
    // Se solo il log e cambiato, skip tutto (il listener /log gestisce il render del log)
    if(stateKey===_lastStateKey)return;
    _lastStateKey=stateKey;
    // Esegui solo su veri cambiamenti di stato
    checkZeckaDmg(state);
    checkLionDmg(state);
    if(G.pendingConfirm)return;
    _latestState=state;
    if(_renderPending)return;
    _renderPending=true;
    requestAnimationFrame(()=>{_renderPending=false;if(!G.pendingConfirm&&_latestState)renderState(_latestState);});
  });
}

function renderState(state){
  const players=state.players||{};
  const order=state.playerOrder||Object.keys(players);
  const aliveOrder=order.filter(pid=>players[pid]?.alive);
  if(!aliveOrder.length)return;
  // FIX: find currentPid by scanning forward from stored index, don't use modulo on alive array
  // because currentTurnIndex is stored relative to the alive array at time of nextTurn write
  const currentPid=aliveOrder[Math.min(state.currentTurnIndex||0,aliveOrder.length-1)]||aliveOrder[0];
  const pu=state.activePowerups||{};
  const isMyTurn=!G.isSpectator&&currentPid===G.playerId;

  // Fox removed
  // TEST MODE: automatically activate master override for non-personal turns; clear it on personal turn
  if(G.isTestMode){
    if(isMyTurn){
      // It's actually my turn (p0) â€” clear any leftover override
      if(G.masterOverrideActive){G.masterOverrideActive=false;G.masterOverridePid=null;}
    }else if(!G.masterOverrideActive){
      G.masterOverrideActive=true;G.masterOverridePid=currentPid;
    }
  }
  // Bear â€” FIX 7: also activate for fox owner playing for bear target
  const bearTargetPid=G.masterOverrideActive?G.masterOverridePid:G.playerId;
  if(pu.bear&&pu.bear.target===bearTargetPid&&(isMyTurn||G.masterOverrideActive)&&!G.bearMode&&G.bearCardsChosen===0){
    G.bearMode=true;G.bearCardsChosen=0;G.bearFirstTarget=null;G.bearFirstCardId=null;
  }
  const canPlay=isMyTurn||G.masterOverrideActive;

  // New turn announcement
  if(_lastTurnPid!==currentPid){
    _lastTurnPid=currentPid;G._shownAnims={};
    if(isMyTurn){playSound('flip');vibrate([40,30,80]);flashTurn();}
  }
  // Turn name glow for active player
  const turnNameEl=document.getElementById('turn-name');
  if(turnNameEl){turnNameEl.classList.toggle('turn-name-glow',isMyTurn);turnNameEl.classList.toggle('my-turn',isMyTurn&&!G.isSpectator);}
  const myTurnBar=document.getElementById('my-turn-bar');
  if(myTurnBar)myTurnBar.classList.toggle('show',isMyTurn&&!G.isSpectator&&!G.pendingConfirm);
  const turnLbl=document.getElementById('turn-label-text');
  if(turnLbl)turnLbl.textContent=isMyTurn&&!G.isSpectator?'IL TUO TURNO':'Turno di';

  // Per-turn alerts
  if(!G._shownAnims.kang_alert&&pu.kangaroo?.target===G.playerId){G._shownAnims.kang_alert=true;showAnimalAlert('ğŸ¦˜','TURNO SALTATO!','Il Canguro ti ha scavalcato!','#f0b040');}
  if(!G._shownAnims.bear_alert&&pu.bear?.target===G.playerId&&isMyTurn){G._shownAnims.bear_alert=true;showAnimalAlert('ğŸ»','ORSO!','Devi scegliere 2 carte diverse!','#c0392b');}
  if(!G._shownAnims.owl_alert&&pu.owl?.target===G.playerId&&isMyTurn){G._shownAnims.owl_alert=true;showAnimalAlert('ğŸ¦‰','GUFO!','Non puoi attivare power-up!','#6c5ce7');}
  if(!G._shownAnims.wolf_alert&&pu.wolf&&canPlay){G._shownAnims.wolf_alert=true;toast('ğŸº Lupo! Nessun potere disponibile questo turno.');}
  if(!G._shownAnims.ostrich_alert&&pu.ostrich&&canPlay){G._shownAnims.ostrich_alert=true;if(!document.querySelector('.pua-card'))showAnimalAlert('ğŸ¦¤','DODO!','L\'ultima carta a destra Ã¨ bloccata!','#d4a040');}

  // Per-turn anim triggers
  if(canPlay&&!G._shownAnims.rat&&pu.rat&&pu.rat.owner!==G.playerId){G._shownAnims.rat=true;triggerAnim('rat');}
  if(canPlay&&!G._shownAnims.cheetah&&pu.cheetah&&!G.timerActive){G._shownAnims.cheetah=true;triggerAnim('cheetah');}
  // NOTE: triggerAnim('crocodile') removed â€” crocodile is secret, only revealed when it fires in resolveCard

  // UI updates
  document.getElementById('turn-name').textContent=isMyTurn&&!G.isSpectator?'TU':players[currentPid]?.name||'â€”';
  // Hide direction bar completely (removed per request)
  const dirBar=document.getElementById('dir-bar');if(dirBar)dirBar.style.display='none';
  // Log always visible per rules
  const logList=document.getElementById('log-list');
  const logHeader=document.getElementById('log-header');
  if(logList){logList.style.display='block';}
  if(logHeader){logHeader.classList.add('open');}
  G._logOpen=true;
  renderHpStrip(players,order,currentPid,state.initialHp||1000);
  renderPuBanner(pu,canPlay);

  const pill=document.getElementById('special-turn-pill');
  if(pill){
    if(G.bearMode&&canPlay){pill.style.display='block';pill.innerHTML=`ğŸ» ORSO â€” Scegli carta <span class="bear-cards-left">${G.bearCardsChosen+1}/2</span>`;}
    else{pill.style.display='none';}
  }

  // Reset card-pick lock when turnCount advances (new turn started)
  if((state.turnCount||0) !== G._lastRenderedTurn){
    G._lastRenderedTurn = state.turnCount||0;
    G._cardPickedOnTurn = -1; // new turn â†’ allow picking again
    _cardLocked = false;
  }
  renderCards(state,canPlay,currentPid);
  // renderLog Ã¨ gestito da listener separato in startPlayingScreen

  const mo=document.getElementById('master-override');
  if(mo){
    // In test mode, override is automatic â€” hide the manual button
    if(G.isTestMode){mo.style.display='none';}
    else if(G.isMaster&&!isMyTurn&&!G.masterOverrideActive){
      mo.style.display='flex';
      document.getElementById('master-override-text').textContent=`Gioca per ${players[currentPid]?.name}`;
    }else{mo.style.display='none';}
  }
  // In test mode: update test pill to show who you're playing as
  const tPill=document.getElementById('test-mode-pill');
  if(tPill&&G.isTestMode){
    const playingAs=isMyTurn?players[G.playerId]?.name:players[currentPid]?.name;
    tPill.textContent=`ğŸ§ª TEST â€” Stai giocando come: ${playingAs||'?'}`;
    tPill.classList.add('show');
  }

  // Cheetah timer
  const cheetahOwner=pu.cheetah?.owner;
  if(canPlay&&pu.cheetah&&!G.timerActive&&cheetahOwner!==G.playerId&&!G.isSpectator){
    startTimer(12,async()=>{
      hidePuSection();
      const fresh=G._lastState||(await dbGet(`rooms/${G.roomId}`));if(!fresh)return;
      addLog(`<span class='lpu'>â± Tempo scaduto!</span> <span class='lp'>${players[currentPid]?.name}</span> salta il turno.`,'system');
    dbUpdate(`rooms/${G.roomId}`,{[`stats/${currentPid}/turnsSkipped`]:(state.stats?.[currentPid]?.turnsSkipped||0)+1}).catch(()=>{});
      await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/cheetah':null});
      await nextTurn(fresh);
    });
  }else if(pu.cheetah&&!canPlay){
    const tn=document.getElementById('timer-num');if(tn)tn.textContent='ğŸ†';
    const tw=document.getElementById('timer-wrap');if(tw)tw.classList.add('urgent');
  }else if(!pu.cheetah){
    clearTimer();
    const tn=document.getElementById('timer-num');if(tn)tn.textContent='â€”';
    const tr=document.getElementById('timer-ring');if(tr)tr.style.strokeDashoffset='0';
    const tw=document.getElementById('timer-wrap');if(tw)tw.classList.remove('urgent');
  }
}

// â•â• HP Strip â€” optimized with DOM diffing â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _hpStripCache={};
function renderHpStrip(players,order,currentPid,initialHp){
  const strip=document.getElementById('hp-strip');
  const existingCards=strip.children;
  const needsRebuild=existingCards.length!==order.filter(pid=>players[pid]).length;
  
  if(needsRebuild){
    strip.innerHTML='';_hpStripCache={};
  }
  
  let idx=0;
  order.forEach(pid=>{
    const p=players[pid];if(!p)return;
    const pct=Math.max(0,Math.min(100,(p.hp/p.maxHp)*100));
    const isDanger=p.alive&&p.hp<(initialHp||p.maxHp)*.2;
    const barColor=pct>50?'var(--heal)':pct>25?'var(--gold)':'var(--red3)';
    const isActive=pid===currentPid;
    const cache=_hpStripCache[pid]||{};
    const hpChanged=cache.hp!==p.hp;
    const stateKey=`${p.alive}-${isActive}-${isDanger}-${p.activeBug}-${pct}`;
    
    let card;
    if(needsRebuild){
      card=document.createElement('div');
      card.id=`hp-${pid}`;
      card.innerHTML=`${isDanger&&p.alive?'<div class="danger-skull">ğŸ’€</div>':''}
        ${p.activeBug?'<div class="bug-shield">ğŸ</div>':''}
        <div class="hpc-name">${p.name}</div>
        <div class="hpc-val">${p.alive?p.hp:'â˜ '}</div>
        <div class="hpc-bar"><div class="hpc-fill"></div></div>`;
      strip.appendChild(card);
    } else {
      card=existingCards[idx];
    }
    
    if(card){
      // Only update changed properties
      const newClass=`hp-card${!p.alive?' dead':''}${isActive?' active':''}${isDanger&&p.alive?' danger':''}`;
      if(hpChanged&&cache.hp!==undefined){
        const wasHit=p.hp<cache.hp;
        card.className=newClass+(wasHit?' hit':' healed');
      }else if(cache.stateKey!==stateKey){
        card.className=newClass;
      }
      
      if(cache.hp!==p.hp||cache.alive!==p.alive){
        const valEl=card.querySelector('.hpc-val');
        if(valEl){valEl.textContent=p.alive?p.hp:'â˜ ';
          valEl.style.color=!p.alive?'var(--muted)':pct>50?'var(--text)':pct>25?'var(--gold)':'var(--red3)';}
        const fillEl=card.querySelector('.hpc-fill');
        if(fillEl){fillEl.style.width=pct+'%';fillEl.style.background=barColor;}
      }
    }
    
    _hpStripCache[pid]={hp:p.hp,alive:p.alive,stateKey};
    idx++;
  });
}

// â•â• PU Banner â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Visibili a TUTTI nel banner (e nel log)
const PU_PUBLIC=['rat','cheetah','wolf','weasel','pigeon','ostrich','ladybug','blacksheep'];
// Visibili SOLO all'attivatore nel banner (nel log visibili a tutti dopo attivazione)
const PU_OWNER_ONLY=['eagle'];
// Tutti gli altri: nascosti come "?" a TUTTI nel banner fino alla rivelazione
function renderPuBanner(pu,canPlay){
  const banner=document.getElementById('pu-banner');
  const entries=pu?Object.entries(pu).filter(([k])=>!['_lionPendingDmg','_hyenaSkip'].includes(k)):[];
  if(!entries.length){banner.classList.remove('show');return;}
  let shown=false;
  for(const [id,val] of entries){
    const def=POWERUPS.find(p=>p.id===id);
    if(!def)continue;
    const isPublic=PU_PUBLIC.includes(id);
    const isOwnerOnly=PU_OWNER_ONLY.includes(id);
    // Determine owner pid from the PU object
    const ownerPid=val?.owner||val?.target||null;
    // iAmOwner: ONLY the actual activator â€” canPlay (=current active player) is NOT sufficient
    // This ensures owner-only PUs (like Eagle) are NEVER shown to other players even on their turn
    const iAmOwner=!G.isSpectator&&(ownerPid&&ownerPid===G.playerId);
    let showReal=false;
    if(isPublic) showReal=true;
    else if(isOwnerOnly&&iAmOwner) showReal=true;
    else if(isOwnerOnly&&!iAmOwner){
      // Owner-only PU: completely hidden from others (no ? shown)
      continue;
    }
    // else: fully hidden â†’ show ? to everyone
    document.getElementById('pu-banner-icon').textContent=showReal?def.icon:'â“';
    document.getElementById('pu-banner-title').textContent=showReal?def.name.toUpperCase()+' ATTIVO':'POTERE SEGRETO';
    document.getElementById('pu-banner-desc').textContent=showReal?def.desc:'Un potere nascosto Ã¨ attivo...';
    banner.classList.add('show');shown=true;break;
  }
  if(!shown) banner.classList.remove('show');
}

// â•â• Seeded shuffle (deterministic per turn) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function seededShuffle(arr, seed){
  let s=(seed^0x9e3779b9)>>>0;
  const out=[...arr];
  for(let i=out.length-1;i>0;i--){
    s=(Math.imul(s,1664525)+1013904223)>>>0;
    const j=s%(i+1);
    [out[i],out[j]]=[out[j],out[i]];
  }
  return out;
}

// â•â• Render Cards â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _cardLocked=false;
let _cardsRenderKey='';
function renderCards(state,canPlay,currentPid){
  if(G.pendingConfirm)return;
  const grid=document.getElementById('cards-grid');
  const pu=state.activePowerups||{};
  const players=state.players||{};
  const activePid=G.masterOverrideActive?G.masterOverridePid:G.playerId;
  const iAmActive=canPlay;

  document.getElementById('cards-label').textContent=
    canPlay?(G.bearMode?`ğŸ» Orso: scegli carta ${G.bearCardsChosen+1} di 2`:'âš”ï¸ Scegli la tua carta'):
    G.isSpectator?'ğŸ‘ Vista spettatore':'â³ Attendi il tuo turno';

  // BUG FIX: Hyena - block card selection while auto-advance is pending
  const rhinoBlocked=false; // Rinoceronte Ã¨ ora istantaneo, non blocca piÃ¹ le carte
  const hyenaBlocked=!!(state._hyenaSkip===activePid&&iAmActive);
  if(hyenaBlocked){
    document.getElementById('cards-label').textContent='ğŸ¦ Iena â€” le carte si attivano automaticamente... attendi';
  }

  let cards=[...(state.cards||[])];
  // Tick card - disguised as normal for active player (random position)
  if(state.tickCard) cards.push({...state.tickCard, _disguised:true});
  // Mosca: show the fly card ONLY to the target player (so they can stop the effect) and spectators
  if(state.moscaCard&&pu.fly){
    if(pu.fly.target===activePid||G.isSpectator)
      cards.push({...state.moscaCard,_disguised:true});
  }
  // Viper card - disguised as normal for active player (random position)
  if(pu.viper) cards.push({id:'viper-special',value:pu.viper.value||42,assignedTo:'viper',assignedName:'???',badge:'viper',_disguised:true});
  // Butterfly cards - BUG FIX: only show the butterfly card assigned to the current active player
  // Spectators see all butterfly cards (disguised) so they know they exist
  if(state.butterflyActive&&state.butterflyCards) Object.values(state.butterflyCards).forEach(bc=>{
    if(G.isSpectator||bc.assignedTo===activePid) cards.push({...bc,badge:'butterfly',assignedName:'ğŸ¦‹',_disguised:true});
  });
  // Camaleonte: ora effetto istantaneo â€” non aggiunge piÃ¹ carte speciali revival
  // Scorpione: carta nascosta per il giocatore attivo (come Vipera) â€” appare come carta normale, -100 HP se scelta
  // Mostrata solo al giocatore target (prossimo dopo il proprietario), non al proprietario stesso
  // Spettatori vedono la carta (mascherata) come avviene per vipera e scarabeo
  if(pu.scorpion&&(pu.scorpion.target===activePid||G.isSpectator)) cards.push({id:'scorpion-special',value:pu.scorpion.fakeValue||rnd(20,80),assignedTo:'scorpion',assignedName:'???',badge:'scorpion',_disguised:true});
  // Zebra duplicate card
  if(pu.zebra?.target===currentPid&&pu.zebra.dupCard) cards.push({...pu.zebra.dupCard,badge:'zebra',_disguised:true});
  // Scarab card
  if(pu.scarab?.target===currentPid) cards.push({id:'scarab-special',value:pu.scarab.cardValue??'Â½',assignedTo:'scarab',assignedName:'???',badge:'scarab',_disguised:true});
  // Walrus badge card: for all non-owner players AND spectators (owner is excluded)
  if(pu.walrus&&pu.walrus.owner!==activePid){
    const walSum=(state.cards||[]).filter(c=>!c.badge).reduce((s,c)=>s+c.value,0);
    // Use stable fake value from Firebase (never >=80 to avoid critical-card visual)
    const walFakeVal=pu.walrus.fakeValue||37;
    cards.push({id:'walrus-special',value:walFakeVal,assignedTo:'walrus',assignedName:'???',badge:'walrus',_alwaysDisguised:true,_walrusSum:walSum});
  }

  // FIX 5: Remove cards assigned to dead players â€” they should disappear immediately on elimination
  const _specialAssignees=new Set(['viper','scorpion','walrus','scarab','zebra','butterfly','tick','skunk','fly']);
  cards=cards.filter(c=>c.badge||_specialAssignees.has(c.assignedTo)||!c.assignedTo||(players[c.assignedTo]?.alive!==false));
  // Puzzola: aggiungi la carta skunk al giocatore attivo se presente
  if(state.skunkCards){
    const mySkunk=Object.values(state.skunkCards).find(sc=>sc.assignedTo===activePid);
    if(mySkunk&&!cards.find(c=>c.id===mySkunk.id)){
      // Mostrata come carta normale mascherata (valore nascosto) â€” solo il badge Ã¨ visibile agli spettatori
      cards.push({...mySkunk,assignedName:'???',_disguised:true});
    }
  }

  // Shuffle deterministico basato su turnCount: tutti i giocatori (e spettatori) vedono
  // le stesse carte nello stesso ordine stabile durante il turno.
  // Le carte trappola non sono sempre in posizione fissa, ma l'ordine non cambia ad ogni render.
  if(cards.length>1){
    cards=seededShuffle(cards,(state.turnCount||1)*1000+(cards.length));
  }
  // PERF: skip rebuild if cards are structurally identical
  const _newCardsKey=cards.map(c=>c.id+(c.badge||'')+(c.value||0)+(canPlay?'1':'0')).join('|');
  if(_newCardsKey===_cardsRenderKey&&grid.children.length===cards.length){return;}
  _cardsRenderKey=_newCardsKey;
  grid.innerHTML='';

  // Donkey swap display: only show to non-active players
  if(pu.donkey&&!iAmActive&&!G.isSpectator){
    const normal=cards.filter(c=>!c.badge);
    if(normal.length>=2){
      const vals=[...normal].map(c=>c.value).sort((a,b)=>a-b);
      const minV=vals[0],maxV=vals[vals.length-1];
      if(minV!==maxV){
        cards=cards.map(c=>{
          if(!c.badge){if(c.value===minV)return{...c,value:maxV};if(c.value===maxV)return{...c,value:minV};}
          return c;
        });
      }
    }
  }

  // VISIBILITY LOGIC (BUG FIX: Rat now covers cards for active player too)
  let forceCovered=false;
  let showNames=true;
  const ratActive=!!(pu.rat&&pu.rat.owner!==activePid&&!G.isSpectator);

  if(G.isSpectator){
    forceCovered=false;showNames=true;
  }else if(ratActive&&iAmActive){
    // BUG FIX: Rat covers active player's cards (like hardcore mode)
    forceCovered=true;showNames=false;
  }else if(ratActive&&!iAmActive){
    forceCovered=true;showNames=false;
  }else if(state.mode==='hardcore'||state.mode==='chaos'){
    if(iAmActive){forceCovered=true;showNames=false;}
    else{forceCovered=false;showNames=true;}
  }else{
    // Classic mode
    if(iAmActive){forceCovered=false;showNames=false;}
    else{forceCovered=false;showNames=true;}
  }

  // Eagle: active player sees 1 specific name revealed (eagleRevealPid set per-card below)
  // Rat class
  const sec=document.querySelector('.cards-section');
  if(sec) sec.classList.toggle('rat-active', ratActive);
  grid.className='cards-grid'+(cards.length>6?' compact':'');

  // Pigeon: one card blocked per player (random index stored in Firebase)
  const pigeonActive=!!pu.pigeon&&pu.pigeon.owner!==activePid;
  let pigeonBlockedIdx=pigeonActive?(pu.pigeon?.blocked?.[activePid]??-1):-1;

  // Ostrich: last card blocked
  const ostrichActive=!!pu.ostrich&&pu.ostrich.owner!==activePid;

  // Regolamento: se Piccione+Struzzo bloccano TUTTE le carte, sblocca una a caso
  if(iAmActive&&canPlay){
    const normalCards=cards.filter(c=>!c.badge);
    const allBlocked=normalCards.length>0&&normalCards.every((c,i)=>{
      const isPigBlk=pigeonActive&&i===pigeonBlockedIdx;
      const isOstLast=ostrichActive&&(cards.indexOf(c)===cards.length-1);
      return isPigBlk||isOstLast;
    });
    if(allBlocked){
      // Sblocca una carta casuale rimuovendo il blocco Piccione (prioritÃ  sul Piccione)
      pigeonBlockedIdx=-1;
      toast('ğŸ”“ Tutte le carte erano bloccate â€” una viene sbloccata automaticamente!');
    }
  }

  let _eagleRevealPid=(pu.eagle&&pu.eagle.owner===activePid&&iAmActive)?pu.eagle.reveal:null;
  // FIX 6: if eagle reveal target is dead or card doesn't exist, pick first available non-owner card
  if(_eagleRevealPid&&(!players[_eagleRevealPid]?.alive||!cards.find(c=>c.assignedTo===_eagleRevealPid))){
    const fallback=cards.find(c=>!c.badge&&c.assignedTo&&c.assignedTo!==activePid&&players[c.assignedTo]?.alive);
    _eagleRevealPid=fallback?.assignedTo||null;
  }
  const eagleRevealPid=_eagleRevealPid;
  cards.forEach((card,idx)=>{
    const div=document.createElement('div');
    const isLastCard=(idx===cards.length-1);
    const isOstrichBlocked=ostrichActive&&isLastCard&&!card.badge;
    const isCrit=card.value>=80&&!forceCovered&&!card.hidden;
    // BUG FIX: Bear must choose 2 different cards (different card IDs, not same-target restriction)
    const isBearDisabled=G.bearMode&&G.bearCardsChosen===1&&card.id===G.bearFirstCardId;
    const isPigeonBlocked=pigeonActive&&idx===pigeonBlockedIdx&&!card.badge;
    const cls=['game-card'];
    if(!canPlay||isBearDisabled||isOstrichBlocked||rhinoBlocked||hyenaBlocked||isPigeonBlocked)cls.push('disabled');
    if(isCrit&&!forceCovered)cls.push('critical-card');
    if(forceCovered||card.hidden)cls.push('card-covered');
    if(isOstrichBlocked)cls.push('card-covered');
    div.className=cls.join(' ');

    const isEagle=eagleRevealPid&&eagleRevealPid===card.assignedTo;
    if((forceCovered||(isOstrichBlocked&&!forceCovered)||card.hidden)&&!isEagle){
      const sym=isOstrichBlocked&&!forceCovered?'ğŸ¦¤':isPigeonBlocked&&!forceCovered?'ğŸ•Šï¸':'ğŸ¾';
      div.innerHTML=`<div class="card-covered-pattern"></div><div class="card-covered-shimmer"></div><div class="card-covered-symbol">${sym}</div>`;
    }else{
      const showThisName=showNames||isEagle;
      const nameClass=showThisName?`revealed${isEagle?' eagle-glow':''}`:' hidden';
      // Badge labels: active player AND spectators see '?' â€” only target/non-active see real name
      const isDisguised=card._disguised&&(iAmActive||G.isSpectator);
      // Spectators also see '?' for all badge cards (no spoilers on secret powers)
      const hideSecret=iAmActive||G.isSpectator;
      // For disguised cards, replace special values with fake normal ones
      const displayValue=isDisguised&&(typeof card.value!=='number')?Math.floor(Math.random()*90+5):card.value;
      const badgeLabels={
        tick:hideSecret?'':'ğŸœ ZECCA',
        viper:hideSecret?'':'ğŸ VIPERA',
        butterfly:hideSecret?'':'ğŸ¦‹ FARFALLA',
        revival:'ğŸ’š VITA',
        scorpion:hideSecret?'':'ğŸ¦‚ SCORPIONE',
        zebra:hideSecret?'':'ğŸ¦“ ZEBRA',
        scarab:hideSecret?'':'ğŸª² SCARABEO',
        walrus:hideSecret?'':'ğŸ¦­ TRICHECO',
        skunk:hideSecret?'':'ğŸ¦¨ PUZZOLA',
      };
      const badgeHtml=(card.badge&&!isDisguised)?`<div class="card-badge badge-${card.badge}">${badgeLabels[card.badge]||''}</div>`:'';
      const cardVal=isDisguised?displayValue:card.value;
      div.innerHTML=`
        <div class="card-corner tl">${(typeof cardVal==='number'?cardVal:50)>=50?'â™¦':'â™£'}</div>
        <div class="card-corner br">${(typeof cardVal==='number'?cardVal:50)>=50?'â™¦':'â™£'}</div>
        ${isCrit?'<div class="critical-flash">CRITICO</div>':''}
        ${badgeHtml}
        <div class="card-val-main">${cardVal}</div>
        <div class="card-name-reveal ${nameClass}">${showThisName&&card.assignedName?card.assignedName:''}</div>
        ${isPigeonBlocked?'<div class="pigeon-block-x"></div>':''}`;
    }

    if(canPlay&&!isBearDisabled&&!isOstrichBlocked&&!rhinoBlocked&&!hyenaBlocked&&!isPigeonBlocked){
      div.addEventListener('click',()=>{
        const currentTurnCount=state.turnCount||0;
        const isBearSecondPick=G.bearMode&&G.bearCardsChosen===1;
        // PRIMARY LOCK: turn-based. Block if already picked a card this turn,
        // unless this is Bear's mandatory second pick.
        if(G._cardPickedOnTurn===currentTurnCount&&!isBearSecondPick)return;
        // SECONDARY LOCK: in-flight guard (prevents double-click race)
        if(_cardLocked||G.pendingConfirm)return;
        // Acquire locks
        _cardLocked=true;
        G.pendingConfirm=true;
        if(!isBearSecondPick) G._cardPickedOnTurn=currentTurnCount;
        div.classList.add('flip-anim');
        playSound(card.value>=80?'crit':'flip');vibrate([60]);
        document.querySelectorAll('.game-card').forEach(c=>c.classList.add('disabled'));
        setTimeout(async()=>{
          try {
            const fresh=G._lastState;
            if(fresh&&fresh.status==='playing'){
              await resolveCard(card,fresh);
            } else { G.pendingConfirm=false; _cardLocked=false; }
          } catch(err) {
            console.error('resolveCard error:',err);
            G.pendingConfirm=false; _cardLocked=false;
            toast('âš ï¸ Errore durante la risoluzione della carta. Riprova.');
          }
        },380);
      });
    }
    grid.appendChild(div);
  });
}

// Helper: aggiunge riga di rivelazione potere segreto al log
function logReveal(puId, arr){
  const def=POWERUPS.find(p=>p.id===puId);
  if(def) arr.push({html:`ğŸ”“ <span class='lpu'>${def.icon} ${def.name}</span> â€” potere rivelato!`,type:'powerup'});
}

// â•â• Resolve card â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function resolveCard(card,state){
  G.pendingConfirm=true;
  const activePid=G.masterOverrideActive?G.masterOverridePid:G.playerId;
  // Store chosen card for elephant/monkey PU that need unchosen card sum
  const _normalCardsAtPick=(state.cards||[]).filter(c=>!c.badge);
  const _chosenCardValue=card.badge?0:card.value;
  const _unchosenSum=_normalCardsAtPick.reduce((s,c)=>s+(c.badge?0:c.value),0)-_chosenCardValue;
  G._lastUnchosenSum=_unchosenSum; // accessible in confirmPowerup â†’ activatePu
  const pu=state.activePowerups||{};
  const players=state.players||{};
  const postUpd={};
  let _duckFired=false; // FIXED: declared here to avoid TDZ crash
  if(pu.eagle&&pu.eagle.owner===activePid){
    toast('ğŸ¦… Aquila: carta spiata! Il nome Ã¨ visibile durante questo turno.');
    // NOTE: non viene loggato per mantenere l'aquila privata all'attivatore
    // Eagle scade alla fine del turno (in nextTurn)
  }
  // duck cleanup is handled via 'afters' array in the batch update below

  // â”€â”€ Badge cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(card.badge==='tick'){
    await applyHpFresh(activePid,-card.value);
    addLog(`<span class='lp'>${players[activePid]?.name}</span> sceglie la <span class='lpu'>ğŸœ Formica</span>: <span class='ld'>-${card.value}</span> â€” formica rimossa`,'damage');
    spawnFloat(`-${card.value}`,'red');shakeScreen();playSound('hit');vibrate([80]);
    await dbUpdate(`rooms/${G.roomId}`,{tickCard:null,...postUpd});
    await clearAfterBadgePick(pu); // FIX 4+5
    await checkElimAndWin(activePid);
    await proceedAfterCard(state,activePid);return;
  }
  if(card.badge==='viper'){
    triggerAnim('viper');
    addLog(`ğŸ”“ <span class='lpu'>ğŸ Vipera</span> â€” potere segreto rivelato!`,'powerup');
    await dbUpdate(`rooms/${G.roomId}`,{[`players/${activePid}/hp`]:0,[`players/${activePid}/alive`]:false,'activePowerups/viper':null,...postUpd});
    addLog(`<span class='lp'>${players[activePid]?.name}</span> cade nella <span class='lpu'>ğŸ Vipera</span>: <span class='ld'>ELIMINATO!</span>`,'elim');
    triggerEliminationAnim(players[activePid]?.name||'?');
    // BUG FIX: eliminated player loses active powerups and can't choose PU
    await clearPlayerPowerups(activePid,state);
    // PERF FIX: use cached state for win check and next turn
    const freshAfterViper=G._lastState||state;
    await checkWin(freshAfterViper);
    // Skip PU choice since player is eliminated
    G.pendingConfirm=false;_cardLocked=false;
    G.bearMode=false;G.bearCardsChosen=0;
    G.masterOverrideActive=false;G.masterOverridePid=null;
    const freshViper=G._lastState||freshAfterViper;
    if(freshViper&&freshViper.status==='playing') await nextTurn(freshViper, activePid);
    return;
  }
  if(card.badge==='butterfly'){
    const owner=state.butterflyOwner;
    triggerAnim('butterfly');
    addLog(`ğŸ”“ <span class='lpu'>ğŸ¦‹ Farfalla</span> â€” potere rivelato!`,'powerup');
    if(owner&&players[owner]?.alive){
      await applyHpFresh(owner,card.value);
      addLog(`<span class='lpu'>ğŸ¦‹ Farfalla</span>: <span class='lp'>${players[owner]?.name}</span> guadagna <span class='lh'>+${card.value}</span> HP!`,'heal');
      spawnFloat(`+${card.value}`,'green');playSound('heal');vibrate([60]);
    }
    const remainingBf={};
    if(state.butterflyCards){Object.entries(state.butterflyCards).forEach(([k,v])=>{if(v.id!==card.id)remainingBf[k]=v;});}
    const hasRemaining=Object.keys(remainingBf).length>0;
    await dbUpdate(`rooms/${G.roomId}`,{butterflyActive:hasRemaining,butterflyCards:hasRemaining?remainingBf:null,butterflyOwner:hasRemaining?owner:null,...postUpd});
    await clearAfterBadgePick(pu); // FIX 4+5
    await proceedAfterCard(state,activePid);return;
  }

  // Scorpione: carta trappola nascosta â€” infligge -100 HP (puÃ² eliminare)
  if(card.badge==='scorpion'){
    triggerAnim('scorpion');
    addLog(`ğŸ”“ <span class='lpu'>ğŸ¦‚ Scorpione</span> â€” potere segreto rivelato!`,'powerup');
    const scorpHpBefore=players[activePid]?.hp||0;
    const scorpNewHp=Math.max(0, scorpHpBefore-100);
    const scorpAlive=scorpNewHp>0;
    await dbUpdate(`rooms/${G.roomId}`,{[`players/${activePid}/hp`]:scorpNewHp,[`players/${activePid}/alive`]:scorpAlive,'activePowerups/scorpion':null,...postUpd});
    addLog(`<span class='lp'>${players[activePid]?.name}</span> ğŸ¦‚ ha trovato uno <span class='lpu'>Scorpione</span> nascosto! <span class='ld'>-100 HP!</span> (${scorpHpBefore} â†’ ${scorpNewHp})${!scorpAlive?' â€” ELIMINATO!':''}`, scorpAlive?'damage':'elim');
    spawnFloat('ğŸ¦‚ -100','red');shakeScreen();playSound('crit');vibrate([100,50,100]);
    if(!scorpAlive) triggerEliminationAnim(players[activePid]?.name||'?');
    await clearAfterBadgePick(pu);
    await checkElimAndWin(activePid);
    await proceedAfterCard(state,activePid);return;
  }
  // Walrus badge card: picking it deals sum of all normal cards
  if(card.badge==='walrus'){
    triggerAnim('walrus');
    const walNormalCards=(state.cards||[]).filter(c=>!c.badge);
    const walSum=walNormalCards.reduce((s,c)=>s+c.value,0);
    addLog(`<span class='lp'>${players[activePid]?.name}</span> sceglie la carta del <span class='lpu'>ğŸ¦­ Foca</span>: <span class='ld'>-${walSum} HP!</span>`,'damage');
    toast(`ğŸ¦­ Foca! -${walSum} HP!`);shakeScreen();
    await applyHpFresh(activePid,-walSum);
    // FIX: clear walrus when card is picked
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/walrus':null,...postUpd});
    await checkElimAndWin(activePid);
    await proceedAfterCard(state,activePid);return;
  }
  // Zebra duplicate card (same as original)
  if(card.badge==='zebra'){
    triggerAnim('zebra');
    addLog(`<span class='lp'>${players[activePid]?.name}</span> sceglie il doppione della <span class='lpu'>ğŸ¦“ Zebra</span>!`,'powerup');
    toast('ğŸ¦“ Zebra! Hai scelto la carta duplicata!');
    // Treat as normal card with same target/value
    const zebraTarget=card.assignedTo;
    const zebraDmg=card.value;
    await applyHpFresh(zebraTarget,-zebraDmg);
    addLog(`<span class='lp'>${players[activePid]?.name}</span> â†’ ${players[zebraTarget]?.name}: <span class='ld'>-${zebraDmg}</span>`,'damage');
    spawnFloat(`-${zebraDmg}`,'red');shakeScreen();playSound('hit');
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/zebra':null,...postUpd});
    await clearAfterBadgePick(pu); // FIX 4+5 (clear scarab etc)
    await checkElimAndWin(zebraTarget);
    await proceedAfterCard(state,activePid);return;
  }
  // Scarab card (lose half HP)
  if(card.badge==='scarab'){
    triggerAnim('scarab');
    // PERF FIX: use cached player data
    const cachedP=G._lastState?.players?.[activePid];
    const halfHp=Math.ceil((cachedP?.hp||players[activePid]?.hp||0)/2);
    await applyHpFresh(activePid,-halfHp);
    addLog(`<span class='lp'>${players[activePid]?.name}</span> sceglie lo <span class='lpu'>ğŸª² Scarabeo</span>: <span class='ld'>-${halfHp} HP</span> (metÃ  vita!)`, 'damage');
    spawnFloat(`-${halfHp}`,'red');shakeScreen();playSound('crit');vibrate([100,50,100]);
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/scarab':null,...postUpd});
    await clearAfterBadgePick(pu); // FIX 4+5 (clear zebra etc)
    await checkElimAndWin(activePid);
    await proceedAfterCard(state,activePid);return;
  }

  // â”€â”€ Puzzola badge card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(card.badge==='skunk'){
    const skunkPu=pu.skunk;
    const skunkInitHp=skunkPu?.initialHp||state.initialHp||1000;
    const curHp=players[activePid]?.hp||0;
    const halfInitHp=skunkInitHp/2;
    addLog(`ğŸ”“ <span class='lpu'>ğŸ¦¨ Puzzola</span> â€” potere segreto rivelato!`,'powerup');
    if(curHp>halfInitHp){
      // HP > metÃ  iniziale: danno doppio
      const skunkDmg=card.value*2;
      await applyHpFresh(activePid,-skunkDmg);
      addLog(`<span class='lp'>${players[activePid]?.name}</span> ğŸ¦¨ Puzzola (HP sopra metÃ ): <span class='ld'>-${skunkDmg}</span> (danno doppio)!`,'damage');
      toast(`ğŸ¦¨ Puzzola! -${skunkDmg} HP (danno doppio)!`);
      spawnFloat(`ğŸ¦¨ -${skunkDmg}`,'red');shakeScreen();playSound('crit');vibrate([100,50,100]);
    } else {
      // HP â‰¤ metÃ  iniziale: cura
      await applyHpFresh(activePid,card.value);
      addLog(`<span class='lp'>${players[activePid]?.name}</span> ğŸ¦¨ Puzzola (HP sotto metÃ ): <span class='lh'>+${card.value}</span> (cura)!`,'heal');
      toast(`ğŸ¦¨ Puzzola! +${card.value} HP (cura)!`);
      spawnFloat(`ğŸ¦¨ +${card.value}`,'green');playSound('heal');vibrate([40]);
    }
    // Rimuovi questa carta puzzola dallo skunkCards
    const remainSkunk={};
    if(state.skunkCards){Object.entries(state.skunkCards).forEach(([k,v])=>{if(v.id!==card.id)remainSkunk[k]=v;});}
    const hasRemSkunk=Object.keys(remainSkunk).length>0;
    await dbUpdate(`rooms/${G.roomId}`,{skunkCards:hasRemSkunk?remainSkunk:null,...postUpd});
    await checkElimAndWin(activePid);
    await proceedAfterCard(state,activePid);return;
  }

  // â”€â”€ Mosca badge card: picking it stops the fly effect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(card.badge==='fly'){
    triggerAnim('fly');
    addLog(`ğŸ”“ <span class='lpu'>ğŸª° Mosca</span> â€” carta interrotta da <span class='lp'>${players[activePid]?.name}</span>! Effetto rimosso.`,'powerup');
    toast('ğŸª° Mosca fermata! Effetto rimosso.');
    spawnFloat('ğŸª° STOP','gold');playSound('pu');vibrate([40,20,40]);
    await dbUpdate(`rooms/${G.roomId}`,{moscaCard:null,'activePowerups/fly':null,...postUpd});
    await clearAfterBadgePick(pu);
    await proceedAfterCard(state,activePid);return;
  }

  // â”€â”€ Normal card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let target=card.assignedTo;
  let dmg=card.value;
  let dmgType='damage';

  // Fox: randomize card value (0-100) for the active player
  let foxFired=false;
  if(pu.fox&&pu.fox.target===activePid&&!card.badge){
    foxFired=true;
    dmg=rnd(0,100);
    // reveal log added when resolving below
  }

  // Pig: next player's card is worth 0
  let pigFired=false;
  if(pu.pig&&pu.pig.target===activePid&&!card.badge){
    pigFired=true;
    dmg=0;
    triggerAnim('pig');
    addLog(`ğŸ”“ <span class='lpu'>ğŸ· Maiale</span> â€” potere rivelato! Carta azzerata!`,'powerup');
    toast('ğŸ· Maiale! Questa carta vale 0!');
  }

  // Duck: redirect damage to self if duck targets this player (before any modifiers)
  if(pu.duck&&pu.duck.target===activePid&&!card.badge){
    triggerAnim('duck');
    addLog(`<span class='lpu'>ğŸ¦† Anatra</span>: la carta di <span class='lp'>${players[activePid]?.name}</span> colpisce se stesso!`,'system');
    toast('ğŸ¦† Anatra! Il danno colpisce te stesso!');
    target=activePid; // redirect to self
    _duckFired=true;
  }

  // Donkey swap
  if(pu.donkey){
    const normalCards=(state.cards||[]).filter(c=>!c.badge);
    if(normalCards.length>=2){
      const vals=normalCards.map(c=>c.value).sort((a,b)=>a-b);
      const minV=vals[0],maxV=vals[vals.length-1];
      if(minV!==maxV){
        if(card.value===minV)dmg=maxV;
        else if(card.value===maxV)dmg=minV;
      }
    }
    triggerAnim('donkey');
    addLog(`<span class='lpu'>ğŸ« Asino</span>: valori scambiati!`,'powerup');
  }

  // Frog: swap HP instead of damage â€” FIX 6: only if target is alive
  if(pu.frog&&target!==activePid&&players[target]?.alive){
    triggerAnim('frog');
    addLog(`ğŸ”“ <span class='lpu'>ğŸ¸ Rana</span> â€” potere rivelato!`,'powerup');
    const myHp=players[activePid]?.hp||0;
    const theirHp=players[target]?.hp||0;
    await dbUpdate(`rooms/${G.roomId}`,{
      [`players/${activePid}/hp`]:theirHp,
      [`players/${target}/hp`]:myHp,
      'activePowerups/frog':null,...postUpd
    });
    addLog(`<span class='lpu'>ğŸ¸ Rana</span>: <span class='lp'>${players[activePid]?.name}</span> (${myHp} HP) â†” <span class='lp'>${players[target]?.name}</span> (${theirHp} HP) â€” scambio vita!`,'powerup');
    toast(`ğŸ¸ Rana! Scambio HP: ${myHp} â†” ${theirHp}`);
    spawnFloat('â†”','green');playSound('heal');
    await clearAfterPU(pu);
    G.sessionStats.turnsPlayed++;
    await proceedAfterCard(state,activePid);return;
  }

  // Crocodile block
  if(pu.crocodile?.owner&&target===pu.crocodile.owner&&activePid!==pu.crocodile.owner){
    triggerAnim('crocodile');
    toast(`ğŸŠ Coccodrillo! Non puoi colpire ${players[pu.crocodile.owner]?.name}! Il turno prosegue.`);
    addLog(`<span class='lpu'>ğŸŠ Coccodrillo</span>: <span class='lp'>${players[activePid]?.name}</span> non puÃ² colpire <span class='lp'>${players[pu.crocodile.owner]?.name}</span> â€” danno nullo!`,'system');
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/crocodile':null,...postUpd});
    G.pendingConfirm=false;_cardLocked=false;
    // PERF FIX: use cached state
    const freshCroc=G._lastState||state;
    if(freshCroc&&freshCroc.status==='playing') await proceedAfterCard(freshCroc,activePid);
    return;
  }

  // Panda: absorb next damage directed at owner â€” convert to heal (secret)
  let pandaFired=false;
  if(pu.panda&&pu.panda.owner===target&&dmgType==='damage'&&target!==activePid&&!card.badge){
    pandaFired=true;
  }

  // Bug reflect â€” only fires on actual damage (not when koala/parrot will convert to heal)
  let bugReflect=false;
  const _willBeHeal=!!(pu.koala||pu.parrot||pandaFired);
  if(players[target]?.activeBug&&target!==activePid&&!_willBeHeal&&dmgType==='damage'){
    bugReflect=true;target=activePid;
    // activeBug clear merged into main batch below (no separate write)
    triggerAnim('bug');
  }

  // (Zanzara is now instant in activatePu â€” no persistent modifier here)

  // Modifiers
  if(pu.bull){dmg=Math.min(99999,dmg*2);triggerAnim('bull');}
  if(pu.horse&&dmg%2===0&&dmgType==='damage'&&!card.badge){dmg=Math.min(99999,dmg*2);triggerAnim('horse');}
  if(pu.turtle)dmg=Math.ceil(dmg/2);
  if(pu.koala){dmgType='heal';triggerAnim('koala');}
  if(pu.hedgehog){dmgType='all';triggerAnim('hedgehog');}
  // Parrot: all damage becomes heals
  if(pu.parrot&&dmgType==='damage'&&!card.badge){dmgType='heal';triggerAnim('parrot');}
  // Panda: absorb damage aimed at owner, convert to heal for them
  if(pandaFired&&!bugReflect){dmgType='heal';triggerAnim('panda');}
  // Medusa: carte pari â†’ doppio danno, dispari â†’ metÃ  (ceil). Solo su carte normali, prima del calcolo finale.
  if(pu.medusa&&dmgType==='damage'&&!card.badge){
    if(card.value%2===0){dmg=Math.min(99999,dmg*2);addLog(`<span class='lpu'>ğŸ™ Piovra</span>: carta pari â€” danno raddoppiato!`,'powerup');}
    else{dmg=Math.ceil(dmg/2);addLog(`<span class='lpu'>ğŸ™ Piovra</span>: carta dispari â€” danno dimezzato!`,'powerup');}
  }
  // Camel: heal all other alive players instead of damaging
  let camelFired=false;
  if(pu.camel&&pu.camel.target===activePid&&!card.badge&&dmgType==='damage'){
    camelFired=true;dmgType='all_heal';
  }
  const isDeer=!!pu.deer;

  // tName must be computed AFTER gorilla may have changed target
  const tName=players[target]?.name||'???';
  const aName=players[activePid]?.name||'???';
  let icon,title,desc,dmgClass='red';

  if(bugReflect){icon='ğŸ';title='APE! DANNO RIFLESSO';desc=`${aName} voleva colpire ${players[card.assignedTo]?.name} ma il danno Ã¨ stato riflesso!`;dmgClass='red';}
  else if(dmgType==='all'){icon='ğŸ¦”';title='RICCIO! DANNI A TUTTI!';desc=`${aName} infligge ${dmg} a TUTTI!`;}
  else if(dmgType==='all_heal'){icon='ğŸª';title='CAMMELLO! CURA TUTTI!';desc=`${aName} cura tutti i vivi di ${dmg} HP!`;dmgClass='green';}
  else if(dmgType==='heal'&&target===activePid&&!pu.koala){icon='ğŸ’š';title='CURA SÃ‰ STESSO!';desc=`${aName} guadagna ${dmg} HP!`;dmgClass='green';}
  else if(dmgType==='heal'){icon='ğŸ’š';title=`${pandaFired?'PANDA! DANNO ASSORBITO!':pu.parrot?'PAPPAGALLO! CURA!':'KOALA! CURA!'}`;desc=`${aName} cura ${tName} di ${dmg} HP${pandaFired?' (Panda: danno assorbito!)':''}`;dmgClass='green';}
  else{
    icon=dmg>=80?'ğŸ’¥':dmg===0?'ğŸ›¡ï¸':'âš”ï¸';
    title=dmg===0?'CARTA NULLIFICATA!':(dmg>=80?'COLPO CRITICO!':`COLPITO: ${tName.toUpperCase()}!`);
    desc=`${aName} infligge ${dmg} danni a ${tName}${pu.bull?' (Toro Ã—2!)':pu.turtle?' (Tartaruga Ã·2!)':''}${foxFired?` (ğŸ¦Š Volpe! valore casuale)`:pigFired?' (ğŸ· Maiale! valore 0)':''}`;  }

  // â”€â”€ COMPUTE EVERYTHING BEFORE SHOWING REVEAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // This lets us fire the Firebase write in parallel with the modal
  {
    const hpDeltas=[];
    const extraUpd={};
    const logLines=[];

    // If bug reflected: clear activeBug flag (merged into main batch)
    if(bugReflect) extraUpd[`players/${card.assignedTo}/activeBug`]=false;

    // Reveal secret powerups firing this turn
    const _secretFiring=[];
    if(pu.bull) _secretFiring.push('bull');
    if(pu.turtle) _secretFiring.push('turtle');
    if(pu.koala) _secretFiring.push('koala');
    if(pu.hedgehog) _secretFiring.push('hedgehog');
    if(pu.armadillo&&dmgType!=='heal') _secretFiring.push('armadillo');
    if(pu.deer&&dmgType!=='all') _secretFiring.push('deer');
    if(pu.ram&&dmgType==='damage') _secretFiring.push('ram');
    if(pu.donkey) _secretFiring.push('donkey');
    if(pu.swordfish&&dmgType==='damage') _secretFiring.push('swordfish');
    if(pu.crocodile) _secretFiring.push('crocodile');
    if(pu.duck) _secretFiring.push('duck');
    if(pu.horse&&dmg%2===0&&dmgType==='damage'&&!card.badge) _secretFiring.push('horse');
    if(foxFired) _secretFiring.push('fox');
    if(pigFired) _secretFiring.push('pig');
    if(camelFired) _secretFiring.push('camel');
    if(pu.parrot&&dmgType==='heal'&&!pu.koala&&!pu.parrot.revealed) _secretFiring.push('parrot');
    if(pandaFired&&!bugReflect) _secretFiring.push('panda');
    if(pu.parrot&&dmgType==='heal'&&!pu.koala&&!pu.parrot.revealed) extraUpd['activePowerups/parrot']={...pu.parrot,revealed:true};
    if(pandaFired) extraUpd['activePowerups/panda']=null;
    _secretFiring.forEach(id=>logReveal(id,logLines));

    if(dmgType==='all_heal'){
      const aliveHeal=Object.entries(players).filter(([hpid,p])=>p.alive&&hpid!==activePid);
      aliveHeal.forEach(([hpid])=>hpDeltas.push({pid:hpid,delta:dmg}));
      spawnFloat(`+${dmg} TUTTI`,'green');playSound('heal');vibrate([40]);
      extraUpd['activePowerups/camel']=null;
    } else if(dmgType==='all'){
      const alivePs=Object.entries(players).filter(([_,p])=>p.alive).map(([id])=>id);
      for(const apid of alivePs){
        if(pu.crocodile?.owner===apid&&apid!==activePid){logLines.push({html:`<span class='lpu'>ğŸŠ Coccodrillo</span> protegge <span class='lp'>${players[apid]?.name}</span>!`,type:'system'});continue;}
        if(players[apid]?.activeBug&&apid!==activePid){
          hpDeltas.push({pid:activePid,delta:-(dmg*2)});
          logLines.push({html:`<span class='lpu'>ğŸ Ape</span>: <span class='lp'>${players[apid]?.name}</span> riflette ${dmg*2} a chi ha attaccato!`,type:'damage'});
          extraUpd[`players/${apid}/activeBug`]=false;continue;
        }
        hpDeltas.push({pid:apid,delta:-dmg});
      }
      spawnFloat(`-${dmg} TUTTI`,'red');shakeScreen();playSound(dmg>=80?'crit':'hit');vibrate([100,40,100]);
    }else{
      hpDeltas.push({pid:target,delta:dmgType==='heal'?dmg:-dmg});
      if(pu.armadillo&&dmgType!=='heal'){
        hpDeltas.push({pid:activePid,delta:-dmg});
        const armMsg=target===activePid?`danno Ã—2 su se stesso`:`subisce <span class='ld'>-${dmg}</span>`;
        logLines.push({html:`<span class='lpu'>ğŸ¦¡ Tasso</span>: <span class='lp'>${aName}</span> ${armMsg}!`,type:'damage'});
        triggerAnim('armadillo');
      }
      if(pu.ram&&dmgType==='damage'){
        const ord=state.playerOrder||[];
        const ai=ord.indexOf(target);
        let pi=ai,ni=ai;
        for(let s=1;s<ord.length;s++){const lp=ord[(ai-s+ord.length)%ord.length];if(lp!==target&&players[lp]?.alive){pi=(ai-s+ord.length)%ord.length;break;}}
        for(let s=1;s<ord.length;s++){const rp=ord[(ai+s)%ord.length];if(rp!==target&&players[rp]?.alive){ni=(ai+s)%ord.length;break;}}
        const prevRam=ord[pi],nextRam=ord[ni];
        const applyRamHit=(rpid)=>{
          if(!players[rpid]?.alive||rpid===target)return;
          if(pu.crocodile?.owner===rpid){logLines.push({html:`<span class='lpu'>ğŸŠ Coccodrillo</span> protegge <span class='lp'>${players[rpid]?.name}</span> dall'Ariete!`,type:'system'});return;}
          if(players[rpid]?.activeBug){
            hpDeltas.push({pid:activePid,delta:-(dmg*2)});
            logLines.push({html:`<span class='lpu'>ğŸ Ape</span>: <span class='lp'>${players[rpid]?.name}</span> riflette ${dmg*2}!`,type:'damage'});
            extraUpd[`players/${rpid}/activeBug`]=false;return;
          }
          hpDeltas.push({pid:rpid,delta:-dmg});
          logLines.push({html:`<span class='lpu'>ğŸ Ariete</span>: <span class='lp'>${players[rpid]?.name}</span> <span class='ld'>-${dmg}</span>`,type:'damage'});
        };
        if(prevRam!==target)applyRamHit(prevRam);
        if(nextRam!==target&&nextRam!==prevRam)applyRamHit(nextRam);
        triggerAnim('ram');
      }
      if(pu.swordfish&&dmgType==='damage'){
        const ord=state.playerOrder||[];
        const ti=ord.indexOf(target);
        let count=0;
        for(let s=1;s<ord.length&&count<2;s++){
          const np=ord[(ti+s)%ord.length];
          if(np!==target&&players[np]?.alive){
            count++;
            if(pu.crocodile?.owner===np){logLines.push({html:`<span class='lpu'>ğŸŠ Coccodrillo</span> protegge <span class='lp'>${players[np]?.name}</span> dal Pesce Palla!`,type:'system'});continue;}
            if(players[np]?.activeBug){
              hpDeltas.push({pid:activePid,delta:-(dmg*2)});
              logLines.push({html:`<span class='lpu'>ğŸ Ape</span>: <span class='lp'>${players[np]?.name}</span> riflette ${dmg*2} danni!`,type:'damage'});
              extraUpd[`players/${np}/activeBug`]=false;continue;
            }
            hpDeltas.push({pid:np,delta:-dmg});
            logLines.push({html:`<span class='lpu'>ğŸ¡ Pesce Palla</span>: <span class='lp'>${players[np]?.name}</span> <span class='ld'>-${dmg}</span>!`,type:'damage'});
          }
        }
        triggerAnim('swordfish');
      }
      const isHeal=dmgType==='heal';
      spawnFloat(`${isHeal?'+':'-'}${dmg}`,isHeal?'green':'red');
      if(!isHeal){shakeScreen();playSound(dmg>=80?'crit':'hit');vibrate(dmg>=80?[100,50,100,50,200]:[80]);if(dmg>=80)critExplode();}
      else{playSound('heal');vibrate([40]);}
    }

    // Stats (fire-and-forget)
    if(dmgType!=='heal'&&dmgType!=='all_heal'){G.sessionStats.dmgDealt+=dmg;if(dmg>G.sessionStats.highCard)G.sessionStats.highCard=dmg;}
    if(G.roomId&&G.playerId){
      const statUpd={};
      if(dmgType==='all'){
        const alivePs=Object.entries(players).filter(([_,p])=>p.alive);
        const totalDmg=dmg*alivePs.length;
        statUpd[`stats/${activePid}/dmgDealt`]=(state.stats?.[activePid]?.dmgDealt||0)+totalDmg;
        statUpd[`stats/${activePid}/maxHit`]=Math.max(state.stats?.[activePid]?.maxHit||0,dmg);
        const curMin=state.stats?.[activePid]?.minHit;
        statUpd[`stats/${activePid}/minHit`]=(curMin===undefined||curMin===null)?dmg:Math.min(curMin,dmg);
        alivePs.forEach(([pid])=>{statUpd[`stats/${pid}/dmgReceived`]=(state.stats?.[pid]?.dmgReceived||0)+dmg;statUpd[`stats/${pid}/timesHit`]=(state.stats?.[pid]?.timesHit||0)+1;});
      } else if(dmgType==='all_heal'){
        const aliveHealPs=Object.entries(players).filter(([hpid,p])=>p.alive&&hpid!==activePid);
        aliveHealPs.forEach(([hpid])=>{statUpd[`stats/${hpid}/totalHeal`]=(state.stats?.[hpid]?.totalHeal||0)+dmg;});
      } else if(dmgType==='heal'){
        statUpd[`stats/${target}/totalHeal`]=(state.stats?.[target]?.totalHeal||0)+dmg;
      } else {
        statUpd[`stats/${activePid}/dmgDealt`]=(state.stats?.[activePid]?.dmgDealt||0)+dmg;
        statUpd[`stats/${activePid}/maxHit`]=Math.max(state.stats?.[activePid]?.maxHit||0,dmg);
        const curMin2=state.stats?.[activePid]?.minHit;
        statUpd[`stats/${activePid}/minHit`]=(curMin2===undefined||curMin2===null)?dmg:Math.min(curMin2,dmg);
        statUpd[`stats/${target}/dmgReceived`]=(state.stats?.[target]?.dmgReceived||0)+dmg;
        statUpd[`stats/${target}/timesHit`]=(state.stats?.[target]?.timesHit||0)+1;
        if(target===activePid) statUpd[`stats/${activePid}/selfHits`]=(state.stats?.[activePid]?.selfHits||0)+1;
        else statUpd[`stats/${activePid}/targets/${target}`]=(state.stats?.[activePid]?.targets?.[target]||0)+1;
      }
      if(Object.keys(statUpd).length) dbUpdate(`rooms/${G.roomId}`,statUpd).catch(()=>{});
    }

    // Main log line
    const lc=dmgType==='heal'?'lh':'ld';
    const sym=dmgType==='heal'?'+':'-';
    if(players[target]?.jaguarShield&&pu.jaguar?.owner===target&&target!==activePid&&dmgType==='damage'&&!card.badge){
      logReveal('jaguar',logLines);
      const jAlive=Object.entries(players).filter(([jpid,jp])=>jp.alive&&jpid!==target);
      if(jAlive.length>0){
        const [jvpid,jvp]=jAlive[rnd(0,jAlive.length-1)];
        logLines.push({html:`<span class='lpu'>ğŸˆâ€â¬› Gatto</span>: <span class='lp'>${players[target]?.name}</span> rimanda il danno su <span class='lp'>${jvp.name}</span>!`,type:'damage'});
        toast(`ğŸˆâ€â¬› Gatto! Danno di ${players[target]?.name} ribaltato su ${jvp.name}!`);
        const origIdx=hpDeltas.findIndex(d=>d.pid===target&&d.delta<0);
        if(origIdx>-1){hpDeltas[origIdx]={pid:jvpid,delta:hpDeltas[origIdx].delta};}
        extraUpd[`players/${target}/jaguarShield`]=false;
        extraUpd['activePowerups/jaguar']=null;
      }
    }
    const targetHpBefore=players[target]?.hp||0;
    const activatorHpBefore=players[activePid]?.hp||0;
    let mainLogHtml;
    if(dmgType==='all'){
      mainLogHtml=`âš”ï¸ <span class='lp'>${aName}</span> <span class='larr'>â†  TUTTI</span> <span class='ld'>-${dmg}</span> HP ciascuno${pu.hedgehog?' <span class=\'lpu\'>ğŸ¦” Riccio</span>':''}`;
    } else if(dmgType==='all_heal'){
      mainLogHtml=`ğŸ’š <span class='lpu'>ğŸª Cammello</span>: <span class='lp'>${aName}</span> cura tutti i vivi di <span class='lh'>+${dmg}</span> HP!`;
    } else if(dmgType==='heal'){
      mainLogHtml=`ğŸ’š <span class='lp'>${aName}</span> <span class='larr'>â†’</span> <span class='lp'>${tName}</span> <span class='lh'>+${dmg} HP</span>${pu.koala?' <span class=\'lpu\'>ğŸ¨ Koala</span>':pu.parrot?' <span class=\'lpu\'>ğŸ¦œ Pappagallo</span>':pandaFired?' <span class=\'lpu\'>ğŸ¼ Panda</span>':''}`;
    } else {
      const critStr=dmg>=80?' âš¡ <b>CRITICO!</b>':'';
      const bugStr=bugReflect?' <span class=\'lpu\'>ğŸ Riflesso</span>':'';
      const pigStr=pigFired?' <span class=\'lpu\'>ğŸ· Maiale</span>':'';
      const foxStr=foxFired?` <span class='lpu'>ğŸ¦Š Volpe</span> (${card.value}â†’${dmg})`:'';
      mainLogHtml=`âš”ï¸ <span class='lp'>${aName}</span> <span class='larr'>â†’</span> <span class='lp'>${tName}</span> <span class='ld'>-${dmg} HP</span>${critStr}${bugStr}${pigStr}${foxStr}`;
    }
    logLines.unshift({html:mainLogHtml,type:dmgType==='heal'?'heal':'damage'});

    // Compute batch
    const batchResult=computeHpBatch(players,hpDeltas);
    flashHpCards(hpDeltas,players);

    // Cervo
    const deerDeltas=[];
    if(isDeer&&dmgType!=='all'){
      const remaining=(state.cards||[]).filter(c=>!c.badge&&c.id!==card.id);
      if(remaining.length>0){
        const deerCard=remaining[rnd(0,remaining.length-1)];
        triggerAnim('deer');
        Object.entries(batchResult.working).forEach(([dpid,p])=>{if(p.alive) deerDeltas.push({pid:dpid,delta:-deerCard.value});});
        logLines.push({html:`<span class='lpu'>ğŸ¦Œ Cervo</span> carta ${deerCard.value} â†’ <span class='ld'>-${deerCard.value} a TUTTI</span>`,type:'damage'});
        spawnFloat(`ğŸ¦Œ -${deerCard.value}`,'red');shakeScreen();
      }
    }
    const finalDeltas=[...hpDeltas,...deerDeltas];
    const finalBatch=deerDeltas.length>0?computeHpBatch(players,finalDeltas):batchResult;
    if(G.bearMode&&G.bearCardsChosen===0){G.bearFirstTarget=card.assignedTo;G.bearFirstCardId=card.id;}

    // Clear after-PUs + postUpd
    const afters=['bull','hedgehog','turtle','koala','armadillo','deer','ram','donkey','crocodile','swordfish','frog','zebra','scarab','horse','duck','monkey','elephant','pig','fox'];
    afters.forEach(id=>{if(pu[id])extraUpd[`activePowerups/${id}`]=null;});
    Object.assign(extraUpd,postUpd);

    // Compute final players state
    const computedPlayers={...players};
    Object.entries(finalBatch.working).forEach(([pid,w])=>{computedPlayers[pid]={...players[pid],...w};});
    // BUG FIX 1: also apply player-level changes from extraUpd (e.g. spider skipNext, activeBug, jaguarShield)
    Object.entries(extraUpd).forEach(([k,v])=>{
      const m=k.match(/^players\/([^/]+)\/(.+)$/);
      if(m){const[,epid,field]=m;if(computedPlayers[epid])computedPlayers[epid]={...computedPlayers[epid],[field]:v};}
    });

    // Merge Zecca into main batch (no separate write)
    if(state.tickCard&&computedPlayers[activePid]?.alive){
      const zecVal=state.tickCard.value;
      const zecCurHp=computedPlayers[activePid]?.hp||0;
      const zecNewHp=Math.max(0,zecCurHp-zecVal);
      extraUpd[`players/${activePid}/hp`]=zecNewHp;
      extraUpd[`players/${activePid}/alive`]=zecNewHp>0;
      computedPlayers[activePid]={...computedPlayers[activePid],hp:zecNewHp,alive:zecNewHp>0};
      logLines.push({html:`<span class='lpu'>ğŸœ Formica</span>: <span class='lp'>${computedPlayers[activePid]?.name||'?'}</span> subisce <span class='ld'>-${zecVal}</span> dopo la carta!`,type:'damage'});
      spawnFloat(`ğŸœ -${zecVal}`,'red');
      if(zecNewHp<=0) triggerEliminationAnim(computedPlayers[activePid]?.name||'?');
    }
    // Mosca: applica danno al bersaglio fisso dopo ogni carta (bypassa Panda/Ape/Gatto)
    if(state.moscaCard&&state.activePowerups?.fly?.target){
      const moscaTarget=state.activePowerups.fly.target;
      if(computedPlayers[moscaTarget]?.alive){
        const moscaVal=state.moscaCard.value;
        const moscaCurHp=computedPlayers[moscaTarget]?.hp||0;
        const moscaNewHp=Math.max(0,moscaCurHp-moscaVal);
        extraUpd[`players/${moscaTarget}/hp`]=moscaNewHp;
        extraUpd[`players/${moscaTarget}/alive`]=moscaNewHp>0;
        computedPlayers[moscaTarget]={...computedPlayers[moscaTarget],hp:moscaNewHp,alive:moscaNewHp>0};
        logLines.push({html:`<span class='lpu'>ğŸª° Mosca</span>: <span class='lp'>${computedPlayers[moscaTarget]?.name||'?'}</span> subisce <span class='ld'>-${moscaVal}</span> dalla mosca!`,type:'damage'});
        spawnFloat(`ğŸª° -${moscaVal}`,'red');
        if(moscaNewHp<=0){
          triggerEliminationAnim(computedPlayers[moscaTarget]?.name||'?');
          // Mosca elimina il bersaglio â†’ disattiva automaticamente
          extraUpd['moscaCard']=null;
          extraUpd['activePowerups/fly']=null;
          logLines.push({html:`<span class='lpu'>ğŸª° Mosca</span>: bersaglio eliminato â€” effetto disattivato!`,type:'system'});
        }
      }
    }

    const aliveCount=Object.values(computedPlayers).filter(p=>p.alive).length;

    // Flush logs NOW (before modal â€” they appear immediately)
    logLines.forEach(l=>addLog(l.html,l.type));

    // Trigger elim anims for newly dead
    finalBatch.eliminated.forEach(pid=>{const p=players[pid];if(p)triggerEliminationAnim(p.name||'?');});
    G.sessionStats.turnsPlayed++;

    // â”€â”€ FIRE WRITE IMMEDIATELY â€” parallel with reveal modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const combinedUpd={...finalBatch.updates,...extraUpd};
    const _writePromise=Object.keys(combinedUpd).length?dbUpdate(`rooms/${G.roomId}`,combinedUpd):Promise.resolve();

    // Pre-compute merged state for proceedAfterCard (ready before user clicks OK)
    const _mergedState={
      ...state,
      players:computedPlayers,
      activePowerups:Object.fromEntries(
        Object.entries({...state.activePowerups,...Object.fromEntries(
          Object.entries({...extraUpd,...postUpd})
            .filter(([k])=>k.startsWith('activePowerups/'))
            .map(([k,v])=>[k.replace('activePowerups/',''),v])
        )}).filter(([,v])=>v!==null)
      )
    };

    if(aliveCount<=1){
      // Game over â€” flush logs and declare winner
      await flushAllLogs();
      const winnerPid=Object.entries(computedPlayers).find(([_,p])=>p.alive)?.[0]||null;
      await _writePromise;
      await dbUpdate(`rooms/${G.roomId}`,{status:'gameover',winner:winnerPid});
      G.pendingConfirm=false;
      // Show reveal without callback (game is ending)
      showReveal(icon,title,desc,dmg,dmgClass,()=>{});
      return;
    }

    // Show reveal modal â€” write is already in-flight, will be done by click time
    showReveal(icon,title,desc,dmg,dmgClass,async()=>{
      // Write should already be complete; await just in case
      await _writePromise;

      if(computedPlayers[activePid]&&!computedPlayers[activePid].alive){
        const freshForElim=G._lastState||state;
        if(freshForElim) await clearPlayerPowerups(activePid,freshForElim);
        G.pendingConfirm=false;_cardLocked=false;
        G.bearMode=false;G.bearCardsChosen=0;G.masterOverrideActive=false;
        const freshNext=G._lastState||freshForElim;
        if(freshNext&&freshNext.status==='playing') await nextTurn(freshNext,activePid);
        return;
      }

      await proceedAfterCard(_mergedState,activePid);
      G.pendingConfirm=false;
    });
  }
}

// â•â•â• BATCH HP SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Computes HP changes from in-memory state â€” NO extra Firebase GETs.
// Returns: { updates: {}, eliminated: [pids], newPlayers: {...} }
function computeHpBatch(players, deltas){
  // deltas = [{pid, delta}, ...]
  const upd={};
  const eliminated=[];
  const newPlayers={};
  // Build a working copy of HP values to accumulate multiple deltas on same player
  const working={};
  Object.entries(players).forEach(([pid,p])=>{working[pid]={hp:p.hp,alive:p.alive,maxHp:p.maxHp||99999,name:p.name};});
  for(const {pid,delta} of deltas){
    const p=working[pid];
    if(!p||!p.alive) continue;
    const newHp=Math.max(0,p.hp+delta); // HP can exceed initial HP per rules
    p.hp=newHp;
    if(newHp===0&&p.alive){p.alive=false;eliminated.push(pid);}
  }
  // Build firebase update object only for changed players
  Object.entries(working).forEach(([pid,p])=>{
    const orig=players[pid];
    if(p.hp!==orig.hp||p.alive!==orig.alive){
      upd[`players/${pid}/hp`]=p.hp;
      upd[`players/${pid}/alive`]=p.alive;
      newPlayers[pid]={...orig,...p};
    }
  });
  return {updates:upd,eliminated,working};
}

// Fire visual effects for HP changes (no Firebase)
function flashHpCards(deltas,players){
  for(const {pid,delta} of deltas){
    const p=players[pid];if(!p||!p.alive)continue;
    const el=document.getElementById(`hp-${pid}`);
    if(el){el.classList.add(delta>0?'healed':'hit');setTimeout(()=>el.classList.remove('healed','hit'),600);}
  }
}

// Legacy single-player apply used ONLY in isolated badge card paths
async function applyHpFresh(pid,delta){
  // PERF: use cached state, avoid redundant dbGet round-trip
  const p=G._lastState?.players?.[pid]||(await dbGet(`rooms/${G.roomId}/players/${pid}`));
  if(!p||!p.alive)return;
  const newHp=Math.max(0,p.hp+delta); // HP can exceed initial per game rules (consistent with computeHpBatch)
  const alive=newHp>0;
  await dbUpdate(`rooms/${G.roomId}`,{[`players/${pid}/hp`]:newHp,[`players/${pid}/alive`]:alive});
  if(!alive)triggerEliminationAnim(p.name||'?');
  const el=document.getElementById(`hp-${pid}`);
  if(el){el.classList.add(delta>0?'healed':'hit');setTimeout(()=>el.classList.remove('healed','hit'),600);}
}

// BUG FIX: clear active powerups owned by eliminated player
async function clearPlayerPowerups(pid,state){
  const pu=state?.activePowerups||{};
  const upd={};
  for(const [puId,val] of Object.entries(pu)){
    if(val?.owner===pid) upd[`activePowerups/${puId}`]=null;
  }
  // FIX: also clear player-level flags that persist after elimination
  upd[`players/${pid}/jaguarShield`]=false;
  upd[`players/${pid}/activeBug`]=false;
  upd[`players/${pid}/skipNext`]=false;
  if(state?.butterflyActive&&state.butterflyOwner===pid){
    upd['butterflyActive']=false;upd['butterflyCards']=null;upd['butterflyOwner']=null;
  }
  // Se il bersaglio della Mosca viene eliminato, rimuovi l'effetto
  if(state?.moscaCard&&state?.activePowerups?.fly?.target===pid){
    upd['moscaCard']=null;upd['activePowerups/fly']=null;
  }
  // Se l'owner della Mosca viene eliminato, rimuovi l'effetto
  if(state?.moscaCard&&state?.activePowerups?.fly?.owner===pid){
    upd['moscaCard']=null;upd['activePowerups/fly']=null;
  }
  if(Object.keys(upd).length) await dbUpdate(`rooms/${G.roomId}`,upd);
}

async function checkElimAndWin(pid){
  // PERF FIX: use cached state instead of dbGet
  const fresh=G._lastState||(await dbGet(`rooms/${G.roomId}`));
  if(!fresh)return;
  if(!fresh.players?.[pid]?.alive) await clearPlayerPowerups(pid,fresh);
  await checkWin(fresh);
}

// FIX 4+5: clear 'after' PUs that linger if a badge card is picked instead of normal card
async function clearAfterBadgePick(puState){
  const toCheck=['zebra','scarab','bull','hedgehog','turtle','koala','armadillo','deer','ram','donkey','crocodile','swordfish','frog','horse','duck','monkey','elephant','pig','fox'];
  const upd={};
  toCheck.forEach(id=>{if(puState?.[id])upd[`activePowerups/${id}`]=null;});
  if(Object.keys(upd).length) await dbUpdate(`rooms/${G.roomId}`,upd);
}
async function clearAfterPU(pu){
  const afters=['bull','hedgehog','turtle','koala','armadillo','deer','ram','donkey','crocodile','swordfish','frog','zebra','scarab','horse','duck','monkey','elephant','pig','camel','fox','blacksheep'];
  const upd={};afters.forEach(id=>{if(pu[id])upd[`activePowerups/${id}`]=null;});
  if(Object.keys(upd).length)await dbUpdate(`rooms/${G.roomId}`,upd);
}

// â•â• Reveal modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showReveal(icon,title,desc,dmg,dmgClass,onClose){
  document.getElementById('reveal-icon').textContent=icon;
  document.getElementById('reveal-title').textContent=title;
  document.getElementById('reveal-desc').textContent=desc;
  const dmgEl=document.getElementById('reveal-dmg');
  if(dmg!==undefined){dmgEl.style.display='block';dmgEl.className=`reveal-dmg ${dmgClass}`;dmgEl.textContent=`${dmgClass==='red'?'-':dmgClass==='green'?'+':'='}${dmg}`;}
  else{dmgEl.style.display='none';}
  document.getElementById('overlay-reveal')._cb=onClose;
  showOverlay('overlay-reveal');
}
function closeReveal(){const cb=document.getElementById('overlay-reveal')._cb;closeOverlay('overlay-reveal');if(cb)cb();}

// â•â• Proceed after card (Bear/Fox/Dog) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function proceedAfterCard(state,activePid){
  G.pendingConfirm=false;_cardLocked=false;

  // Bear mode: allow 2nd pick
  if(G.bearMode&&G.bearCardsChosen===0){
    G.bearCardsChosen=1;
    triggerAnim('bear');
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/bear':null});
    const freshBear=G._lastState||state;
    if(freshBear&&freshBear.status==='playing') renderCards(freshBear,true,null);
    return;
  }

  G.bearMode=false;G.bearCardsChosen=0;G.bearFirstTarget=null;G.bearFirstCardId=null;
  G.masterOverrideActive=false;G.masterOverridePid=null;

  // Use the `state` parameter directly â€” it contains the correctly merged post-card state
  // built by resolveCard. G._lastState is stale here (Firebase listener hasn't fired yet).
  const fresh=state;
  if(!fresh||fresh.status!=='playing')return;

  // If active player was eliminated, skip PU choice
  if(!fresh.players?.[activePid]?.alive){
    const realFresh=G._lastState||fresh;
    await nextTurn(realFresh,activePid);return;
  }

  await showPuChoice(fresh,activePid);
}

// â•â• PU choice â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showPuChoice(state,activePid){
  const pu=state.activePowerups||{};

  // Wolf blocks all PU choices
  if(pu.wolf&&pu.wolf.owner!==activePid){
    addLog(`<span class='lpu'>ğŸº Lupo</span>: nessun powerup disponibile.`,'system');
    toast('ğŸº Lupo! Nessun potere questo turno.');
    await nextTurn(state, activePid);return;
  }

  // Owl blocks
  if(pu.owl){
    addLog(`<span class='lpu'>ğŸ¦‰ Gufo</span>: <span class='lp'>${state.players?.[activePid]?.name}</span> non puÃ² usare poteri.`,'system');
    toast('ğŸ¦‰ Gufo! Nessun potere questo turno.');
    // Pass owl clear to nextTurn â€” merged into its single write (no extra round-trip)
    await nextTurn(G._lastState||state,activePid,{'activePowerups/owl':null});return;
  }

  // Chaos mode: random PU
  if(state.mode==='chaos'){
    const bans=MODE_BANS.chaos;
    const hasElimChaos=Object.values(state.players||{}).some(pl=>!pl.alive);
    const enabled=POWERUPS.filter(p=>{
      if(bans.includes(p.id))return false;
      if(state.puEnabled?.[p.id]===false||G.puEnabled[p.id]===false)return false;
      // Singleton checks
      if(p.id==='rat'&&pu.rat)return false;
      if(p.id==='cheetah'&&pu.cheetah)return false;
      if(p.id==='tick'&&state.tickCard)return false;
      if(p.id==='fly'&&state.moscaCard)return false;
      if(p.id==='viper'&&pu.viper)return false;
      if(p.id==='wolf'&&pu.wolf)return false;
      if(p.id==='ostrich'&&pu.ostrich)return false;
      if(p.id==='scorpion'&&pu.scorpion)return false;
      if(p.id==='lion'&&pu.lion)return false;
      if(p.id==='weasel'&&pu.weasel)return false;
      if(p.id==='horse'&&pu.horse)return false;
      if(p.id==='pigeon'&&pu.pigeon)return false;
      if(p.id==='walrus'&&pu.walrus)return false;
      if(p.id==='hyena'&&pu.hyena)return false;
      if(p.id==='duck'&&pu.duck)return false;
      if(p.id==='parrot'&&pu.parrot)return false;
      if(p.id==='ladybug'&&pu.ladybug)return false;
      if(p.id==='pig'&&pu.pig)return false;
      if(p.id==='camel'&&pu.camel)return false;
      if(p.id==='fox'&&pu.fox)return false;
      if(p.id==='blacksheep'&&pu.blacksheep)return false;
      if(p.id==='medusa'&&pu.medusa)return false;
      if(p.id==='skunk'&&pu.skunk)return false;
      if(p.id==='panda'&&pu.panda)return false;
        return true;
    });
    // Dog in chaos: 2 random PU
    const dogActive=pu.dog?.owner===activePid;
    const puCount=dogActive?2:1;
    // PERF FIX: batch all chaos PU activations into one Firebase write
    const chaosUpd={};
    for(let i=0;i<puCount&&enabled.length>0;i++){
      const pick=enabled.splice(Math.floor(Math.random()*enabled.length),1)[0];
      await activatePu(pick,state,activePid,chaosUpd); // collect into chaosUpd, no write yet
      triggerAnim(pick.id);
      addLog(`<span class='lp'>${state.players?.[activePid]?.name}</span> ğŸŒ€ casuale: <span class='lpu'>${pick.icon} ${pick.name}</span>`,'powerup');
      playSound('pu');G.sessionStats.puUsed++;
    }
    if(dogActive) chaosUpd['activePowerups/dog']=null;
    // Pass chaosUpd to nextTurn â€” merged into its single write (eliminates extra round-trip)
    await nextTurn(G._lastState||state,activePid,chaosUpd);return;
  }

  // Normal PU choice
  document.getElementById('pu-section').style.display='block';
  document.getElementById('confirm-row').style.display='flex';
  G.selectedPU=null;
  const _prevDogMode=G.dogMode;
  G.dogMode=!!(pu.dog?.owner===activePid);
  if(!_prevDogMode) G.dogPuCount=0; // only reset if starting fresh, not mid-dog-sequence

  // Pecora: force random PU for target player
  if(pu.blacksheep&&pu.blacksheep.target===activePid){
    showAnimalAlert('ğŸ‘','PECORA!','Il gioco sceglie il powerup per te!','#bdbdbd');
    addLog(`<span class='lpu'>ğŸ‘ Pecora</span>: <span class='lp'>${state.players?.[activePid]?.name}</span> non puÃ² scegliere!`,'system');
    toast('ğŸ‘ Pecora! Il gioco sceglie per te.');
    await dbUpdate(`rooms/${G.roomId}`,{'activePowerups/blacksheep':null});
    const bsState=G._lastState||state;
    const bsBans=MODE_BANS[bsState.mode||'classic']||[];
    const bsPu=bsState.activePowerups||{};
    const bsHasElim=Object.values(bsState.players||{}).some(pl=>!pl.alive);
    const bsEnabled=POWERUPS.filter(p=>{
      if(bsBans.includes(p.id))return false;if(bsState.puEnabled?.[p.id]===false||G.puEnabled[p.id]===false)return false;
      if(p.id==='rat'&&bsPu.rat)return false;if(p.id==='cheetah'&&bsPu.cheetah)return false;
      if(p.id==='tick'&&bsState.tickCard)return false;if(p.id==='fly'&&bsState.moscaCard)return false;if(p.id==='viper'&&bsPu.viper)return false;
      if(p.id==='wolf'&&bsPu.wolf)return false;if(p.id==='ostrich'&&bsPu.ostrich)return false;
      if(p.id==='scorpion'&&bsPu.scorpion)return false;if(p.id==='lion'&&bsPu.lion)return false;
      if(p.id==='weasel'&&bsPu.weasel)return false;if(p.id==='horse'&&bsPu.horse)return false;
      if(p.id==='pigeon'&&bsPu.pigeon)return false;if(p.id==='walrus'&&bsPu.walrus)return false;
      if(p.id==='hyena'&&bsPu.hyena)return false;if(p.id==='duck'&&bsPu.duck)return false;
      if(p.id==='parrot'&&bsPu.parrot)return false;if(p.id==='ladybug'&&bsPu.ladybug)return false;
      if(p.id==='pig'&&bsPu.pig)return false;if(p.id==='camel'&&bsPu.camel)return false;
      if(p.id==='fox'&&bsPu.fox)return false;if(p.id==='blacksheep'&&bsPu.blacksheep)return false;
      if(p.id==='panda'&&bsPu.panda)return false;
      if(p.id==='medusa'&&bsPu.medusa)return false;
      if(p.id==='skunk'&&bsPu.skunk)return false;
      return true;
    });
    hidePuSection();
    const bsUpd={'activePowerups/blacksheep':null}; // pre-cleared above, carry it forward
    if(bsEnabled.length>0){
      const bsPick=bsEnabled[Math.floor(Math.random()*bsEnabled.length)];
      await activatePu(bsPick,bsState,activePid,bsUpd); // batch into bsUpd
      triggerAnim(bsPick.id);
      addLog(`<span class='lp'>${bsState.players?.[activePid]?.name}</span> ğŸ‘ Pecora: <span class='lpu'>${bsPick.icon} ${bsPick.name}</span>`,'powerup');
      playSound('pu');G.sessionStats.puUsed++;
    }
    // Pass bsUpd to nextTurn â€” single write instead of 2-3 sequential ones
    const freshBS=G._lastState||bsState;
    await nextTurn(freshBS,activePid,bsUpd);return;
  }

  // Ladybug: determine if PU choices should be covered
  const ladybugCovered=!!(pu.ladybug&&pu.ladybug.owner!==activePid);

  const bans=MODE_BANS[state.mode]||[];
  const hasElim=Object.values(state.players||{}).some(pl=>!pl.alive);
  const weaselActive=pu.weasel&&pu.weasel.owner!==activePid;
  const puChoiceCount=weaselActive?2:3;

  const enabled=POWERUPS.filter(p=>{
    if(bans.includes(p.id))return false;
    if(state.puEnabled?.[p.id]===false||G.puEnabled[p.id]===false)return false;
    if(p.id==='rat'&&pu.rat)return false;
    if(p.id==='cheetah'&&pu.cheetah)return false;
    if(p.id==='tick'&&state.tickCard)return false;
    if(p.id==='viper'&&pu.viper)return false;
    if(p.id==='wolf'&&pu.wolf)return false;
    if(p.id==='ostrich'&&pu.ostrich)return false;
    if(p.id==='scorpion'&&pu.scorpion)return false;
    if(p.id==='lion'&&pu.lion)return false;
    if(p.id==='weasel'&&pu.weasel)return false;
    // Singleton checks for new PUs
    if(p.id==='horse'&&pu.horse)return false;
    if(p.id==='pigeon'&&pu.pigeon)return false;
    if(p.id==='walrus'&&pu.walrus)return false;
    if(p.id==='hyena'&&pu.hyena)return false;
    if(p.id==='duck'&&pu.duck)return false;
    if(p.id==='parrot'&&pu.parrot)return false;
    if(p.id==='ladybug'&&pu.ladybug)return false;
    if(p.id==='pig'&&pu.pig)return false;
    if(p.id==='camel'&&pu.camel)return false;
    if(p.id==='fox'&&pu.fox)return false;
    if(p.id==='blacksheep'&&pu.blacksheep)return false;
    if(p.id==='panda'&&pu.panda)return false;
    if(p.id==='medusa'&&pu.medusa)return false;
    if(p.id==='fly'&&state.moscaCard)return false;
    if(p.id==='skunk'&&pu.skunk)return false;
    return true;
  });
  const chosen=[...enabled].sort(()=>Math.random()-.5).slice(0,Math.min(puChoiceCount,enabled.length));
  G._puChoices=chosen; // Store for Dog auto-activate
  const grid=document.getElementById('pu-grid');grid.innerHTML='';

  if(weaselActive){
    toast('ğŸ¦¦ Donnola! Solo 2 poteri tra cui scegliere.');
  }
  if(ladybugCovered){
    toast('ğŸ Coccinella! Tutti i powerup sono nascosti!');
  }

  chosen.forEach(pu=>{
    const th=PU_THEMES[pu.id]||{bg:'linear-gradient(160deg,#0e0e1e,#1a1a2e)',glow:'#c0c0c0',accent:'#e0e0e0'};
    const covered=ladybugCovered;
    const coverTh={bg:'linear-gradient(160deg,#280000,#580000,#920000)',glow:'#ef5350',accent:'#bdbdbd'};
    const dispTh=covered?coverTh:th;
    const div=document.createElement('div');
    div.className=covered?'pu-choice pu-choice-covered':'pu-choice';
    div.style.cssText=`background:${dispTh.bg};border:2px solid ${dispTh.glow}50;box-shadow:0 8px 30px rgba(0,0,0,.7)`;
    div.innerHTML=covered?`
      <div class="puc-art-zone" style="background:radial-gradient(ellipse 120% 100% at 50% 40%,${dispTh.glow}40 0%,transparent 70%)">
        <div class="puc-icon" style="filter:drop-shadow(0 0 18px ${dispTh.glow})">â“</div>
      </div>
      <div class="puc-band" style="background:linear-gradient(180deg,transparent,rgba(0,0,0,.9) 30%)">
        <div class="puc-name" style="color:${dispTh.accent};letter-spacing:4px">SEGRETO</div>
        <div class="puc-desc">ğŸ Coccinella â€” potere nascosto</div>
      </div>
      <div class="puc-corner" style="color:${dispTh.accent}">â“</div>
      <div class="puc-shine"></div>` : `
      <div class="puc-art-zone" style="background:radial-gradient(ellipse 120% 100% at 50% 40%,${th.glow}40 0%,transparent 70%)">
        <div class="puc-icon" style="filter:drop-shadow(0 0 18px ${th.glow}) drop-shadow(0 0 35px ${th.glow}60)">${pu.icon}</div>
      </div>
      <div class="puc-band" style="background:linear-gradient(180deg,transparent,rgba(0,0,0,.9) 30%)">
        <div class="puc-name" style="color:${th.accent};text-shadow:0 0 14px ${th.glow}">${pu.name.toUpperCase()}</div>
        <div class="puc-desc">${pu.desc}</div>
      </div>
      <div class="puc-corner" style="color:${th.accent}">${pu.icon}</div>
      <div class="puc-shine"></div>`;
    div.addEventListener('mouseenter',()=>{div.style.transform='perspective(600px) rotateY(-6deg) rotateX(3deg) scale(1.05)';div.style.boxShadow=`0 16px 50px rgba(0,0,0,.8),0 0 30px ${dispTh.glow}60`;div.style.borderColor=`${dispTh.glow}90`;});
    div.addEventListener('mouseleave',()=>{if(!div.classList.contains('chosen')){div.style.transform='';div.style.boxShadow=`0 8px 30px rgba(0,0,0,.7)`;div.style.borderColor=`${dispTh.glow}50`;}});
    div.addEventListener('click',()=>{
      playSound('flip');vibrate([40]);
      document.querySelectorAll('.pu-choice').forEach(c=>{c.classList.remove('chosen');c.style.transform='';c.style.boxShadow=`0 8px 30px rgba(0,0,0,.7)`;});
      div.classList.add('chosen');
      div.style.transform='perspective(600px) scale(1.07) translateY(-4px)';
      div.style.boxShadow=`0 20px 60px rgba(0,0,0,.9),0 0 50px ${dispTh.glow}70`;
      div.style.borderColor=`${dispTh.glow}`;
      G.selectedPU=pu;
    });
    grid.appendChild(div);
  });
}

async function confirmPowerup(){
  if(!G.selectedPU){toast('Scegli un potere');return;}
  if(!document.getElementById('pu-section')||document.getElementById('pu-section').style.display==='none')return;
  const pu=G.selectedPU;
  try {
  const state=G._lastState||(await dbGet(`rooms/${G.roomId}`));if(!state)return;
  const activePid=G.masterOverrideActive?G.masterOverridePid:G.playerId;

  // Collect ALL PU activation updates into one batch â†’ merged into nextTurn's single write
  const puUpd={};
  await activatePu(pu,state,activePid,puUpd);
  triggerAnim(pu.id);
  const FULLY_HIDDEN_LOG=['eagle','bull','hedgehog','turtle','koala','armadillo','crocodile',
    'bug','deer','butterfly','viper','ram','donkey','scorpion','scarab','zebra','frog','jaguar',
    'horse','walrus','duck','swordfish','tick',
    'parrot','pig','camel','fox','panda','skunk'];
  const SELF_LOGGED_PUBLIC=['pigeon','ladybug'];
  const aName2=state.players?.[activePid]?.name||'?';
  if(FULLY_HIDDEN_LOG.includes(pu.id)){
    addLog(`<span class='lp'>${aName2}</span> attiva <span class='lpu'>â“ un potere segreto</span>`,'system');
  } else if(!SELF_LOGGED_PUBLIC.includes(pu.id)){
    addLog(`<span class='lp'>${aName2}</span> attiva <span class='lpu'>${pu.icon} ${pu.name}</span>`,'powerup');
  }
  playSound('pu');vibrate([40,20,40]);G.sessionStats.puUsed++;
  dbUpdate(`rooms/${G.roomId}`,{[`stats/${activePid}/puCount`]:(state?.stats?.[activePid]?.puCount||0)+1}).catch(()=>{});

  // Dog: batch all 3 PU activations together
  if(pu.id==='dog'&&G._puChoices){
    const otherPus=G._puChoices.filter(p=>p.id!=='dog');
    for(const otherPu of otherPus){
      const freshState=G._lastState||state;
      await activatePu(otherPu,freshState,activePid,puUpd);
      triggerAnim(otherPu.id);
      if(FULLY_HIDDEN_LOG.includes(otherPu.id)){
        addLog(`<span class='lp'>${state.players?.[activePid]?.name}</span> ğŸ• Cane auto-attiva <span class='lpu'>â“ un potere segreto</span>`,'system');
      } else {
        addLog(`<span class='lp'>${state.players?.[activePid]?.name}</span> ğŸ• Cane auto-attiva <span class='lpu'>${otherPu.icon} ${otherPu.name}</span>`,'powerup');
      }
      playSound('pu');G.sessionStats.puUsed++;
    }
    toast(`ğŸ• Cane! Tutti e 3 i poteri attivati!`);
  }

  G.dogMode=false;G.dogPuCount=0;
  hidePuSection();
  // Pass puUpd to nextTurn â†’ merged into its single Firebase write (eliminates 1 round-trip)
  const freshForNext=G._lastState||state;
  await nextTurn(freshForNext,activePid,puUpd);
  } catch(err) {
    console.error('confirmPowerup error:',err);
    G.pendingConfirm=false;_cardLocked=false;
    toast('âš ï¸ Errore nell\'attivazione del potere. Riprova.');
  }
}

function hidePuSection(){
  const s=document.getElementById('pu-section');if(s)s.style.display='none';
  const c=document.getElementById('confirm-row');if(c)c.style.display='none';
}

// â•â• Activate PU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// batchUpd: if provided, merges updates into it instead of calling dbUpdate (for chaos-mode batching)
async function activatePu(pu,state,pid,batchUpd=null){
  const ord=state.playerOrder||[];
  const alive=ord.filter(p=>state.players?.[p]?.alive);
  const myI=alive.indexOf(pid);
  const nextPid=alive[(myI+1)%alive.length];
  const upd={};

  switch(pu.id){
    case 'eagle': {
      const eagleAlive=ord.filter(p=>state.players?.[p]?.alive&&p!==pid);
      const eaglePick=eagleAlive.length>0?eagleAlive[rnd(0,eagleAlive.length-1)]:null;
      if(eaglePick) upd['activePowerups/eagle']={owner:pid,reveal:eaglePick};
      break;
    }
    case 'rat':
      if(state.activePowerups?.rat){toast('ğŸ­ Topo giÃ  attivo!');return;}
      upd['activePowerups/rat']={owner:pid};
      break;
    case 'kangaroo':
      upd['activePowerups/kangaroo']={target:nextPid};
      // Notify IMMEDIATELY (before current turn ends) â€” double-skip fix: spread order in nextTurn ensures clear wins
      addLog(`<span class='lpu'>ğŸ¦˜ Canguro</span>: <span class='lp'>${state.players?.[nextPid]?.name||'?'}</span> salterÃ  il prossimo turno!`,'system');
      toast(`ğŸ¦˜ Canguro! ${state.players?.[nextPid]?.name||'?'} salterÃ  il suo turno!`);
      break;
    case 'cheetah':
      if(state.activePowerups?.cheetah){toast('ğŸ† Ghepardo giÃ  attivo!');return;}
      upd['activePowerups/cheetah']={owner:pid};
      break;
    case 'bear': upd['activePowerups/bear']={owner:pid,target:nextPid}; break;
    case 'owl':  upd['activePowerups/owl']={target:nextPid}; break;
    case 'shark': {
      const thresh=(state.initialHp||1000)*.15;
      const victims=[];
      Object.entries(state.players||{}).forEach(([spid,sp])=>{
        if(sp.alive&&sp.hp<thresh){
          upd[`players/${spid}/alive`]=false;upd[`players/${spid}/hp`]=0;victims.push(sp.name);
          setTimeout(()=>triggerEliminationAnim(sp.name||'?'),400);
        }
      });
      toast(`ğŸ¦ˆ Squalo! ${victims.length?victims.join(', ')+' eliminati!':'Nessuno eliminato.'}`);
      if(victims.length){
        addLog(`<span class='lpu'>ğŸ¦ˆ Squalo</span>: eliminati <span class='ld'>${victims.join(', ')}</span>!`,'elim');
        // FIX 2: check win after shark eliminates players
      }
      break;
    }
    case 'bug': upd[`players/${pid}/activeBug`]=true; break;
    case 'crocodile': upd['activePowerups/crocodile']={owner:pid};
      break;
    case 'tick':
      if(state.tickCard){toast('ğŸœ Formica giÃ  attiva!');return;}
      upd['tickCard']={id:'tick-special',value:rnd(0,100),badge:'tick',assignedTo:'tick'};
      break;
    case 'rhino': {
      // Rinoceronte: somma HP di tutti i vivi / numero vivi (ceil) â†’ danno a giocatore casuale
      const rhinoAlive=Object.entries(state.players||{}).filter(([,rp])=>rp.alive);
      if(rhinoAlive.length>0){
        const totalHp=rhinoAlive.reduce((s,[,rp])=>s+rp.hp,0);
        const avgDmg=Math.ceil(totalHp/rhinoAlive.length);
        // Scegli bersaglio casuale tra tutti i vivi (incluso l'attivatore)
        const [rvpid,rvp]=rhinoAlive[rnd(0,rhinoAlive.length-1)];
        const newRhinoHp=Math.max(0,(state.players[rvpid]?.hp||0)-avgDmg);
        upd[`players/${rvpid}/hp`]=newRhinoHp;upd[`players/${rvpid}/alive`]=newRhinoHp>0;
        if(newRhinoHp===0)setTimeout(()=>triggerEliminationAnim(rvp.name||'?'),400);
        toast(`ğŸ¦ Rinoceronte! ${rvp.name} subisce ${avgDmg} danni (media HP)!`);
        addLog(`<span class='lpu'>ğŸ¦ Rinoceronte</span>: media HP = ${avgDmg}, <span class='lp'>${rvp.name}</span> <span class='ld'>-${avgDmg}</span>!`,'damage');
        spawnFloat(`ğŸ¦ -${avgDmg}`,'red');shakeScreen();playSound('crit');vibrate([100,50,100]);
      } else {toast('ğŸ¦ Rinoceronte: nessun bersaglio!');}
      break;
    }
    case 'fly': {
      if(state.moscaCard){toast('ğŸª° Mosca giÃ  attiva!');return;}
      const flyAlive=Object.entries(state.players||{}).filter(([fpid,fp])=>fp.alive&&fpid!==pid);
      if(flyAlive.length===0){toast('ğŸª° Mosca: nessun bersaglio disponibile!');return;}
      const [flyTarget,flyTargetP]=flyAlive[Math.floor(Math.random()*flyAlive.length)];
      const flyVal=rnd(0,100);
      upd['moscaCard']={id:'mosca-special',value:flyVal,badge:'fly',assignedTo:'fly'};
      upd['activePowerups/fly']={owner:pid,target:flyTarget};
      toast(`ğŸª° Mosca! ${flyTargetP.name} Ã¨ il bersaglio!`);
      addLog(`<span class='lpu'>ğŸª° Mosca</span>: <span class='lp'>${state.players?.[pid]?.name}</span> attiva la Mosca su <span class='lp'>${flyTargetP.name}</span>!`,'powerup');
      // Note: triggerAnim('fly') is called in confirmPowerup â€” no showAnimalAlert here to avoid double box
      break;
    }
    case 'butterfly': {
      const bfAlive=Object.entries(state.players||{}).filter(([bpid,bp])=>bp.alive&&bpid!==pid);
      const bfCards={};
      // BUG FIX: each player gets their OWN butterfly card assigned to their pid
      bfAlive.forEach(([bpid],i)=>{bfCards[`bc${i}`]={id:`bc${i}`,value:rnd(10,80),assignedTo:bpid,assignedName:'ğŸ¦‹',badge:'butterfly'};});
      upd['butterflyActive']=true;upd['butterflyOwner']=pid;upd['butterflyCards']=bfCards;
      break;
    }
    case 'viper':
      if(state.activePowerups?.viper){toast('ğŸ Vipera giÃ  attiva!');return;}
      upd['activePowerups/viper']={value:rnd(0,100)};
      break;
    case 'chameleon': {
      // Camaleonte: i tuoi HP diventano uguali al giocatore con piÃ¹ HP
      const chamAlive=Object.entries(state.players||{}).filter(([,cp])=>cp.alive);
      if(chamAlive.length>0){
        const maxHpEntry=chamAlive.reduce((best,[bpid,bp])=>bp.hp>best[1].hp?[bpid,bp]:best,chamAlive[0]);
        const maxHp=maxHpEntry[1].hp;
        const myHpNow=state.players?.[pid]?.hp||0;
        upd[`players/${pid}/hp`]=maxHp;
        const maxName=maxHpEntry[1].name||'?';
        const myName=state.players?.[pid]?.name||'?';
        const delta=maxHp-myHpNow;
        toast(`ğŸ¦ Camaleonte! ${myName}: ${myHpNow} â†’ ${maxHp} HP (come ${maxName})`);
        addLog(`<span class='lpu'>ğŸ¦ Camaleonte</span>: <span class='lp'>${myName}</span> copia gli HP di <span class='lp'>${maxName}</span> â€” ora ha <span class='lh'>${maxHp}</span> HP!`,delta>=0?'heal':'damage');
        spawnFloat(`${delta>=0?'+':''}${delta}`,delta>=0?'green':'red');
        if(delta>=0)playSound('heal'); else {shakeScreen();playSound('hit');}
      } else {toast('ğŸ¦ Camaleonte: nessun giocatore vivo!');}
      break;
    }
    case 'spider': {
      // Ragno: tutti i giocatori subiscono metÃ  degli HP del giocatore con meno vita (ceil)
      const spiderAlive=Object.entries(state.players||{}).filter(([,sp])=>sp.alive);
      if(spiderAlive.length>0){
        const minHpEntry=spiderAlive.reduce((best,[bpid,bp])=>bp.hp<best[1].hp?[bpid,bp]:best,spiderAlive[0]);
        const dmgAmt=Math.ceil(minHpEntry[1].hp/2);
        const spiderLogParts=[];
        spiderAlive.forEach(([spid,sp])=>{
          const newHp=Math.max(0,sp.hp-dmgAmt);
          upd[`players/${spid}/hp`]=newHp;upd[`players/${spid}/alive`]=newHp>0;
          if(newHp===0)setTimeout(()=>triggerEliminationAnim(sp.name||'?'),400);
          spiderLogParts.push(`<span class='lp'>${sp.name}</span> <span class='ld'>-${dmgAmt}</span>`);
        });
        toast(`ğŸ•·ï¸ Ragno! Tutti subiscono ${dmgAmt} danni!`);
        addLog(`<span class='lpu'>ğŸ•·ï¸ Ragno</span>: -${dmgAmt} a tutti (metÃ  del min HP di ${minHpEntry[1].name}): ${spiderLogParts.join(', ')}!`,'damage');
        spawnFloat(`ğŸ•·ï¸ -${dmgAmt} TUTTI`,'red');shakeScreen();playSound('hit');vibrate([60,30,60]);
      } else {toast('ğŸ•·ï¸ Ragno: nessun giocatore vivo!');}
      break;
    }
    case 'ram':     upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'donkey':  upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'bull':    upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'hedgehog':upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'turtle':  upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'koala':   upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'deer':    upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;
    case 'armadillo':upd[`activePowerups/${pu.id}`]={target:nextPid};
      break;

    // === NEW POWERUPS ===
    case 'mosquito': {
      // Instant: deal random 1-100 to a random other alive player, heal self same amount
      const moqAlive=Object.entries(state.players||{}).filter(([mpid,mp])=>mp.alive&&mpid!==pid);
      if(moqAlive.length>0){
        const [mvpid,mvp]=moqAlive[rnd(0,moqAlive.length-1)];
        const moqDmg=rnd(1,100);
        const newMvpHp=Math.max(0,(state.players[mvpid]?.hp||0)-moqDmg);
        const newMyHp=(state.players?.[pid]?.hp||0)+moqDmg;
        upd[`players/${mvpid}/hp`]=newMvpHp;upd[`players/${mvpid}/alive`]=newMvpHp>0;
        upd[`players/${pid}/hp`]=newMyHp;
        if(newMvpHp===0)setTimeout(()=>triggerEliminationAnim(mvp.name||'?'),400);
        toast(`ğŸ¦Ÿ Zanzara! -${moqDmg} a ${mvp.name}, +${moqDmg} a te!`);
        addLog(`<span class='lpu'>ğŸ¦Ÿ Zanzara</span>: <span class='lp'>${state.players?.[pid]?.name}</span> drena <span class='ld'>-${moqDmg}</span> da <span class='lp'>${mvp.name}</span> e si cura di <span class='lh'>+${moqDmg}</span>!`,'damage');
        spawnFloat(`ğŸ¦Ÿ -${moqDmg}`,'red');shakeScreen();playSound('hit');vibrate([60,20,60]);
      } else {toast('ğŸ¦Ÿ Zanzara: nessun bersaglio disponibile!');}
      break;
    }

    case 'scorpion':
      if(state.activePowerups?.scorpion){toast('ğŸ¦‚ Scorpione giÃ  attivo!');return;}
      upd['activePowerups/scorpion']={owner:pid,target:nextPid,fakeValue:rnd(20,80)};
      break;
    case 'peacock': {
      // Randomize all alive players' HP (1 to initialHp)
      const peacockMax=state.initialHp||1000;
      Object.entries(state.players||{}).forEach(([ppid,pp])=>{
        if(pp.alive){
          const newHp=rnd(1,peacockMax);
          upd[`players/${ppid}/hp`]=newHp;
        }
      });
      toast(`ğŸ¦š Pavone! HP di tutti randomizzati (1-${peacockMax})!`);
      addLog(`<span class='lpu'>ğŸ¦š Pavone</span>: HP di tutti randomizzati (1-${peacockMax})!`,'powerup');
      break;
    }
    case 'zebra': {
      // Pick a random normal card from next player's deck and duplicate it
      const nextCards=(state.cards||[]).filter(c=>c.assignedTo===nextPid);
      if(nextCards.length>0){
        const orig=nextCards[rnd(0,nextCards.length-1)];
        upd['activePowerups/zebra']={target:nextPid,dupCard:{id:'zebra-dup',value:orig.value,assignedTo:orig.assignedTo,assignedName:orig.assignedName}};
      }
      break;
    }
    case 'scarab': upd['activePowerups/scarab']={target:nextPid,cardValue:rnd(0,100)}; break;
    case 'swordfish': upd['activePowerups/swordfish']={target:nextPid};
      break;
    case 'wolf':
      if(state.activePowerups?.wolf){toast('ğŸº Lupo giÃ  attivo!');return;}
      upd['activePowerups/wolf']={owner:pid};
      break;
    case 'ostrich':
      if(state.activePowerups?.ostrich){toast('ğŸ¦¤ Dodo giÃ  attivo!');return;}
      upd['activePowerups/ostrich']={owner:pid};
      addLog(`<span class='lpu'>ğŸ¦¤ Dodo</span>: l'ultima carta del mazzo Ã¨ bloccata per tutti!`,'system');
      break;

    case 'lion': {
      // Leone: danno casuale 1..max(HP attuali di tutti i vivi) a un giocatore casuale diverso dall'attivatore
      const allLionAlive=Object.entries(state.players||{}).filter(([,lp])=>lp.alive);
      const maxHpNow=allLionAlive.reduce((mx,[,lp])=>Math.max(mx,lp.hp),0)||1;
      const maxHpPlayerName=allLionAlive.find(([,lp])=>lp.hp===maxHpNow)?.[1]?.name||'?';
      const lionDmg=rnd(1,maxHpNow);
      const lionAlive=allLionAlive.filter(([lpid])=>lpid!==pid);
      if(lionAlive.length>0){
        const [lvpid,lvp]=lionAlive[rnd(0,lionAlive.length-1)];
        const newLionHp=Math.max(0,(state.players[lvpid]?.hp||0)-lionDmg);
        upd[`players/${lvpid}/hp`]=newLionHp;upd[`players/${lvpid}/alive`]=newLionHp>0;
        if(newLionHp===0)setTimeout(()=>triggerEliminationAnim(lvp.name||'?'),400);
        toast(`ğŸ¦ Leone! ${lvp.name} subisce ${lionDmg} danni (max HP: ${maxHpNow} di ${maxHpPlayerName})!`);
        addLog(`<span class='lpu'>ğŸ¦ Leone</span>: danno <span class='ld'>${lionDmg}</span> (da 1 a ${maxHpNow}, vita max: <span class='lp'>${maxHpPlayerName}</span>) â†’ <span class='lp'>${lvp.name}</span> <span class='ld'>-${lionDmg}</span>!`,'damage');
        spawnFloat(`ğŸ¦ -${lionDmg}`,'red');shakeScreen();playSound('crit');vibrate([80,30,80]);
      } else { toast('ğŸ¦ Leone: nessun bersaglio disponibile!'); }
      // Leone istantaneo â€” nessun activePowerup salvato
      break;
    }
    case 'dog': {
      // Dog: activate ALL 3 powerups. The other 2 are chosen alongside dog in showPuChoice.
      // Store the other 2 PU IDs in the dog state for activation
      upd['activePowerups/dog']={owner:pid};
      break;
    }
    case 'weasel':
      if(state.activePowerups?.weasel){toast('ğŸ¦¦ Donnola giÃ  attiva!');return;}
      upd['activePowerups/weasel']={owner:pid};
      break;
    case 'frog': upd['activePowerups/frog']={target:nextPid};
      break;

    // â”€â”€ 17 NEW POWERUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    case 'pigeon': {
      // Block a random card for each other alive player
      const pigBlocked={};
      Object.keys(state.players||{}).forEach(ppid=>{
        if(ppid!==pid&&state.players[ppid]?.alive){
          const pcards=(state.cards||[]).filter(c=>!c.badge);
          const pcardIdx=rnd(0,Math.max(pcards.length-1,0));
          pigBlocked[ppid]=pcardIdx;
        }
      });
      upd['activePowerups/pigeon']={owner:pid,blocked:pigBlocked};
      addLog(`<span class='lpu'>ğŸ•Šï¸ Piccione</span>: carte bloccate per tutti gli avversari!`,'system');
      break;
    }

    case 'elephant': {
      // Sum of unchosen normal cards â†’ random player takes damage
      const elSum=G._lastUnchosenSum||0;
      if(elSum>0){
        const elVictims=Object.entries(state.players||{}).filter(([epid,ep])=>ep.alive&&epid!==pid);
        if(elVictims.length>0){
          const [evpid,evp]=elVictims[rnd(0,elVictims.length-1)];
          const newHp=Math.max(0,(state.players[evpid]?.hp||0)-elSum);
          upd[`players/${evpid}/hp`]=newHp;
          upd[`players/${evpid}/alive`]=newHp>0;
          if(newHp===0)setTimeout(()=>triggerEliminationAnim(evp.name||'?'),400);
          toast(`ğŸ˜ Elefante! ${evp.name} subisce ${elSum} danni!`);
          addLog(`<span class='lpu'>ğŸ˜ Elefante</span>: <span class='lp'>${evp.name}</span> subisce <span class='ld'>-${elSum}</span> danni (somma carte scartate)!`,'damage');
          }
      } else {toast('ğŸ˜ Elefante: nessuna carta scartata da sommare!');}
      break;
    }

    case 'jaguar': {
      upd[`players/${pid}/jaguarShield`]=true;
      upd['activePowerups/jaguar']={owner:pid};
      break;
    }

    case 'crab': {
      // 3 random players take 3 random dmg each (1-100) â€” Parrot does NOT affect instant effects
      const crabAlive=Object.entries(state.players||{}).filter(([_,cp])=>cp.alive);
      const crabTargets=[];
      const crabPool=[...crabAlive];
      for(let ci=0;ci<Math.min(3,crabPool.length);ci++){
        const ridx=rnd(0,crabPool.length-1);
        const [cpid,cp]=crabPool.splice(ridx,1)[0];
        const cd=rnd(1,100);
        crabTargets.push({pid:cpid,name:cp.name,dmg:cd});
        const newHp=Math.max(0,(state.players[cpid]?.hp||0)-cd);
        upd[`players/${cpid}/hp`]=newHp;upd[`players/${cpid}/alive`]=newHp>0;
        if(newHp===0){setTimeout(()=>triggerEliminationAnim(cp.name||'?'),400);}
      }
      toast('ğŸ¦€ Granchio! '+crabTargets.map(t=>`${t.name} -${t.dmg}`).join(', '));
      addLog(`<span class='lpu'>ğŸ¦€ Granchio</span>: ${crabTargets.map(t=>`<span class='lp'>${t.name}</span> <span class='ld'>-${t.dmg}</span>`).join(', ')}!`,'damage');
      spawnFloat('-? x3','red');shakeScreen();playSound('hit');
      break;
    }

    case 'bat': {
      // Gain HP = lowest HP among ALL alive players (including self)
      const batAlive=Object.entries(state.players||{}).filter(([,bp])=>bp.alive);
      if(batAlive.length>0){
        const minHpEntry=batAlive.reduce((best,[bpid,bp])=>bp.hp<best[1].hp?[bpid,bp]:best,batAlive[0]);
        const gain=minHpEntry[1].hp;
        const myHp=state.players?.[pid]?.hp||0;
        const newHp=myHp+gain;
        upd[`players/${pid}/hp`]=newHp;
        const isSelf=minHpEntry[0]===pid;
        toast(`ğŸ¦‡ Pipistrello! +${gain} HP${isSelf?' (sei tu il piÃ¹ debole!)':` da ${minHpEntry[1].name}`}!`);
        addLog(`<span class='lpu'>ğŸ¦‡ Pipistrello</span>: <span class='lp'>${state.players?.[pid]?.name}</span> guadagna <span class='lh'>+${gain}</span> HP (vita minima: <span class='lp'>${minHpEntry[1].name}</span>)!`,'heal');
        spawnFloat(`+${gain}`,'green');playSound('heal');
      } else {toast('ğŸ¦‡ Pipistrello: nessun giocatore vivo!');}
      break;
    }

    case 'horse': {
      upd['activePowerups/horse']={owner:pid};
      break;
    }

    case 'squirrel': {
      // Shuffle alive players' HP values
      const sqAlive=Object.entries(state.players||{}).filter(([_,sp])=>sp.alive);
      const sqHps=sqAlive.map(([_,sp])=>sp.hp);
      for(let si=sqHps.length-1;si>0;si--){const sj=Math.floor(Math.random()*(si+1));[sqHps[si],sqHps[sj]]=[sqHps[sj],sqHps[si]];}
      sqAlive.forEach(([spid],si)=>{upd[`players/${spid}/hp`]=sqHps[si];});
      toast('ğŸ¿ï¸ Scoiattolo! HP rimescolati!');
      addLog(`<span class='lpu'>ğŸ¿ï¸ Scoiattolo</span>: punti vita riassegnati casualmente!`,'system');
      break;
    }

    case 'walrus': {
      upd['activePowerups/walrus']={owner:pid,fakeValue:rnd(5,74)}; // max 74 avoids critical-card look
      break;
    }

    case 'hyena': {
      // GALLO: danni casuali (1-100) a ogni giocatore vivo. Istantaneo.
      // Non interagisce con il Pappagallo. Bypassa Anatra.
      const galloName=state.players?.[pid]?.name||'?';
      // Gallo bypassa l'Anatra se Ã¨ attiva sull'attivatore
      if(state.activePowerups?.duck?.target===pid) upd['activePowerups/duck']=null;
      // Processa in ordine fisso (ordine turni/lobby)
      const galloAlive=ord.filter(p=>state.players?.[p]?.alive).map(p=>[p,state.players[p]]);
      const galloHpMap={};
      galloAlive.forEach(([apid])=>{ galloHpMap[apid]=0; });
      const galloLogParts=[];
      galloAlive.forEach(([apid,ap])=>{
        const roll=rnd(1,100);
        // Coccodrillo: protegge il suo owner da questa fonte
        if(state.activePowerups?.crocodile?.owner===apid&&apid!==pid){
          upd['activePowerups/crocodile']=null;
          galloLogParts.push(`<span class='lp'>${ap.name}</span> ğŸŠ protetto`);
          return;
        }
        // Ape: riflette il danno sull'attivatore
        if(ap.activeBug&&apid!==pid){
          galloHpMap[pid]=(galloHpMap[pid]||0)-roll;
          upd[`players/${apid}/activeBug`]=false;
          galloLogParts.push(`<span class='lp'>${ap.name}</span> ğŸ riflette <span class='ld'>-${roll}</span> su ${galloName}`);
          return;
        }
        // Gatto (jaguar): redirige il danno su un random
        if(ap.jaguarShield&&apid!==pid&&state.activePowerups?.jaguar?.owner===apid){
          const others=galloAlive.filter(([jpid])=>jpid!==apid);
          if(others.length>0){
            const [jrpid,jrp]=others[rnd(0,others.length-1)];
            galloHpMap[jrpid]=(galloHpMap[jrpid]||0)-roll;
            upd[`players/${apid}/jaguarShield`]=false;
            upd['activePowerups/jaguar']=null;
            galloLogParts.push(`<span class='lp'>${ap.name}</span> ğŸˆâ€â¬› ridirige <span class='ld'>-${roll}</span> su <span class='lp'>${jrp.name}</span>`);
            return;
          }
        }
        // Tasso (armadillo): se il target del gallo Ã¨ il target dell'armadillo, il danno colpisce anche l'attivatore
        if(state.activePowerups?.armadillo?.target===apid){
          galloHpMap[apid]=(galloHpMap[apid]||0)-roll;
          galloHpMap[pid]=(galloHpMap[pid]||0)-roll;
          upd['activePowerups/armadillo']=null;
          galloLogParts.push(`<span class='lp'>${ap.name}</span> <span class='ld'>-${roll}</span> ğŸ¦¡ Tasso: ${galloName} <span class='ld'>-${roll}</span>`);
          return;
        }
        galloHpMap[apid]=(galloHpMap[apid]||0)-roll;
        galloLogParts.push(`<span class='lp'>${ap.name}</span> <span class='ld'>-${roll}</span>`);
      });
      // Applica HP changes
      Object.entries(galloHpMap).forEach(([apid,delta])=>{
        if(!state.players?.[apid]?.alive||delta===0)return;
        const newHp=Math.max(0,(state.players[apid]?.hp||0)+delta);
        upd[`players/${apid}/hp`]=newHp;upd[`players/${apid}/alive`]=newHp>0;
        if(newHp===0)setTimeout(()=>triggerEliminationAnim(state.players[apid]?.name||'?'),400);
      });
      toast(`ğŸ“ Gallo! Danni casuali a tutti!`);
      addLog(`<span class='lpu'>ğŸ“ Gallo</span>: ${galloLogParts.join(', ')}!`,'damage');
      spawnFloat('-? TUTTI','red');shakeScreen();playSound('hit');vibrate([60,30,60]);
      // Gallo istantaneo â€” nessun activePowerup salvato
      break;
    }

    case 'giraffe': {
      // Richest player loses half HP, distributed to others
      // In case of tie, pick a random one among those with max HP
      const gAlive=Object.entries(state.players||{}).filter(([_,gp])=>gp.alive);
      if(gAlive.length>1){
        const maxHp=gAlive.reduce((m,[_,gp])=>Math.max(m,gp.hp),0);
        const richCandidates=gAlive.filter(([_,gp])=>gp.hp===maxHp);
        const richEntry=richCandidates[rnd(0,richCandidates.length-1)];
        const [richPid,richP]=richEntry;
        const loss=Math.floor(richP.hp/2);
        const gain=Math.ceil(loss/(gAlive.length-1));
        upd[`players/${richPid}/hp`]=richP.hp-loss;
        gAlive.forEach(([gpid,gp])=>{if(gpid!==richPid){upd[`players/${gpid}/hp`]=gp.hp+gain;}});
        toast(`ğŸ¦’ Giraffa! ${richP.name} perde ${loss} HP!`);
        addLog(`<span class='lpu'>ğŸ¦’ Giraffa</span>: <span class='lp'>${richP.name}</span> perde <span class='ld'>${loss}</span> HP redistribuiti!`,'system');
      }
      break;
    }







    case 'duck': {
      upd['activePowerups/duck']={owner:pid,target:nextPid};
      break;
    }

    case 'tiger': {
      // Random alive player takes |myHp - theirHp| damage
      const tiAlive=Object.entries(state.players||{}).filter(([tpid,tp])=>tp.alive&&tpid!==pid);
      if(tiAlive.length>0){
        const [tvpid,tvp]=tiAlive[rnd(0,tiAlive.length-1)];
        const myHp=state.players?.[pid]?.hp||0;
        const tiDmg=Math.abs(myHp-tvp.hp);
        const newHp=Math.max(0,tvp.hp-tiDmg);
        upd[`players/${tvpid}/hp`]=newHp;upd[`players/${tvpid}/alive`]=newHp>0;
        if(newHp===0)setTimeout(()=>triggerEliminationAnim(tvp.name||'?'),400);
        toast(`ğŸ¯ Tigre! ${tvp.name} subisce ${tiDmg} danni!`);
        addLog(`<span class='lpu'>ğŸ¯ Tigre</span>: <span class='lp'>${tvp.name}</span> subisce <span class='ld'>-${tiDmg}</span> (differenza HP)!`,'damage');
      }
      break;
    }

    case 'mantis': {
      // Random alive player loses half HP
      const maAlive=Object.entries(state.players||{}).filter(([mapid,map2])=>map2.alive&&mapid!==pid);
      if(maAlive.length>0){
        const [mavpid,mavp]=maAlive[rnd(0,maAlive.length-1)];
        const loss=Math.ceil(mavp.hp/2);
        const newHp=Math.max(0,mavp.hp-loss);
        upd[`players/${mavpid}/hp`]=newHp;upd[`players/${mavpid}/alive`]=newHp>0;
        if(newHp===0)setTimeout(()=>triggerEliminationAnim(mavp.name||'?'),400);
        toast(`ğŸ¦— Mantide! ${mavp.name} perde metÃ  HP!`);
        addLog(`<span class='lpu'>ğŸ¦— Mantide</span>: <span class='lp'>${mavp.name}</span> perde <span class='ld'>${loss}</span> HP!`,'damage');
      }
      break;
    }

    case 'monkey': {
      // Gain HP = sum of unchosen normal cards
      const monSum=G._lastUnchosenSum||0;
      if(monSum>0){
        const myHp2=state.players?.[pid]?.hp||0;
        const newHp2=myHp2+monSum; // HP can exceed initial HP per rules
        upd[`players/${pid}/hp`]=newHp2;
        toast(`ğŸ’ Scimmia! +${monSum} HP!`);
        addLog(`<span class='lpu'>ğŸ’ Scimmia</span>: <span class='lp'>${state.players?.[pid]?.name}</span> guadagna <span class='lh'>+${monSum}</span> HP!`,'heal');
        spawnFloat(`+${monSum}`,'green');
      } else {toast('ğŸ’ Scimmia: nessuna carta scartata!');}
      break;
    }

    // === 9 NUOVISSIMI POWERUP ===
    case 'orca': {
      // Damage the first alive player before and after activator â€” Parrot does NOT affect instant effects
      const orcaOrd=ord;
      const orcaIdx=orcaOrd.indexOf(pid);
      let prevOrcaPid=null,nextOrcaPid=null;
      for(let s=1;s<orcaOrd.length;s++){const c=orcaOrd[(orcaIdx-s+orcaOrd.length)%orcaOrd.length];if(state.players?.[c]?.alive){prevOrcaPid=c;break;}}
      for(let s=1;s<orcaOrd.length;s++){const c=orcaOrd[(orcaIdx+s)%orcaOrd.length];if(state.players?.[c]?.alive){nextOrcaPid=c;break;}}
      const orcaTargets=[];
      if(prevOrcaPid&&prevOrcaPid!==nextOrcaPid)orcaTargets.push(prevOrcaPid);
      if(nextOrcaPid)orcaTargets.push(nextOrcaPid);
      orcaTargets.forEach(opid=>{
        const od=rnd(1,100);
        const oh=Math.max(0,(state.players[opid]?.hp||0)-od);
        upd[`players/${opid}/hp`]=oh;upd[`players/${opid}/alive`]=oh>0;
        if(oh===0)setTimeout(()=>triggerEliminationAnim(state.players[opid]?.name||'?'),400);
        addLog(`<span class='lpu'>ğŸ‹ Orca</span>: <span class='lp'>${state.players[opid]?.name}</span> <span class='ld'>-${od}</span>!`,'damage');
      });
      toast(`ğŸ‹ Orca! Attacco ai vicini!`);
      spawnFloat('ğŸ‹','red');shakeScreen();playSound('hit');
      break;
    }
    case 'gorilla': {
      const gorAlive=Object.entries(state.players||{}).filter(([gpid,gp])=>gp.alive&&gpid!==pid);
      if(gorAlive.length>0){
        const [gvpid,gvp]=gorAlive[rnd(0,gorAlive.length-1)];
        // Parrot does NOT affect instant effects
        const newGorHp=Math.max(0,(state.players[gvpid]?.hp||0)-100);
        upd[`players/${gvpid}/hp`]=newGorHp;upd[`players/${gvpid}/alive`]=newGorHp>0;
        if(newGorHp===0)setTimeout(()=>triggerEliminationAnim(gvp.name||'?'),400);
        toast(`ğŸ¦ Gorilla! ${gvp.name} subisce 100 danni!`);
        addLog(`<span class='lpu'>ğŸ¦ Gorilla</span>: <span class='lp'>${gvp.name}</span> subisce <span class='ld'>-100</span>!`,'damage');
        spawnFloat('-100','red');shakeScreen();playSound('crit');vibrate([100,50,100]);
      }
      break;
    }
    case 'parrot': {
      if(state.activePowerups?.parrot){toast('ğŸ¦œ Pappagallo giÃ  attivo!');return;}
      upd['activePowerups/parrot']={owner:pid,revealed:false};
      break;
    }
    case 'ladybug': {
      if(state.activePowerups?.ladybug){toast('ğŸ Coccinella giÃ  attiva!');return;}
      upd['activePowerups/ladybug']={owner:pid};
      addLog(`<span class='lpu'>ğŸ Coccinella</span>: tutti i powerup sono coperti fino al prossimo turno di <span class='lp'>${state.players?.[pid]?.name}</span>!`,'powerup');
      break;
    }
    case 'snail': {
      const now=new Date();
      const snailDmg=now.getHours()+now.getMinutes();
      // Parrot does NOT affect instant effects
      const snailAlive=Object.entries(state.players||{}).filter(([spid,sp])=>sp.alive&&spid!==pid);
      if(snailAlive.length>0){
        const [svpid,svp]=snailAlive[rnd(0,snailAlive.length-1)];
        const timeStr=`${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        const newSnailHp=Math.max(0,(state.players[svpid]?.hp||0)-snailDmg);
        upd[`players/${svpid}/hp`]=newSnailHp;upd[`players/${svpid}/alive`]=newSnailHp>0;
        if(newSnailHp===0)setTimeout(()=>triggerEliminationAnim(svp.name||'?'),400);
        toast(`ğŸŒ Lumaca! ${svp.name} subisce ${snailDmg} danni (ore ${timeStr})`);
        addLog(`<span class='lpu'>ğŸŒ Lumaca</span>: <span class='lp'>${svp.name}</span> subisce <span class='ld'>-${snailDmg}</span> (${now.getHours()}h + ${now.getMinutes()}m = ${snailDmg}, ore ${timeStr})!`,'damage');
        spawnFloat(`ğŸŒ -${snailDmg}`,'red');shakeScreen();playSound('hit');
      }
      break;
    }
    case 'pig':      upd['activePowerups/pig']={owner:pid,target:nextPid}; break;
    case 'camel':    upd['activePowerups/camel']={owner:pid,target:nextPid}; break;
    case 'fox':      upd['activePowerups/fox']={owner:pid,target:nextPid}; break;
    case 'blacksheep': upd['activePowerups/blacksheep']={owner:pid,target:nextPid}; break;
    case 'panda': upd['activePowerups/panda']={owner:pid}; break;

    // === NUOVISSIMI ===
    case 'rabbit': {
      // Coniglio: imposta gli HP di tutti i vivi uguali ai tuoi
      const myHpRab=Math.max(1,state.players?.[pid]?.hp||1); // min 1 per sicurezza
      const rabName=state.players?.[pid]?.name||'?';
      const rabAlive=Object.entries(state.players||{}).filter(([rpid,rp])=>rp.alive&&rpid!==pid);
      rabAlive.forEach(([rpid])=>{upd[`players/${rpid}/hp`]=myHpRab;upd[`players/${rpid}/alive`]=true;});
      toast(`ğŸ‡ Coniglio! Tutti ora hanno ${myHpRab} HP!`);
      addLog(`<span class='lpu'>ğŸ‡ Coniglio</span>: <span class='lp'>${rabName}</span> imposta tutti a <span class='lh'>${myHpRab}</span> HP!`,'system');
      spawnFloat(`ğŸ‡ =${myHpRab}`,'green');playSound('pu');vibrate([40,20,40]);
      break;
    }
    case 'medusa': {
      if(state.activePowerups?.medusa){toast('ğŸ™ Piovra giÃ  attiva!');return;}
      upd['activePowerups/medusa']={owner:pid};
      toast('ğŸ™ Piovra! Carte pari = x2 danno, dispari = x0.5 danno!');
      addLog(`<span class='lpu'>ğŸ™ Piovra</span>: <span class='lp'>${state.players?.[pid]?.name}</span> attiva la Piovra!`,'powerup');
      break;
    }
    case 'skunk': {
      if(state.activePowerups?.skunk){toast('ğŸ¦¨ Puzzola giÃ  attiva!');return;}
      // Aggiungi carta Puzzola a tutti i giocatori vivi
      const skunkVal=rnd(1,100);
      const skunkCards={};
      const skunkAlive=Object.entries(state.players||{}).filter(([,sp])=>sp.alive);
      skunkAlive.forEach(([spid],si)=>{
        skunkCards[`sk${si}`]={id:`sk${si}`,value:skunkVal,assignedTo:spid,assignedName:'ğŸ¦¨',badge:'skunk'};
      });
      upd['activePowerups/skunk']={owner:pid,initialHp:state.initialHp||1000};
      upd['skunkCards']=skunkCards;
      break;
    }

    default: upd[`activePowerups/${pu.id}`]={target:nextPid,value:rnd(0,100)};
  }
  // If batching (chaos mode), accumulate into shared object; otherwise write immediately
  if(batchUpd){Object.assign(batchUpd,upd);}
  else if(Object.keys(upd).length) await dbUpdate(`rooms/${G.roomId}`,upd);
}

// â•â• Next turn â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function nextTurn(state, fromPid=null, pendingUpd=null){
  hidePuSection();
  // PERF FIX: use passed state - caller already has fresh data. Only re-fetch if state is null.
  const fresh=state||(await dbGet(`rooms/${G.roomId}`));if(!fresh)return;
  const ord=fresh.playerOrder||[];
  const alive=ord.filter(p=>fresh.players?.[p]?.alive);
  if(alive.length<=1){await checkWin(fresh);return;}

  // FIX A: Robust next-player logic using playerOrder, not index arithmetic.
  // When current player dies, currentTurnIndex points to wrong player in shrunk alive array.
  // We find the player who JUST played (fromPid or alive[currentTurnIndex]),
  // then scan playerOrder forward to find next alive player.
  let playedPid = fromPid;
  if(!playedPid){
    const safeIdx=fresh.currentTurnIndex%Math.max(alive.length,1);
    playedPid=alive[safeIdx];
  }
  const playedOrdIdx=ord.indexOf(playedPid);
  let nextPid=null;
  for(let s=1;s<=ord.length;s++){
    const candidate=ord[(playedOrdIdx+s)%ord.length];
    if(fresh.players?.[candidate]?.alive){nextPid=candidate;break;}
  }
  if(!nextPid){await checkWin(fresh);return;}
  let idx=alive.indexOf(nextPid);
  if(idx<0)idx=0;

  const upd={};
  const pu={...fresh.activePowerups||{}};
  // BUG FIX 1: merge pendingUpd activePowerups so effects activated THIS turn (kangaroo etc.)
  // are visible to skip/effect logic before the Firebase write completes
  if(pendingUpd){
    Object.entries(pendingUpd).forEach(([k,v])=>{
      if(k.startsWith('activePowerups/')){
        const id=k.replace('activePowerups/','');
        if(v===null) delete pu[id];
        else pu[id]=v;
      }
    });
  }

  // FIX 6: Eagle â€” if it's the owner's turn and reveal target is dead, pick a new alive player
  if(pu.eagle?.owner===nextPid){
    const eagleRevealTarget=pu.eagle.reveal;
    const eagleTargetAlive=eagleRevealTarget&&fresh.players?.[eagleRevealTarget]?.alive;
    if(!eagleTargetAlive){
      // Target died â€” re-pick from currently alive players (excluding owner)
      const newEagleAlive=ord.filter(p=>fresh.players?.[p]?.alive&&p!==nextPid);
      if(newEagleAlive.length>0){
        const newReveal=newEagleAlive[rnd(0,newEagleAlive.length-1)];
        upd['activePowerups/eagle']={...pu.eagle,reveal:newReveal};
      } else {
        upd['activePowerups/eagle']=null; // no valid target, clear eagle
      }
    }
  }
  // Mosquito is now instant â€” no expiry needed
  // Eagle: scade quando il proprietario ha appena giocato il suo turno (ma NON se Ã¨ stata appena attivata questo stesso turno)
  const eagleJustActivated = pendingUpd?.['activePowerups/eagle'] && pendingUpd['activePowerups/eagle']!==null;
  if(pu.eagle?.owner===fromPid && !eagleJustActivated){upd['activePowerups/eagle']=null;}
  // === Clear persistent PUs when owner's turn comes back ===
  // Expire new persistent PUs when owner's turn comes back
  if(pu.horse?.owner===nextPid){upd['activePowerups/horse']=null;toast('ğŸ´ Cavallo scaduto!');}
  if(pu.pigeon?.owner===nextPid){upd['activePowerups/pigeon']=null;toast('ğŸ•Šï¸ Piccione scaduto!');}
  if(pu.walrus?.owner===nextPid){upd['activePowerups/walrus']=null;toast('ğŸ¦­ Foca scaduto!');}
  if(pu.duck?.owner===nextPid){upd['activePowerups/duck']=null;toast('ğŸ¦† Anatra scaduta (non attivata)!');}
  if(pu.medusa?.owner===nextPid){upd['activePowerups/medusa']=null;toast('ğŸ™ Piovra scaduta!');}
  if(pu.skunk?.owner===nextPid){upd['activePowerups/skunk']=null;upd['skunkCards']=null;toast('ğŸ¦¨ Puzzola scaduta!');}
  if(pu.jaguar?.owner===nextPid){
    // Jaguar expires: clear shield
    upd['activePowerups/jaguar']=null;
    upd[`players/${nextPid}/jaguarShield`]=false;
    toast('ğŸˆâ€â¬› Gatto scaduto!');
  }

  // Hyena moved after generateCards (see below)

  if(pu.cheetah?.owner===nextPid){upd['activePowerups/cheetah']=null;toast('ğŸ† Ghepardo scaduto!');}
  if(pu.rat?.owner===nextPid){upd['activePowerups/rat']=null;toast('ğŸ­ Topo scaduto!');}
  if(pu.wolf?.owner===nextPid){upd['activePowerups/wolf']=null;toast('ğŸº Lupo scaduto!');}
  if(pu.ostrich?.owner===nextPid){upd['activePowerups/ostrich']=null;toast('ğŸ¦¤ Dodo scaduto!');}
  if(pu.weasel?.owner===nextPid){upd['activePowerups/weasel']=null;toast('ğŸ¦¦ Donnola scaduta!');}
  if(pu.scorpion?.owner===nextPid){upd['activePowerups/scorpion']=null;toast('ğŸ¦‚ Scorpione scaduto!');}
  // (mosquito is now instant, no expiry needed)
  if(pu.dog?.owner!==nextPid&&pu.dog){upd['activePowerups/dog']=null;}
  if(fresh.butterflyActive&&fresh.butterflyOwner===nextPid){upd['butterflyActive']=false;upd['butterflyCards']=null;upd['butterflyOwner']=null;toast('ğŸ¦‹ Farfalla scaduta!');}
  // Mosca: aggiorna il valore della carta ogni turno; controlla se il bersaglio Ã¨ ancora vivo
  if(fresh.moscaCard&&fresh.activePowerups?.fly){
    const flyTgt=fresh.activePowerups.fly.target;
    if(!fresh.players?.[flyTgt]?.alive){
      upd['moscaCard']=null;upd['activePowerups/fly']=null;
      toast('ğŸª° Mosca: bersaglio eliminato, effetto rimosso!');
    } else {
      const newFlyVal=rnd(0,100);
      upd['moscaCard']={...fresh.moscaCard,value:newFlyVal};
    }
  }
  // New PUs expiry
  if(pu.parrot?.owner===nextPid){upd['activePowerups/parrot']=null;toast('ğŸ¦œ Pappagallo scaduto!');}
  if(pu.ladybug?.owner===nextPid){upd['activePowerups/ladybug']=null;toast('ğŸ Coccinella scaduta!');}
  if(pu.pig?.owner===nextPid){upd['activePowerups/pig']=null;toast('ğŸ· Maiale scaduto (non attivato)!');}
  if(pu.camel?.owner===nextPid){upd['activePowerups/camel']=null;toast('ğŸª Cammello scaduto (non attivato)!');}
  if(pu.fox?.owner===nextPid){upd['activePowerups/fox']=null;toast('ğŸ¦Š Volpe scaduta (non attivata)!');}
  if(pu.blacksheep?.owner===nextPid){upd['activePowerups/blacksheep']=null;}
  if(pu.panda?.owner===nextPid){upd['activePowerups/panda']=null;toast('ğŸ¼ Panda scaduto (non attivato)!');}

  // Kangaroo: skip â€” FIX E: also clear skipNext on skipped player to avoid double-skip
  if(pu.kangaroo?.target===nextPid){
    const skippedByKang=nextPid;
    const skippedName=fresh.players?.[nextPid]?.name||'?';
    toast(`ğŸ¦˜ ${skippedName} salta il turno!`);
    addLog(`<span class='lpu'>ğŸ¦˜ Canguro</span>: <span class='lp'>${skippedName}</span> salta il turno!`,'system');
    upd['activePowerups/kangaroo']=null;
    upd[`stats/${nextPid}/turnsSkipped`]=(fresh.stats?.[nextPid]?.turnsSkipped||0)+1;
    upd[`players/${nextPid}/skipNext`]=false; // clear any stale skipNext flag
    // Advance to next alive in ord after skipped player
    const skipOrdIdx=ord.indexOf(nextPid);
    nextPid=null;
    for(let s=1;s<=ord.length;s++){const c=ord[(skipOrdIdx+s)%ord.length];if(fresh.players?.[c]?.alive){nextPid=c;break;}}
    if(!nextPid){await checkWin(fresh);return;}
    idx=alive.indexOf(nextPid);if(idx<0)idx=0;
    // Regolamento Canguro: gli effetti "prossimo giocatore" slittano al successivo vivo
    const slidePuIds=['bull','turtle','koala','deer','armadillo','bear','frog','donkey',
     'swordfish','ram','owl','zebra','scarab','hedgehog','duck',
     'pig','camel','fox','blacksheep'];
    slidePuIds.forEach(puId=>{
      if(pu[puId]?.target===skippedByKang) upd[`activePowerups/${puId}`]={...pu[puId],target:nextPid};
    });
  }
  // Generate new cards
  let cards=generateCards(fresh.players,fresh.mode);

  // Piccione: aggiorna gli indici bloccati sui nuovi cards (BUGFIX: spostato qui, dopo la generazione)
  if(pu.pigeon&&pu.pigeon.owner!==nextPid){
    const pigBlocked2={};
    const normalNewCards=cards.filter(c=>!c.badge);
    Object.keys(fresh.players||{}).forEach(ppid=>{
      if(ppid!==pu.pigeon.owner&&fresh.players[ppid]?.alive){
        pigBlocked2[ppid]=normalNewCards.length>0?rnd(0,normalNewCards.length-1):0;
      }
    });
    upd['activePowerups/pigeon']={...pu.pigeon,blocked:pigBlocked2};
  }

  // Zecca: aggiorna solo il valore; il danno viene inflitto DOPO la carta principale (in resolveCard)
  let tickCard=fresh.tickCard;
  if(tickCard){
    const newVal=rnd(0,100);
    tickCard={...tickCard,value:newVal};
  }

  // Aggiungi separatore di turno nello storico
  const turnNum=(fresh.turnCount||0)+1;
  const turnPlayer=fresh.players?.[nextPid]?.name||'?';
  addLog(`â€” Turno ${turnNum}: ${turnPlayer} â€”`,'turn-divider');

  await dbUpdate(`rooms/${G.roomId}`,{
    cards,currentTurnIndex:idx,turnCount:turnNum,
    ...(tickCard?{tickCard}:{}),
    ...(pendingUpd||{}), // pendingUpd first (PU activations)
    ...upd, // upd LAST: clears override activations (e.g. kangaroo skip clears kangaroo so it doesn't persist)
  });
  clearTimer();
  G.masterOverrideActive=false;G.masterOverridePid=null;
  G.bearMode=false;G.bearCardsChosen=0;G.bearFirstTarget=null;G.bearFirstCardId=null;
  G.dogMode=false;G.dogPuCount=0;
  // BUG FIX: check win including ALL changes from pendingUpd (shark, lion, gorilla, mantis, etc.)
  {
    const computedForWin={...fresh,players:{...fresh.players}};
    // Apply pendingUpd player changes (shark/lion/gorilla/mantis/etc. eliminations)
    if(pendingUpd){
      Object.entries(pendingUpd).forEach(([k,v])=>{
        const m=k.match(/^players\/([^/]+)\/(.+)$/);
        if(m){const[,epid,field]=m;if(computedForWin.players[epid])computedForWin.players[epid]={...computedForWin.players[epid],[field]:v};}
      });
    }
    const aliveAfter=Object.values(computedForWin.players).filter(p=>p.alive).length;
    if(aliveAfter<=1) await checkWin(computedForWin);
  }
}

// â•â• Pending damage notifications â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lastZeckaPending=null;
function tickDamageAnim(dmg){
  const f=document.createElement('div');f.className='zecca-flash';document.body.appendChild(f);
  setTimeout(()=>f.remove(),900);
  spawnFloat(`ğŸœ -${dmg}`,'red');
  playSound('zecca');vibrate([80,40,80]);
}
function checkZeckaDmg(state){
  const z=state._zeckaPendingDmg;if(!z)return;
  const key=`${z.target}_${z.dmg}_${state.turnCount||0}`;
  if(_lastZeckaPending===key)return;
  _lastZeckaPending=key;
  const pName=state.players?.[z.target]?.name||'?';
  const isMe=z.target===G.playerId;
  if(isMe||G.isSpectator){
    tickDamageAnim(z.dmg);
    addLog(`<span class='lpu'>ğŸœ Formica</span>: <span class='lp'>${pName}</span> subisce <span class='ld'>-${z.dmg}</span>`,'damage');
  }
  if(G.isMaster||isMe) dbUpdate(`rooms/${G.roomId}`,{_zeckaPendingDmg:null});
}

let _lastLionPending=null;
function checkLionDmg(state){
  const l=state._lionPendingDmg;if(!l)return;
  const key=`lion_${l.turn}`;
  if(_lastLionPending===key)return;
  _lastLionPending=key;
  const dmgs=l.dmgs||{};
  let logParts=[];
  Object.entries(dmgs).forEach(([pid,d])=>{
    const name=state.players?.[pid]?.name||'?';
    logParts.push(`${name}: -${d}`);
    if(pid===G.playerId||G.isSpectator) spawnFloat(`ğŸ¦ -${d}`,'red');
  });
  if(G.playerId in dmgs||G.isSpectator){
    playSound('lion');vibrate([60,30,60]);shakeScreen();
  }
  addLog(`<span class='lpu'>ğŸ¦ Leone</span>: danni casuali a tutti! ${logParts.join(', ')}`,'damage');
  if(G.isMaster) dbUpdate(`rooms/${G.roomId}`,{_lionPendingDmg:null});
}

async function checkWin(state){
  if(!state)return;
  const alive=Object.entries(state.players||{}).filter(([_,p])=>p.alive);
  if(alive.length<=1) await dbUpdate(`rooms/${G.roomId}`,{status:'gameover',winner:alive[0]?alive[0][0]:null});
}

// â•â• Timer â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CIRC=138.2; // 2*pi*r where r=22 (54px timer)
function _getOrCreateCheetahOvl(){
  let ovl=document.getElementById('cheetah-ovl');
  if(!ovl){
    ovl=document.createElement('div');ovl.id='cheetah-ovl';ovl.className='cheetah-ovl';
    ovl.innerHTML='<div class="cheetah-ovl-lbl">ğŸ† Ghepardo â€” Tempo rimanente</div><div class="cheetah-ovl-num" id="cheetah-ovl-num">7</div>';
    document.body.appendChild(ovl);
  }
  return ovl;
}
function startTimer(secs,onExpire){
  clearTimer();G.timerSec=secs;G.timerActive=true;
  const num=document.getElementById('timer-num');
  const ring=document.getElementById('timer-ring');
  const wrap=document.getElementById('timer-wrap');
  _getOrCreateCheetahOvl();
  function tick(){
    if(!G.timerActive)return;
    if(num)num.textContent=G.timerSec;
    if(ring)ring.style.strokeDashoffset=CIRC*(1-G.timerSec/secs);
    if(wrap)wrap.classList.toggle('urgent',G.timerSec<=3);
    const bigNum=document.getElementById('cheetah-ovl-num');
    if(bigNum){bigNum.textContent=G.timerSec;bigNum.classList.toggle('urgent',G.timerSec<=3);}
    if(G.timerSec<=3){playSound('tick');vibrate([30]);}
    if(G.timerSec<=0){clearTimer();onExpire();return;}
    G.timerSec--;G.timerTO=setTimeout(tick,1000);
  }
  tick();
}
function clearTimer(){clearTimeout(G.timerTO);G.timerActive=false;const ovl=document.getElementById('cheetah-ovl');if(ovl)ovl.remove();}

// â•â• Log â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _logCount=0;
let _logRenderedKeys=new Set();
let _lastLogKey='';
function renderLog(log){
  const list=document.getElementById('log-list');if(!list)return;
  if(!log){list.innerHTML='';_logCount=0;_logRenderedKeys.clear();_lastLogKey='';return;}
  const entries=Array.isArray(log)?log:Object.values(log);
  const sorted=entries.sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,80);
  const newKey=sorted.map(e=>e.ts+'_'+e.type+'_'+(e.html||'').slice(0,12)).join('|');
  if(newKey===_lastLogKey)return;
  _lastLogKey=newKey;
  _logCount=sorted.length;
  // PERF: incremental prepend â€” use ts+html slice as unique key to avoid same-ms collision
  const existingKeys=new Set(Array.from(list.children).map(el=>el.dataset.k));
  const newEntries=sorted.filter(e=>!existingKeys.has(String(e.ts)+'_'+(e.html||'').slice(0,12)));
  if(newEntries.length===0&&list.children.length===sorted.length)return;
  // Prepend new entries
  const frag=document.createDocumentFragment();
  newEntries.forEach(e=>{const d=document.createElement('div');d.className=`log-entry ${e.type||'system'}`;d.innerHTML=e.html||'';d.dataset.k=String(e.ts)+'_'+(e.html||'').slice(0,12);frag.appendChild(d);});
  if(newEntries.length>0)list.insertBefore(frag,list.firstChild);
  // Trim excess (keep max 80)
  while(list.children.length>80)list.removeChild(list.lastChild);
}

// â•â• Master override â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function masterPlayForCurrent(){
  const state=await dbGet(`rooms/${G.roomId}`);if(!state)return;
  const ord=state.playerOrder||[];
  const alive=ord.filter(p=>state.players?.[p]?.alive);
  // Use same ord-based scan as nextTurn to find current player reliably
  const safeIdx=Math.min(state.currentTurnIndex||0,alive.length-1);
  const cpid=alive[safeIdx<0?0:safeIdx]||alive[0];
  if(!cpid)return;
  G.masterOverrideActive=true;G.masterOverridePid=cpid;
  toast(`âš¡ Giochi per ${state.players[cpid]?.name}`);
  renderState(state);
}

// â•â• Game over â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showGameOver(state){
  if(G._gameoverShown)return;G._gameoverShown=true;
  if(G._elapsedTimer){clearInterval(G._elapsedTimer);G._elapsedTimer=null;}
  showScreen('screen-gameover');clearTimer();
  // DO NOT dbUnsubAll() here â€” keep listening for restart
  confetti();playSound('win');vibrate([100,50,100,50,200,50,300]);
  const winner=state.winner?state.players[state.winner]:null;
  document.getElementById('winner-name').textContent=winner?.name||'Nessuno';

  // Compute rich stats from Firebase data
  const stats=state.stats||{};
  const players=state.players||{};
  const pids=Object.keys(players);
  // Duration
  const durMs=state.gameStartTime?Date.now()-state.gameStartTime:0;
  const durMin=Math.floor(durMs/60000),durSec=Math.floor((durMs%60000)/1000);
  const durStr=durMs?`${durMin}m ${durSec}s`:'â€”';
  const pn=pid=>players[pid]?.name||'â€”';
  const sv=pid=>stats[pid]||{};
  // PiÃ¹ danni totali
  const mostDmgPid=pids.reduce((b,p)=>(sv(p).dmgDealt||0)>(sv(b).dmgDealt||0)?p:b,pids[0]);
  // Danno singolo piÃ¹ alto
  const highHitPid=pids.reduce((b,p)=>(sv(p).maxHit||0)>(sv(b).maxHit||0)?p:b,pids[0]);
  // Meno danni totali (solo chi ha almeno colpito)
  const activePids=pids.filter(p=>(sv(p).dmgDealt||0)>0);
  const leastDmgPid=activePids.length?activePids.reduce((b,p)=>(sv(p).dmgDealt||0)<(sv(b).dmgDealt||0)?p:b,activePids[0]):pids[0];
  // Danno singolo piÃ¹ basso
  const lowHitPid=activePids.length?activePids.reduce((b,p)=>{
    const mB=sv(b).minHit,mP=sv(p).minHit;
    if(mP===undefined||mP===null)return b;
    if(mB===undefined||mB===null)return p;
    return mP<mB?p:b;
  },activePids[0]):pids[0];
  // PiÃ¹ curato
  const mostHealPid=pids.reduce((b,p)=>(sv(p).totalHeal||0)>(sv(b).totalHeal||0)?p:b,pids[0]);
  // PiÃ¹ colpito (volte)
  const mostTargPid=pids.reduce((b,p)=>(sv(p).timesHit||0)>(sv(b).timesHit||0)?p:b,pids[0]);
  // Turni saltati
  const mostSkipPid=pids.reduce((b,p)=>(sv(p).turnsSkipped||0)>(sv(b).turnsSkipped||0)?p:b,pids[0]);

  const sb=(label,name,value)=>`<div class="stat-box"><div class="stat-val-name">${name}</div><div class="stat-val-num">${value}</div><div class="stat-label">${label}</div></div>`;
  const sbPlain=(label,value)=>`<div class="stat-box"><div class="stat-val">${value}</div><div class="stat-label">${label}</div></div>`;
  document.getElementById('stats-grid').innerHTML=
    sbPlain('â± Turni',state.turnCount||0)+
    sbPlain('â± Durata',durStr)+
    sb('âš”ï¸ PiÃ¹ danni totali',pn(mostDmgPid),(sv(mostDmgPid).dmgDealt||0)+' dmg')+
    sb('ğŸ’¥ Danno piÃ¹ alto',pn(highHitPid),(sv(highHitPid).maxHit||0)+' dmg')+
    sb('ğŸ’š PiÃ¹ curato',pn(mostHealPid),(sv(mostHealPid).totalHeal||0)+' HP')+
    sb('ğŸ’¢ PiÃ¹ colpito',pn(mostTargPid),(sv(mostTargPid).timesHit||0)+' volte')+
    sb('ğŸ˜´ PiÃ¹ turni saltati',pn(mostSkipPid),(sv(mostSkipPid).turnsSkipped||0)+' volte');
  const sorted=Object.values(players).sort((a,b)=>(b.alive?1:0)-(a.alive?1:0)||(b.hp-a.hp));
  document.getElementById('final-list').innerHTML=sorted.map((p,i)=>`
    <div class="final-row">
      <div class="final-rank">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||'#'+(i+1)}</div>
      <div class="final-name">${p.name}</div>
      <div class="final-hp">${p.alive?p.hp:0} HP</div>
    </div>`).join('');
  // Render full game log in final stats
  const finalLogEl=document.getElementById('final-log');
  if(finalLogEl&&state.log){
    const logEntries=Object.values(state.log).sort((a,b)=>(a.ts||0)-(b.ts||0));
    finalLogEl.innerHTML=logEntries.map(e=>`<div class="log-entry ${e.type||'system'}">${e.html||''}</div>`).join('');
  }
  // Show/hide restart button based on role
  const goBtn=document.getElementById('go-restart-btn');
  const goWait=document.getElementById('go-waiting-msg');
  if(goBtn)goBtn.style.display=G.isMaster?'block':'none';
  if(goWait)goWait.style.display=G.isMaster?'none':'block';
  // Re-listen for restart: if master resets status to 'playing', rejoin game
  const{db,ref,onValue}=window._fb;
  const statusRef=ref(db,`rooms/${G.roomId}/status`);
  const unsub=onValue(statusRef,snap=>{
    const s=snap.exists()?snap.val():null;
    if(s==='playing'&&G._gameoverShown){
      G._gameoverShown=false;
      G._gameStartedAt=Date.now(); // reset elapsed timer for new game
      unsub(); // remove this specific listener
      startPlayingScreen();
    }
  });
}

// â•â• Settings â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSettingsModal(){
  document.getElementById('settings-content').innerHTML=G.isMaster?`
    <button class="modal-btn" onclick="openPuManager()">ğŸ¾ Gestione Poteri</button>
    <button class="modal-btn" onclick="closeOverlay('overlay-settings');showOverlay('overlay-restart')">ğŸ”„ Riavvia Partita</button>
    <button class="modal-btn danger" onclick="endGameNow()">â›” Termina Partita</button>
    <button class="modal-btn" onclick="reshowQR()">ğŸ“· Mostra QR Code</button>`
    :`<p style="color:var(--muted);font-size:13px;text-align:center;padding:10px 0">Solo il Master puÃ² modificare.</p>`;
  showOverlay('overlay-settings');
}
function openPuBrowser(){
  const state=G._lastState;
  const mode=state?.mode||G.gameMode||'classic';
  const bans=MODE_BANS[mode]||[];
  const puEnabled=state?.puEnabled||{};
  const title=document.getElementById('pu-browser-title');
  const note=document.getElementById('pu-browser-mode-note');
  const list=document.getElementById('pu-browser-list');
  title.textContent=`ğŸ“– TUTTI I POTERI â€” ${mode.toUpperCase()}`;
  const showBanned=(mode==='hardcore'||mode==='chaos');
  note.textContent=showBanned?`I poteri in rosso sono disabilitati in modalitÃ  ${mode}.`:'';
  list.innerHTML=POWERUPS.map(p=>{
    const isBanned=bans.includes(p.id)||puEnabled[p.id]===false;
    const th=PU_THEMES[p.id]||{glow:'#c0c0c0'};
    const timingLabel=p.timing==='before'?'PRIMA':'DOPO';
    return `<div class="pu-browser-entry${isBanned?' pu-browser-banned':''}">
      <div class="pu-browser-icon" style="filter:drop-shadow(0 0 8px ${th.glow}80)">${p.icon}</div>
      <div class="pu-browser-info">
        <div class="pu-browser-name">
          ${p.name.toUpperCase()}
          <span class="pu-browser-timing">${timingLabel}</span>
          ${isBanned?`<span class="pu-banned-tag">BANNATO</span>`:''}
        </div>
        <div class="pu-browser-desc">${p.desc}</div>
      </div>
    </div>`;
  }).join('');
  showOverlay('overlay-pu-browser');
}
function openPuManager(){
  closeOverlay('overlay-settings');
  document.getElementById('pu-manager-list').innerHTML=POWERUPS.map(p=>`
    <div class="pu-manager-row">
      <div class="pu-mgr-icon">${p.icon}</div>
      <div class="pu-mgr-info"><div class="pu-mgr-name">${p.name}</div><div class="pu-mgr-desc">${p.desc}</div></div>
      <label class="toggle"><input type="checkbox" ${G.puEnabled[p.id]!==false?'checked':''} onchange="togglePu('${p.id}',this.checked)"><span class="toggle-slider"></span></label>
    </div>`).join('');
  showOverlay('overlay-pu-manager');
}
async function togglePu(id,val){G.puEnabled[id]=val;if(G.roomId)await dbUpdate(`rooms/${G.roomId}`,{[`puEnabled/${id}`]:val});}
async function endGameNow(){closeOverlay('overlay-settings');await dbUpdate(`rooms/${G.roomId}`,{status:'gameover',winner:null});}
async function doRestart(){
  const hp=parseInt(document.getElementById('restart-hp').value)||1000;
  const room=await dbGet(`rooms/${G.roomId}`);if(!room)return;
  const players={};
  Object.entries(room.players).forEach(([pid,p])=>{players[pid]={...p,hp,maxHp:hp,alive:true,skipNext:false,activeBug:false,jaguarShield:false};});
  const cards=generateCards(players,room.mode);
  const bans=MODE_BANS[room.mode]||[];
  const puEnabled={};
  if(G.isTestMode){POWERUPS.forEach(p=>puEnabled[p.id]=true);}
  else{POWERUPS.forEach(p=>puEnabled[p.id]=!bans.includes(p.id));}
  // Full state reset via dbSet to wipe all old fields
  await dbSet(`rooms/${G.roomId}`,{
    status:'playing',mode:room.mode,initialHp:hp,direction:1,
    currentTurnIndex:0,turnCount:1,gameStartTime:Date.now(),
    players,playerOrder:room.playerOrder,
    cards,activePowerups:{},puEnabled,log:{},stats:{},
    tickCard:null,moscaCard:null,butterflyActive:false,butterflyCards:null,butterflyOwner:null,
    skunkCards:null,chameleonUsed:false,winner:null,
    _zeckaPendingDmg:null,_lionPendingDmg:null,_hyenaSkip:null,
  });
  G._gameoverShown=false;closeOverlay('overlay-restart');startPlayingScreen();
}
function reshowQR(){
  closeOverlay('overlay-settings');
  document.getElementById('qr-overlay-code').textContent=G.roomId||'----';
  const qrEl=document.getElementById('qr-overlay-container');
  qrEl.innerHTML='';
  if(G.roomId){
    const url=`${location.origin}${location.pathname}?room=${G.roomId}`;
    try{new QRCode(qrEl,{text:url,width:160,height:160,colorDark:'#000',colorLight:'#fff'});}catch(e){qrEl.textContent=url;}
  }
  showOverlay('overlay-qr');
}
function restartGame(){if(G.isMaster)showOverlay('overlay-restart');else toast('Solo il Master puÃ² riavviare.');}
function goHome(){
  G._gameoverShown=false;clearTimer();dbUnsubAll();
  G.isTestMode=false;G.isMaster=false;G.isSpectator=false;
  G.masterOverrideActive=false;G.masterOverridePid=null;
  G.bearMode=false;G.bearCardsChosen=0;
  G.pendingConfirm=false;_cardLocked=false;
  // Reset mode selector UI to classic
  G.gameMode='classic';G.isTestMode=false;
  ['classic','hardcore','chaos','test'].forEach(id=>{
    const el=document.getElementById('mode-'+id);
    if(el)el.classList.toggle('selected',id==='classic');
  });
  const mDesc=document.getElementById('mode-desc');
  if(mDesc)mDesc.textContent='ğŸ´ Classica: vedi i valori delle carte, scegli il powerup dopo ogni turno.';
  const btn=document.getElementById('btn-create-game');if(btn)btn.textContent='âš”ï¸ CREA PARTITA';
  showScreen('screen-home');
}

// â•â• URL join â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('firebase-ready',()=>{
  const r=new URLSearchParams(location.search).get('room');
  if(r){document.getElementById('join-code').value=r;showScreen('screen-join');setTimeout(loadRoomNames,500);}
});

// â•â• Mobile performance â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fix iOS 100vh (visual viewport instead of layout viewport)
function fixViewportHeight(){
  const vh=window.visualViewport?window.visualViewport.height:window.innerHeight;
  document.documentElement.style.setProperty('--vh',`${vh*0.01}px`);
}
fixViewportHeight();
if(window.visualViewport)window.visualViewport.addEventListener('resize',fixViewportHeight);
// Kill long-press context menus on game cards (interferes with gameplay on mobile)
document.addEventListener('contextmenu',e=>{
  if(e.target.closest('.game-card,.cards-grid,.hp-strip,.pu-choice'))e.preventDefault();
},{passive:false});


</script>
</body>
</html>
